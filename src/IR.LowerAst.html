<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-2"></span><span class="hs-comment">{- | Lower the representation of a sslang Ast into sslang IR.

This pass expects prior desugaring passes to ensure that:

- Op regions are unflatted into proper applications.
- Patterns in definitions consist of only (annotated) identifiers or wildcards.
-}</span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IR.LowerAst</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.LowerAst.html#lowerProgram"><span class="hs-identifier">lowerProgram</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Common.Compiler.html"><span class="hs-identifier">Common.Compiler</span></a></span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Compiler</span></span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Front.Ast.html"><span class="hs-identifier">Front.Ast</span></a></span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.IR.html"><span class="hs-identifier">IR.IR</span></a></span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html"><span class="hs-identifier">IR.Types.Annotated</span></a></span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html"><span class="hs-identifier">IR.Types.TypeSystem</span></a></span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Common.Identifiers.html"><span class="hs-identifier">Common.Identifiers</span></a></span><span>             </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier">TVarId</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.Identifiers.html#fromId"><span class="hs-identifier">fromId</span></a></span><span>
</span><span id="line-23"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromString</span></span><span>
</span><span id="line-24"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.Identifiers.html#isCons"><span class="hs-identifier">isCons</span></a></span><span>
</span><span id="line-25"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.Identifiers.html#isVar"><span class="hs-identifier">isVar</span></a></span><span>
</span><span id="line-26"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Comonad</span></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Comonad</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span>                 </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Bifunctor</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>                     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">fromJust</span></span><span>
</span><span id="line-31"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isJust</span></span><span>
</span><span id="line-32"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-comment">{- | IR type annotation continuation.

In the AST, type annotations appear as first-class expression/pattern nodes that
wrap other nodes, whereas in the IR, type annotations appear as data that appear
alongside those notes. Thus a common pattern that emerges from this pass is to
accummulate a continuation of type annotations via composition while those AST
annotations are being unwrapped.
-}</span><span>
</span><span id="line-41"></span><span class="hs-keyword">type</span><span> </span><span id="AnnotationK"><span class="annot"><a href="IR.LowerAst.html#AnnotationK"><span class="hs-identifier hs-var">AnnotationK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-comment">-- | Lowers the AST's representation of types into that of the IR.</span><span>
</span><span id="line-44"></span><span class="annot"><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-type">lowerType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Typ"><span class="hs-identifier hs-type">A.Typ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-45"></span><span id="lowerType"><span class="annot"><span class="annottext">lowerType :: Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var hs-var">lowerType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#TTuple"><span class="hs-identifier hs-type">A.TTuple</span></a></span><span> </span><span id="local-6989586621679472677"><span class="annot"><span class="annottext">[Typ]
</span><a href="#local-6989586621679472677"><span class="hs-identifier hs-var">tys</span></a></span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Type
forall t. TypeSystem t =&gt; [t] -&gt; t
</span><a href="IR.Types.TypeSystem.html#tuple"><span class="hs-identifier hs-var">I.tuple</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; Type) -&gt; [Type] -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Typ -&gt; Type) -&gt; [Typ] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">[Typ]
</span><a href="#local-6989586621679472677"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-46"></span><span class="annot"><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#TArrow"><span class="hs-identifier hs-type">A.TArrow</span></a></span><span> </span><span id="local-6989586621679472674"><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472674"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621679472673"><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472673"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472674"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
forall t. TypeSystem t =&gt; t -&gt; t -&gt; t
</span><a href="IR.Types.TypeSystem.html#arrow"><span class="hs-operator hs-var">`I.arrow`</span></a></span><span> </span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472673"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-47"></span><span class="annot"><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#TCon"><span class="hs-identifier hs-type">A.TCon</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;Int&quot;</span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">I.int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-48"></span><span class="annot"><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#TCon"><span class="hs-identifier hs-type">A.TCon</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;()&quot;</span></span><span>     </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-identifier hs-var">I.unit</span></a></span><span>
</span><span id="line-49"></span><span class="annot"><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#TCon"><span class="hs-identifier hs-type">A.TCon</span></a></span><span> </span><span id="local-6989586621679472668"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472668"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; Bool
forall a. Identifiable a =&gt; a -&gt; Bool
</span><a href="Common.Identifiers.html#isCons"><span class="hs-identifier hs-var">isCons</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472668"><span class="hs-identifier hs-var">i</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeAnnote] -&gt; Type
</span><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-var">I.Type</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TConId -&gt; [Type] -&gt; TypeAnnote
</span><a href="IR.Types.Annotated.html#TCon"><span class="hs-identifier hs-var">I.TCon</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; TConId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472668"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-50"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeAnnote] -&gt; Type
</span><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-var">I.Type</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TVarId -&gt; TypeAnnote
</span><a href="IR.Types.Annotated.html#TVar"><span class="hs-identifier hs-var">I.TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; TVarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472668"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-51"></span><span class="annot"><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span id="local-6989586621679472664"><span class="annot"><span class="annottext">a :: Typ
</span><a href="#local-6989586621679472664"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#TApp"><span class="hs-identifier hs-type">A.TApp</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Typ
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Typ -&gt; (Typ, [Typ])
</span><a href="Front.Ast.html#collectTApp"><span class="hs-identifier hs-var">A.collectTApp</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472664"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#TCon"><span class="hs-identifier hs-type">A.TCon</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;&amp;&quot;</span></span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621679472661"><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472661"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall t. TypeSystem t =&gt; t -&gt; t
</span><a href="IR.Types.TypeSystem.html#ref"><span class="hs-identifier hs-var">I.ref</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472661"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#TCon"><span class="hs-identifier hs-type">A.TCon</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;[]&quot;</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621679472659"><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472659"><span class="hs-identifier hs-var">_arg</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Type
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;list types are not yet implemented&quot;</span></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#TCon"><span class="hs-identifier hs-type">A.TCon</span></a></span><span> </span><span id="local-6989586621679472657"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472657"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679472656"><span class="annot"><span class="annottext">[Typ]
</span><a href="#local-6989586621679472656"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; Bool
forall a. Identifiable a =&gt; a -&gt; Bool
</span><a href="Common.Identifiers.html#isCons"><span class="hs-identifier hs-var">isCons</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472657"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[TypeAnnote] -&gt; Type
</span><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-var">I.Type</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TConId -&gt; [Type] -&gt; TypeAnnote
</span><a href="IR.Types.Annotated.html#TCon"><span class="hs-identifier hs-var">I.TCon</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; TConId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472657"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; TypeAnnote) -&gt; [Type] -&gt; TypeAnnote
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Typ -&gt; Type) -&gt; [Typ] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">[Typ]
</span><a href="#local-6989586621679472656"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><span class="annottext">(Typ, [Typ])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><span class="annottext">[Char] -&gt; Type
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Type) -&gt; [Char] -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot lower type application with non-constant head: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Typ -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472664"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">-- | Lower an AST 'Program' into IR.</span><span>
</span><span id="line-59"></span><span class="annot"><a href="IR.LowerAst.html#lowerProgram"><span class="hs-identifier hs-type">lowerProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Program"><span class="hs-identifier hs-type">A.Program</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span id="lowerProgram"><span class="annot"><span class="annottext">lowerProgram :: Program -&gt; Pass (Program Type)
</span><a href="IR.LowerAst.html#lowerProgram"><span class="hs-identifier hs-var hs-var">lowerProgram</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Program"><span class="hs-identifier hs-type">A.Program</span></a></span><span> </span><span id="local-6989586621679472653"><span class="annot"><span class="annottext">[TopDef]
</span><a href="#local-6989586621679472653"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679472652"><span class="annot"><span class="annottext">[TypeDef]
</span><a href="#local-6989586621679472652"><span class="hs-identifier hs-var">tds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679472651"><span class="annot"><span class="annottext">[[Char]]
</span><a href="#local-6989586621679472651"><span class="hs-identifier hs-var">cds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679472650"><span class="annot"><span class="annottext">[ExternDecl]
</span><a href="#local-6989586621679472650"><span class="hs-identifier hs-var">xds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679472649"><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679472649"><span class="hs-identifier hs-var">dds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TopDef] -&gt; ([TypeDef], [[Char]], [ExternDecl], [Definition])
</span><a href="Front.Ast.html#getTops"><span class="hs-identifier hs-var">A.getTops</span></a></span><span> </span><span class="annot"><span class="annottext">[TopDef]
</span><a href="#local-6989586621679472653"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-62"></span><span>  </span><span id="local-6989586621679472647"><span class="annot"><span class="annottext">[(TConId, TypeDef Type)]
</span><a href="#local-6989586621679472647"><span class="hs-identifier hs-var">tds'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TypeDef -&gt; Pass (TConId, TypeDef Type))
-&gt; [TypeDef] -&gt; Pass [(TConId, TypeDef Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TypeDef -&gt; Pass (TConId, TypeDef Type)
</span><a href="IR.LowerAst.html#lowerTypeDef"><span class="hs-identifier hs-var">lowerTypeDef</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeDef]
</span><a href="#local-6989586621679472652"><span class="hs-identifier hs-var">tds</span></a></span><span>
</span><span id="line-63"></span><span>  </span><span id="local-6989586621679472644"><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679472644"><span class="hs-identifier hs-var">xds'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ExternDecl -&gt; Pass (VarId, Type))
-&gt; [ExternDecl] -&gt; Pass [(VarId, Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">ExternDecl -&gt; Pass (VarId, Type)
</span><a href="IR.LowerAst.html#lowerExternDecl"><span class="hs-identifier hs-var">lowerExternDecl</span></a></span><span> </span><span class="annot"><span class="annottext">[ExternDecl]
</span><a href="#local-6989586621679472650"><span class="hs-identifier hs-var">xds</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span id="local-6989586621679472642"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679472642"><span class="hs-identifier hs-var">dds'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Definition -&gt; Pass (VarId, Expr Type))
-&gt; [Definition] -&gt; Pass [(VarId, Expr Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Definition -&gt; Pass (VarId, Expr Type)
</span><a href="IR.LowerAst.html#lowerDataDef"><span class="hs-identifier hs-var">lowerDataDef</span></a></span><span> </span><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679472649"><span class="hs-identifier hs-var">dds</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Program Type -&gt; Pass (Program Type))
-&gt; Program Type -&gt; Pass (Program Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program :: forall t.
VarId
-&gt; [Char]
-&gt; [(VarId, t)]
-&gt; [(VarId, Expr t)]
-&gt; [(TConId, TypeDef t)]
-&gt; Program t
</span><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">programEntry :: VarId
</span><a href="IR.IR.html#programEntry"><span class="hs-identifier hs-var">I.programEntry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; VarId
forall a. IsString a =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;main&quot;</span></span><span> </span><span class="hs-comment">-- TODO: don't hardcode</span><span>
</span><span id="line-66"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">programDefs :: [(VarId, Expr Type)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var">I.programDefs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679472642"><span class="hs-identifier hs-var">dds'</span></a></span><span>
</span><span id="line-67"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">externDecls :: [(VarId, Type)]
</span><a href="IR.IR.html#externDecls"><span class="hs-identifier hs-var">I.externDecls</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679472644"><span class="hs-identifier hs-var">xds'</span></a></span><span>
</span><span id="line-68"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">typeDefs :: [(TConId, TypeDef Type)]
</span><a href="IR.IR.html#typeDefs"><span class="hs-identifier hs-var">I.typeDefs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TConId, TypeDef Type)]
</span><a href="#local-6989586621679472647"><span class="hs-identifier hs-var">tds'</span></a></span><span>
</span><span id="line-69"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cDefs :: [Char]
</span><a href="IR.IR.html#cDefs"><span class="hs-identifier hs-var">I.cDefs</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[Char]]
</span><a href="#local-6989586621679472651"><span class="hs-identifier hs-var">cds</span></a></span><span>
</span><span id="line-70"></span><span>                     </span><span class="hs-special">}</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">-- | Lower a top-level data definition into IR.</span><span>
</span><span id="line-73"></span><span class="annot"><a href="IR.LowerAst.html#lowerDataDef"><span class="hs-identifier hs-type">lowerDataDef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Definition"><span class="hs-identifier hs-type">A.Definition</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span id="lowerDataDef"><span class="annot"><span class="annottext">lowerDataDef :: Definition -&gt; Pass (VarId, Expr Type)
</span><a href="IR.LowerAst.html#lowerDataDef"><span class="hs-identifier hs-var hs-var">lowerDataDef</span></a></span></span><span> </span><span id="local-6989586621679472633"><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679472633"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Definition -&gt; (Binder, Expr Type)
</span><a href="IR.LowerAst.html#lowerDef"><span class="hs-identifier hs-var">lowerDef</span></a></span><span> </span><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679472633"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679472631"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679472631"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679472630"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679472630"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(VarId, Expr Type) -&gt; Pass (VarId, Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679472631"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679472630"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Pass (VarId, Expr Type)
forall (m :: * -&gt; *) a. MonadError Error m =&gt; [Char] -&gt; m a
</span><a href="Common.Compiler.html#unexpected"><span class="hs-identifier hs-var">Compiler.unexpected</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Missing top-level binding&quot;</span></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-comment">-- TODO: This might actually be ok, to allow top-level evaluation</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-comment">-- | Lower a top-level type definition into IR.</span><span>
</span><span id="line-80"></span><span class="annot"><a href="IR.LowerAst.html#lowerTypeDef"><span class="hs-identifier hs-type">lowerTypeDef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#TypeDef"><span class="hs-identifier hs-type">A.TypeDef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#TConId"><span class="hs-identifier hs-type">I.TConId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#TypeDef"><span class="hs-identifier hs-type">I.TypeDef</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span id="lowerTypeDef"><span class="annot"><span class="annottext">lowerTypeDef :: TypeDef -&gt; Pass (TConId, TypeDef Type)
</span><a href="IR.LowerAst.html#lowerTypeDef"><span class="hs-identifier hs-var hs-var">lowerTypeDef</span></a></span></span><span> </span><span class="annot"><a href="Front.Ast.html#TypeDef"><span class="hs-identifier hs-type">A.TypeDef</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">typeName :: TypeDef -&gt; Identifier
</span><a href="Front.Ast.html#typeName"><span class="hs-identifier hs-var">A.typeName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679472626"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472626"><span class="hs-identifier hs-var">tn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">typeParams :: TypeDef -&gt; [Identifier]
</span><a href="Front.Ast.html#typeParams"><span class="hs-identifier hs-var">A.typeParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679472624"><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679472624"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">typeVariants :: TypeDef -&gt; [TypeVariant]
</span><a href="Front.Ast.html#typeVariants"><span class="hs-identifier hs-var">A.typeVariants</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679472622"><span class="annot"><span class="annottext">[TypeVariant]
</span><a href="#local-6989586621679472622"><span class="hs-identifier hs-var">tds</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TConId, TypeDef Type) -&gt; Pass (TConId, TypeDef Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; TConId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472626"><span class="hs-identifier hs-var">tn</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeDef :: forall t. [(DConId, TypeVariant t)] -&gt; [TVarId] -&gt; TypeDef t
</span><a href="IR.Types.TypeSystem.html#TypeDef"><span class="hs-identifier hs-type">I.TypeDef</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">targs :: [TVarId]
</span><a href="IR.Types.TypeSystem.html#targs"><span class="hs-identifier hs-var">I.targs</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; TVarId) -&gt; [Identifier] -&gt; [TVarId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; TVarId
</span><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier hs-var">TVarId</span></a></span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679472624"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-85"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">variants :: [(DConId, TypeVariant Type)]
</span><a href="IR.Types.TypeSystem.html#variants"><span class="hs-identifier hs-var">I.variants</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TypeVariant -&gt; (DConId, TypeVariant Type))
-&gt; [TypeVariant] -&gt; [(DConId, TypeVariant Type)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeVariant -&gt; (DConId, TypeVariant Type)
forall a. Identifiable a =&gt; TypeVariant -&gt; (a, TypeVariant Type)
</span><a href="#local-6989586621679472617"><span class="hs-identifier hs-var">lowerTypeVariant</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeVariant]
</span><a href="#local-6989586621679472622"><span class="hs-identifier hs-var">tds</span></a></span><span>
</span><span id="line-86"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-89"></span><span>  </span><span id="local-6989586621679472617"><span class="annot"><span class="annottext">lowerTypeVariant :: TypeVariant -&gt; (a, TypeVariant Type)
</span><a href="#local-6989586621679472617"><span class="hs-identifier hs-var hs-var">lowerTypeVariant</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#VariantUnnamed"><span class="hs-identifier hs-type">A.VariantUnnamed</span></a></span><span> </span><span id="local-6989586621679472615"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472615"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span id="local-6989586621679472614"><span class="annot"><span class="annottext">[Typ]
</span><a href="#local-6989586621679472614"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; a
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472615"><span class="hs-identifier hs-var">vn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; TypeVariant Type
forall t. [t] -&gt; TypeVariant t
</span><a href="IR.Types.TypeSystem.html#VariantUnnamed"><span class="hs-identifier hs-var">I.VariantUnnamed</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; TypeVariant Type) -&gt; [Type] -&gt; TypeVariant Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Typ -&gt; Type) -&gt; [Typ] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">[Typ]
</span><a href="#local-6989586621679472614"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-comment">-- | Lower an 'A.ExternDecl' into an identifier/type pair.</span><span>
</span><span id="line-93"></span><span class="annot"><a href="IR.LowerAst.html#lowerExternDecl"><span class="hs-identifier hs-type">lowerExternDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#ExternDecl"><span class="hs-identifier hs-type">A.ExternDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span id="lowerExternDecl"><span class="annot"><span class="annottext">lowerExternDecl :: ExternDecl -&gt; Pass (VarId, Type)
</span><a href="IR.LowerAst.html#lowerExternDecl"><span class="hs-identifier hs-var hs-var">lowerExternDecl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#ExternDecl"><span class="hs-identifier hs-type">A.ExternDecl</span></a></span><span> </span><span id="local-6989586621679472611"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472611"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679472610"><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472610"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarId, Type) -&gt; Pass (VarId, Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472611"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472610"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">{- | Lower an 'A.Definition' into a name and bound expression.

Upon encountering a function definition 'A.DefFn', the args are unpacked in
a series of nested anonymous functions 'I.Lambda', bound to the function name in
the IR.
-}</span><span>
</span><span id="line-102"></span><span class="annot"><a href="IR.LowerAst.html#lowerDef"><span class="hs-identifier hs-type">lowerDef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Definition"><span class="hs-identifier hs-type">A.Definition</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span id="lowerDef"><span class="annot"><span class="annottext">lowerDef :: Definition -&gt; (Binder, Expr Type)
</span><a href="IR.LowerAst.html#lowerDef"><span class="hs-identifier hs-var hs-var">lowerDef</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#DefPat"><span class="hs-identifier hs-type">A.DefPat</span></a></span><span> </span><span id="local-6989586621679472608"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472608"><span class="hs-identifier hs-var">aPat</span></a></span></span><span> </span><span id="local-6989586621679472607"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472607"><span class="hs-identifier hs-var">aBody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat -&gt; Binder
</span><a href="IR.LowerAst.html#lowerPatName"><span class="hs-identifier hs-var">lowerPatName</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472608"><span class="hs-identifier hs-var">aPat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472607"><span class="hs-identifier hs-var">aBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat -&gt; Type
</span><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var">lowerPatType</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472608"><span class="hs-identifier hs-var">aPat</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="annot"><a href="IR.LowerAst.html#lowerDef"><span class="hs-identifier hs-var">lowerDef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#DefFn"><span class="hs-identifier hs-type">A.DefFn</span></a></span><span> </span><span id="local-6989586621679472602"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472602"><span class="hs-identifier hs-var">aName</span></a></span></span><span> </span><span id="local-6989586621679472601"><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472601"><span class="hs-identifier hs-var">aPats</span></a></span></span><span> </span><span id="local-6989586621679472600"><span class="annot"><span class="annottext">TypFn
</span><a href="#local-6989586621679472600"><span class="hs-identifier hs-var">aTy</span></a></span></span><span> </span><span id="local-6989586621679472599"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472599"><span class="hs-identifier hs-var">aBody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; Binder
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(VarId -&gt; Binder) -&gt; VarId -&gt; Binder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472602"><span class="hs-identifier hs-var">aName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Pat] -&gt; Expr -&gt; (Type -&gt; Type) -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerLambda"><span class="hs-identifier hs-var">lowerLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472601"><span class="hs-identifier hs-var">aPats</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472599"><span class="hs-identifier hs-var">aBody</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472597"><span class="hs-identifier hs-var">lambdaAnn</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472596"><span class="hs-identifier hs-var">lambdaRetAnn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-comment">{- | Where the 'A.TypFn' type annotation should be applied.

  When @let f x y = b@ is desugared into @let f = \x -&gt; \y -&gt; b@
  'A.TypProper' means the type annotation applies to the definition bound to @f@
  (i.e., @\x -&gt; \y -&gt; b@), whereas 'A.TypReturn' means the type annotation
  applies to the inner most function body (i.e., @b@). 'A.TypNone' means no type
  annotations need to be applied.

  Note that while 'A.TypProper' gives us enough information to unpack the
  arrow types and annotate all the intermediate lambdas, we punt that to the
  type checker. That is, @let f x : Int = b@ won't fail here, but it will/should
  be caught by the type checker.
  -}</span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><a href="#local-6989586621679472597"><span class="hs-identifier hs-type">lambdaAnn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679472596"><span class="hs-identifier hs-type">lambdaRetAnn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.LowerAst.html#AnnotationK"><span class="hs-identifier hs-type">AnnotationK</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679472597"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472597"><span class="hs-identifier hs-var">lambdaAnn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679472596"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472596"><span class="hs-identifier hs-var">lambdaRetAnn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypFn
</span><a href="#local-6989586621679472600"><span class="hs-identifier hs-var">aTy</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><a href="Front.Ast.html#TypProper"><span class="hs-identifier hs-type">A.TypProper</span></a></span><span> </span><span id="local-6989586621679472594"><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472594"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472594"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="Front.Ast.html#TypReturn"><span class="hs-identifier hs-type">A.TypReturn</span></a></span><span> </span><span id="local-6989586621679472591"><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472591"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472591"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><span class="annottext">TypFn
</span><a href="Front.Ast.html#TypNone"><span class="hs-identifier hs-var">A.TypNone</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">{- | Lowers an AST expression into an IR expression.

Performs the following desugaring inline:

- Desugars 'A.IfElse' to 'I.Match'
- Unrolls 'A.Constraint' to annotate sub-expressions

In particular, this function accepts a continuation @k :: (I.Type -&gt; I.Type)@ to
represent type information known by the caller. The callee may apply this
continuation to locally known type information (typically none, i.e.,
'I.untyped') to produce a type annotation that can be embedded in an 'I.Expr'
node, or extend it with further type information (via function composition) to
propogate it elsewhere. This is possible because the IR's type annotations
'I.Type' form a monoid, where 'I.untyped' is the identity element and '(&lt;&gt;)' is
the join operation.
-}</span><span>
</span><span id="line-143"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-type">lowerExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Expr"><span class="hs-identifier hs-type">A.Expr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LowerAst.html#AnnotationK"><span class="hs-identifier hs-type">AnnotationK</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-144"></span><span id="lowerExpr"><span class="annot"><span class="annottext">lowerExpr :: Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var hs-var">lowerExpr</span></a></span></span><span> </span><span id="local-6989586621679472589"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472589"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679472588"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472588"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe Primitive -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Primitive -&gt; Bool) -&gt; Maybe Primitive -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr -&gt; Maybe Primitive
</span><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472589"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Primitive -&gt; Primitive
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Primitive -&gt; Primitive) -&gt; Maybe Primitive -&gt; Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr -&gt; Maybe Primitive
</span><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472589"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472588"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span id="local-6989586621679472583"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472583"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472582"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472582"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; Bool
forall a. Identifiable a =&gt; a -&gt; Bool
</span><a href="Common.Identifiers.html#isCons"><span class="hs-identifier hs-var">isCons</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472583"><span class="hs-identifier hs-var">v</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DConId -&gt; Type -&gt; Expr Type
forall t. DConId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Data"><span class="hs-identifier hs-var">I.Data</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; DConId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472583"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472582"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Expr Type
forall t. VarId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Var"><span class="hs-identifier hs-var">I.Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472583"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472582"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span>  </span><span class="annot"><a href="Front.Ast.html#Lit"><span class="hs-identifier hs-type">A.Lit</span></a></span><span> </span><span id="local-6989586621679472578"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679472578"><span class="hs-identifier hs-var">l</span></a></span></span><span>    </span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472577"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472577"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Type -&gt; Expr Type
forall t. Literal -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lit"><span class="hs-identifier hs-var">I.Lit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; Literal
</span><a href="IR.LowerAst.html#lowerLit"><span class="hs-identifier hs-var">lowerLit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679472578"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472577"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span id="local-6989586621679472574"><span class="annot"><span class="annottext">a :: Expr
</span><a href="#local-6989586621679472574"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Apply"><span class="hs-identifier hs-type">A.Apply</span></a></span><span> </span><span id="local-6989586621679472572"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472572"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679472571"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472571"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472570"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472570"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Expr -&gt; Maybe Primitive)
-&gt; (Expr, [Expr]) -&gt; (Maybe Primitive, [Expr])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">Expr -&gt; Maybe Primitive
</span><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Expr, [Expr])
</span><a href="Front.Ast.html#collectApp"><span class="hs-identifier hs-var">A.collectApp</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472574"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679472567"><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679472567"><span class="hs-keyword hs-var">prim</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679472566"><span class="annot"><span class="annottext">[Expr]
</span><a href="#local-6989586621679472566"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679472567"><span class="hs-keyword hs-var">prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr -&gt; Expr Type) -&gt; [Expr] -&gt; [Expr Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-operator hs-var">`lowerExpr`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr]
</span><a href="#local-6989586621679472566"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472570"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Primitive
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Expr]
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#App"><span class="hs-identifier hs-var">I.App</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472572"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472571"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472570"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Let"><span class="hs-identifier hs-type">A.Let</span></a></span><span> </span><span id="local-6989586621679472563"><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679472563"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621679472562"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472562"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472561"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472561"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><span class="annottext">[(Binder, Expr Type)] -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. [(Binder, Expr t)] -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Let"><span class="hs-identifier hs-var">I.Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Definition -&gt; (Binder, Expr Type))
-&gt; [Definition] -&gt; [(Binder, Expr Type)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Definition -&gt; (Binder, Expr Type)
</span><a href="IR.LowerAst.html#lowerDef"><span class="hs-identifier hs-var">lowerDef</span></a></span><span> </span><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679472563"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472562"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472561"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Lambda"><span class="hs-identifier hs-type">A.Lambda</span></a></span><span> </span><span id="local-6989586621679472558"><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472558"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621679472557"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472557"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472556"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472556"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pat] -&gt; Expr -&gt; (Type -&gt; Type) -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerLambda"><span class="hs-identifier hs-var">lowerLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472558"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472557"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472556"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-155"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#While"><span class="hs-identifier hs-type">A.While</span></a></span><span>  </span><span id="local-6989586621679472554"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472554"><span class="hs-identifier hs-var">c</span></a></span></span><span>  </span><span id="local-6989586621679472553"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472553"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472552"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472552"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Loop"><span class="hs-identifier hs-var">I.Loop</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679472550"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472552"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679472550"><span class="annot"><span class="annottext">body :: Expr Type
</span><a href="#local-6989586621679472550"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; Expr -&gt; Expr -&gt; Expr
</span><a href="Front.Ast.html#IfElse"><span class="hs-identifier hs-var">A.IfElse</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472554"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; Expr
</span><a href="Front.Ast.html#Lit"><span class="hs-identifier hs-var">A.Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="Front.Ast.html#LitEvent"><span class="hs-identifier hs-var">A.LitEvent</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="Front.Ast.html#Break"><span class="hs-identifier hs-var">A.Break</span></a></span><span> </span><span class="annot"><span class="annottext">Expr -&gt; Expr -&gt; Expr
</span><a href="Front.Ast.html#Seq"><span class="hs-operator hs-var">`A.Seq`</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472553"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-157"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Loop"><span class="hs-identifier hs-type">A.Loop</span></a></span><span> </span><span id="local-6989586621679472544"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472544"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472543"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472543"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Loop"><span class="hs-identifier hs-var">I.Loop</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472544"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472543"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Par"><span class="hs-identifier hs-type">A.Par</span></a></span><span>  </span><span id="local-6989586621679472541"><span class="annot"><span class="annottext">[Expr]
</span><a href="#local-6989586621679472541"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472540"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472540"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Par"><span class="hs-identifier hs-var">I.Par</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr -&gt; Expr Type) -&gt; [Expr] -&gt; [Expr Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-operator hs-var">`lowerExpr`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr]
</span><a href="#local-6989586621679472541"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472540"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#After"><span class="hs-identifier hs-type">A.After</span></a></span><span> </span><span id="local-6989586621679472537"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472537"><span class="hs-identifier hs-var">delay</span></a></span></span><span> </span><span id="local-6989586621679472536"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472536"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621679472535"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472535"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472534"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472534"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#After"><span class="hs-identifier hs-var">I.After</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr -&gt; Expr Type) -&gt; [Expr] -&gt; [Expr Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-operator hs-var">`lowerExpr`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472537"><span class="hs-identifier hs-var">delay</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472536"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472535"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472534"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Assign"><span class="hs-identifier hs-type">A.Assign</span></a></span><span> </span><span id="local-6989586621679472531"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472531"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621679472530"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472530"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472529"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472529"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-162"></span><span>  </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Assign"><span class="hs-identifier hs-var">I.Assign</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr -&gt; Expr Type) -&gt; [Expr] -&gt; [Expr Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-operator hs-var">`lowerExpr`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472531"><span class="hs-identifier hs-var">lhs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472530"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472529"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Constraint"><span class="hs-identifier hs-type">A.Constraint</span></a></span><span> </span><span id="local-6989586621679472526"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472526"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679472525"><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472525"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472524"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472524"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472526"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472524"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; (Type -&gt; Type) -&gt; Type -&gt; Type
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472525"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Wait"><span class="hs-identifier hs-type">A.Wait</span></a></span><span> </span><span id="local-6989586621679472521"><span class="annot"><span class="annottext">[Expr]
</span><a href="#local-6989586621679472521"><span class="hs-identifier hs-var">exprs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472520"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472520"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Wait"><span class="hs-identifier hs-var">I.Wait</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr -&gt; Expr Type) -&gt; [Expr] -&gt; [Expr Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-operator hs-var">`lowerExpr`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr]
</span><a href="#local-6989586621679472521"><span class="hs-identifier hs-var">exprs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472520"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Seq"><span class="hs-identifier hs-type">A.Seq</span></a></span><span> </span><span id="local-6989586621679472518"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472518"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679472517"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472517"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472516"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472516"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><span class="annottext">[(Binder, Expr Type)] -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. [(Binder, Expr t)] -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Let"><span class="hs-identifier hs-var">I.Let</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472518"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472517"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472516"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="Front.Ast.html#Break"><span class="hs-identifier hs-var">A.Break</span></a></span><span>        </span><span id="local-6989586621679472515"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472515"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Break"><span class="hs-identifier hs-var">I.Break</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472515"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Match"><span class="hs-identifier hs-type">A.Match</span></a></span><span> </span><span id="local-6989586621679472512"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472512"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679472511"><span class="annot"><span class="annottext">[(Pat, Expr)]
</span><a href="#local-6989586621679472511"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472510"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472510"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; [(Alt, Expr Type)] -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; [(Alt, Expr t)] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Match"><span class="hs-identifier hs-var">I.Match</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679472508"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Pat, Expr) -&gt; (Alt, Expr Type))
-&gt; [(Pat, Expr)] -&gt; [(Alt, Expr Type)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Pat, Expr) -&gt; (Alt, Expr Type)
</span><a href="#local-6989586621679472507"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[(Pat, Expr)]
</span><a href="#local-6989586621679472511"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472510"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-171"></span><span>  </span><span id="local-6989586621679472508"><span class="annot"><span class="annottext">cond :: Expr Type
</span><a href="#local-6989586621679472508"><span class="hs-identifier hs-var hs-var">cond</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472512"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-172"></span><span>  </span><span id="local-6989586621679472507"><span class="annot"><span class="annottext">f :: (Pat, Expr) -&gt; (Alt, Expr Type)
</span><a href="#local-6989586621679472507"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679472506"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472506"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679472505"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472505"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat -&gt; Alt
</span><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472506"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472505"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#IfElse"><span class="hs-identifier hs-type">A.IfElse</span></a></span><span> </span><span id="local-6989586621679472503"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472503"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679472502"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472502"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679472501"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472501"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472500"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472500"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; [(Alt, Expr Type)] -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; [(Alt, Expr t)] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Match"><span class="hs-identifier hs-var">I.Match</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679472499"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(Alt, Expr Type)
</span><a href="#local-6989586621679472498"><span class="hs-identifier hs-var">eArm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Alt, Expr Type)
</span><a href="#local-6989586621679472497"><span class="hs-identifier hs-var">tArm</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472500"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-175"></span><span>  </span><span id="local-6989586621679472499"><span class="annot"><span class="annottext">cond :: Expr Type
</span><a href="#local-6989586621679472499"><span class="hs-identifier hs-var hs-var">cond</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472503"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-176"></span><span>  </span><span id="local-6989586621679472497"><span class="annot"><span class="annottext">tArm :: (Alt, Expr Type)
</span><a href="#local-6989586621679472497"><span class="hs-identifier hs-var hs-var">tArm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder -&gt; Alt
</span><a href="IR.IR.html#AltDefault"><span class="hs-identifier hs-var">I.AltDefault</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472502"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>  </span><span id="local-6989586621679472498"><span class="annot"><span class="annottext">eArm :: (Alt, Expr Type)
</span><a href="#local-6989586621679472498"><span class="hs-identifier hs-var hs-var">eArm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; Alt
</span><a href="IR.IR.html#AltLit"><span class="hs-identifier hs-var">I.AltLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Literal
</span><a href="IR.IR.html#LitIntegral"><span class="hs-identifier hs-var">I.LitIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472501"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#CQuote"><span class="hs-identifier hs-type">A.CQuote</span></a></span><span> </span><span id="local-6989586621679472492"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679472492"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472491"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472491"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Primitive
</span><a href="IR.IR.html#CQuote"><span class="hs-identifier hs-var">I.CQuote</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Primitive) -&gt; [Char] -&gt; Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char]
forall a. IsString a =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679472492"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472491"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#CCall"><span class="hs-identifier hs-type">A.CCall</span></a></span><span> </span><span id="local-6989586621679472488"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472488"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679472487"><span class="annot"><span class="annottext">[Expr]
</span><a href="#local-6989586621679472487"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472486"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472486"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CSym -&gt; Primitive
</span><a href="IR.IR.html#CCall"><span class="hs-identifier hs-var">I.CCall</span></a></span><span> </span><span class="annot"><span class="annottext">(CSym -&gt; Primitive) -&gt; CSym -&gt; Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; CSym
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472488"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr -&gt; Expr Type) -&gt; [Expr] -&gt; [Expr Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-operator hs-var">`lowerExpr`</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr]
</span><a href="#local-6989586621679472487"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472486"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#OpRegion"><span class="hs-identifier hs-type">A.OpRegion</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">OpRegion
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Expr Type
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Should already be desugared&quot;</span></span><span>
</span><span id="line-182"></span><span class="annot"><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="Front.Ast.html#NoExpr"><span class="hs-identifier hs-var">A.NoExpr</span></a></span><span>         </span><span id="local-6989586621679472482"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472482"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Type -&gt; Expr Type
forall t. Literal -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lit"><span class="hs-identifier hs-var">I.Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="IR.IR.html#LitEvent"><span class="hs-identifier hs-var">I.LitEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472482"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="hs-comment">-- | Lower an A.Pat into an I.Alt</span><span>
</span><span id="line-185"></span><span class="annot"><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-type">lowerAlt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Pat"><span class="hs-identifier hs-type">A.Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Alt"><span class="hs-identifier hs-type">I.Alt</span></a></span><span>
</span><span id="line-186"></span><span id="lowerAlt"><span class="annot"><span class="annottext">lowerAlt :: Pat -&gt; Alt
</span><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var hs-var">lowerAlt</span></a></span></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="Front.Ast.html#PatWildcard"><span class="hs-identifier hs-var">A.PatWildcard</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Binder -&gt; Alt
</span><a href="IR.IR.html#AltDefault"><span class="hs-identifier hs-var">I.AltDefault</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-187"></span><span class="annot"><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatId"><span class="hs-identifier hs-type">A.PatId</span></a></span><span> </span><span id="local-6989586621679472478"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472478"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; Bool
forall a. Identifiable a =&gt; a -&gt; Bool
</span><a href="Common.Identifiers.html#isVar"><span class="hs-identifier hs-var">isVar</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472478"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Binder -&gt; Alt
</span><a href="IR.IR.html#AltDefault"><span class="hs-identifier hs-var">I.AltDefault</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; Binder
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(VarId -&gt; Binder) -&gt; VarId -&gt; Binder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; VarId
</span><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-var">I.VarId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472478"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">DConId -&gt; [Binder] -&gt; Alt
</span><a href="IR.IR.html#AltData"><span class="hs-identifier hs-var">I.AltData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; DConId
</span><a href="Common.Identifiers.html#DConId"><span class="hs-identifier hs-var">I.DConId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472478"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-189"></span><span class="annot"><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatLit"><span class="hs-identifier hs-type">A.PatLit</span></a></span><span> </span><span id="local-6989586621679472473"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679472473"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Alt
</span><a href="IR.IR.html#AltLit"><span class="hs-identifier hs-var">I.AltLit</span></a></span><span> </span><span class="annot"><span class="annottext">(Literal -&gt; Alt) -&gt; Literal -&gt; Alt
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Literal
</span><a href="IR.LowerAst.html#lowerLit"><span class="hs-identifier hs-var">lowerLit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679472473"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-190"></span><span class="annot"><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatTup"><span class="hs-identifier hs-type">A.PatTup</span></a></span><span> </span><span class="annot"><span class="annottext">[Pat]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Alt
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;I.Alt for A.PatTup not implemented yet&quot;</span></span><span>
</span><span id="line-191"></span><span class="annot"><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatApp"><span class="hs-identifier hs-type">A.PatApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatId"><span class="hs-identifier hs-type">A.PatId</span></a></span><span> </span><span id="local-6989586621679472470"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472470"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679472469"><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472469"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DConId -&gt; [Binder] -&gt; Alt
</span><a href="IR.IR.html#AltData"><span class="hs-identifier hs-var">I.AltData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; DConId
</span><a href="Common.Identifiers.html#DConId"><span class="hs-identifier hs-var">I.DConId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472470"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>                                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat -&gt; Binder
</span><a href="#local-6989586621679472468"><span class="hs-identifier hs-var">lowerPatArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Pat -&gt; Binder) -&gt; [Pat] -&gt; [Binder]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472469"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><a href="#local-6989586621679472468"><span class="hs-identifier hs-type">lowerPatArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Pat"><span class="hs-identifier hs-type">A.Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span id="local-6989586621679472468"><span class="annot"><span class="annottext">lowerPatArg :: Pat -&gt; Binder
</span><a href="#local-6989586621679472468"><span class="hs-identifier hs-var hs-var">lowerPatArg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatId"><span class="hs-identifier hs-type">A.PatId</span></a></span><span> </span><span id="local-6989586621679472466"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472466"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Binder
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(VarId -&gt; Binder) -&gt; (Identifier -&gt; VarId) -&gt; Identifier -&gt; Binder
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; VarId
</span><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-var">I.VarId</span></a></span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; Binder) -&gt; Identifier -&gt; Binder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472466"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><a href="#local-6989586621679472468"><span class="hs-identifier hs-var">lowerPatArg</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="Front.Ast.html#PatWildcard"><span class="hs-identifier hs-var">A.PatWildcard</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Binder
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><a href="#local-6989586621679472468"><span class="hs-identifier hs-var">lowerPatArg</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- TODO: allow A.PatApp as an argument to A.PatApp</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><span class="annottext">[Char] -&gt; Binder
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;currently only accept identifiers or wildcards as args to a PatApp&quot;</span></span><span>
</span><span id="line-199"></span><span class="annot"><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatApp"><span class="hs-identifier hs-type">A.PatApp</span></a></span><span> </span><span class="annot"><span class="annottext">[Pat]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Alt
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;this should never happen!&quot;</span></span><span>
</span><span id="line-200"></span><span class="annot"><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatAnn"><span class="hs-identifier hs-type">A.PatAnn</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679472464"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472464"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; Alt
</span><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472464"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-201"></span><span class="annot"><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatAs"><span class="hs-identifier hs-type">A.PatAs</span></a></span><span>  </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679472462"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472462"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; Alt
</span><a href="IR.LowerAst.html#lowerAlt"><span class="hs-identifier hs-var">lowerAlt</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472462"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">{- | Unpack a list of patterns into nested (curried) lambdas.

This helper takes two arguments @lambdaAnn, lambdaRetAnn :: I.Type -&gt; I.Type)@,
which represent annotations that should be applied to the whole lambda
expression and only the body of the lambda expression. These roughly correspond
to 'A.TypProper' and 'A.TypReturn' annotations.
-}</span><span>
</span><span id="line-210"></span><span class="annot"><a href="IR.LowerAst.html#lowerLambda"><span class="hs-identifier hs-type">lowerLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Front.Ast.html#Pat"><span class="hs-identifier hs-type">A.Pat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Front.Ast.html#Expr"><span class="hs-identifier hs-type">A.Expr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LowerAst.html#AnnotationK"><span class="hs-identifier hs-type">AnnotationK</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LowerAst.html#AnnotationK"><span class="hs-identifier hs-type">AnnotationK</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-211"></span><span id="lowerLambda"><span class="annot"><span class="annottext">lowerLambda :: [Pat] -&gt; Expr -&gt; (Type -&gt; Type) -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerLambda"><span class="hs-identifier hs-var hs-var">lowerLambda</span></a></span></span><span> </span><span id="local-6989586621679472461"><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472461"><span class="hs-identifier hs-var">aPats</span></a></span></span><span> </span><span id="local-6989586621679472460"><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472460"><span class="hs-identifier hs-var">aBody</span></a></span></span><span> </span><span id="local-6989586621679472459"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472459"><span class="hs-identifier hs-var">lambdaAnn</span></a></span></span><span> </span><span id="local-6989586621679472458"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472458"><span class="hs-identifier hs-var">lambdaRetAnn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pat] -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="#local-6989586621679472457"><span class="hs-identifier hs-var">lowerBinds</span></a></span><span> </span><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472461"><span class="hs-identifier hs-var">aPats</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472459"><span class="hs-identifier hs-var">lambdaAnn</span></a></span><span>
</span><span id="line-212"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-comment">-- | Unpack a list of argument patterns into sequence of nested lambdas.</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="#local-6989586621679472457"><span class="hs-identifier hs-type">lowerBinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Front.Ast.html#Pat"><span class="hs-identifier hs-type">A.Pat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LowerAst.html#AnnotationK"><span class="hs-identifier hs-type">AnnotationK</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span id="local-6989586621679472457"><span class="annot"><span class="annottext">lowerBinds :: [Pat] -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="#local-6989586621679472457"><span class="hs-identifier hs-var hs-var">lowerBinds</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679472456"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472456"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679472455"><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472455"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679472454"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472454"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Binder -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Binder -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-var">I.Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679472452"><span class="hs-identifier hs-var">lVar</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679472451"><span class="hs-identifier hs-var">lBody</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679472450"><span class="hs-identifier hs-var">lType</span></a></span><span>
</span><span id="line-216"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621679472452"><span class="annot"><span class="annottext">lVar :: Binder
</span><a href="#local-6989586621679472452"><span class="hs-identifier hs-var hs-var">lVar</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; Binder
</span><a href="IR.LowerAst.html#lowerPatName"><span class="hs-identifier hs-var">lowerPatName</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472456"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621679472451"><span class="annot"><span class="annottext">lBody :: Expr Type
</span><a href="#local-6989586621679472451"><span class="hs-identifier hs-var hs-var">lBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Pat] -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="#local-6989586621679472457"><span class="hs-identifier hs-var">lowerBinds</span></a></span><span> </span><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472455"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621679472450"><span class="annot"><span class="annottext">lType :: Type
</span><a href="#local-6989586621679472450"><span class="hs-identifier hs-var hs-var">lType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472454"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat -&gt; Type
</span><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var">lowerPatType</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472456"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
forall t. TypeSystem t =&gt; t -&gt; t -&gt; t
</span><a href="IR.Types.TypeSystem.html#arrow"><span class="hs-operator hs-var">`I.arrow`</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679472451"><span class="hs-identifier hs-var">lBody</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><a href="#local-6989586621679472457"><span class="hs-identifier hs-var">lowerBinds</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679472448"><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472448"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr -&gt; (Type -&gt; Type) -&gt; Expr Type
</span><a href="IR.LowerAst.html#lowerExpr"><span class="hs-identifier hs-var">lowerExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><a href="#local-6989586621679472460"><span class="hs-identifier hs-var">aBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472448"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; (Type -&gt; Type) -&gt; Type -&gt; Type
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621679472458"><span class="hs-identifier hs-var">lambdaRetAnn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-comment">-- | Lower an AST literal into an IR literal.</span><span>
</span><span id="line-223"></span><span class="annot"><a href="IR.LowerAst.html#lowerLit"><span class="hs-identifier hs-type">lowerLit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Literal"><span class="hs-identifier hs-type">A.Literal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Literal"><span class="hs-identifier hs-type">I.Literal</span></a></span><span>
</span><span id="line-224"></span><span id="lowerLit"><span class="annot"><span class="annottext">lowerLit :: Literal -&gt; Literal
</span><a href="IR.LowerAst.html#lowerLit"><span class="hs-identifier hs-var hs-var">lowerLit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#LitInt"><span class="hs-identifier hs-type">A.LitInt</span></a></span><span> </span><span id="local-6989586621679472446"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679472446"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Literal
</span><a href="IR.IR.html#LitIntegral"><span class="hs-identifier hs-var">I.LitIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679472446"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-225"></span><span class="annot"><a href="IR.LowerAst.html#lowerLit"><span class="hs-identifier hs-var">lowerLit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="Front.Ast.html#LitEvent"><span class="hs-identifier hs-var">A.LitEvent</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="IR.IR.html#LitEvent"><span class="hs-identifier hs-var">I.LitEvent</span></a></span><span>
</span><span id="line-226"></span><span class="annot"><a href="IR.LowerAst.html#lowerLit"><span class="hs-identifier hs-var">lowerLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#LitChar"><span class="hs-identifier hs-type">A.LitChar</span></a></span><span>   </span><span id="local-6989586621679472444"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679472444"><span class="hs-identifier hs-var">_c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Literal
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Char literals are not yet implemented&quot;</span></span><span>
</span><span id="line-227"></span><span class="annot"><a href="IR.LowerAst.html#lowerLit"><span class="hs-identifier hs-var">lowerLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#LitString"><span class="hs-identifier hs-type">A.LitString</span></a></span><span> </span><span id="local-6989586621679472442"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679472442"><span class="hs-identifier hs-var">_s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Literal
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;String literals are not yet implemented&quot;</span></span><span>
</span><span id="line-228"></span><span class="annot"><a href="IR.LowerAst.html#lowerLit"><span class="hs-identifier hs-var">lowerLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#LitRat"><span class="hs-identifier hs-type">A.LitRat</span></a></span><span>    </span><span id="local-6989586621679472440"><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621679472440"><span class="hs-identifier hs-var">_r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Literal
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Rational literals are not yet implemented&quot;</span></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-comment">-- | Translate an AST identifier into the corresponding IR primitive, if any.</span><span>
</span><span id="line-231"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-type">lowerPrim</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Expr"><span class="hs-identifier hs-type">A.Expr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="IR.IR.html#Primitive"><span class="hs-identifier hs-type">I.Primitive</span></a></span><span>
</span><span id="line-232"></span><span id="lowerPrim"><span class="annot"><span class="annottext">lowerPrim :: Expr -&gt; Maybe Primitive
</span><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var hs-var">lowerPrim</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;new&quot;</span></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#New"><span class="hs-identifier hs-var">I.New</span></a></span><span>
</span><span id="line-233"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;deref&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Deref"><span class="hs-identifier hs-var">I.Deref</span></a></span><span>
</span><span id="line-234"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;now&quot;</span></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Now"><span class="hs-identifier hs-var">I.Now</span></a></span><span>
</span><span id="line-235"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;+&quot;</span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimAdd"><span class="hs-identifier hs-var">I.PrimAdd</span></a></span><span>
</span><span id="line-236"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;-&quot;</span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimSub"><span class="hs-identifier hs-var">I.PrimSub</span></a></span><span>
</span><span id="line-237"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;*&quot;</span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimMul"><span class="hs-identifier hs-var">I.PrimMul</span></a></span><span>
</span><span id="line-238"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;/&quot;</span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimDiv"><span class="hs-identifier hs-var">I.PrimDiv</span></a></span><span>
</span><span id="line-239"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;%&quot;</span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimMod"><span class="hs-identifier hs-var">I.PrimMod</span></a></span><span>
</span><span id="line-240"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;==&quot;</span></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimEq"><span class="hs-identifier hs-var">I.PrimEq</span></a></span><span>
</span><span id="line-241"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;!=&quot;</span></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimNeq"><span class="hs-identifier hs-var">I.PrimNeq</span></a></span><span>
</span><span id="line-242"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;&gt;=&quot;</span></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimGe"><span class="hs-identifier hs-var">I.PrimGe</span></a></span><span>
</span><span id="line-243"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;&lt;=&quot;</span></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimLe"><span class="hs-identifier hs-var">I.PrimLe</span></a></span><span>
</span><span id="line-244"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;&gt;&quot;</span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimGt"><span class="hs-identifier hs-var">I.PrimGt</span></a></span><span>
</span><span id="line-245"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#Id"><span class="hs-identifier hs-type">A.Id</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;&lt;&quot;</span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; Maybe Primitive
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Primitive -&gt; Maybe Primitive) -&gt; Primitive -&gt; Maybe Primitive
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimLt"><span class="hs-identifier hs-var">I.PrimLt</span></a></span><span>
</span><span id="line-246"></span><span class="annot"><a href="IR.LowerAst.html#lowerPrim"><span class="hs-identifier hs-var">lowerPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Expr
</span><span class="hs-identifier">_</span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Primitive
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-comment">-- | Extract an optional identifier from an Ast pattern.</span><span>
</span><span id="line-249"></span><span class="annot"><a href="IR.LowerAst.html#lowerPatName"><span class="hs-identifier hs-type">lowerPatName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Pat"><span class="hs-identifier hs-type">A.Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span>
</span><span id="line-250"></span><span id="lowerPatName"><span class="annot"><span class="annottext">lowerPatName :: Pat -&gt; Binder
</span><a href="IR.LowerAst.html#lowerPatName"><span class="hs-identifier hs-var hs-var">lowerPatName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatId"><span class="hs-identifier hs-type">A.PatId</span></a></span><span> </span><span id="local-6989586621679472424"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472424"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Binder
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(VarId -&gt; Binder) -&gt; VarId -&gt; Binder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679472424"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-251"></span><span class="annot"><a href="IR.LowerAst.html#lowerPatName"><span class="hs-identifier hs-var">lowerPatName</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="Front.Ast.html#PatWildcard"><span class="hs-identifier hs-var">A.PatWildcard</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Binder
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-252"></span><span class="annot"><a href="IR.LowerAst.html#lowerPatName"><span class="hs-identifier hs-var">lowerPatName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatAnn"><span class="hs-identifier hs-type">A.PatAnn</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679472423"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472423"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; Binder
</span><a href="IR.LowerAst.html#lowerPatName"><span class="hs-identifier hs-var">lowerPatName</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472423"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-253"></span><span class="annot"><a href="IR.LowerAst.html#lowerPatName"><span class="hs-identifier hs-var">lowerPatName</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Binder
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;pattern should be desguared into pattern match&quot;</span></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="hs-comment">-- | Extracts and lowers possible AST type annotation from a binding.</span><span>
</span><span id="line-256"></span><span class="annot"><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-type">lowerPatType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Front.Ast.html#Pat"><span class="hs-identifier hs-type">A.Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-257"></span><span id="lowerPatType"><span class="annot"><span class="annottext">lowerPatType :: Pat -&gt; Type
</span><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var hs-var">lowerPatType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatAs"><span class="hs-identifier hs-type">A.PatAs</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679472422"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472422"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; Type
</span><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var">lowerPatType</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472422"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-258"></span><span class="annot"><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var">lowerPatType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatTup"><span class="hs-identifier hs-type">A.PatTup</span></a></span><span> </span><span id="local-6989586621679472421"><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472421"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Type
forall t. TypeSystem t =&gt; [t] -&gt; t
</span><a href="IR.Types.TypeSystem.html#tuple"><span class="hs-identifier hs-var">I.tuple</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; Type) -&gt; [Type] -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Pat -&gt; Type) -&gt; [Pat] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Pat -&gt; Type
</span><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var">lowerPatType</span></a></span><span> </span><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472421"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-259"></span><span class="hs-comment">-- lowerPatType (A.PatCon _dcon) = error &quot;need to perform DConId lookup&quot;</span><span>
</span><span id="line-260"></span><span class="annot"><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var">lowerPatType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatApp"><span class="hs-identifier hs-type">A.PatApp</span></a></span><span> </span><span id="local-6989586621679472420"><span class="annot"><span class="annottext">[Pat]
</span><a href="#local-6989586621679472420"><span class="hs-identifier hs-var">_ps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Type
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;FIXME: unsure how to lower applicative patterns&quot;</span></span><span>
</span><span id="line-262"></span><span class="annot"><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var">lowerPatType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Front.Ast.html#PatAnn"><span class="hs-identifier hs-type">A.PatAnn</span></a></span><span> </span><span id="local-6989586621679472419"><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472419"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span id="local-6989586621679472418"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472418"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Typ -&gt; Type
</span><a href="IR.LowerAst.html#lowerType"><span class="hs-identifier hs-var">lowerType</span></a></span><span> </span><span class="annot"><span class="annottext">Typ
</span><a href="#local-6989586621679472419"><span class="hs-identifier hs-var">typ</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pat -&gt; Type
</span><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var">lowerPatType</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621679472418"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-263"></span><span class="annot"><a href="IR.LowerAst.html#lowerPatType"><span class="hs-identifier hs-var">lowerPatType</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.Types.Annotated.html#untyped"><span class="hs-identifier hs-var">I.untyped</span></a></span><span>
</span><span id="line-264"></span></pre></body></html>