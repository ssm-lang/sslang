<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- | Intermediate representation (IR) stage of the compiler pipeline.

The IR stage is organized into 4 distinct substages: 'lower', 'ann2Class',
'class2Poly', and 'poly2Flat', delineated by each type system used in the
compiler.
-}</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IR</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Common.Compiler.html"><span class="hs-identifier">Common.Compiler</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Common.Default.html"><span class="hs-identifier">Common.Default</span></a></span><span>                 </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Common.Default.html#Default"><span class="hs-identifier">Default</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Front.Ast.html"><span class="hs-identifier">Front.Ast</span></a></span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="IR.ClassInstantiation.html"><span class="hs-identifier">IR.ClassInstantiation</span></a></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.ClassInstantiation.html#instProgram"><span class="hs-identifier">instProgram</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="IR.DConToFunc.html"><span class="hs-identifier">IR.DConToFunc</span></a></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.DConToFunc.html#dConToFunc"><span class="hs-identifier">dConToFunc</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="IR.ExternToCall.html"><span class="hs-identifier">IR.ExternToCall</span></a></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.ExternToCall.html#externToCall"><span class="hs-identifier">externToCall</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.HM.html"><span class="hs-identifier">IR.HM</span></a></span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.IR.html"><span class="hs-identifier">IR.IR</span></a></span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="IR.InsertRefCounting.html"><span class="hs-identifier">IR.InsertRefCounting</span></a></span><span>           </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.InsertRefCounting.html#insertRefCounting"><span class="hs-identifier">insertRefCounting</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="IR.LambdaLift.html"><span class="hs-identifier">IR.LambdaLift</span></a></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#liftProgramLambdas"><span class="hs-identifier">liftProgramLambdas</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="IR.LowerAst.html"><span class="hs-identifier">IR.LowerAst</span></a></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.LowerAst.html#lowerProgram"><span class="hs-identifier">lowerProgram</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.TypeChecker.html"><span class="hs-identifier">IR.TypeChecker</span></a></span><span>                </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TC</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html"><span class="hs-identifier">IR.Types.Annotated</span></a></span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ann</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.Classes.html"><span class="hs-identifier">IR.Types.Classes</span></a></span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cls</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.Poly.html"><span class="hs-identifier">IR.Types.Poly</span></a></span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Poly</span></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.Console.GetOpt</span></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">ArgDescr</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">OptDescr</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-comment">-- | Operation modes for the IR compiler stage.</span><span>
</span><span id="line-31"></span><span class="hs-keyword">data</span><span> </span><span id="Mode"><span class="annot"><a href="IR.html#Mode"><span class="hs-identifier hs-var">Mode</span></a></span></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Continue"><span class="annot"><a href="IR.html#Continue"><span class="hs-identifier hs-var">Continue</span></a></span></span><span>          </span><span class="hs-comment">-- ^ Compile end-to-end (default).</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DumpIR"><span class="annot"><a href="IR.html#DumpIR"><span class="hs-identifier hs-var">DumpIR</span></a></span></span><span>            </span><span class="hs-comment">-- ^ Print the IR immediately after lowering.</span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DumpIRTyped"><span class="annot"><a href="IR.html#DumpIRTyped"><span class="hs-identifier hs-var">DumpIRTyped</span></a></span></span><span>       </span><span class="hs-comment">-- ^ Print the fully-typed IR after type inference.</span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DumpIRLifted"><span class="annot"><a href="IR.html#DumpIRLifted"><span class="hs-identifier hs-var">DumpIRLifted</span></a></span></span><span>      </span><span class="hs-comment">-- ^ Print the IR after lambda lifting.</span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DumpIRFinal"><span class="annot"><a href="IR.html#DumpIRFinal"><span class="hs-identifier hs-var">DumpIRFinal</span></a></span></span><span>       </span><span class="hs-comment">-- ^ Print the final IR representation before codegen.</span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679474811"><span id="local-6989586621679474813"><span class="annot"><span class="annottext">Mode -&gt; Mode -&gt; Bool
(Mode -&gt; Mode -&gt; Bool) -&gt; (Mode -&gt; Mode -&gt; Bool) -&gt; Eq Mode
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Mode -&gt; Mode -&gt; Bool
$c/= :: Mode -&gt; Mode -&gt; Bool
== :: Mode -&gt; Mode -&gt; Bool
$c== :: Mode -&gt; Mode -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679474804"><span id="local-6989586621679474806"><span id="local-6989586621679474808"><span class="annot"><span class="annottext">Int -&gt; Mode -&gt; ShowS
[Mode] -&gt; ShowS
Mode -&gt; String
(Int -&gt; Mode -&gt; ShowS)
-&gt; (Mode -&gt; String) -&gt; ([Mode] -&gt; ShowS) -&gt; Show Mode
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Mode] -&gt; ShowS
$cshowList :: [Mode] -&gt; ShowS
show :: Mode -&gt; String
$cshow :: Mode -&gt; String
showsPrec :: Int -&gt; Mode -&gt; ShowS
$cshowsPrec :: Int -&gt; Mode -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">data</span><span> </span><span id="TIType"><span class="annot"><a href="IR.html#TIType"><span class="hs-identifier hs-var">TIType</span></a></span></span><span>
</span><span id="line-40"></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="HMOnly"><span class="annot"><a href="IR.html#HMOnly"><span class="hs-identifier hs-var">HMOnly</span></a></span></span><span>             </span><span class="hs-comment">-- ^ Only run HM type inference</span><span>
</span><span id="line-41"></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="TCOnly"><span class="annot"><a href="IR.html#TCOnly"><span class="hs-identifier hs-var">TCOnly</span></a></span></span><span>             </span><span class="hs-comment">-- ^ Only run type checker</span><span>
</span><span id="line-42"></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Both"><span class="annot"><a href="IR.html#Both"><span class="hs-identifier hs-var">Both</span></a></span></span><span>               </span><span class="hs-comment">-- ^ Run both HM type Inference and type checker</span><span>
</span><span id="line-43"></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679474796"><span id="local-6989586621679474798"><span class="annot"><span class="annottext">TIType -&gt; TIType -&gt; Bool
(TIType -&gt; TIType -&gt; Bool)
-&gt; (TIType -&gt; TIType -&gt; Bool) -&gt; Eq TIType
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: TIType -&gt; TIType -&gt; Bool
$c/= :: TIType -&gt; TIType -&gt; Bool
== :: TIType -&gt; TIType -&gt; Bool
$c== :: TIType -&gt; TIType -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679474790"><span id="local-6989586621679474792"><span id="local-6989586621679474794"><span class="annot"><span class="annottext">Int -&gt; TIType -&gt; ShowS
[TIType] -&gt; ShowS
TIType -&gt; String
(Int -&gt; TIType -&gt; ShowS)
-&gt; (TIType -&gt; String) -&gt; ([TIType] -&gt; ShowS) -&gt; Show TIType
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TIType] -&gt; ShowS
$cshowList :: [TIType] -&gt; ShowS
show :: TIType -&gt; String
$cshow :: TIType -&gt; String
showsPrec :: Int -&gt; TIType -&gt; ShowS
$cshowsPrec :: Int -&gt; TIType -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-comment">-- | Compiler options for the IR compiler stage.</span><span>
</span><span id="line-46"></span><span class="hs-keyword">data</span><span> </span><span id="Options"><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-var">Options</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Options"><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-var">Options</span></a></span></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="mode"><span class="annot"><span class="annottext">Options -&gt; Mode
</span><a href="IR.html#mode"><span class="hs-identifier hs-var hs-var">mode</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.html#Mode"><span class="hs-identifier hs-type">Mode</span></a></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="tiType"><span class="annot"><span class="annottext">Options -&gt; TIType
</span><a href="IR.html#tiType"><span class="hs-identifier hs-var hs-var">tiType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.html#TIType"><span class="hs-identifier hs-type">TIType</span></a></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679474783"><span id="local-6989586621679474785"><span class="annot"><span class="annottext">Options -&gt; Options -&gt; Bool
(Options -&gt; Options -&gt; Bool)
-&gt; (Options -&gt; Options -&gt; Bool) -&gt; Eq Options
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Options -&gt; Options -&gt; Bool
$c/= :: Options -&gt; Options -&gt; Bool
== :: Options -&gt; Options -&gt; Bool
$c== :: Options -&gt; Options -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679474777"><span id="local-6989586621679474779"><span id="local-6989586621679474781"><span class="annot"><span class="annottext">Int -&gt; Options -&gt; ShowS
[Options] -&gt; ShowS
Options -&gt; String
(Int -&gt; Options -&gt; ShowS)
-&gt; (Options -&gt; String) -&gt; ([Options] -&gt; ShowS) -&gt; Show Options
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Options] -&gt; ShowS
$cshowList :: [Options] -&gt; ShowS
show :: Options -&gt; String
$cshow :: Options -&gt; String
showsPrec :: Int -&gt; Options -&gt; ShowS
$cshowsPrec :: Int -&gt; Options -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Common.Default.html#Default"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-53"></span><span>  </span><span id="local-6989586621679474774"><span class="annot"><span class="annottext">def :: Options
</span><a href="Common.Default.html#def"><span class="hs-identifier hs-var hs-var hs-var hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options :: Mode -&gt; TIType -&gt; Options
</span><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mode :: Mode
</span><a href="IR.html#mode"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="IR.html#Continue"><span class="hs-identifier hs-var">Continue</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tiType :: TIType
</span><a href="IR.html#tiType"><span class="hs-identifier hs-var">tiType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TIType
</span><a href="IR.html#Both"><span class="hs-identifier hs-var">Both</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-comment">-- | CLI options for the IR compiler stage.</span><span>
</span><span id="line-56"></span><span class="annot"><a href="IR.html#options"><span class="hs-identifier hs-type">options</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">OptDescr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-57"></span><span id="options"><span class="annot"><span class="annottext">options :: [OptDescr (Options -&gt; Options)]
</span><a href="IR.html#options"><span class="hs-identifier hs-var hs-var">options</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
-&gt; [String]
-&gt; ArgDescr (Options -&gt; Options)
-&gt; String
-&gt; OptDescr (Options -&gt; Options)
forall a. String -&gt; [String] -&gt; ArgDescr a -&gt; String -&gt; OptDescr a
</span><span class="hs-identifier hs-var">Option</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-59"></span><span>           </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dump-ir&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-60"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a. a -&gt; ArgDescr a
</span><span class="hs-identifier hs-var">NoArg</span></span><span> </span><span class="annot"><span class="annottext">((Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options))
-&gt; (Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Mode -&gt; Options -&gt; Options
</span><a href="#local-6989586621679474769"><span class="hs-identifier hs-var">setMode</span></a></span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="IR.html#DumpIR"><span class="hs-identifier hs-var">DumpIR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>           </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Print the IR immediately after lowering&quot;</span></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
-&gt; [String]
-&gt; ArgDescr (Options -&gt; Options)
-&gt; String
-&gt; OptDescr (Options -&gt; Options)
forall a. String -&gt; [String] -&gt; ArgDescr a -&gt; String -&gt; OptDescr a
</span><span class="hs-identifier hs-var">Option</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-63"></span><span>           </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dump-ir-typed&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-64"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a. a -&gt; ArgDescr a
</span><span class="hs-identifier hs-var">NoArg</span></span><span> </span><span class="annot"><span class="annottext">((Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options))
-&gt; (Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Mode -&gt; Options -&gt; Options
</span><a href="#local-6989586621679474769"><span class="hs-identifier hs-var">setMode</span></a></span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="IR.html#DumpIRTyped"><span class="hs-identifier hs-var">DumpIRTyped</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>           </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Print the fully-typed IR after type inference&quot;</span></span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
-&gt; [String]
-&gt; ArgDescr (Options -&gt; Options)
-&gt; String
-&gt; OptDescr (Options -&gt; Options)
forall a. String -&gt; [String] -&gt; ArgDescr a -&gt; String -&gt; OptDescr a
</span><span class="hs-identifier hs-var">Option</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-67"></span><span>           </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dump-ir-lifted&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-68"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a. a -&gt; ArgDescr a
</span><span class="hs-identifier hs-var">NoArg</span></span><span> </span><span class="annot"><span class="annottext">((Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options))
-&gt; (Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Mode -&gt; Options -&gt; Options
</span><a href="#local-6989586621679474769"><span class="hs-identifier hs-var">setMode</span></a></span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="IR.html#DumpIRLifted"><span class="hs-identifier hs-var">DumpIRLifted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>           </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Print the IR after lambda lifting&quot;</span></span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
-&gt; [String]
-&gt; ArgDescr (Options -&gt; Options)
-&gt; String
-&gt; OptDescr (Options -&gt; Options)
forall a. String -&gt; [String] -&gt; ArgDescr a -&gt; String -&gt; OptDescr a
</span><span class="hs-identifier hs-var">Option</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-71"></span><span>           </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dump-ir-final&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-72"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a. a -&gt; ArgDescr a
</span><span class="hs-identifier hs-var">NoArg</span></span><span> </span><span class="annot"><span class="annottext">((Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options))
-&gt; (Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Mode -&gt; Options -&gt; Options
</span><a href="#local-6989586621679474769"><span class="hs-identifier hs-var">setMode</span></a></span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="IR.html#DumpIRFinal"><span class="hs-identifier hs-var">DumpIRFinal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>           </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Print the last IR representation before code generation&quot;</span></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
-&gt; [String]
-&gt; ArgDescr (Options -&gt; Options)
-&gt; String
-&gt; OptDescr (Options -&gt; Options)
forall a. String -&gt; [String] -&gt; ArgDescr a -&gt; String -&gt; OptDescr a
</span><span class="hs-identifier hs-var">Option</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;only-hm&quot;</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a. a -&gt; ArgDescr a
</span><span class="hs-identifier hs-var">NoArg</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Options
</span><a href="IR.html#setHM"><span class="hs-identifier hs-var">setHM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Only run HM type inference&quot;</span></span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
-&gt; [String]
-&gt; ArgDescr (Options -&gt; Options)
-&gt; String
-&gt; OptDescr (Options -&gt; Options)
forall a. String -&gt; [String] -&gt; ArgDescr a -&gt; String -&gt; OptDescr a
</span><span class="hs-identifier hs-var">Option</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;only-tc&quot;</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Options -&gt; Options) -&gt; ArgDescr (Options -&gt; Options)
forall a. a -&gt; ArgDescr a
</span><span class="hs-identifier hs-var">NoArg</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Options
</span><a href="IR.html#setTC"><span class="hs-identifier hs-var">setTC</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Only run type checker&quot;</span></span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679474769"><span class="annot"><span class="annottext">setMode :: Mode -&gt; Options -&gt; Options
</span><a href="#local-6989586621679474769"><span class="hs-identifier hs-var hs-var">setMode</span></a></span></span><span> </span><span id="local-6989586621679474766"><span class="annot"><span class="annottext">Mode
</span><a href="#local-6989586621679474766"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679474765"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474765"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474765"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mode :: Mode
</span><a href="IR.html#mode"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="#local-6989586621679474766"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-comment">-- | IR compiler sub-stage, lowering AST to optionally type-annotated IR.</span><span>
</span><span id="line-80"></span><span class="annot"><a href="IR.html#lower"><span class="hs-identifier hs-type">lower</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Front.Ast.html#Program"><span class="hs-identifier hs-type">A.Program</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span id="lower"><span class="annot"><span class="annottext">lower :: Options -&gt; Program -&gt; Pass (Program Type)
</span><a href="IR.html#lower"><span class="hs-identifier hs-var hs-var">lower</span></a></span></span><span> </span><span id="local-6989586621679474763"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474763"><span class="hs-identifier hs-var">opt</span></a></span></span><span> </span><span id="local-6989586621679474762"><span class="annot"><span class="annottext">Program
</span><a href="#local-6989586621679474762"><span class="hs-identifier hs-var">prg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-82"></span><span>  </span><span id="local-6989586621679474761"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474761"><span class="hs-identifier hs-var">ir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Program -&gt; Pass (Program Type)
</span><a href="IR.LowerAst.html#lowerProgram"><span class="hs-identifier hs-var">lowerProgram</span></a></span><span> </span><span class="annot"><span class="annottext">Program
</span><a href="#local-6989586621679474762"><span class="hs-identifier hs-var">prg</span></a></span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Pass () -&gt; Pass ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Options -&gt; Mode
</span><a href="IR.html#mode"><span class="hs-identifier hs-var hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474763"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">Mode -&gt; Mode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="IR.html#DumpIR"><span class="hs-identifier hs-var">DumpIR</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Pass () -&gt; Pass ()) -&gt; Pass () -&gt; Pass ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass ()
forall a x. Pretty a =&gt; a -&gt; Pass x
</span><a href="Common.Compiler.html#dump"><span class="hs-identifier hs-var">dump</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474761"><span class="hs-identifier hs-var">ir</span></a></span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474761"><span class="hs-identifier hs-var">ir</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-comment">{- | IR compiler sub-stage, ultimately producing a fully-typed IR.

Runs HM inference, type checker, or both (default) based on the CLI option.

When both algorithms are run, the program fails type check iff both algorithms
throw an error.
-}</span><span>
</span><span id="line-93"></span><span class="annot"><a href="IR.html#ann2Class"><span class="hs-identifier hs-type">ann2Class</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Cls.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span id="ann2Class"><span class="annot"><span class="annottext">ann2Class :: Options -&gt; Program Type -&gt; Pass (Program Type)
</span><a href="IR.html#ann2Class"><span class="hs-identifier hs-var hs-var">ann2Class</span></a></span></span><span> </span><span id="local-6989586621679474758"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474758"><span class="hs-identifier hs-var">opt</span></a></span></span><span> </span><span id="local-6989586621679474757"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474757"><span class="hs-identifier hs-var">ir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-95"></span><span>  </span><span id="local-6989586621679474756"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474756"><span class="hs-identifier hs-var">irInferred</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679474755"><span class="annot"><span class="annottext">irHMInferred :: Pass (Program Type)
</span><a href="#local-6989586621679474755"><span class="hs-identifier hs-var hs-var">irHMInferred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
</span><a href="IR.HM.html#inferProgram"><span class="hs-identifier hs-var">HM.inferProgram</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474757"><span class="hs-identifier hs-var">ir</span></a></span><span>
</span><span id="line-97"></span><span>        </span><span id="local-6989586621679474753"><span class="annot"><span class="annottext">irTCInferred :: Pass (Program Type)
</span><a href="#local-6989586621679474753"><span class="hs-identifier hs-var hs-var">irTCInferred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
</span><a href="IR.TypeChecker.html#inferProgram"><span class="hs-identifier hs-var">TC.inferProgram</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474757"><span class="hs-identifier hs-var">ir</span></a></span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Options -&gt; TIType
</span><a href="IR.html#tiType"><span class="hs-identifier hs-var hs-var">tiType</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474758"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-99"></span><span>      </span><span class="annot"><span class="annottext">TIType
</span><a href="IR.html#HMOnly"><span class="hs-identifier hs-var">HMOnly</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pass (Program Type)
</span><a href="#local-6989586621679474755"><span class="hs-identifier hs-var">irHMInferred</span></a></span><span>
</span><span id="line-100"></span><span>      </span><span class="annot"><span class="annottext">TIType
</span><a href="IR.html#TCOnly"><span class="hs-identifier hs-var">TCOnly</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pass (Program Type)
</span><a href="#local-6989586621679474753"><span class="hs-identifier hs-var">irTCInferred</span></a></span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><span class="annottext">TIType
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pass (Program Type) -&gt; Either Error (Program Type, [Warning])
forall a. Pass a -&gt; Either Error (a, [Warning])
</span><a href="Common.Compiler.html#runPass"><span class="hs-identifier hs-var">runPass</span></a></span><span> </span><span class="annot"><span class="annottext">Pass (Program Type)
</span><a href="#local-6989586621679474755"><span class="hs-identifier hs-var">irHMInferred</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pass (Program Type) -&gt; Either Error (Program Type, [Warning])
forall a. Pass a -&gt; Either Error (a, [Warning])
</span><a href="Common.Compiler.html#runPass"><span class="hs-identifier hs-var">runPass</span></a></span><span> </span><span class="annot"><span class="annottext">Pass (Program Type)
</span><a href="#local-6989586621679474753"><span class="hs-identifier hs-var">irTCInferred</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-102"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span id="local-6989586621679474750"><span class="annot"><span class="annottext">Error
</span><a href="#local-6989586621679474750"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">Error
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Error -&gt; Pass (Program Type)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">Error
</span><a href="#local-6989586621679474750"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-103"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">(Program Type, [Warning])
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Either Error (Program Type, [Warning])
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pass (Program Type)
</span><a href="#local-6989586621679474755"><span class="hs-identifier hs-var">irHMInferred</span></a></span><span>
</span><span id="line-104"></span><span>        </span><span class="annot"><span class="annottext">(Either Error (Program Type, [Warning]),
 Either Error (Program Type, [Warning]))
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pass (Program Type)
</span><a href="#local-6989586621679474753"><span class="hs-identifier hs-var">irTCInferred</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Pass () -&gt; Pass ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Options -&gt; Mode
</span><a href="IR.html#mode"><span class="hs-identifier hs-var hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474758"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">Mode -&gt; Mode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="IR.html#DumpIRTyped"><span class="hs-identifier hs-var">DumpIRTyped</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Pass () -&gt; Pass ()) -&gt; Pass () -&gt; Pass ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass ()
forall a x. Pretty a =&gt; a -&gt; Pass x
</span><a href="Common.Compiler.html#dump"><span class="hs-identifier hs-var">dump</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474756"><span class="hs-identifier hs-var">irInferred</span></a></span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474756"><span class="hs-identifier hs-var">irInferred</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-comment">-- | IR compiler sub-stage, ultimately instantiating all type classes.</span><span>
</span><span id="line-109"></span><span class="annot"><a href="IR.html#class2Poly"><span class="hs-identifier hs-type">class2Poly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Cls.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Poly.html#Type"><span class="hs-identifier hs-type">Poly.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span id="class2Poly"><span class="annot"><span class="annottext">class2Poly :: Options -&gt; Program Type -&gt; Pass (Program Type)
</span><a href="IR.html#class2Poly"><span class="hs-identifier hs-var hs-var">class2Poly</span></a></span></span><span> </span><span class="annot"><span class="annottext">Options
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
</span><a href="IR.ClassInstantiation.html#instProgram"><span class="hs-identifier hs-var">instProgram</span></a></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- | IR compiler sub-stage, performing source-to-source translations.</span><span>
</span><span id="line-113"></span><span class="annot"><a href="IR.html#poly2Poly"><span class="hs-identifier hs-type">poly2Poly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Poly.html#Type"><span class="hs-identifier hs-type">Poly.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Poly.html#Type"><span class="hs-identifier hs-type">Poly.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span id="poly2Poly"><span class="annot"><span class="annottext">poly2Poly :: Options -&gt; Program Type -&gt; Pass (Program Type)
</span><a href="IR.html#poly2Poly"><span class="hs-identifier hs-var hs-var">poly2Poly</span></a></span></span><span> </span><span id="local-6989586621679474746"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474746"><span class="hs-identifier hs-var">opt</span></a></span></span><span> </span><span id="local-6989586621679474745"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474745"><span class="hs-identifier hs-var">ir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-115"></span><span>  </span><span id="local-6989586621679474744"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474744"><span class="hs-identifier hs-var">ir'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
</span><a href="IR.LambdaLift.html#liftProgramLambdas"><span class="hs-identifier hs-var">liftProgramLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">(Program Type -&gt; Pass (Program Type))
-&gt; Pass (Program Type) -&gt; Pass (Program Type)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
</span><a href="IR.ExternToCall.html#externToCall"><span class="hs-identifier hs-var">externToCall</span></a></span><span> </span><span class="annot"><span class="annottext">(Program Type -&gt; Pass (Program Type))
-&gt; Pass (Program Type) -&gt; Pass (Program Type)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
</span><a href="IR.DConToFunc.html#dConToFunc"><span class="hs-identifier hs-var">dConToFunc</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474745"><span class="hs-identifier hs-var">ir</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Pass () -&gt; Pass ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Options -&gt; Mode
</span><a href="IR.html#mode"><span class="hs-identifier hs-var hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474746"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">Mode -&gt; Mode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="IR.html#DumpIRLifted"><span class="hs-identifier hs-var">DumpIRLifted</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Pass () -&gt; Pass ()) -&gt; Pass () -&gt; Pass ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass ()
forall a x. Pretty a =&gt; a -&gt; Pass x
</span><a href="Common.Compiler.html#dump"><span class="hs-identifier hs-var">dump</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474744"><span class="hs-identifier hs-var">ir'</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span id="local-6989586621679474742"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474742"><span class="hs-identifier hs-var">ir''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
</span><a href="IR.InsertRefCounting.html#insertRefCounting"><span class="hs-identifier hs-var">insertRefCounting</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474744"><span class="hs-identifier hs-var">ir'</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Pass () -&gt; Pass ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Options -&gt; Mode
</span><a href="IR.html#mode"><span class="hs-identifier hs-var hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474746"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">Mode -&gt; Mode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Mode
</span><a href="IR.html#DumpIRFinal"><span class="hs-identifier hs-var">DumpIRFinal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Pass () -&gt; Pass ()) -&gt; Pass () -&gt; Pass ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; Pass ()
forall a x. Pretty a =&gt; a -&gt; Pass x
</span><a href="Common.Compiler.html#dump"><span class="hs-identifier hs-var">dump</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474742"><span class="hs-identifier hs-var">ir''</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><span class="annottext">Program Type -&gt; Pass (Program Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679474742"><span class="hs-identifier hs-var">ir''</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- | IR compiler stage.</span><span>
</span><span id="line-122"></span><span class="annot"><a href="IR.html#run"><span class="hs-identifier hs-type">run</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Front.Ast.html#Program"><span class="hs-identifier hs-type">A.Program</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Poly.html#Type"><span class="hs-identifier hs-type">Poly.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span id="run"><span class="annot"><span class="annottext">run :: Options -&gt; Program -&gt; Pass (Program Type)
</span><a href="IR.html#run"><span class="hs-identifier hs-var hs-var">run</span></a></span></span><span> </span><span id="local-6989586621679474740"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474740"><span class="hs-identifier hs-var">opt</span></a></span></span><span> </span><span id="local-6989586621679474739"><span class="annot"><span class="annottext">Program
</span><a href="#local-6989586621679474739"><span class="hs-identifier hs-var">prg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><span class="annottext">Options -&gt; Program -&gt; Pass (Program Type)
</span><a href="IR.html#lower"><span class="hs-identifier hs-var">lower</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474740"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">Program
</span><a href="#local-6989586621679474739"><span class="hs-identifier hs-var">prg</span></a></span><span> </span><span class="annot"><span class="annottext">Pass (Program Type)
-&gt; (Program Type -&gt; Pass (Program Type)) -&gt; Pass (Program Type)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Program Type -&gt; Pass (Program Type)
</span><a href="IR.html#ann2Class"><span class="hs-identifier hs-var">ann2Class</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474740"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">Pass (Program Type)
-&gt; (Program Type -&gt; Pass (Program Type)) -&gt; Pass (Program Type)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Program Type -&gt; Pass (Program Type)
</span><a href="IR.html#class2Poly"><span class="hs-identifier hs-var">class2Poly</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474740"><span class="hs-identifier hs-var">opt</span></a></span><span> </span><span class="annot"><span class="annottext">Pass (Program Type)
-&gt; (Program Type -&gt; Pass (Program Type)) -&gt; Pass (Program Type)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Program Type -&gt; Pass (Program Type)
</span><a href="IR.html#poly2Poly"><span class="hs-identifier hs-var">poly2Poly</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474740"><span class="hs-identifier hs-var">opt</span></a></span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">-- | Helper function to set ti type to HM-only</span><span>
</span><span id="line-127"></span><span class="annot"><a href="IR.html#setHM"><span class="hs-identifier hs-type">setHM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span>
</span><span id="line-128"></span><span id="setHM"><span class="annot"><span class="annottext">setHM :: Options -&gt; Options
</span><a href="IR.html#setHM"><span class="hs-identifier hs-var hs-var">setHM</span></a></span></span><span> </span><span id="local-6989586621679474738"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474738"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474738"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tiType :: TIType
</span><a href="IR.html#tiType"><span class="hs-identifier hs-var">tiType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TIType
</span><a href="IR.html#HMOnly"><span class="hs-identifier hs-var">HMOnly</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-comment">-- | Helper function to set ti type to TC-only</span><span>
</span><span id="line-131"></span><span class="annot"><a href="IR.html#setTC"><span class="hs-identifier hs-type">setTC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span>
</span><span id="line-132"></span><span id="setTC"><span class="annot"><span class="annottext">setTC :: Options -&gt; Options
</span><a href="IR.html#setTC"><span class="hs-identifier hs-var hs-var">setTC</span></a></span></span><span> </span><span id="local-6989586621679474737"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474737"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679474737"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tiType :: TIType
</span><a href="IR.html#tiType"><span class="hs-identifier hs-var">tiType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TIType
</span><a href="IR.html#TCOnly"><span class="hs-identifier hs-var">TCOnly</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-133"></span></pre></body></html>