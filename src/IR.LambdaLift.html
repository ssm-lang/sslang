<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DerivingVia #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">{- | Lift lambda definitions into the global scope.

This pass is responsible for moving nested lambda definitions into the global
scope and performing necessary callsite adjustments.
-}</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IR.LambdaLift</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-11"></span><span>  </span><span class="annot"><a href="IR.LambdaLift.html#liftProgramLambdas"><span class="hs-identifier">liftProgramLambdas</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Common.Compiler.html"><span class="hs-identifier">Common.Compiler</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Compiler</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Common.Identifiers.html"><span class="hs-identifier">Common.Identifiers</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.IR.html"><span class="hs-identifier">IR.IR</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.html"><span class="hs-identifier">IR.Types</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadError</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Lazy</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><span class="hs-identifier">MonadState</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>  </span><span class="annot"><span class="hs-identifier">StateT</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><span class="hs-identifier">evalStateT</span></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>  </span><span class="annot"><span class="hs-identifier">gets</span></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><span class="hs-identifier">modify</span></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">intersperse</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tails</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(\\)</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">maybeToList</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="annot"><a href="IR.LambdaLift.html#binderVars"><span class="hs-identifier hs-type">binderVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-37"></span><span id="binderVars"><span class="annot"><span class="annottext">binderVars :: [Binder Type] -&gt; [(VarId, Type)]
</span><a href="IR.LambdaLift.html#binderVars"><span class="hs-identifier hs-var hs-var">binderVars</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#BindVar"><span class="hs-identifier hs-type">I.BindVar</span></a></span><span> </span><span id="local-6989586621679505880"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679505880"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679505879"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505879"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679505878"><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505878"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679505880"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505879"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VarId, Type) -&gt; [(VarId, Type)] -&gt; [(VarId, Type)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Binder Type] -&gt; [(VarId, Type)]
</span><a href="IR.LambdaLift.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505878"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-38"></span><span class="annot"><a href="IR.LambdaLift.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679505877"><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505877"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Binder Type] -&gt; [(VarId, Type)]
</span><a href="IR.LambdaLift.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505877"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-39"></span><span class="annot"><a href="IR.LambdaLift.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-comment">-- | Lifting Environment</span><span>
</span><span id="line-43"></span><span class="hs-keyword">data</span><span> </span><span id="LiftCtx"><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-var">LiftCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiftCtx"><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-var">LiftCtx</span></a></span></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="globalScope"><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#globalScope"><span class="hs-identifier hs-var hs-var">globalScope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-comment">-- ^ 'globalScope' is a set containing top-level identifiers. All scopes,</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-comment">-- regardless of depth, have access to these identifiers.</span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="currentScope"><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var hs-var">currentScope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-comment">-- ^ 'currentScope' is a set containing the identifiers available in the</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-comment">-- current scope.</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="currentTrail"><span class="annot"><span class="annottext">LiftCtx -&gt; [Identifier]
</span><a href="IR.LambdaLift.html#currentTrail"><span class="hs-identifier hs-var hs-var">currentTrail</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-comment">-- ^ 'currentTrail' is a list of strings tracing the surrounding scopes in</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-comment">-- terms of language constructs and relevant identifiers. It is used for</span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-comment">-- creating unique identifiers for lifted lambdas.</span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="currentFreeVars"><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#currentFreeVars"><span class="hs-identifier hs-var hs-var">currentFreeVars</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-comment">-- ^ Free variable encounetered during the a descent. These need to be added</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-comment">-- as arguments to lifted closures, and applied at the original site of the</span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-comment">-- closure.</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="lifted"><span class="annot"><span class="annottext">LiftCtx -&gt; [(Binder Type, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var hs-var">lifted</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-comment">-- ^ 'lifted' is a list of lifted lambdas created while descending into a</span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-comment">-- top-level definition.</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="freshCounter"><span class="annot"><span class="annottext">LiftCtx -&gt; Int
</span><a href="IR.LambdaLift.html#freshCounter"><span class="hs-identifier hs-var hs-var">freshCounter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-comment">-- ^ 'anonCount' is a monotonically increasing counter used for creating</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-comment">-- unique identifiers for lifted lambdas.</span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-comment">-- | Lift Monad</span><span>
</span><span id="line-68"></span><span class="hs-keyword">newtype</span><span> </span><span id="LiftFn"><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-var">LiftFn</span></a></span></span><span> </span><span id="local-6989586621679505869"><span class="annot"><a href="#local-6989586621679505869"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiftFn"><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-var">LiftFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679505869"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505864"><span id="local-6989586621679505866"><span class="annot"><span class="annottext">a -&gt; LiftFn b -&gt; LiftFn a
(a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
(forall a b. (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b)
-&gt; (forall a b. a -&gt; LiftFn b -&gt; LiftFn a) -&gt; Functor LiftFn
forall a b. a -&gt; LiftFn b -&gt; LiftFn a
forall a b. (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; LiftFn b -&gt; LiftFn a
$c&lt;$ :: forall a b. a -&gt; LiftFn b -&gt; LiftFn a
fmap :: (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
$cfmap :: forall a b. (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505852"><span id="local-6989586621679505854"><span id="local-6989586621679505856"><span id="local-6989586621679505858"><span id="local-6989586621679505860"><span class="annot"><span class="annottext">Functor LiftFn
a -&gt; LiftFn a
Functor LiftFn
-&gt; (forall a. a -&gt; LiftFn a)
-&gt; (forall a b. LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c)
-&gt; (forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b)
-&gt; (forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn a)
-&gt; Applicative LiftFn
LiftFn a -&gt; LiftFn b -&gt; LiftFn b
LiftFn a -&gt; LiftFn b -&gt; LiftFn a
LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
(a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c
forall a. a -&gt; LiftFn a
forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn a
forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b
forall a b. LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
forall a b c. (a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: LiftFn a -&gt; LiftFn b -&gt; LiftFn a
$c&lt;* :: forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn a
*&gt; :: LiftFn a -&gt; LiftFn b -&gt; LiftFn b
$c*&gt; :: forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b
liftA2 :: (a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c
$cliftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c
&lt;*&gt; :: LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
$c&lt;*&gt; :: forall a b. LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
pure :: a -&gt; LiftFn a
$cpure :: forall a. a -&gt; LiftFn a
$cp1Applicative :: Functor LiftFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505844"><span id="local-6989586621679505846"><span id="local-6989586621679505848"><span class="annot"><span class="annottext">Applicative LiftFn
a -&gt; LiftFn a
Applicative LiftFn
-&gt; (forall a b. LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b)
-&gt; (forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b)
-&gt; (forall a. a -&gt; LiftFn a)
-&gt; Monad LiftFn
LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b
LiftFn a -&gt; LiftFn b -&gt; LiftFn b
forall a. a -&gt; LiftFn a
forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b
forall a b. LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: a -&gt; LiftFn a
$creturn :: forall a. a -&gt; LiftFn a
&gt;&gt; :: LiftFn a -&gt; LiftFn b -&gt; LiftFn b
$c&gt;&gt; :: forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b
&gt;&gt;= :: LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b
$c&gt;&gt;= :: forall a b. LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b
$cp1Monad :: Applicative LiftFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505840"><span class="annot"><span class="annottext">Monad LiftFn
Monad LiftFn -&gt; (forall a. String -&gt; LiftFn a) -&gt; MonadFail LiftFn
String -&gt; LiftFn a
forall a. String -&gt; LiftFn a
forall (m :: * -&gt; *).
Monad m -&gt; (forall a. String -&gt; m a) -&gt; MonadFail m
fail :: String -&gt; LiftFn a
$cfail :: forall a. String -&gt; LiftFn a
$cp1MonadFail :: Monad LiftFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadFail</span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505834"><span id="local-6989586621679505836"><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Common.Compiler.html#Error"><span class="hs-identifier hs-type">Compiler.Error</span></a></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505826"><span id="local-6989586621679505828"><span id="local-6989586621679505830"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">-- | Run a LiftFn computation.</span><span>
</span><span id="line-78"></span><span id="local-6989586621679505951"><span class="annot"><a href="IR.LambdaLift.html#runLiftFn"><span class="hs-identifier hs-type">runLiftFn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679505951"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679505951"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-79"></span><span id="runLiftFn"><span class="annot"><span class="annottext">runLiftFn :: [(Binder Type, Type)] -&gt; LiftFn a -&gt; Pass a
</span><a href="IR.LambdaLift.html#runLiftFn"><span class="hs-identifier hs-var hs-var">runLiftFn</span></a></span></span><span> </span><span id="local-6989586621679505823"><span class="annot"><span class="annottext">[(Binder Type, Type)]
</span><a href="#local-6989586621679505823"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span id="local-6989586621679505822"><span class="annot"><span class="annottext">StateT LiftCtx Pass a
</span><a href="#local-6989586621679505822"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><span class="annottext">StateT LiftCtx Pass a -&gt; LiftCtx -&gt; Pass a
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><span class="annottext">StateT LiftCtx Pass a
</span><a href="#local-6989586621679505822"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="annottext">LiftCtx :: Map VarId Type
-&gt; Map VarId Type
-&gt; [Identifier]
-&gt; Map VarId Type
-&gt; [(Binder Type, Expr Type)]
-&gt; Int
-&gt; LiftCtx
</span><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">globalScope :: Map VarId Type
</span><a href="IR.LambdaLift.html#globalScope"><span class="hs-identifier hs-var">globalScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)] -&gt; Map VarId Type
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679505820"><span class="hs-identifier hs-var">globals'</span></a></span><span>
</span><span id="line-84"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentScope :: Map VarId Type
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var">currentScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentFreeVars :: Map VarId Type
</span><a href="IR.LambdaLift.html#currentFreeVars"><span class="hs-identifier hs-var">currentFreeVars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-86"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentTrail :: [Identifier]
</span><a href="IR.LambdaLift.html#currentTrail"><span class="hs-identifier hs-var">currentTrail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-87"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lifted :: [(Binder Type, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var">lifted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-88"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">freshCounter :: Int
</span><a href="IR.LambdaLift.html#freshCounter"><span class="hs-identifier hs-var">freshCounter</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-89"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-90"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-91"></span><span>  </span><span id="local-6989586621679505820"><span class="annot"><span class="annottext">globals' :: [(VarId, Type)]
</span><a href="#local-6989586621679505820"><span class="hs-identifier hs-var hs-var">globals'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Binder Type, Type) -&gt; Maybe (VarId, Type))
-&gt; [(Binder Type, Type)] -&gt; [(VarId, Type)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">(Binder Type, Type) -&gt; Maybe (VarId, Type)
forall a b. (Binder a, b) -&gt; Maybe (VarId, b)
</span><a href="#local-6989586621679505818"><span class="hs-identifier hs-var">extractBindVar</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Type)]
</span><a href="#local-6989586621679505823"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span id="local-6989586621679505818"><span class="annot"><span class="annottext">extractBindVar :: (Binder a, b) -&gt; Maybe (VarId, b)
</span><a href="#local-6989586621679505818"><span class="hs-identifier hs-var hs-var">extractBindVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder a -&gt; Maybe VarId
forall a. Binder a -&gt; Maybe VarId
</span><a href="IR.IR.html#binderToVar"><span class="hs-identifier hs-var">I.binderToVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679505816"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679505816"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505815"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679505815"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarId, b) -&gt; Maybe (VarId, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679505816"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679505815"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><a href="#local-6989586621679505818"><span class="hs-identifier hs-var">extractBindVar</span></a></span><span> </span><span class="annot"><span class="annottext">(Binder a, b)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (VarId, b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- | Create a string composed of the scope trail and a variable name.</span><span>
</span><span id="line-97"></span><span class="annot"><a href="IR.LambdaLift.html#prependTrail"><span class="hs-identifier hs-type">prependTrail</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span>
</span><span id="line-98"></span><span id="prependTrail"><span class="annot"><span class="annottext">prependTrail :: Identifier -&gt; LiftFn Identifier
</span><a href="IR.LambdaLift.html#prependTrail"><span class="hs-identifier hs-var hs-var">prependTrail</span></a></span></span><span> </span><span id="local-6989586621679505813"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505813"><span class="hs-identifier hs-var">cur</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-99"></span><span>  </span><span id="local-6989586621679505812"><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679505812"><span class="hs-identifier hs-var">curTrail</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; [Identifier]) -&gt; LiftFn [Identifier]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; [Identifier]
</span><a href="IR.LambdaLift.html#currentTrail"><span class="hs-identifier hs-var hs-var">currentTrail</span></a></span><span>
</span><span id="line-100"></span><span>  </span><span class="annot"><span class="annottext">Identifier -&gt; LiftFn Identifier
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; LiftFn Identifier)
-&gt; Identifier -&gt; LiftFn Identifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Identifier] -&gt; Identifier
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Identifier] -&gt; Identifier) -&gt; [Identifier] -&gt; Identifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; [Identifier] -&gt; [Identifier]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">intersperse</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">([Identifier] -&gt; [Identifier]) -&gt; [Identifier] -&gt; [Identifier]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Identifier] -&gt; [Identifier]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([Identifier] -&gt; [Identifier]) -&gt; [Identifier] -&gt; [Identifier]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505813"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; [Identifier] -&gt; [Identifier]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679505812"><span class="hs-identifier hs-var">curTrail</span></a></span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-comment">-- | Construct a fresh variable name for a new lifted lambda.</span><span>
</span><span id="line-104"></span><span class="annot"><a href="IR.LambdaLift.html#getFresh"><span class="hs-identifier hs-type">getFresh</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span>
</span><span id="line-105"></span><span id="getFresh"><span class="annot"><span class="annottext">getFresh :: LiftFn Identifier
</span><a href="IR.LambdaLift.html#getFresh"><span class="hs-identifier hs-var hs-var">getFresh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>  </span><span id="local-6989586621679505809"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679505809"><span class="hs-identifier hs-var">curCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Int) -&gt; LiftFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Int
</span><a href="IR.LambdaLift.html#freshCounter"><span class="hs-identifier hs-var hs-var">freshCounter</span></a></span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679505808"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505808"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505808"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">freshCounter :: Int
</span><a href="IR.LambdaLift.html#freshCounter"><span class="hs-identifier hs-var">freshCounter</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Int
</span><a href="IR.LambdaLift.html#freshCounter"><span class="hs-identifier hs-var hs-var">freshCounter</span></a></span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505808"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="annottext">Identifier -&gt; LiftFn Identifier
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; LiftFn Identifier)
-&gt; Identifier -&gt; LiftFn Identifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;anon&quot;</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; Identifier -&gt; Identifier
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Identifier
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679505809"><span class="hs-identifier hs-var">curCount</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | Update lift environment before entering a new scope (e.g. non-recursive let definition, match arm).</span><span>
</span><span id="line-112"></span><span id="local-6989586621679505936"><span class="annot"><a href="IR.LambdaLift.html#withEnclosingScope"><span class="hs-identifier hs-type">withEnclosingScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679505936"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679505936"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-113"></span><span id="withEnclosingScope"><span class="annot"><span class="annottext">withEnclosingScope :: Maybe Identifier -&gt; [Binder Type] -&gt; LiftFn a -&gt; LiftFn a
</span><a href="IR.LambdaLift.html#withEnclosingScope"><span class="hs-identifier hs-var hs-var">withEnclosingScope</span></a></span></span><span> </span><span id="local-6989586621679505804"><span class="annot"><span class="annottext">Maybe Identifier
</span><a href="#local-6989586621679505804"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binder Type] -&gt; [(VarId, Type)]
</span><a href="IR.LambdaLift.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679505803"><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679505803"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679505802"><span class="annot"><span class="annottext">LiftFn a
</span><a href="#local-6989586621679505802"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679505801"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505801"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505800"><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679505800"><span class="hs-identifier hs-var">trail</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map VarId Type -&gt; [Identifier] -&gt; (Map VarId Type, [Identifier]))
-&gt; LiftFn (Map VarId Type)
-&gt; LiftFn ([Identifier] -&gt; (Map VarId Type, [Identifier]))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Map VarId Type) -&gt; LiftFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var hs-var">currentScope</span></a></span><span> </span><span class="annot"><span class="annottext">LiftFn ([Identifier] -&gt; (Map VarId Type, [Identifier]))
-&gt; LiftFn [Identifier] -&gt; LiftFn (Map VarId Type, [Identifier])
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; [Identifier]) -&gt; LiftFn [Identifier]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; [Identifier]
</span><a href="IR.LambdaLift.html#currentTrail"><span class="hs-identifier hs-var hs-var">currentTrail</span></a></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679505798"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505798"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505798"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-118"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentScope :: Map VarId Type
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var">currentScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)] -&gt; Map VarId Type
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679505803"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId Type -&gt; Map VarId Type -&gt; Map VarId Type
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-operator hs-var">`M.union`</span></span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505801"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-comment">-- Add bindings to inner scope</span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentTrail :: [Identifier]
</span><a href="IR.LambdaLift.html#currentTrail"><span class="hs-identifier hs-var">currentTrail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier -&gt; [Identifier]
forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">maybeToList</span></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
</span><a href="#local-6989586621679505804"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">[Identifier] -&gt; [Identifier] -&gt; [Identifier]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679505800"><span class="hs-identifier hs-var">trail</span></a></span><span> </span><span class="hs-comment">-- Possibly extend trail</span><span>
</span><span id="line-120"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span>  </span><span id="local-6989586621679505796"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679505796"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LiftFn a
</span><a href="#local-6989586621679505802"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679505795"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505795"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505795"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-comment">-- Restore state</span><span>
</span><span id="line-126"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentScope :: Map VarId Type
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var">currentScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505801"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-127"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentTrail :: [Identifier]
</span><a href="IR.LambdaLift.html#currentTrail"><span class="hs-identifier hs-var">currentTrail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679505800"><span class="hs-identifier hs-var">trail</span></a></span><span>
</span><span id="line-128"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; LiftFn a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679505796"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span id="local-6989586621679505902"><span class="annot"><a href="IR.LambdaLift.html#withLiftedScope"><span class="hs-identifier hs-type">withLiftedScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679505902"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679505902"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-133"></span><span id="withLiftedScope"><span class="annot"><span class="annottext">withLiftedScope :: Maybe Identifier
-&gt; [Binder Type] -&gt; LiftFn a -&gt; LiftFn (a, [(VarId, Type)])
</span><a href="IR.LambdaLift.html#withLiftedScope"><span class="hs-identifier hs-var hs-var">withLiftedScope</span></a></span></span><span> </span><span id="local-6989586621679505793"><span class="annot"><span class="annottext">Maybe Identifier
</span><a href="#local-6989586621679505793"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binder Type] -&gt; [(VarId, Type)]
</span><a href="IR.LambdaLift.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679505792"><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679505792"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679505791"><span class="annot"><span class="annottext">LiftFn a
</span><a href="#local-6989586621679505791"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679505790"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505790"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505789"><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679505789"><span class="hs-identifier hs-var">trail</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505788"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505788"><span class="hs-identifier hs-var">free</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map VarId Type
 -&gt; [Identifier]
 -&gt; Map VarId Type
 -&gt; (Map VarId Type, [Identifier], Map VarId Type))
-&gt; LiftFn (Map VarId Type)
-&gt; LiftFn
     ([Identifier]
      -&gt; Map VarId Type
      -&gt; (Map VarId Type, [Identifier], Map VarId Type))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Map VarId Type) -&gt; LiftFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var hs-var">currentScope</span></a></span><span> </span><span class="annot"><span class="annottext">LiftFn
  ([Identifier]
   -&gt; Map VarId Type
   -&gt; (Map VarId Type, [Identifier], Map VarId Type))
-&gt; LiftFn [Identifier]
-&gt; LiftFn
     (Map VarId Type -&gt; (Map VarId Type, [Identifier], Map VarId Type))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; [Identifier]) -&gt; LiftFn [Identifier]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; [Identifier]
</span><a href="IR.LambdaLift.html#currentTrail"><span class="hs-identifier hs-var hs-var">currentTrail</span></a></span><span> </span><span class="annot"><span class="annottext">LiftFn
  (Map VarId Type -&gt; (Map VarId Type, [Identifier], Map VarId Type))
-&gt; LiftFn (Map VarId Type)
-&gt; LiftFn (Map VarId Type, [Identifier], Map VarId Type)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Map VarId Type) -&gt; LiftFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#currentFreeVars"><span class="hs-identifier hs-var hs-var">currentFreeVars</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679505787"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505787"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505787"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-138"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentFreeVars :: Map VarId Type
</span><a href="IR.LambdaLift.html#currentFreeVars"><span class="hs-identifier hs-var">currentFreeVars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span> </span><span class="hs-comment">-- Reset accounting of free variables encountered</span><span>
</span><span id="line-139"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentScope :: Map VarId Type
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var">currentScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)] -&gt; Map VarId Type
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679505792"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-comment">-- Clear the currentScope (which will not exist when the inner scope is lifted to the global scope)</span><span>
</span><span id="line-140"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentTrail :: [Identifier]
</span><a href="IR.LambdaLift.html#currentTrail"><span class="hs-identifier hs-var">currentTrail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier -&gt; [Identifier]
forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">maybeToList</span></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
</span><a href="#local-6989586621679505793"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">[Identifier] -&gt; [Identifier] -&gt; [Identifier]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679505789"><span class="hs-identifier hs-var">trail</span></a></span><span> </span><span class="hs-comment">-- Possibly extend trail</span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>  </span><span id="local-6989586621679505786"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679505786"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LiftFn a
</span><a href="#local-6989586621679505791"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span>  </span><span id="local-6989586621679505785"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505785"><span class="hs-identifier hs-var">free'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Map VarId Type) -&gt; LiftFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#currentFreeVars"><span class="hs-identifier hs-var hs-var">currentFreeVars</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679505784"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505784"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505784"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-comment">-- Restore state</span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentFreeVars :: Map VarId Type
</span><a href="IR.LambdaLift.html#currentFreeVars"><span class="hs-identifier hs-var">currentFreeVars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505788"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId Type -&gt; Map VarId Type -&gt; Map VarId Type
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-operator hs-var">`M.union`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505785"><span class="hs-identifier hs-var">free'</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId Type -&gt; Map VarId Type -&gt; Map VarId Type
forall k a b. Ord k =&gt; Map k a -&gt; Map k b -&gt; Map k a
</span><span class="hs-operator hs-var">\\</span></span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505790"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentScope :: Map VarId Type
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var">currentScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505790"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentTrail :: [Identifier]
</span><a href="IR.LambdaLift.html#currentTrail"><span class="hs-identifier hs-var">currentTrail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679505789"><span class="hs-identifier hs-var">trail</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><span class="annottext">(a, [(VarId, Type)]) -&gt; LiftFn (a, [(VarId, Type)])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679505786"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId Type -&gt; [(VarId, Type)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505785"><span class="hs-identifier hs-var">free'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- | Store a new lifted lambda to later add to the program's top level definitions.</span><span>
</span><span id="line-156"></span><span class="annot"><a href="IR.LambdaLift.html#tellLifted"><span class="hs-identifier hs-type">tellLifted</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span id="tellLifted"><span class="annot"><span class="annottext">tellLifted :: Identifier -&gt; Expr Type -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#tellLifted"><span class="hs-identifier hs-var hs-var">tellLifted</span></a></span></span><span> </span><span id="local-6989586621679505781"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505781"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679505780"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505780"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679505779"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505779"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505779"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">lifted :: [(Binder Type, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var">lifted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Binder Type
forall t. VarId -&gt; t -&gt; Binder t
</span><a href="IR.IR.html#BindVar"><span class="hs-identifier hs-var">I.BindVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505781"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (c :: * -&gt; *) a. Carrier c =&gt; c a -&gt; a
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505780"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505780"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Binder Type, Expr Type)
-&gt; [(Binder Type, Expr Type)] -&gt; [(Binder Type, Expr Type)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; [(Binder Type, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var hs-var">lifted</span></a></span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505779"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-comment">-- | Context management for liftifreshNameng top level lambda definitions.</span><span>
</span><span id="line-162"></span><span class="annot"><a href="IR.LambdaLift.html#extractLifted"><span class="hs-identifier hs-type">extractLifted</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-163"></span><span id="extractLifted"><span class="annot"><span class="annottext">extractLifted :: LiftFn [(Binder Type, Expr Type)]
</span><a href="IR.LambdaLift.html#extractLifted"><span class="hs-identifier hs-var hs-var">extractLifted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>  </span><span id="local-6989586621679505775"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505775"><span class="hs-identifier hs-var">lifted'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; [(Binder Type, Expr Type)])
-&gt; LiftFn [(Binder Type, Expr Type)]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; [(Binder Type, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var hs-var">lifted</span></a></span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679505774"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505774"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505774"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">lifted :: [(Binder Type, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var">lifted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; LiftFn [(Binder Type, Expr Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(Binder Type, Expr Type)] -&gt; LiftFn [(Binder Type, Expr Type)])
-&gt; [(Binder Type, Expr Type)] -&gt; LiftFn [(Binder Type, Expr Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; [(Binder Type, Expr Type)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505775"><span class="hs-identifier hs-var">lifted'</span></a></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="hs-comment">{- | Entry-point to lambda lifting.

Maps over top level definitions and lifts out lambda definitions to create a new
Program with the relative order of user definitions preserved.
-}</span><span>
</span><span id="line-174"></span><span class="annot"><a href="IR.LambdaLift.html#liftProgramLambdas"><span class="hs-identifier hs-type">liftProgramLambdas</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span id="liftProgramLambdas"><span class="annot"><span class="annottext">liftProgramLambdas :: Program Type -&gt; Pass (Program Type)
</span><a href="IR.LambdaLift.html#liftProgramLambdas"><span class="hs-identifier hs-var hs-var">liftProgramLambdas</span></a></span></span><span> </span><span id="local-6989586621679505773"><span class="annot"><span class="annottext">p :: Program Type
</span><a href="#local-6989586621679505773"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">programDefs :: forall t. Program t -&gt; [(Binder t, Expr t)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var">I.programDefs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679505770"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505770"><span class="hs-identifier hs-var">defs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Type)]
-&gt; LiftFn (Program Type) -&gt; Pass (Program Type)
forall a. [(Binder Type, Type)] -&gt; LiftFn a -&gt; Pass a
</span><a href="IR.LambdaLift.html#runLiftFn"><span class="hs-identifier hs-var">runLiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Binder Type, Expr Type) -&gt; (Binder Type, Type))
-&gt; [(Binder Type, Expr Type)] -&gt; [(Binder Type, Type)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr Type -&gt; Type)
-&gt; (Binder Type, Expr Type) -&gt; (Binder Type, Type)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (c :: * -&gt; *) a. Carrier c =&gt; c a -&gt; a
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505770"><span class="hs-identifier hs-var">defs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LiftFn (Program Type) -&gt; Pass (Program Type))
-&gt; LiftFn (Program Type) -&gt; Pass (Program Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-176"></span><span>  </span><span id="local-6989586621679505768"><span class="annot"><span class="annottext">[[(Binder Type, Expr Type)]]
</span><a href="#local-6989586621679505768"><span class="hs-identifier hs-var">liftedProgramDefs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Binder Type, Expr Type) -&gt; LiftFn [(Binder Type, Expr Type)])
-&gt; [(Binder Type, Expr Type)]
-&gt; LiftFn [[(Binder Type, Expr Type)]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Binder Type, Expr Type) -&gt; LiftFn [(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505766"><span class="hs-identifier hs-var">liftTop</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505770"><span class="hs-identifier hs-var">defs</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="annottext">Program Type -&gt; LiftFn (Program Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Program Type -&gt; LiftFn (Program Type))
-&gt; Program Type -&gt; LiftFn (Program Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679505773"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">programDefs :: [(Binder Type, Expr Type)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var">I.programDefs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[(Binder Type, Expr Type)]] -&gt; [(Binder Type, Expr Type)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[(Binder Type, Expr Type)]]
</span><a href="#local-6989586621679505768"><span class="hs-identifier hs-var">liftedProgramDefs</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-178"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-179"></span><span>  </span><span id="local-6989586621679505766"><span class="annot"><span class="annottext">liftTop :: (Binder Type, Expr Type) -&gt; LiftFn [(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505766"><span class="hs-identifier hs-var hs-var">liftTop</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505764"><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679505764"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505763"><span class="annot"><span class="annottext">lam :: Expr Type
</span><a href="#local-6989586621679505763"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505761"><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505761"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505760"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505760"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; ([Binder Type], Expr Type)
forall t. Expr t -&gt; ([Binder t], Expr t)
</span><a href="IR.IR.html#unfoldLambda"><span class="hs-identifier hs-var">I.unfoldLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505763"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span id="local-6989586621679505758"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505758"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; [Binder Type] -&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type)
forall a. Maybe Identifier -&gt; [Binder Type] -&gt; LiftFn a -&gt; LiftFn a
</span><a href="IR.LambdaLift.html#withEnclosingScope"><span class="hs-identifier hs-var">withEnclosingScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; Identifier
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">(VarId -&gt; Identifier) -&gt; Maybe VarId -&gt; Maybe Identifier
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Binder Type -&gt; Maybe VarId
forall a. Binder a -&gt; Maybe VarId
</span><a href="IR.IR.html#binderToVar"><span class="hs-identifier hs-var">I.binderToVar</span></a></span><span> </span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679505764"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505761"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505760"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621679505756"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505756"><span class="hs-identifier hs-var">liftedLambdas</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LiftFn [(Binder Type, Expr Type)]
</span><a href="IR.LambdaLift.html#extractLifted"><span class="hs-identifier hs-var">extractLifted</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; LiftFn [(Binder Type, Expr Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(Binder Type, Expr Type)] -&gt; LiftFn [(Binder Type, Expr Type)])
-&gt; [(Binder Type, Expr Type)] -&gt; LiftFn [(Binder Type, Expr Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505756"><span class="hs-identifier hs-var">liftedLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
-&gt; [(Binder Type, Expr Type)] -&gt; [(Binder Type, Expr Type)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679505764"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Binder Type] -&gt; Expr Type -&gt; Expr Type
</span><a href="IR.IR.html#foldLambda"><span class="hs-identifier hs-var">I.foldLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505761"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505758"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><a href="#local-6989586621679505766"><span class="hs-identifier hs-var">liftTop</span></a></span><span> </span><span id="local-6989586621679505754"><span class="annot"><span class="annottext">(Binder Type, Expr Type)
</span><a href="#local-6989586621679505754"><span class="hs-identifier hs-var">topDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; LiftFn [(Binder Type, Expr Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(Binder Type, Expr Type)
</span><a href="#local-6989586621679505754"><span class="hs-identifier hs-var">topDef</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="hs-comment">{- | Lifting logic for IR expressions.

As we traverse over IR expressions, we note down any bindings we encounter so
that we can detect free variables. For lambda definitions, we use free
variables to create a new top-level lifted equivalent and then adjust the
callsite by partially-applying the new lifted lambda with those free variables
from the surrounding the scope.
-}</span><span>
</span><span id="line-195"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-type">liftLambdas</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span id="liftLambdas"><span class="annot"><span class="annottext">liftLambdas :: Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var hs-var">liftLambdas</span></a></span></span><span> </span><span id="local-6989586621679505753"><span class="annot"><span class="annottext">n :: Expr Type
</span><a href="#local-6989586621679505753"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Var"><span class="hs-identifier hs-type">I.Var</span></a></span><span> </span><span id="local-6989586621679505751"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679505751"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679505750"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505750"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>  </span><span id="local-6989586621679505749"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505749"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId Type -&gt; Map VarId Type -&gt; Map VarId Type
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.union</span></span><span> </span><span class="annot"><span class="annottext">(Map VarId Type -&gt; Map VarId Type -&gt; Map VarId Type)
-&gt; LiftFn (Map VarId Type)
-&gt; LiftFn (Map VarId Type -&gt; Map VarId Type)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Map VarId Type) -&gt; LiftFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var hs-var">currentScope</span></a></span><span> </span><span class="annot"><span class="annottext">LiftFn (Map VarId Type -&gt; Map VarId Type)
-&gt; LiftFn (Map VarId Type) -&gt; LiftFn (Map VarId Type)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Map VarId Type) -&gt; LiftFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#globalScope"><span class="hs-identifier hs-var hs-var">globalScope</span></a></span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; LiftFn () -&gt; LiftFn ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679505751"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId Type -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`M.member`</span></span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679505749"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LiftFn () -&gt; LiftFn ()) -&gt; LiftFn () -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-comment">-- @v@ appears free in the current scope; make a note of it so we know to</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-comment">-- apply it when lifting the enclosing closure.</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679505747"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505747"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505747"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">currentFreeVars :: Map VarId Type
</span><a href="IR.LambdaLift.html#currentFreeVars"><span class="hs-identifier hs-var">currentFreeVars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Map VarId Type -&gt; Map VarId Type
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679505751"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505750"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VarId Type -&gt; Map VarId Type)
-&gt; Map VarId Type -&gt; Map VarId Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#currentFreeVars"><span class="hs-identifier hs-var hs-var">currentFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679505747"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-202"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505753"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-203"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#App"><span class="hs-identifier hs-type">I.App</span></a></span><span> </span><span id="local-6989586621679505744"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505744"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621679505743"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505743"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621679505742"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505742"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#App"><span class="hs-identifier hs-var">I.App</span></a></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; Expr Type -&gt; Type -&gt; Expr Type)
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type -&gt; Type -&gt; Expr Type)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505744"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">LiftFn (Expr Type -&gt; Type -&gt; Expr Type)
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Type -&gt; Expr Type)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505743"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">LiftFn (Type -&gt; Expr Type) -&gt; LiftFn Type -&gt; LiftFn (Expr Type)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; LiftFn Type
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505742"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-204"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span id="local-6989586621679505740"><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679505740"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679505739"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679505739"><span class="hs-identifier hs-var">exprs</span></a></span></span><span> </span><span id="local-6989586621679505738"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505738"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679505740"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">([Expr Type] -&gt; Type -&gt; Expr Type)
-&gt; LiftFn [Expr Type] -&gt; LiftFn (Type -&gt; Expr Type)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; [Expr Type] -&gt; LiftFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679505739"><span class="hs-identifier hs-var">exprs</span></a></span><span> </span><span class="annot"><span class="annottext">LiftFn (Type -&gt; Expr Type) -&gt; LiftFn Type -&gt; LiftFn (Expr Type)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; LiftFn Type
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505738"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-205"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span id="local-6989586621679505737"><span class="annot"><span class="annottext">lam :: Expr Type
</span><a href="#local-6989586621679505737"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftFn Identifier
</span><a href="IR.LambdaLift.html#getFresh"><span class="hs-identifier hs-var">getFresh</span></a></span><span> </span><span class="annot"><span class="annottext">LiftFn Identifier
-&gt; (Identifier -&gt; LiftFn (Expr Type)) -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; [Binder Type] -&gt; Identifier -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambda"><span class="hs-identifier hs-var">liftLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505737"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-206"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Let"><span class="hs-identifier hs-type">I.Let</span></a></span><span> </span><span id="local-6989586621679505734"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505734"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621679505733"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505733"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679505732"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505732"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">((Binder Type, Expr Type) -&gt; Bool)
-&gt; [(Binder Type, Expr Type)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Bool
forall t. Expr t -&gt; Bool
</span><a href="#local-6989586621679505730"><span class="hs-identifier hs-var">isLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; Bool)
-&gt; ((Binder Type, Expr Type) -&gt; Expr Type)
-&gt; (Binder Type, Expr Type)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Binder Type, Expr Type) -&gt; Expr Type
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505734"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-comment">-- e.g.,  let f x = ...</span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-comment">--            g y = ...</span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-comment">--        ...</span><span>
</span><span id="line-211"></span><span>      </span><span class="hs-comment">-- Bindings (e.g., f, g) might be recursive and apppear inside definitions.</span><span>
</span><span id="line-212"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679505728"><span class="annot"><span class="annottext">binders :: [Binder Type]
</span><a href="#local-6989586621679505728"><span class="hs-identifier hs-var hs-var">binders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Binder Type, Expr Type) -&gt; Binder Type)
-&gt; [(Binder Type, Expr Type)] -&gt; [Binder Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Binder Type, Expr Type) -&gt; Binder Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505734"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-213"></span><span>      </span><span id="local-6989586621679505727"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505727"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
-&gt; ((Binder Type, Expr Type) -&gt; LiftFn (Binder Type, Expr Type))
-&gt; LiftFn [(Binder Type, Expr Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505734"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">(((Binder Type, Expr Type) -&gt; LiftFn (Binder Type, Expr Type))
 -&gt; LiftFn [(Binder Type, Expr Type)])
-&gt; ((Binder Type, Expr Type) -&gt; LiftFn (Binder Type, Expr Type))
-&gt; LiftFn [(Binder Type, Expr Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679505726"><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679505726"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505725"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505725"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-214"></span><span>        </span><span id="local-6989586621679505724"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505724"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LiftFn Identifier
</span><a href="IR.LambdaLift.html#getFresh"><span class="hs-identifier hs-var">getFresh</span></a></span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621679505723"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505723"><span class="hs-identifier hs-var">d'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; [Binder Type] -&gt; Identifier -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambda"><span class="hs-identifier hs-var">liftLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505725"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505728"><span class="hs-identifier hs-var">binders</span></a></span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; LiftFn (Expr Type))
-&gt; Identifier -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; (VarId -&gt; Identifier) -&gt; Maybe VarId -&gt; Identifier
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505724"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Identifier
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe VarId -&gt; Identifier) -&gt; Maybe VarId -&gt; Identifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Binder Type -&gt; Maybe VarId
forall a. Binder a -&gt; Maybe VarId
</span><a href="IR.IR.html#_binderId"><span class="hs-identifier hs-var hs-var">I._binderId</span></a></span><span> </span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679505726"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-comment">-- TODO: handle recursive bindings</span><span>
</span><span id="line-217"></span><span>        </span><span class="annot"><span class="annottext">(Binder Type, Expr Type) -&gt; LiftFn (Binder Type, Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679505726"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505723"><span class="hs-identifier hs-var">d'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>      </span><span id="local-6989586621679505720"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505720"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; [Binder Type] -&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type)
forall a. Maybe Identifier -&gt; [Binder Type] -&gt; LiftFn a -&gt; LiftFn a
</span><a href="IR.LambdaLift.html#withEnclosingScope"><span class="hs-identifier hs-var">withEnclosingScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505728"><span class="hs-identifier hs-var">binders</span></a></span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505733"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-219"></span><span>      </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; Expr Type -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. [(Binder t, Expr t)] -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Let"><span class="hs-identifier hs-var">I.Let</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505727"><span class="hs-identifier hs-var">ds'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505720"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505732"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505734"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>      </span><span class="hs-comment">-- e.g.,  let x = ...</span><span>
</span><span id="line-222"></span><span>      </span><span class="hs-comment">--        ...</span><span>
</span><span id="line-223"></span><span>      </span><span class="hs-comment">-- Binding is not recursive, so x cannot appear in definition.</span><span>
</span><span id="line-224"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505718"><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679505718"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505717"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505717"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; (Binder Type, Expr Type)
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505734"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-225"></span><span>      </span><span id="local-6989586621679505715"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505715"><span class="hs-identifier hs-var">d'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505717"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-226"></span><span>      </span><span id="local-6989586621679505714"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505714"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; [Binder Type] -&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type)
forall a. Maybe Identifier -&gt; [Binder Type] -&gt; LiftFn a -&gt; LiftFn a
</span><a href="IR.LambdaLift.html#withEnclosingScope"><span class="hs-identifier hs-var">withEnclosingScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679505718"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505733"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-227"></span><span>      </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; Expr Type -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. [(Binder t, Expr t)] -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Let"><span class="hs-identifier hs-var">I.Let</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679505718"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505715"><span class="hs-identifier hs-var">d'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505714"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505732"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; LiftFn (Expr Type)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; LiftFn (Expr Type)) -&gt; String -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Let expressions should only bind a list of values, or a single non-value &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679505734"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-229"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-230"></span><span>  </span><span id="local-6989586621679505730"><span class="annot"><span class="annottext">isLambda :: Expr t -&gt; Bool
</span><a href="#local-6989586621679505730"><span class="hs-identifier hs-var hs-var">isLambda</span></a></span></span><span> </span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><a href="#local-6989586621679505730"><span class="hs-identifier hs-var">isLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Expr t
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-232"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Match"><span class="hs-identifier hs-type">I.Match</span></a></span><span> </span><span id="local-6989586621679505711"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505711"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679505710"><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679505710"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621679505709"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505709"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-233"></span><span>  </span><span id="local-6989586621679505708"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505708"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505711"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-234"></span><span>  </span><span id="local-6989586621679505707"><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679505707"><span class="hs-identifier hs-var">as'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
-&gt; ((Alt Type, Expr Type) -&gt; LiftFn (Alt Type, Expr Type))
-&gt; LiftFn [(Alt Type, Expr Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679505710"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">(((Alt Type, Expr Type) -&gt; LiftFn (Alt Type, Expr Type))
 -&gt; LiftFn [(Alt Type, Expr Type)])
-&gt; ((Alt Type, Expr Type) -&gt; LiftFn (Alt Type, Expr Type))
-&gt; LiftFn [(Alt Type, Expr Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679505706"><span class="annot"><span class="annottext">Alt Type
</span><a href="#local-6989586621679505706"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505705"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505705"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>    </span><span id="local-6989586621679505704"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505704"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; [Binder Type] -&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type)
forall a. Maybe Identifier -&gt; [Binder Type] -&gt; LiftFn a -&gt; LiftFn a
</span><a href="IR.LambdaLift.html#withEnclosingScope"><span class="hs-identifier hs-var">withEnclosingScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt Type -&gt; [Binder Type]
forall t. Alt t -&gt; [Binder t]
</span><a href="IR.IR.html#altBinders"><span class="hs-identifier hs-var">I.altBinders</span></a></span><span> </span><span class="annot"><span class="annottext">Alt Type
</span><a href="#local-6989586621679505706"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505705"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><span class="annottext">(Alt Type, Expr Type) -&gt; LiftFn (Alt Type, Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt Type
</span><a href="#local-6989586621679505706"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505704"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; Expr Type -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; [(Alt Type, Expr Type)] -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; [(Alt t, Expr t)] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Match"><span class="hs-identifier hs-var">I.Match</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505708"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679505707"><span class="hs-identifier hs-var">as'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505709"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-238"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span id="local-6989586621679505702"><span class="annot"><span class="annottext">lit :: Expr Type
</span><a href="#local-6989586621679505702"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Lit"><span class="hs-identifier hs-type">I.Lit</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505702"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-239"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span id="local-6989586621679505700"><span class="annot"><span class="annottext">dat :: Expr Type
</span><a href="#local-6989586621679505700"><span class="hs-identifier hs-var">dat</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Data"><span class="hs-identifier hs-type">I.Data</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505700"><span class="hs-identifier hs-var">dat</span></a></span><span>
</span><span id="line-240"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span id="local-6989586621679505698"><span class="annot"><span class="annottext">e :: Expr Type
</span><a href="#local-6989586621679505698"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Exception"><span class="hs-identifier hs-type">I.Exception</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505698"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambda"><span class="hs-identifier hs-type">liftLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span id="liftLambda"><span class="annot"><span class="annottext">liftLambda :: Expr Type -&gt; [Binder Type] -&gt; Identifier -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambda"><span class="hs-identifier hs-var hs-var">liftLambda</span></a></span></span><span> </span><span id="local-6989586621679505696"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505696"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621679505695"><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505695"><span class="hs-identifier hs-var">letBinds</span></a></span></span><span> </span><span id="local-6989586621679505694"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505694"><span class="hs-identifier hs-var">letName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505693"><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505693"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505692"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505692"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; ([Binder Type], Expr Type)
forall t. Expr t -&gt; ([Binder t], Expr t)
</span><a href="IR.IR.html#unfoldLambda"><span class="hs-identifier hs-var">I.unfoldLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505696"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span id="local-6989586621679505691"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505691"><span class="hs-identifier hs-var">fullName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; LiftFn Identifier
</span><a href="IR.LambdaLift.html#prependTrail"><span class="hs-identifier hs-var">prependTrail</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505694"><span class="hs-identifier hs-var">letName</span></a></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679505690"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505690"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505689"><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679505689"><span class="hs-identifier hs-var">free</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; [Binder Type]
-&gt; LiftFn (Expr Type)
-&gt; LiftFn (Expr Type, [(VarId, Type)])
forall a.
Maybe Identifier
-&gt; [Binder Type] -&gt; LiftFn a -&gt; LiftFn (a, [(VarId, Type)])
</span><a href="IR.LambdaLift.html#withLiftedScope"><span class="hs-identifier hs-var">withLiftedScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; Maybe Identifier
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505694"><span class="hs-identifier hs-var">letName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505695"><span class="hs-identifier hs-var">letBinds</span></a></span><span> </span><span class="annot"><span class="annottext">[Binder Type] -&gt; [Binder Type] -&gt; [Binder Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505693"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type, [(VarId, Type)]))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, [(VarId, Type)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505692"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-comment">-- Lift lambda body to the top-level</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><span class="annottext">Identifier -&gt; Expr Type -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#tellLifted"><span class="hs-identifier hs-var">tellLifted</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505691"><span class="hs-identifier hs-var">fullName</span></a></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn ()) -&gt; Expr Type -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Binder Type] -&gt; Expr Type -&gt; Expr Type
</span><a href="IR.IR.html#foldLambda"><span class="hs-identifier hs-var">I.foldLambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((VarId, Type) -&gt; Binder Type) -&gt; [(VarId, Type)] -&gt; [Binder Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarId -&gt; Type -&gt; Binder Type) -&gt; (VarId, Type) -&gt; Binder Type
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Binder Type
forall t. VarId -&gt; t -&gt; Binder t
</span><a href="IR.IR.html#BindVar"><span class="hs-identifier hs-var">I.BindVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679505689"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">[Binder Type] -&gt; [Binder Type] -&gt; [Binder Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Binder Type]
</span><a href="#local-6989586621679505693"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505690"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-comment">-- Helper function to prepend arguments to a function type</span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621679505687"><span class="annot"><span class="annottext">prependArrow :: [Type] -&gt; Type -&gt; Type
</span><a href="#local-6989586621679505687"><span class="hs-identifier hs-var hs-var">prependArrow</span></a></span></span><span> </span><span id="local-6989586621679505686"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679505686"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621679505685"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505685"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679505684"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679505684"><span class="hs-identifier hs-var">ats'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505683"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505683"><span class="hs-identifier hs-var">rt'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([Type], Type)
</span><a href="IR.Types.Type.html#unfoldArrow"><span class="hs-identifier hs-var">I.unfoldArrow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505685"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">([Type], Type) -&gt; Type
</span><a href="IR.Types.Type.html#foldArrow"><span class="hs-identifier hs-var">I.foldArrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679505686"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679505684"><span class="hs-identifier hs-var">ats'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505683"><span class="hs-identifier hs-var">rt'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-comment">-- 'tails' of the types of free variables in lambda body</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679505680"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679505680"><span class="hs-identifier hs-var">liftedLamType</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679505679"><span class="annot"><span class="annottext">[[Type]]
</span><a href="#local-6989586621679505679"><span class="hs-identifier hs-var">intermediateTypes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [[Type]]
forall a. [a] -&gt; [[a]]
</span><span class="hs-identifier hs-var">tails</span></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [[Type]]) -&gt; [Type] -&gt; [[Type]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((VarId, Type) -&gt; Type) -&gt; [(VarId, Type)] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VarId, Type) -&gt; Type
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679505689"><span class="hs-identifier hs-var">free</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- Construct arguments to be folded into the call site</span><span>
</span><span id="line-261"></span><span>    </span><span id="local-6989586621679505678"><span class="annot"><span class="annottext">freeActuals :: [(Expr Type, Type)]
</span><a href="#local-6989586621679505678"><span class="hs-identifier hs-var hs-var">freeActuals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VarId, Type) -&gt; [Type] -&gt; (Expr Type, Type))
-&gt; [(VarId, Type)] -&gt; [[Type]] -&gt; [(Expr Type, Type)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679505676"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679505676"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679505675"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505675"><span class="hs-identifier hs-var">t'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679505674"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679505674"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Expr Type
forall t. VarId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Var"><span class="hs-identifier hs-var">I.Var</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679505676"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679505675"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Type -&gt; Type
</span><a href="#local-6989586621679505687"><span class="hs-identifier hs-var">prependArrow</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679505674"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (c :: * -&gt; *) a. Carrier c =&gt; c a -&gt; a
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505696"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679505689"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">[[Type]]
</span><a href="#local-6989586621679505679"><span class="hs-identifier hs-var">intermediateTypes</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-comment">-- Replace lambda with call to lifted top-level lambda applied to all free variables</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; Expr Type -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; [(Expr Type, Type)] -&gt; Expr Type
forall t. Expr t -&gt; [(Expr t, t)] -&gt; Expr t
</span><a href="IR.IR.html#foldApp"><span class="hs-identifier hs-var">I.foldApp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Expr Type
forall t. VarId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Var"><span class="hs-identifier hs-var">I.Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679505691"><span class="hs-identifier hs-var">fullName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Expr Type) -&gt; Type -&gt; Expr Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Type -&gt; Type
</span><a href="#local-6989586621679505687"><span class="hs-identifier hs-var">prependArrow</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679505680"><span class="hs-identifier hs-var">liftedLamType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (c :: * -&gt; *) a. Carrier c =&gt; c a -&gt; a
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679505696"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Expr Type, Type)]
</span><a href="#local-6989586621679505678"><span class="hs-identifier hs-var">freeActuals</span></a></span><span>
</span><span id="line-265"></span></pre></body></html>