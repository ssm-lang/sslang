<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DerivingVia #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-comment">{- | Lift lambda definitions into the global scope.

This pass is responsible for moving nested lambda definitions into the global
scope and performing necessary callsite adjustments.
-}</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IR.LambdaLift</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#liftProgramLambdas"><span class="hs-identifier">liftProgramLambdas</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Common.Compiler.html"><span class="hs-identifier">Common.Compiler</span></a></span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Compiler</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Common.Identifiers.html"><span class="hs-identifier">Common.Identifiers</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.IR.html"><span class="hs-identifier">IR.IR</span></a></span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.html"><span class="hs-identifier">IR.Types</span></a></span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">forM_</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>           </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">MonadError</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Lazy</span></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">MonadState</span></span><span>
</span><span id="line-20"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">StateT</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalStateT</span></span><span>
</span><span id="line-22"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">gets</span></span><span>
</span><span id="line-23"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">modify</span></span><span>
</span><span id="line-24"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span>
</span><span id="line-25"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span>                 </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">first</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">intersperse</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>                     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span>
</span><span id="line-31"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span>
</span><span id="line-32"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-comment">-- | Lifting Environment</span><span>
</span><span id="line-36"></span><span class="hs-keyword">data</span><span> </span><span id="LiftCtx"><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-var">LiftCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiftCtx"><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-var">LiftCtx</span></a></span></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="globalScope"><span class="annot"><span class="annottext">LiftCtx -&gt; Set VarId
</span><a href="IR.LambdaLift.html#globalScope"><span class="hs-identifier hs-var hs-var">globalScope</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-comment">{- ^ 'globalScope' is a set containing top-level identifiers. All scopes,
  regardless of depth, have access to these identifiers.
  -}</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="currentScope"><span class="annot"><span class="annottext">LiftCtx -&gt; Set VarId
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var hs-var">currentScope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-comment">{- ^ 'currentScope' is a set containing the identifiers available in the
  current scope.
  -}</span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="freeTypes"><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var hs-var">freeTypes</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-comment">{- ^ 'freeTypes' maps an identifier for a free variable to its type. -}</span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="lifted"><span class="annot"><span class="annottext">LiftCtx -&gt; [(VarId, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var hs-var">lifted</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-comment">{- ^ 'lifted' is a list of lifted lambdas created while descending into a
  top-level definition.
  -}</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="trail"><span class="annot"><span class="annottext">LiftCtx -&gt; [Identifier]
</span><a href="IR.LambdaLift.html#trail"><span class="hs-identifier hs-var hs-var">trail</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-comment">{- ^ 'trail' is a list of strings tracing the surrounding scopes in terms of
  language constructs and relevant identifiers. It is used for
  creating unique identifiers for lifted lambdas.
  -}</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="anonCount"><span class="annot"><span class="annottext">LiftCtx -&gt; Int
</span><a href="IR.LambdaLift.html#anonCount"><span class="hs-identifier hs-var hs-var">anonCount</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-comment">{- ^ 'anonCount' is a monotonically increasing counter used for creating
  unique identifiers for lifted lambdas.
  -}</span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-comment">-- | Lift Monad</span><span>
</span><span id="line-63"></span><span class="hs-keyword">newtype</span><span> </span><span id="LiftFn"><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-var">LiftFn</span></a></span></span><span> </span><span id="local-6989586621679569644"><span class="annot"><a href="#local-6989586621679569644"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiftFn"><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-var">LiftFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679569644"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679569639"><span id="local-6989586621679569641"><span class="annot"><span class="annottext">a -&gt; LiftFn b -&gt; LiftFn a
(a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
(forall a b. (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b)
-&gt; (forall a b. a -&gt; LiftFn b -&gt; LiftFn a) -&gt; Functor LiftFn
forall a b. a -&gt; LiftFn b -&gt; LiftFn a
forall a b. (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; LiftFn b -&gt; LiftFn a
$c&lt;$ :: forall a b. a -&gt; LiftFn b -&gt; LiftFn a
fmap :: (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
$cfmap :: forall a b. (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span>                      </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679569627"><span id="local-6989586621679569629"><span id="local-6989586621679569631"><span id="local-6989586621679569633"><span id="local-6989586621679569635"><span class="annot"><span class="annottext">Functor LiftFn
a -&gt; LiftFn a
Functor LiftFn
-&gt; (forall a. a -&gt; LiftFn a)
-&gt; (forall a b. LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c)
-&gt; (forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b)
-&gt; (forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn a)
-&gt; Applicative LiftFn
LiftFn a -&gt; LiftFn b -&gt; LiftFn b
LiftFn a -&gt; LiftFn b -&gt; LiftFn a
LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
(a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c
forall a. a -&gt; LiftFn a
forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn a
forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b
forall a b. LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
forall a b c. (a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: LiftFn a -&gt; LiftFn b -&gt; LiftFn a
$c&lt;* :: forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn a
*&gt; :: LiftFn a -&gt; LiftFn b -&gt; LiftFn b
$c*&gt; :: forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b
liftA2 :: (a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c
$cliftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; LiftFn a -&gt; LiftFn b -&gt; LiftFn c
&lt;*&gt; :: LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
$c&lt;*&gt; :: forall a b. LiftFn (a -&gt; b) -&gt; LiftFn a -&gt; LiftFn b
pure :: a -&gt; LiftFn a
$cpure :: forall a. a -&gt; LiftFn a
$cp1Applicative :: Functor LiftFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span>                  </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679569619"><span id="local-6989586621679569621"><span id="local-6989586621679569623"><span class="annot"><span class="annottext">Applicative LiftFn
a -&gt; LiftFn a
Applicative LiftFn
-&gt; (forall a b. LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b)
-&gt; (forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b)
-&gt; (forall a. a -&gt; LiftFn a)
-&gt; Monad LiftFn
LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b
LiftFn a -&gt; LiftFn b -&gt; LiftFn b
forall a. a -&gt; LiftFn a
forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b
forall a b. LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: a -&gt; LiftFn a
$creturn :: forall a. a -&gt; LiftFn a
&gt;&gt; :: LiftFn a -&gt; LiftFn b -&gt; LiftFn b
$c&gt;&gt; :: forall a b. LiftFn a -&gt; LiftFn b -&gt; LiftFn b
&gt;&gt;= :: LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b
$c&gt;&gt;= :: forall a b. LiftFn a -&gt; (a -&gt; LiftFn b) -&gt; LiftFn b
$cp1Monad :: Applicative LiftFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span>                        </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679569615"><span class="annot"><span class="annottext">Monad LiftFn
Monad LiftFn -&gt; (forall a. String -&gt; LiftFn a) -&gt; MonadFail LiftFn
String -&gt; LiftFn a
forall a. String -&gt; LiftFn a
forall (m :: * -&gt; *).
Monad m -&gt; (forall a. String -&gt; m a) -&gt; MonadFail m
fail :: String -&gt; LiftFn a
$cfail :: forall a. String -&gt; LiftFn a
$cp1MonadFail :: Monad LiftFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadFail</span></span></span><span>                    </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679569609"><span id="local-6989586621679569611"><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Common.Compiler.html#Error"><span class="hs-identifier hs-type">Compiler.Error</span></a></span></span></span><span class="hs-special">)</span><span>  </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679569601"><span id="local-6989586621679569603"><span id="local-6989586621679569605"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span></span></span></span><span class="hs-special">)</span><span>         </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-comment">-- | Run a LiftFn computation.</span><span>
</span><span id="line-72"></span><span id="local-6989586621679569710"><span class="annot"><a href="IR.LambdaLift.html#runLiftFn"><span class="hs-identifier hs-type">runLiftFn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679569710"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679569710"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-73"></span><span id="runLiftFn"><span class="annot"><span class="annottext">runLiftFn :: LiftFn a -&gt; Pass a
</span><a href="IR.LambdaLift.html#runLiftFn"><span class="hs-identifier hs-var hs-var">runLiftFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span id="local-6989586621679569598"><span class="annot"><span class="annottext">StateT LiftCtx Pass a
</span><a href="#local-6989586621679569598"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateT LiftCtx Pass a -&gt; LiftCtx -&gt; Pass a
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span>
</span><span id="line-74"></span><span>  </span><span class="annot"><span class="annottext">StateT LiftCtx Pass a
</span><a href="#local-6989586621679569598"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-75"></span><span>  </span><span class="annot"><span class="annottext">LiftCtx :: Set VarId
-&gt; Set VarId
-&gt; Map VarId Type
-&gt; [(VarId, Expr Type)]
-&gt; [Identifier]
-&gt; Int
-&gt; LiftCtx
</span><a href="IR.LambdaLift.html#LiftCtx"><span class="hs-identifier hs-type">LiftCtx</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">globalScope :: Set VarId
</span><a href="IR.LambdaLift.html#globalScope"><span class="hs-identifier hs-var">globalScope</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VarId
forall a. Set a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-76"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentScope :: Set VarId
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var">currentScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VarId
forall a. Set a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-77"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">freeTypes :: Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var">freeTypes</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-78"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lifted :: [(VarId, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var">lifted</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-79"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">trail :: [Identifier]
</span><a href="IR.LambdaLift.html#trail"><span class="hs-identifier hs-var">trail</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-80"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">anonCount :: Int
</span><a href="IR.LambdaLift.html#anonCount"><span class="hs-identifier hs-var">anonCount</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-81"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-comment">-- | Extract top level definition names that compose program's global scope.</span><span>
</span><span id="line-84"></span><span class="annot"><a href="IR.LambdaLift.html#populateGlobalScope"><span class="hs-identifier hs-type">populateGlobalScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span id="populateGlobalScope"><span class="annot"><span class="annottext">populateGlobalScope :: [(VarId, Expr Type)] -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#populateGlobalScope"><span class="hs-identifier hs-var hs-var">populateGlobalScope</span></a></span></span><span> </span><span id="local-6989586621679569594"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679569594"><span class="hs-identifier hs-var">defs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679569593"><span class="annot"><span class="annottext">[VarId]
</span><a href="#local-6989586621679569593"><span class="hs-identifier hs-var">globalNames</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; ([VarId], [Expr Type])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679569594"><span class="hs-identifier hs-var">defs</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569591"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569591"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569591"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">globalScope :: Set VarId
</span><a href="IR.LambdaLift.html#globalScope"><span class="hs-identifier hs-var">globalScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VarId] -&gt; Set VarId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VarId]
</span><a href="#local-6989586621679569593"><span class="hs-identifier hs-var">globalNames</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">-- | Check if an identifier is in the current program scope.</span><span>
</span><span id="line-90"></span><span class="annot"><a href="IR.LambdaLift.html#inCurrentScope"><span class="hs-identifier hs-type">inCurrentScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-91"></span><span id="inCurrentScope"><span class="annot"><span class="annottext">inCurrentScope :: VarId -&gt; LiftFn Bool
</span><a href="IR.LambdaLift.html#inCurrentScope"><span class="hs-identifier hs-var hs-var">inCurrentScope</span></a></span></span><span> </span><span id="local-6989586621679569588"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569588"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Set VarId -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">S.member</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569588"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Set VarId -&gt; Bool) -&gt; LiftFn (Set VarId) -&gt; LiftFn Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Set VarId) -&gt; LiftFn (Set VarId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Set VarId
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var hs-var">currentScope</span></a></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">-- | Add an identifier to the current program scope.</span><span>
</span><span id="line-94"></span><span class="annot"><a href="IR.LambdaLift.html#addCurrentScope"><span class="hs-identifier hs-type">addCurrentScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span id="addCurrentScope"><span class="annot"><span class="annottext">addCurrentScope :: VarId -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#addCurrentScope"><span class="hs-identifier hs-var hs-var">addCurrentScope</span></a></span></span><span> </span><span id="local-6989586621679569584"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569584"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569583"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569583"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569583"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentScope :: Set VarId
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var">currentScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Set VarId -&gt; Set VarId
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569584"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Set VarId -&gt; Set VarId) -&gt; Set VarId -&gt; Set VarId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Set VarId
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var hs-var">currentScope</span></a></span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569583"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-comment">-- | Create a string composed of the scope trail and a variable name.</span><span>
</span><span id="line-99"></span><span class="annot"><a href="IR.LambdaLift.html#prependTrail"><span class="hs-identifier hs-type">prependTrail</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span>
</span><span id="line-100"></span><span id="prependTrail"><span class="annot"><span class="annottext">prependTrail :: Identifier -&gt; LiftFn Identifier
</span><a href="IR.LambdaLift.html#prependTrail"><span class="hs-identifier hs-var hs-var">prependTrail</span></a></span></span><span> </span><span id="local-6989586621679569580"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569580"><span class="hs-identifier hs-var">cur</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621679569579"><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679569579"><span class="hs-identifier hs-var">curTrail</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; [Identifier]) -&gt; LiftFn [Identifier]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; [Identifier]
</span><a href="IR.LambdaLift.html#trail"><span class="hs-identifier hs-var hs-var">trail</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="annot"><span class="annottext">Identifier -&gt; LiftFn Identifier
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; LiftFn Identifier)
-&gt; Identifier -&gt; LiftFn Identifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Identifier] -&gt; Identifier
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Identifier] -&gt; Identifier) -&gt; [Identifier] -&gt; Identifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; [Identifier] -&gt; [Identifier]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">intersperse</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">([Identifier] -&gt; [Identifier]) -&gt; [Identifier] -&gt; [Identifier]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Identifier] -&gt; [Identifier]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([Identifier] -&gt; [Identifier]) -&gt; [Identifier] -&gt; [Identifier]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569580"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; [Identifier] -&gt; [Identifier]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679569579"><span class="hs-identifier hs-var">curTrail</span></a></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">-- | Construct a fresh variable name for a new lifted lambda.</span><span>
</span><span id="line-105"></span><span class="annot"><a href="IR.LambdaLift.html#getFresh"><span class="hs-identifier hs-type">getFresh</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span>
</span><span id="line-106"></span><span id="getFresh"><span class="annot"><span class="annottext">getFresh :: LiftFn Identifier
</span><a href="IR.LambdaLift.html#getFresh"><span class="hs-identifier hs-var hs-var">getFresh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621679569576"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679569576"><span class="hs-identifier hs-var">curCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Int) -&gt; LiftFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Int
</span><a href="IR.LambdaLift.html#anonCount"><span class="hs-identifier hs-var hs-var">anonCount</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569575"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569575"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569575"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">anonCount :: Int
</span><a href="IR.LambdaLift.html#anonCount"><span class="hs-identifier hs-var">anonCount</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Int
</span><a href="IR.LambdaLift.html#anonCount"><span class="hs-identifier hs-var hs-var">anonCount</span></a></span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569575"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="annottext">Identifier -&gt; LiftFn Identifier
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; LiftFn Identifier)
-&gt; Identifier -&gt; LiftFn Identifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-string">&quot;anon&quot;</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; Identifier -&gt; Identifier
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Identifier
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679569576"><span class="hs-identifier hs-var">curCount</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | Store a new lifted lambda to later add to the program's top level definitions.</span><span>
</span><span id="line-112"></span><span class="annot"><a href="IR.LambdaLift.html#addLifted"><span class="hs-identifier hs-type">addLifted</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span id="addLifted"><span class="annot"><span class="annottext">addLifted :: Identifier -&gt; Expr Type -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#addLifted"><span class="hs-identifier hs-var hs-var">addLifted</span></a></span></span><span> </span><span id="local-6989586621679569571"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569571"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679569570"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569570"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569569"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569569"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569569"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lifted :: [(VarId, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var">lifted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569571"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569570"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VarId, Expr Type) -&gt; [(VarId, Expr Type)] -&gt; [(VarId, Expr Type)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; [(VarId, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var hs-var">lifted</span></a></span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569569"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- | Register a (free variable, type) mapping for the current program scope.</span><span>
</span><span id="line-117"></span><span class="annot"><a href="IR.LambdaLift.html#addFreeVar"><span class="hs-identifier hs-type">addFreeVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span id="addFreeVar"><span class="annot"><span class="annottext">addFreeVar :: VarId -&gt; Type -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#addFreeVar"><span class="hs-identifier hs-var hs-var">addFreeVar</span></a></span></span><span> </span><span id="local-6989586621679569566"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569566"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679569565"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569565"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569564"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569564"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569564"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">freeTypes :: Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var">freeTypes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Map VarId Type -&gt; Map VarId Type
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569566"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569565"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VarId Type -&gt; Map VarId Type)
-&gt; Map VarId Type -&gt; Map VarId Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var hs-var">freeTypes</span></a></span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569564"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-comment">-- | Update lift environment before entering a new scope (e.g. lambda body, match arm).</span><span>
</span><span id="line-121"></span><span class="annot"><a href="IR.LambdaLift.html#newScope"><span class="hs-identifier hs-type">newScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span id="newScope"><span class="annot"><span class="annottext">newScope :: [VarId] -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#newScope"><span class="hs-identifier hs-var hs-var">newScope</span></a></span></span><span> </span><span id="local-6989586621679569561"><span class="annot"><span class="annottext">[VarId]
</span><a href="#local-6989586621679569561"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569560"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569560"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569560"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentScope :: Set VarId
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var">currentScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VarId -&gt; Set VarId -&gt; Set VarId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.union</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LiftCtx -&gt; Set VarId
</span><a href="IR.LambdaLift.html#globalScope"><span class="hs-identifier hs-var hs-var">globalScope</span></a></span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569560"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VarId] -&gt; Set VarId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VarId]
</span><a href="#local-6989586621679569561"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">freeTypes :: Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var">freeTypes</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-comment">-- | Optionally append to the scope trail.</span><span>
</span><span id="line-129"></span><span class="annot"><a href="IR.LambdaLift.html#maybeTrailAppend"><span class="hs-identifier hs-type">maybeTrailAppend</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span id="maybeTrailAppend"><span class="annot"><span class="annottext">maybeTrailAppend :: Maybe Identifier -&gt; [Identifier] -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#maybeTrailAppend"><span class="hs-identifier hs-var hs-var">maybeTrailAppend</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679569557"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569557"><span class="hs-identifier hs-var">scopeName</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679569556"><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679569556"><span class="hs-identifier hs-var">trail'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679569555"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569555"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569555"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">trail :: [Identifier]
</span><a href="IR.LambdaLift.html#trail"><span class="hs-identifier hs-var">trail</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569557"><span class="hs-identifier hs-var">scopeName</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; [Identifier] -&gt; [Identifier]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679569556"><span class="hs-identifier hs-var">trail'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span class="annot"><a href="IR.LambdaLift.html#maybeTrailAppend"><span class="hs-identifier hs-var">maybeTrailAppend</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; LiftFn ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-comment">-- | Context management for lifting new scopes (restore information after lifting the body).</span><span>
</span><span id="line-135"></span><span class="annot"><a href="IR.LambdaLift.html#descend"><span class="hs-identifier hs-type">descend</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">VarId</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span id="descend"><span class="annot"><span class="annottext">descend :: Maybe Identifier
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
</span><a href="IR.LambdaLift.html#descend"><span class="hs-identifier hs-var hs-var">descend</span></a></span></span><span> </span><span id="local-6989586621679569553"><span class="annot"><span class="annottext">Maybe Identifier
</span><a href="#local-6989586621679569553"><span class="hs-identifier hs-var">scopeName</span></a></span></span><span> </span><span id="local-6989586621679569552"><span class="annot"><span class="annottext">LiftFn (Expr Type)
</span><a href="#local-6989586621679569552"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>  </span><span id="local-6989586621679569551"><span class="annot"><span class="annottext">Set VarId
</span><a href="#local-6989586621679569551"><span class="hs-identifier hs-var">savedScope</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Set VarId) -&gt; LiftFn (Set VarId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Set VarId
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var hs-var">currentScope</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span id="local-6989586621679569550"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569550"><span class="hs-identifier hs-var">savedFreeTypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Map VarId Type) -&gt; LiftFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var hs-var">freeTypes</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span id="local-6989586621679569549"><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679569549"><span class="hs-identifier hs-var">savedTrail</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; [Identifier]) -&gt; LiftFn [Identifier]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; [Identifier]
</span><a href="IR.LambdaLift.html#trail"><span class="hs-identifier hs-var hs-var">trail</span></a></span><span>
</span><span id="line-143"></span><span>  </span><span id="local-6989586621679569548"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569548"><span class="hs-identifier hs-var">liftedBody</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier -&gt; [Identifier] -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#maybeTrailAppend"><span class="hs-identifier hs-var">maybeTrailAppend</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
</span><a href="#local-6989586621679569553"><span class="hs-identifier hs-var">scopeName</span></a></span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679569549"><span class="hs-identifier hs-var">savedTrail</span></a></span><span> </span><span class="annot"><span class="annottext">LiftFn () -&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">LiftFn (Expr Type)
</span><a href="#local-6989586621679569552"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-144"></span><span>  </span><span id="local-6989586621679569547"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569547"><span class="hs-identifier hs-var">freeTypesBody</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; Map VarId Type) -&gt; LiftFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var hs-var">freeTypes</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569546"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569546"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569546"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentScope :: Set VarId
</span><a href="IR.LambdaLift.html#currentScope"><span class="hs-identifier hs-var">currentScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VarId
</span><a href="#local-6989586621679569551"><span class="hs-identifier hs-var">savedScope</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">freeTypes :: Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var">freeTypes</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type -&gt; Map VarId Type -&gt; Map VarId Type
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.union</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map VarId Type -&gt; VarId -&gt; Map VarId Type)
-&gt; Map VarId Type -&gt; Set VarId -&gt; Map VarId Type
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Set b -&gt; a
</span><span class="hs-identifier hs-var">S.foldl</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarId -&gt; Map VarId Type -&gt; Map VarId Type)
-&gt; Map VarId Type -&gt; VarId -&gt; Map VarId Type
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId Type -&gt; Map VarId Type
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.delete</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569547"><span class="hs-identifier hs-var">freeTypesBody</span></a></span><span> </span><span class="annot"><span class="annottext">Set VarId
</span><a href="#local-6989586621679569551"><span class="hs-identifier hs-var">savedScope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>                             </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569550"><span class="hs-identifier hs-var">savedFreeTypes</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">trail :: [Identifier]
</span><a href="IR.LambdaLift.html#trail"><span class="hs-identifier hs-var">trail</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Identifier]
</span><a href="#local-6989586621679569549"><span class="hs-identifier hs-var">savedTrail</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, Map VarId Type) -&gt; LiftFn (Expr Type, Map VarId Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569548"><span class="hs-identifier hs-var">liftedBody</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569547"><span class="hs-identifier hs-var">freeTypesBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">-- | Context management for lifting top level lambda definitions.</span><span>
</span><span id="line-154"></span><span class="annot"><a href="IR.LambdaLift.html#extractLifted"><span class="hs-identifier hs-type">extractLifted</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">VarId</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span id="extractLifted"><span class="annot"><span class="annottext">extractLifted :: LiftFn (Expr Type, Map VarId Type)
-&gt; LiftFn (Expr Type, [(VarId, Expr Type)])
</span><a href="IR.LambdaLift.html#extractLifted"><span class="hs-identifier hs-var hs-var">extractLifted</span></a></span></span><span> </span><span id="local-6989586621679569540"><span class="annot"><span class="annottext">LiftFn (Expr Type, Map VarId Type)
</span><a href="#local-6989586621679569540"><span class="hs-identifier hs-var">bodyDescended</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679569539"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569539"><span class="hs-identifier hs-var">liftedBody</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LiftFn (Expr Type, Map VarId Type)
</span><a href="#local-6989586621679569540"><span class="hs-identifier hs-var">bodyDescended</span></a></span><span> </span><span class="hs-comment">-- A top-level body shouldn't have free variables.</span><span>
</span><span id="line-159"></span><span>  </span><span id="local-6989586621679569538"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679569538"><span class="hs-identifier hs-var">newTopDefs</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LiftCtx -&gt; [(VarId, Expr Type)]) -&gt; LiftFn [(VarId, Expr Type)]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">LiftCtx -&gt; [(VarId, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var hs-var">lifted</span></a></span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569537"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569537"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569537"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lifted :: [(VarId, Expr Type)]
</span><a href="IR.LambdaLift.html#lifted"><span class="hs-identifier hs-var">lifted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, [(VarId, Expr Type)])
-&gt; LiftFn (Expr Type, [(VarId, Expr Type)])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569539"><span class="hs-identifier hs-var">liftedBody</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; [(VarId, Expr Type)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679569538"><span class="hs-identifier hs-var">newTopDefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">{- | Entry-point to lambda lifting.

Maps over top level definitions and lifts out lambda definitions to create a new
Program with the relative order of user definitions preserved.
-}</span><span>
</span><span id="line-168"></span><span class="annot"><a href="IR.LambdaLift.html#liftProgramLambdas"><span class="hs-identifier hs-type">liftProgramLambdas</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span id="liftProgramLambdas"><span class="annot"><span class="annottext">liftProgramLambdas :: Program Type -&gt; Pass (Program Type)
</span><a href="IR.LambdaLift.html#liftProgramLambdas"><span class="hs-identifier hs-var hs-var">liftProgramLambdas</span></a></span></span><span> </span><span id="local-6989586621679569536"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679569536"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiftFn (Program Type) -&gt; Pass (Program Type)
forall a. LiftFn a -&gt; Pass a
</span><a href="IR.LambdaLift.html#runLiftFn"><span class="hs-identifier hs-var">runLiftFn</span></a></span><span> </span><span class="annot"><span class="annottext">(LiftFn (Program Type) -&gt; Pass (Program Type))
-&gt; LiftFn (Program Type) -&gt; Pass (Program Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679569535"><span class="annot"><span class="annottext">defs :: [(VarId, Expr Type)]
</span><a href="#local-6989586621679569535"><span class="hs-identifier hs-var hs-var">defs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; [(VarId, Expr Type)]
forall t. Program t -&gt; [(VarId, Expr t)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var hs-var">I.programDefs</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679569536"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#populateGlobalScope"><span class="hs-identifier hs-var">populateGlobalScope</span></a></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679569535"><span class="hs-identifier hs-var">defs</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span id="local-6989586621679569533"><span class="annot"><span class="annottext">[[(VarId, Expr Type)]]
</span><a href="#local-6989586621679569533"><span class="hs-identifier hs-var">liftedProgramDefs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((VarId, Expr Type) -&gt; LiftFn [(VarId, Expr Type)])
-&gt; [(VarId, Expr Type)] -&gt; LiftFn [[(VarId, Expr Type)]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(VarId, Expr Type) -&gt; LiftFn [(VarId, Expr Type)]
</span><a href="IR.LambdaLift.html#liftLambdasTop"><span class="hs-identifier hs-var">liftLambdasTop</span></a></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679569535"><span class="hs-identifier hs-var">defs</span></a></span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><span class="annottext">Program Type -&gt; LiftFn (Program Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Program Type -&gt; LiftFn (Program Type))
-&gt; Program Type -&gt; LiftFn (Program Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679569536"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">programDefs :: [(VarId, Expr Type)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var">I.programDefs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[[(VarId, Expr Type)]] -&gt; [(VarId, Expr Type)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[(VarId, Expr Type)]]
</span><a href="#local-6989586621679569533"><span class="hs-identifier hs-var">liftedProgramDefs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-comment">-- | Given a top-level definition, lift out any lambda definitions.</span><span>
</span><span id="line-176"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdasTop"><span class="hs-identifier hs-type">liftLambdasTop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-177"></span><span id="liftLambdasTop"><span class="annot"><span class="annottext">liftLambdasTop :: (VarId, Expr Type) -&gt; LiftFn [(VarId, Expr Type)]
</span><a href="IR.LambdaLift.html#liftLambdasTop"><span class="hs-identifier hs-var hs-var">liftLambdasTop</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679569529"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569529"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569528"><span class="annot"><span class="annottext">lam :: Expr Type
</span><a href="#local-6989586621679569528"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679569526"><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679569526"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569525"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569525"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; ([Binder], Expr Type)
forall t. Expr t -&gt; ([Binder], Expr t)
</span><a href="IR.IR.html#unfoldLambda"><span class="hs-identifier hs-var">I.unfoldLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569528"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-179"></span><span>      </span><span id="local-6989586621679569523"><span class="annot"><span class="annottext">vs' :: [(Binder, Type)]
</span><a href="#local-6989586621679569523"><span class="hs-identifier hs-var hs-var">vs'</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Binder] -&gt; [Type] -&gt; [(Binder, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679569526"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [(Binder, Type)]) -&gt; [Type] -&gt; [(Binder, Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Type], Type) -&gt; [Type]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; ([Type], Type)
</span><a href="IR.Types.Type.html#unfoldArrow"><span class="hs-identifier hs-var">I.unfoldArrow</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ([Type], Type)) -&gt; Type -&gt; ([Type], Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall t. Expr t -&gt; t
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569528"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679569520"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569520"><span class="hs-identifier hs-var">liftedBody</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569519"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679569519"><span class="hs-identifier hs-var">newTopDefs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LiftFn (Expr Type, Map VarId Type)
-&gt; LiftFn (Expr Type, [(VarId, Expr Type)])
</span><a href="IR.LambdaLift.html#extractLifted"><span class="hs-identifier hs-var">extractLifted</span></a></span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type, Map VarId Type)
 -&gt; LiftFn (Expr Type, [(VarId, Expr Type)]))
-&gt; LiftFn (Expr Type, Map VarId Type)
-&gt; LiftFn (Expr Type, [(VarId, Expr Type)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
</span><a href="IR.LambdaLift.html#descend"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; Maybe Identifier
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; Maybe Identifier) -&gt; Identifier -&gt; Maybe Identifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Identifier
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569529"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><span class="annottext">[VarId] -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#newScope"><span class="hs-identifier hs-var">newScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binder] -&gt; [VarId]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679569526"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569525"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; LiftFn [(VarId, Expr Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(VarId, Expr Type)] -&gt; LiftFn [(VarId, Expr Type)])
-&gt; [(VarId, Expr Type)] -&gt; LiftFn [(VarId, Expr Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679569519"><span class="hs-identifier hs-var">newTopDefs</span></a></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
-&gt; [(VarId, Expr Type)] -&gt; [(VarId, Expr Type)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569529"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Binder, Type)] -&gt; Expr Type -&gt; Expr Type
</span><a href="IR.IR.html#foldLambda"><span class="hs-identifier hs-var">I.foldLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder, Type)]
</span><a href="#local-6989586621679569523"><span class="hs-identifier hs-var">vs'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569520"><span class="hs-identifier hs-var">liftedBody</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-184"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdasTop"><span class="hs-identifier hs-var">liftLambdasTop</span></a></span><span> </span><span id="local-6989586621679569516"><span class="annot"><span class="annottext">(VarId, Expr Type)
</span><a href="#local-6989586621679569516"><span class="hs-identifier hs-var">topDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; LiftFn [(VarId, Expr Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(VarId, Expr Type)
</span><a href="#local-6989586621679569516"><span class="hs-identifier hs-var">topDef</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">{- | Lifting logic for IR expressions.

As we traverse over IR expressions, we note down any bindings we encounter so
that we can detect free variables. For lambda definitions, we use free
variables to create a new top-level lifted equivalent and then adjust the
callsite by partially-applying the new lifted lambda with those free variables
from the surrounding the scope.
-}</span><span>
</span><span id="line-194"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-type">liftLambdas</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span id="liftLambdas"><span class="annot"><span class="annottext">liftLambdas :: Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var hs-var">liftLambdas</span></a></span></span><span> </span><span id="local-6989586621679569515"><span class="annot"><span class="annottext">n :: Expr Type
</span><a href="#local-6989586621679569515"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Var"><span class="hs-identifier hs-type">I.Var</span></a></span><span> </span><span id="local-6989586621679569513"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569513"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679569512"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569512"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>  </span><span id="local-6989586621679569511"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679569511"><span class="hs-identifier hs-var">inScope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; LiftFn Bool
</span><a href="IR.LambdaLift.html#inCurrentScope"><span class="hs-identifier hs-var">inCurrentScope</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569513"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; LiftFn () -&gt; LiftFn ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679569511"><span class="hs-identifier hs-var">inScope</span></a></span><span> </span><span class="annot"><span class="annottext">(LiftFn () -&gt; LiftFn ()) -&gt; LiftFn () -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#addFreeVar"><span class="hs-identifier hs-var">addFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569513"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569512"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569515"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-199"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#App"><span class="hs-identifier hs-type">I.App</span></a></span><span> </span><span id="local-6989586621679569509"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569509"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621679569508"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569508"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621679569507"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569507"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>  </span><span id="local-6989586621679569506"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569506"><span class="hs-identifier hs-var">liftedE1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569509"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span id="local-6989586621679569505"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569505"><span class="hs-identifier hs-var">liftedE2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569508"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-202"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; Expr Type -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#App"><span class="hs-identifier hs-var">I.App</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569506"><span class="hs-identifier hs-var">liftedE1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569505"><span class="hs-identifier hs-var">liftedE2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569507"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-203"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span id="local-6989586621679569503"><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679569503"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679569502"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679569502"><span class="hs-identifier hs-var">exprs</span></a></span></span><span> </span><span id="local-6989586621679569501"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569501"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>  </span><span id="local-6989586621679569500"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679569500"><span class="hs-identifier hs-var">liftedExprs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; [Expr Type] -&gt; LiftFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679569502"><span class="hs-identifier hs-var">exprs</span></a></span><span>
</span><span id="line-205"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; Expr Type -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679569503"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679569500"><span class="hs-identifier hs-var">liftedExprs</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569501"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-206"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span id="local-6989586621679569499"><span class="annot"><span class="annottext">lam :: Expr Type
</span><a href="#local-6989586621679569499"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679569498"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569498"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679569497"><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679569497"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569496"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569496"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; ([Binder], Expr Type)
forall t. Expr t -&gt; ([Binder], Expr t)
</span><a href="IR.IR.html#unfoldLambda"><span class="hs-identifier hs-var">I.unfoldLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569499"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-208"></span><span>      </span><span id="local-6989586621679569495"><span class="annot"><span class="annottext">vs' :: [(Binder, Type)]
</span><a href="#local-6989586621679569495"><span class="hs-identifier hs-var hs-var">vs'</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Binder] -&gt; [Type] -&gt; [(Binder, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679569497"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [(Binder, Type)]) -&gt; [Type] -&gt; [(Binder, Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Type], Type) -&gt; [Type]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; ([Type], Type)
</span><a href="IR.Types.Type.html#unfoldArrow"><span class="hs-identifier hs-var">I.unfoldArrow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569498"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>  </span><span id="local-6989586621679569494"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569494"><span class="hs-identifier hs-var">lamName</span></a></span></span><span>                       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LiftFn Identifier
</span><a href="IR.LambdaLift.html#getFresh"><span class="hs-identifier hs-var">getFresh</span></a></span><span>
</span><span id="line-210"></span><span>  </span><span id="local-6989586621679569493"><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569493"><span class="hs-identifier hs-var">fullName</span></a></span></span><span>                      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; LiftFn Identifier
</span><a href="IR.LambdaLift.html#prependTrail"><span class="hs-identifier hs-var">prependTrail</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569494"><span class="hs-identifier hs-var">lamName</span></a></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679569492"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569492"><span class="hs-identifier hs-var">liftedLamBody</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569491"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569491"><span class="hs-identifier hs-var">lamFreeTypes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
</span><a href="IR.LambdaLift.html#descend"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; Maybe Identifier
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569494"><span class="hs-identifier hs-var">lamName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><span class="annottext">[VarId] -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#newScope"><span class="hs-identifier hs-var">newScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binder] -&gt; [VarId]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679569497"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569496"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679569490"><span class="annot"><span class="annottext">liftedLam :: Expr Type
</span><a href="#local-6989586621679569490"><span class="hs-identifier hs-var hs-var">liftedLam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Binder, Type)] -&gt; Expr Type -&gt; Expr Type
</span><a href="IR.IR.html#foldLambda"><span class="hs-identifier hs-var">I.foldLambda</span></a></span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((VarId, Type) -&gt; (Binder, Type))
-&gt; [(VarId, Type)] -&gt; [(Binder, Type)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarId -&gt; Binder) -&gt; (VarId, Type) -&gt; (Binder, Type)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Binder
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VarId Type -&gt; [(VarId, Type)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569491"><span class="hs-identifier hs-var">lamFreeTypes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Binder, Type)] -&gt; [(Binder, Type)] -&gt; [(Binder, Type)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(Binder, Type)]
</span><a href="#local-6989586621679569495"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>        </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569492"><span class="hs-identifier hs-var">liftedLamBody</span></a></span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><span class="annottext">Identifier -&gt; Expr Type -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#addLifted"><span class="hs-identifier hs-var">addLifted</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569493"><span class="hs-identifier hs-var">fullName</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569490"><span class="hs-identifier hs-var">liftedLam</span></a></span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; Expr Type -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; (VarId, Type) -&gt; Expr Type)
-&gt; Expr Type -&gt; [(VarId, Type)] -&gt; Expr Type
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; (VarId, Type) -&gt; Expr Type
</span><a href="#local-6989586621679569487"><span class="hs-identifier hs-var">applyFree</span></a></span><span>
</span><span id="line-219"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Expr Type
forall t. VarId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Var"><span class="hs-identifier hs-var">I.Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><a href="#local-6989586621679569493"><span class="hs-identifier hs-var">fullName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall t. Expr t -&gt; t
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569490"><span class="hs-identifier hs-var">liftedLam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VarId Type -&gt; [(VarId, Type)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569491"><span class="hs-identifier hs-var">lamFreeTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-222"></span><span>  </span><span id="local-6989586621679569487"><span class="annot"><span class="annottext">applyFree :: Expr Type -&gt; (VarId, Type) -&gt; Expr Type
</span><a href="#local-6989586621679569487"><span class="hs-identifier hs-var hs-var">applyFree</span></a></span></span><span> </span><span id="local-6989586621679569486"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569486"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679569485"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569485"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569484"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569484"><span class="hs-identifier hs-var">t'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall t. Expr t -&gt; t
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569486"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><a href="IR.Types.Type.html#Arrow"><span class="hs-identifier hs-type">I.Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679569482"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569482"><span class="hs-identifier hs-var">rt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#App"><span class="hs-identifier hs-var">I.App</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569486"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Expr Type
forall t. VarId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Var"><span class="hs-identifier hs-var">I.Var</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679569485"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569484"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569482"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569486"><span class="hs-identifier hs-var">app</span></a></span><span>
</span><span id="line-225"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Let"><span class="hs-identifier hs-type">I.Let</span></a></span><span> </span><span id="local-6989586621679569480"><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679569480"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679569479"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569479"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679569478"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569478"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679569477"><span class="annot"><span class="annottext">vs :: [Binder]
</span><a href="#local-6989586621679569477"><span class="hs-identifier hs-var hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Binder, Expr Type) -&gt; Binder)
-&gt; [(Binder, Expr Type)] -&gt; [Binder]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Binder, Expr Type) -&gt; Binder
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679569480"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><span class="annottext">(VarId -&gt; LiftFn ()) -&gt; [VarId] -&gt; LiftFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#addCurrentScope"><span class="hs-identifier hs-var">addCurrentScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binder] -&gt; [VarId]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679569477"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>  </span><span id="local-6989586621679569475"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679569475"><span class="hs-identifier hs-var">liftedLetBodies</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Binder, Expr Type) -&gt; LiftFn (Expr Type))
-&gt; [(Binder, Expr Type)] -&gt; LiftFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Binder, Expr Type) -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdasInLet"><span class="hs-identifier hs-var">liftLambdasInLet</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679569480"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-229"></span><span>  </span><span id="local-6989586621679569473"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569473"><span class="hs-identifier hs-var">liftedExpr</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569479"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; Expr Type -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)] -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. [(Binder, Expr t)] -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Let"><span class="hs-identifier hs-var">I.Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binder] -&gt; [Expr Type] -&gt; [(Binder, Expr Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679569477"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679569475"><span class="hs-identifier hs-var">liftedLetBodies</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569473"><span class="hs-identifier hs-var">liftedExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569478"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-231"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Match"><span class="hs-identifier hs-type">I.Match</span></a></span><span> </span><span id="local-6989586621679569471"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569471"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679569470"><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679569470"><span class="hs-identifier hs-var">arms</span></a></span></span><span> </span><span id="local-6989586621679569469"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569469"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>  </span><span id="local-6989586621679569468"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569468"><span class="hs-identifier hs-var">liftedMatch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569471"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-233"></span><span>  </span><span id="local-6989586621679569467"><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679569467"><span class="hs-identifier hs-var">liftedArms</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Alt, Expr Type) -&gt; LiftFn (Alt, Expr Type))
-&gt; [(Alt, Expr Type)] -&gt; LiftFn [(Alt, Expr Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Alt, Expr Type) -&gt; LiftFn (Alt, Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdasInArm"><span class="hs-identifier hs-var">liftLambdasInArm</span></a></span><span> </span><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679569470"><span class="hs-identifier hs-var">arms</span></a></span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; LiftFn (Expr Type))
-&gt; Expr Type -&gt; LiftFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; [(Alt, Expr Type)] -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; [(Alt, Expr t)] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Match"><span class="hs-identifier hs-var">I.Match</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569468"><span class="hs-identifier hs-var">liftedMatch</span></a></span><span> </span><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679569467"><span class="hs-identifier hs-var">liftedArms</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679569469"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-235"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span id="local-6989586621679569465"><span class="annot"><span class="annottext">lit :: Expr Type
</span><a href="#local-6989586621679569465"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Lit"><span class="hs-identifier hs-type">I.Lit</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569465"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-236"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span id="local-6989586621679569463"><span class="annot"><span class="annottext">dat :: Expr Type
</span><a href="#local-6989586621679569463"><span class="hs-identifier hs-var">dat</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Data"><span class="hs-identifier hs-type">I.Data</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569463"><span class="hs-identifier hs-var">dat</span></a></span><span>
</span><span id="line-237"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span id="local-6989586621679569461"><span class="annot"><span class="annottext">e :: Expr Type
</span><a href="#local-6989586621679569461"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Exception"><span class="hs-identifier hs-type">I.Exception</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569461"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | Entry point for traversing let bindings.</span><span>
</span><span id="line-240"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdasInLet"><span class="hs-identifier hs-type">liftLambdasInLet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span id="liftLambdasInLet"><span class="annot"><span class="annottext">liftLambdasInLet :: (Binder, Expr Type) -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdasInLet"><span class="hs-identifier hs-var hs-var">liftLambdasInLet</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679569459"><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679569459"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569458"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569458"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679569457"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569457"><span class="hs-identifier hs-var">liftedLetBody</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569456"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569456"><span class="hs-identifier hs-var">bodyFrees</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
</span><a href="IR.LambdaLift.html#descend"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarId -&gt; Identifier) -&gt; Binder -&gt; Maybe Identifier
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Identifier
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Identifier) -&gt; (VarId -&gt; String) -&gt; VarId -&gt; Identifier
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; String
forall i. Identifiable i =&gt; i -&gt; String
</span><a href="Common.Identifiers.html#ident"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679569459"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569458"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569453"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569453"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569453"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">freeTypes :: Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var">freeTypes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569456"><span class="hs-identifier hs-var">bodyFrees</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569457"><span class="hs-identifier hs-var">liftedLetBody</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="hs-comment">-- | Entry point for traversing the arms of match expressions.</span><span>
</span><span id="line-248"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdasInArm"><span class="hs-identifier hs-type">liftLambdasInArm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Alt"><span class="hs-identifier hs-type">I.Alt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.LambdaLift.html#LiftFn"><span class="hs-identifier hs-type">LiftFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Alt"><span class="hs-identifier hs-type">I.Alt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span id="liftLambdasInArm"><span class="annot"><span class="annottext">liftLambdasInArm :: (Alt, Expr Type) -&gt; LiftFn (Alt, Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdasInArm"><span class="hs-identifier hs-var hs-var">liftLambdasInArm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#AltLit"><span class="hs-identifier hs-type">I.AltLit</span></a></span><span> </span><span id="local-6989586621679569451"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679569451"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569450"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569450"><span class="hs-identifier hs-var">arm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679569449"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569449"><span class="hs-identifier hs-var">liftedArm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569448"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569448"><span class="hs-identifier hs-var">armFrees</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
</span><a href="IR.LambdaLift.html#descend"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569450"><span class="hs-identifier hs-var">arm</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569447"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569447"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569447"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">freeTypes :: Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var">freeTypes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569448"><span class="hs-identifier hs-var">armFrees</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><span class="annottext">(Alt, Expr Type) -&gt; LiftFn (Alt, Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Literal -&gt; Alt
</span><a href="IR.IR.html#AltLit"><span class="hs-identifier hs-var">I.AltLit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679569451"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569449"><span class="hs-identifier hs-var">liftedArm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdasInArm"><span class="hs-identifier hs-var">liftLambdasInArm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#AltBinder"><span class="hs-identifier hs-type">I.AltBinder</span></a></span><span> </span><span id="local-6989586621679569445"><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679569445"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569444"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569444"><span class="hs-identifier hs-var">arm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679569443"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569443"><span class="hs-identifier hs-var">liftedArm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569442"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569442"><span class="hs-identifier hs-var">armFrees</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
</span><a href="IR.LambdaLift.html#descend"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">Binder -&gt; (VarId -&gt; LiftFn ()) -&gt; LiftFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679569445"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#addCurrentScope"><span class="hs-identifier hs-var">addCurrentScope</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569444"><span class="hs-identifier hs-var">arm</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569441"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569441"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569441"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">freeTypes :: Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var">freeTypes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569442"><span class="hs-identifier hs-var">armFrees</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><span class="annottext">(Alt, Expr Type) -&gt; LiftFn (Alt, Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder -&gt; Alt
</span><a href="IR.IR.html#AltBinder"><span class="hs-identifier hs-var">I.AltBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679569445"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569443"><span class="hs-identifier hs-var">liftedArm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span class="annot"><a href="IR.LambdaLift.html#liftLambdasInArm"><span class="hs-identifier hs-var">liftLambdasInArm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#AltData"><span class="hs-identifier hs-type">I.AltData</span></a></span><span> </span><span id="local-6989586621679569439"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679569439"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679569438"><span class="annot"><span class="annottext">[Alt]
</span><a href="#local-6989586621679569438"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569437"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569437"><span class="hs-identifier hs-var">arm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679569436"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569436"><span class="hs-identifier hs-var">liftedArm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679569435"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569435"><span class="hs-identifier hs-var">armFrees</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
</span><a href="IR.LambdaLift.html#descend"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Identifier
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type))
-&gt; LiftFn (Expr Type) -&gt; LiftFn (Expr Type, Map VarId Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><span class="annottext">(VarId -&gt; LiftFn ()) -&gt; [VarId] -&gt; LiftFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; LiftFn ()
</span><a href="IR.LambdaLift.html#addCurrentScope"><span class="hs-identifier hs-var">addCurrentScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Alt -&gt; Binder) -&gt; [Alt] -&gt; [VarId]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Alt -&gt; Binder
</span><a href="IR.IR.html#getAltDefault"><span class="hs-identifier hs-var">I.getAltDefault</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt]
</span><a href="#local-6989586621679569438"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">Expr Type -&gt; LiftFn (Expr Type)
</span><a href="IR.LambdaLift.html#liftLambdas"><span class="hs-identifier hs-var">liftLambdas</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569437"><span class="hs-identifier hs-var">arm</span></a></span><span>
</span><span id="line-263"></span><span>  </span><span class="annot"><span class="annottext">(LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((LiftCtx -&gt; LiftCtx) -&gt; LiftFn ())
-&gt; (LiftCtx -&gt; LiftCtx) -&gt; LiftFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679569433"><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569433"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LiftCtx
</span><a href="#local-6989586621679569433"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">freeTypes :: Map VarId Type
</span><a href="IR.LambdaLift.html#freeTypes"><span class="hs-identifier hs-var">freeTypes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679569435"><span class="hs-identifier hs-var">armFrees</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="annottext">(Alt, Expr Type) -&gt; LiftFn (Alt, Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DConId -&gt; [Alt] -&gt; Alt
</span><a href="IR.IR.html#AltData"><span class="hs-identifier hs-var">I.AltData</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679569439"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt]
</span><a href="#local-6989586621679569438"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679569436"><span class="hs-identifier hs-var">liftedArm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span></pre></body></html>