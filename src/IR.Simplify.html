<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DerivingVia #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">{- | Simple Inlining Optimization Pass

Performs preinline and postinline unconditionally.
TODO: Callsite Inline
-}</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IR.Simplify</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-9"></span><span>  </span><span class="annot"><a href="IR.Simplify.html#simplifyProgram"><span class="hs-identifier">simplifyProgram</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Common.Compiler.html"><span class="hs-identifier">Common.Compiler</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Compiler</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadError</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Lazy</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-15"></span><span>  </span><span class="annot"><span class="hs-identifier">MonadState</span></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="annot"><span class="hs-identifier">StateT</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>  </span><span class="annot"><span class="hs-identifier">evalStateT</span></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><span class="hs-identifier">gets</span></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>  </span><span class="annot"><span class="hs-identifier">modify</span></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">second</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Generics</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ma</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IR.IR.html"><span class="hs-identifier">IR.IR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#unfoldLambda"><span class="hs-identifier">unfoldLambda</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.IR.html"><span class="hs-identifier">IR.IR</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">type</span><span> </span><span id="InVar"><span class="annot"><a href="IR.Simplify.html#InVar"><span class="hs-identifier hs-var">InVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-comment">-- | type OutVar = I.VarId -- used by callsite inline</span><span>
</span><span id="line-33"></span><span class="hs-keyword">type</span><span> </span><span id="InExpr"><span class="annot"><a href="IR.Simplify.html#InExpr"><span class="hs-identifier hs-var">InExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">type</span><span> </span><span id="OutExpr"><span class="annot"><a href="IR.Simplify.html#OutExpr"><span class="hs-identifier hs-var">OutExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">type</span><span> </span><span id="InScopeSet"><span class="annot"><a href="IR.Simplify.html#InScopeSet"><span class="hs-identifier hs-var">InScopeSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">type</span><span> </span><span id="Context"><span class="annot"><a href="IR.Simplify.html#Context"><span class="hs-identifier hs-var">Context</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">type</span><span> </span><span id="Subst"><span class="annot"><a href="IR.Simplify.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span> </span><span class="annot"><a href="IR.Simplify.html#SubstRng"><span class="hs-identifier hs-type">SubstRng</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">data</span><span> </span><span id="SubstRng"><span class="annot"><a href="IR.Simplify.html#SubstRng"><span class="hs-identifier hs-var">SubstRng</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DoneEx"><span class="annot"><a href="IR.Simplify.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a></span></span><span> </span><span class="annot"><a href="IR.Simplify.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="SuspEx"><span class="annot"><a href="IR.Simplify.html#SuspEx"><span class="hs-identifier hs-var">SuspEx</span></a></span></span><span> </span><span class="annot"><a href="IR.Simplify.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="annot"><a href="IR.Simplify.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503650"><span id="local-6989586621679503652"><span id="local-6989586621679503654"><span class="annot"><span class="annottext">Int -&gt; SubstRng -&gt; ShowS
[SubstRng] -&gt; ShowS
SubstRng -&gt; String
(Int -&gt; SubstRng -&gt; ShowS)
-&gt; (SubstRng -&gt; String) -&gt; ([SubstRng] -&gt; ShowS) -&gt; Show SubstRng
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SubstRng] -&gt; ShowS
$cshowList :: [SubstRng] -&gt; ShowS
show :: SubstRng -&gt; String
$cshow :: SubstRng -&gt; String
showsPrec :: Int -&gt; SubstRng -&gt; ShowS
$cshowsPrec :: Int -&gt; SubstRng -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-comment">{-  | Occurrence Information for each binding

Dead: Does not appear at all
OnceSafe: Appears once, NOT inside a lambda
MultiSafe: The binder occurs at most ONCE in each of several distinct case branches;
           NONE of these ocurrences is inside a lambda
OnceUnsafe: Binder occurs exactly once, but inside a lambda.
MultiUnsafe: Binder may occur many times, including inside lambdas.
           Variables exported from the module are also makred MultiUnsafe.
LoopBreaker: Chosen to break dependency between mutually recursive defintions.
Never: Never inline; we use this to develop our inliner incrementally.
-}</span><span>
</span><span id="line-59"></span><span class="hs-keyword">data</span><span> </span><span id="OccInfo"><span class="annot"><a href="IR.Simplify.html#OccInfo"><span class="hs-identifier hs-var">OccInfo</span></a></span></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Dead"><span class="annot"><a href="IR.Simplify.html#Dead"><span class="hs-identifier hs-var">Dead</span></a></span></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LoopBreaker"><span class="annot"><a href="IR.Simplify.html#LoopBreaker"><span class="hs-identifier hs-var">LoopBreaker</span></a></span></span><span> </span><span class="hs-comment">-- TBD</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="OnceSafe"><span class="annot"><a href="IR.Simplify.html#OnceSafe"><span class="hs-identifier hs-var">OnceSafe</span></a></span></span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MultiSafe"><span class="annot"><a href="IR.Simplify.html#MultiSafe"><span class="hs-identifier hs-var">MultiSafe</span></a></span></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="OnceUnsafe"><span class="annot"><a href="IR.Simplify.html#OnceUnsafe"><span class="hs-identifier hs-var">OnceUnsafe</span></a></span></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MultiUnsafe"><span class="annot"><a href="IR.Simplify.html#MultiUnsafe"><span class="hs-identifier hs-var">MultiUnsafe</span></a></span></span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Never"><span class="annot"><a href="IR.Simplify.html#Never"><span class="hs-identifier hs-var">Never</span></a></span></span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ConstructorFunc"><span class="annot"><a href="IR.Simplify.html#ConstructorFunc"><span class="hs-identifier hs-var">ConstructorFunc</span></a></span></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503635"><span id="local-6989586621679503637"><span id="local-6989586621679503639"><span class="annot"><span class="annottext">Int -&gt; OccInfo -&gt; ShowS
[OccInfo] -&gt; ShowS
OccInfo -&gt; String
(Int -&gt; OccInfo -&gt; ShowS)
-&gt; (OccInfo -&gt; String) -&gt; ([OccInfo] -&gt; ShowS) -&gt; Show OccInfo
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [OccInfo] -&gt; ShowS
$cshowList :: [OccInfo] -&gt; ShowS
show :: OccInfo -&gt; String
$cshow :: OccInfo -&gt; String
showsPrec :: Int -&gt; OccInfo -&gt; ShowS
$cshowsPrec :: Int -&gt; OccInfo -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">-- | Simplifier Environment</span><span>
</span><span id="line-73"></span><span class="hs-keyword">data</span><span> </span><span id="SimplEnv"><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SimplEnv"><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a></span></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="occInfo"><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="annot"><a href="IR.Simplify.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a></span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-comment">-- ^ 'occInfo' maps an identifier to its occurence category</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="subst"><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId SubstRng
</span><a href="IR.Simplify.html#subst"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span> </span><span class="annot"><a href="IR.Simplify.html#SubstRng"><span class="hs-identifier hs-type">SubstRng</span></a></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-comment">-- ^ 'subst' maps an identifier to its substitution</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="runs"><span class="annot"><span class="annottext">SimplEnv -&gt; Int
</span><a href="IR.Simplify.html#runs"><span class="hs-identifier hs-var hs-var">runs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-comment">-- ^ 'runs' stores how many times the simplifier has run so far</span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="countLambda"><span class="annot"><span class="annottext">SimplEnv -&gt; Int
</span><a href="IR.Simplify.html#countLambda"><span class="hs-identifier hs-var hs-var">countLambda</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-comment">-- ^ 'countLambda' how many lambdas the occurence analyzer is inside</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="countMatch"><span class="annot"><span class="annottext">SimplEnv -&gt; Int
</span><a href="IR.Simplify.html#countMatch"><span class="hs-identifier hs-var hs-var">countMatch</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-comment">-- ^ 'countLambda' how many matches the occurence analyzer is inside</span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503623"><span id="local-6989586621679503625"><span id="local-6989586621679503627"><span class="annot"><span class="annottext">Int -&gt; SimplEnv -&gt; ShowS
[SimplEnv] -&gt; ShowS
SimplEnv -&gt; String
(Int -&gt; SimplEnv -&gt; ShowS)
-&gt; (SimplEnv -&gt; String) -&gt; ([SimplEnv] -&gt; ShowS) -&gt; Show SimplEnv
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SimplEnv] -&gt; ShowS
$cshowList :: [SimplEnv] -&gt; ShowS
show :: SimplEnv -&gt; String
$cshow :: SimplEnv -&gt; String
showsPrec :: Int -&gt; SimplEnv -&gt; ShowS
$cshowsPrec :: Int -&gt; SimplEnv -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">-- | Simplifier Monad</span><span>
</span><span id="line-90"></span><span class="hs-keyword">newtype</span><span> </span><span id="SimplFn"><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-var">SimplFn</span></a></span></span><span> </span><span id="local-6989586621679503622"><span class="annot"><a href="#local-6989586621679503622"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SimplFn"><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-var">SimplFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503622"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503617"><span id="local-6989586621679503619"><span class="annot"><span class="annottext">a -&gt; SimplFn b -&gt; SimplFn a
(a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b
(forall a b. (a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b)
-&gt; (forall a b. a -&gt; SimplFn b -&gt; SimplFn a) -&gt; Functor SimplFn
forall a b. a -&gt; SimplFn b -&gt; SimplFn a
forall a b. (a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; SimplFn b -&gt; SimplFn a
$c&lt;$ :: forall a b. a -&gt; SimplFn b -&gt; SimplFn a
fmap :: (a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b
$cfmap :: forall a b. (a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503605"><span id="local-6989586621679503607"><span id="local-6989586621679503609"><span id="local-6989586621679503611"><span id="local-6989586621679503613"><span class="annot"><span class="annottext">Functor SimplFn
a -&gt; SimplFn a
Functor SimplFn
-&gt; (forall a. a -&gt; SimplFn a)
-&gt; (forall a b. SimplFn (a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; SimplFn a -&gt; SimplFn b -&gt; SimplFn c)
-&gt; (forall a b. SimplFn a -&gt; SimplFn b -&gt; SimplFn b)
-&gt; (forall a b. SimplFn a -&gt; SimplFn b -&gt; SimplFn a)
-&gt; Applicative SimplFn
SimplFn a -&gt; SimplFn b -&gt; SimplFn b
SimplFn a -&gt; SimplFn b -&gt; SimplFn a
SimplFn (a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b
(a -&gt; b -&gt; c) -&gt; SimplFn a -&gt; SimplFn b -&gt; SimplFn c
forall a. a -&gt; SimplFn a
forall a b. SimplFn a -&gt; SimplFn b -&gt; SimplFn a
forall a b. SimplFn a -&gt; SimplFn b -&gt; SimplFn b
forall a b. SimplFn (a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b
forall a b c. (a -&gt; b -&gt; c) -&gt; SimplFn a -&gt; SimplFn b -&gt; SimplFn c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: SimplFn a -&gt; SimplFn b -&gt; SimplFn a
$c&lt;* :: forall a b. SimplFn a -&gt; SimplFn b -&gt; SimplFn a
*&gt; :: SimplFn a -&gt; SimplFn b -&gt; SimplFn b
$c*&gt; :: forall a b. SimplFn a -&gt; SimplFn b -&gt; SimplFn b
liftA2 :: (a -&gt; b -&gt; c) -&gt; SimplFn a -&gt; SimplFn b -&gt; SimplFn c
$cliftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; SimplFn a -&gt; SimplFn b -&gt; SimplFn c
&lt;*&gt; :: SimplFn (a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b
$c&lt;*&gt; :: forall a b. SimplFn (a -&gt; b) -&gt; SimplFn a -&gt; SimplFn b
pure :: a -&gt; SimplFn a
$cpure :: forall a. a -&gt; SimplFn a
$cp1Applicative :: Functor SimplFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503597"><span id="local-6989586621679503599"><span id="local-6989586621679503601"><span class="annot"><span class="annottext">Applicative SimplFn
a -&gt; SimplFn a
Applicative SimplFn
-&gt; (forall a b. SimplFn a -&gt; (a -&gt; SimplFn b) -&gt; SimplFn b)
-&gt; (forall a b. SimplFn a -&gt; SimplFn b -&gt; SimplFn b)
-&gt; (forall a. a -&gt; SimplFn a)
-&gt; Monad SimplFn
SimplFn a -&gt; (a -&gt; SimplFn b) -&gt; SimplFn b
SimplFn a -&gt; SimplFn b -&gt; SimplFn b
forall a. a -&gt; SimplFn a
forall a b. SimplFn a -&gt; SimplFn b -&gt; SimplFn b
forall a b. SimplFn a -&gt; (a -&gt; SimplFn b) -&gt; SimplFn b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: a -&gt; SimplFn a
$creturn :: forall a. a -&gt; SimplFn a
&gt;&gt; :: SimplFn a -&gt; SimplFn b -&gt; SimplFn b
$c&gt;&gt; :: forall a b. SimplFn a -&gt; SimplFn b -&gt; SimplFn b
&gt;&gt;= :: SimplFn a -&gt; (a -&gt; SimplFn b) -&gt; SimplFn b
$c&gt;&gt;= :: forall a b. SimplFn a -&gt; (a -&gt; SimplFn b) -&gt; SimplFn b
$cp1Monad :: Applicative SimplFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503593"><span class="annot"><span class="annottext">Monad SimplFn
Monad SimplFn
-&gt; (forall a. String -&gt; SimplFn a) -&gt; MonadFail SimplFn
String -&gt; SimplFn a
forall a. String -&gt; SimplFn a
forall (m :: * -&gt; *).
Monad m -&gt; (forall a. String -&gt; m a) -&gt; MonadFail m
fail :: String -&gt; SimplFn a
$cfail :: forall a. String -&gt; SimplFn a
$cp1MonadFail :: Monad SimplFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadFail</span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503587"><span id="local-6989586621679503589"><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Common.Compiler.html#Error"><span class="hs-identifier hs-type">Compiler.Error</span></a></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503579"><span id="local-6989586621679503581"><span id="local-6989586621679503583"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | Run a SimplFn computation.</span><span>
</span><span id="line-101"></span><span id="local-6989586621679503724"><span class="annot"><a href="IR.Simplify.html#runSimplFn"><span class="hs-identifier hs-type">runSimplFn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503724"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503724"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-102"></span><span id="runSimplFn"><span class="annot"><span class="annottext">runSimplFn :: SimplFn a -&gt; Pass a
</span><a href="IR.Simplify.html#runSimplFn"><span class="hs-identifier hs-var hs-var">runSimplFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span id="local-6989586621679503576"><span class="annot"><span class="annottext">StateT SimplEnv Pass a
</span><a href="#local-6989586621679503576"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">StateT SimplEnv Pass a -&gt; SimplEnv -&gt; Pass a
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">StateT SimplEnv Pass a
</span><a href="#local-6989586621679503576"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="annottext">SimplEnv :: Map VarId OccInfo
-&gt; Map VarId SubstRng -&gt; Int -&gt; Int -&gt; Int -&gt; SimplEnv
</span><a href="IR.Simplify.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a></span><span>
</span><span id="line-106"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">occInfo :: Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var">occInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">runs :: Int
</span><a href="IR.Simplify.html#runs"><span class="hs-identifier hs-var">runs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">countLambda :: Int
</span><a href="IR.Simplify.html#countLambda"><span class="hs-identifier hs-var">countLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">countMatch :: Int
</span><a href="IR.Simplify.html#countMatch"><span class="hs-identifier hs-var">countMatch</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">subst :: Map VarId SubstRng
</span><a href="IR.Simplify.html#subst"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="hs-comment">-- | Add a binder to occInfo with category Dead by default</span><span>
</span><span id="line-115"></span><span class="annot"><a href="IR.Simplify.html#addOccVar"><span class="hs-identifier hs-type">addOccVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span id="addOccVar"><span class="annot"><span class="annottext">addOccVar :: VarId -&gt; SimplFn ()
</span><a href="IR.Simplify.html#addOccVar"><span class="hs-identifier hs-var hs-var">addOccVar</span></a></span></span><span> </span><span id="local-6989586621679503573"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503573"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>  </span><span id="local-6989586621679503572"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503572"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679503571"><span class="annot"><span class="annottext">m' :: Map VarId OccInfo
</span><a href="#local-6989586621679503571"><span class="hs-identifier hs-var hs-var">m'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId OccInfo -&gt; Maybe OccInfo
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503573"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503572"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="annottext">Maybe OccInfo
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; OccInfo -&gt; Map VarId OccInfo -&gt; Map VarId OccInfo
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503573"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="IR.Simplify.html#Dead"><span class="hs-identifier hs-var">Dead</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503572"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-120"></span><span>        </span><span class="annot"><span class="annottext">Maybe OccInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; OccInfo -&gt; Map VarId OccInfo -&gt; Map VarId OccInfo
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503573"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="IR.Simplify.html#ConstructorFunc"><span class="hs-identifier hs-var">ConstructorFunc</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503572"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><span class="annottext">(SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((SimplEnv -&gt; SimplEnv) -&gt; SimplFn ())
-&gt; (SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679503568"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503568"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503568"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">occInfo :: Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var">occInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503571"><span class="hs-identifier hs-var">m'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-comment">-- | Update occInfo for the binder since we just spotted it</span><span>
</span><span id="line-125"></span><span class="annot"><a href="IR.Simplify.html#updateOccVar"><span class="hs-identifier hs-type">updateOccVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span id="updateOccVar"><span class="annot"><span class="annottext">updateOccVar :: VarId -&gt; SimplFn ()
</span><a href="IR.Simplify.html#updateOccVar"><span class="hs-identifier hs-var hs-var">updateOccVar</span></a></span></span><span> </span><span id="local-6989586621679503566"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503566"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>  </span><span id="local-6989586621679503565"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503565"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-128"></span><span>  </span><span id="local-6989586621679503564"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679503564"><span class="hs-identifier hs-var">insidel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplFn Bool
</span><a href="IR.Simplify.html#insideLambda"><span class="hs-identifier hs-var">insideLambda</span></a></span><span>
</span><span id="line-129"></span><span>  </span><span id="local-6989586621679503562"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679503562"><span class="hs-identifier hs-var">insidem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplFn Bool
</span><a href="IR.Simplify.html#insideMatch"><span class="hs-identifier hs-var">insideMatch</span></a></span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679503560"><span class="annot"><span class="annottext">m' :: Map VarId OccInfo
</span><a href="#local-6989586621679503560"><span class="hs-identifier hs-var hs-var">m'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId OccInfo -&gt; Maybe OccInfo
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503566"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503565"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-131"></span><span>        </span><span class="annot"><span class="annottext">Maybe OccInfo
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-132"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Map VarId OccInfo
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span>
</span><span id="line-133"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UDPATE: We should already know about this binder &quot;</span></span><span>
</span><span id="line-134"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503566"><span class="hs-identifier hs-var">binder</span></a></span><span>
</span><span id="line-135"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; :&quot;</span></span><span>
</span><span id="line-136"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503565"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-137"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;!&quot;</span></span><span>
</span><span id="line-138"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="IR.Simplify.html#Dead"><span class="hs-identifier hs-var">Dead</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-140"></span><span>          </span><span class="hs-comment">-- we only handle OnceSafe currently</span><span>
</span><span id="line-141"></span><span>          </span><span class="hs-comment">-- if we're inside a lambda, binder is NOT OnceSafe (in fact, it's OnceUnsafe...)</span><span>
</span><span id="line-142"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679503564"><span class="hs-identifier hs-var">insidel</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679503562"><span class="hs-identifier hs-var">insidem</span></a></span><span>
</span><span id="line-143"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; OccInfo -&gt; Map VarId OccInfo -&gt; Map VarId OccInfo
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503566"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="IR.Simplify.html#Never"><span class="hs-identifier hs-var">Never</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503565"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-144"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; OccInfo -&gt; Map VarId OccInfo -&gt; Map VarId OccInfo
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503566"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="IR.Simplify.html#OnceSafe"><span class="hs-identifier hs-var">OnceSafe</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503565"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-145"></span><span>        </span><span class="annot"><span class="annottext">Maybe OccInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; OccInfo -&gt; Map VarId OccInfo -&gt; Map VarId OccInfo
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503566"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="IR.Simplify.html#Never"><span class="hs-identifier hs-var">Never</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503565"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><span class="annottext">(SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((SimplEnv -&gt; SimplEnv) -&gt; SimplFn ())
-&gt; (SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679503556"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503556"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503556"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">occInfo :: Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var">occInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503560"><span class="hs-identifier hs-var">m'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="hs-comment">{- | Add substitution to the substitution set

Suppose we want to replace x with y.
Then we call insertSubst x (SuspEx y {})
-}</span><span>
</span><span id="line-154"></span><span class="annot"><a href="IR.Simplify.html#insertSubst"><span class="hs-identifier hs-type">insertSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SubstRng"><span class="hs-identifier hs-type">SubstRng</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span id="insertSubst"><span class="annot"><span class="annottext">insertSubst :: VarId -&gt; SubstRng -&gt; SimplFn ()
</span><a href="IR.Simplify.html#insertSubst"><span class="hs-identifier hs-var hs-var">insertSubst</span></a></span></span><span> </span><span id="local-6989586621679503554"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503554"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span id="local-6989586621679503553"><span class="annot"><span class="annottext">SubstRng
</span><a href="#local-6989586621679503553"><span class="hs-identifier hs-var">rng</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>  </span><span id="local-6989586621679503552"><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503552"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId SubstRng) -&gt; SimplFn (Map VarId SubstRng)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId SubstRng
</span><a href="IR.Simplify.html#subst"><span class="hs-identifier hs-var hs-var">subst</span></a></span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679503551"><span class="annot"><span class="annottext">m' :: Map VarId SubstRng
</span><a href="#local-6989586621679503551"><span class="hs-identifier hs-var hs-var">m'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; SubstRng -&gt; Map VarId SubstRng -&gt; Map VarId SubstRng
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503554"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">SubstRng
</span><a href="#local-6989586621679503553"><span class="hs-identifier hs-var">rng</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503552"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><span class="annottext">(SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((SimplEnv -&gt; SimplEnv) -&gt; SimplFn ())
-&gt; (SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679503550"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503550"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503550"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">subst :: Map VarId SubstRng
</span><a href="IR.Simplify.html#subst"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503551"><span class="hs-identifier hs-var">m'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-comment">-- | Record that the ocurrence analyzer is looking inside a lambda</span><span>
</span><span id="line-162"></span><span class="annot"><a href="IR.Simplify.html#recordEnteringLambda"><span class="hs-identifier hs-type">recordEnteringLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span id="recordEnteringLambda"><span class="annot"><span class="annottext">recordEnteringLambda :: SimplFn ()
</span><a href="IR.Simplify.html#recordEnteringLambda"><span class="hs-identifier hs-var hs-var">recordEnteringLambda</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>  </span><span id="local-6989586621679503548"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503548"><span class="hs-identifier hs-var">curCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Int) -&gt; SimplFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Int
</span><a href="IR.Simplify.html#countLambda"><span class="hs-identifier hs-var hs-var">countLambda</span></a></span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><span class="annottext">(SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((SimplEnv -&gt; SimplEnv) -&gt; SimplFn ())
-&gt; (SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679503547"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503547"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503547"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">countLambda :: Int
</span><a href="IR.Simplify.html#countLambda"><span class="hs-identifier hs-var">countLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503548"><span class="hs-identifier hs-var">curCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="hs-comment">-- | Record that the ocurrence analyzer is no longer looking inside a lambda</span><span>
</span><span id="line-169"></span><span class="annot"><a href="IR.Simplify.html#recordExitingLambda"><span class="hs-identifier hs-type">recordExitingLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span id="recordExitingLambda"><span class="annot"><span class="annottext">recordExitingLambda :: SimplFn ()
</span><a href="IR.Simplify.html#recordExitingLambda"><span class="hs-identifier hs-var hs-var">recordExitingLambda</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>  </span><span id="local-6989586621679503544"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503544"><span class="hs-identifier hs-var">curCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Int) -&gt; SimplFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Int
</span><a href="IR.Simplify.html#countLambda"><span class="hs-identifier hs-var hs-var">countLambda</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><span class="annottext">(SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((SimplEnv -&gt; SimplEnv) -&gt; SimplFn ())
-&gt; (SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679503543"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503543"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503543"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">countLambda :: Int
</span><a href="IR.Simplify.html#countLambda"><span class="hs-identifier hs-var">countLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503544"><span class="hs-identifier hs-var">curCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-comment">-- | Returns whether ocurrence analyzer is currently looking inside a lambda</span><span>
</span><span id="line-176"></span><span class="annot"><a href="IR.Simplify.html#insideLambda"><span class="hs-identifier hs-type">insideLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-177"></span><span id="insideLambda"><span class="annot"><span class="annottext">insideLambda :: SimplFn Bool
</span><a href="IR.Simplify.html#insideLambda"><span class="hs-identifier hs-var hs-var">insideLambda</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>  </span><span id="local-6989586621679503542"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503542"><span class="hs-identifier hs-var">curCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Int) -&gt; SimplFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Int
</span><a href="IR.Simplify.html#countLambda"><span class="hs-identifier hs-var hs-var">countLambda</span></a></span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; SimplFn Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503542"><span class="hs-identifier hs-var">curCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- | Record that the ocurrence analyzer is looking inside a match</span><span>
</span><span id="line-183"></span><span class="annot"><a href="IR.Simplify.html#recordEnteringMatch"><span class="hs-identifier hs-type">recordEnteringMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span id="recordEnteringMatch"><span class="annot"><span class="annottext">recordEnteringMatch :: SimplFn ()
</span><a href="IR.Simplify.html#recordEnteringMatch"><span class="hs-identifier hs-var hs-var">recordEnteringMatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>  </span><span id="local-6989586621679503539"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503539"><span class="hs-identifier hs-var">curCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Int) -&gt; SimplFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Int
</span><a href="IR.Simplify.html#countMatch"><span class="hs-identifier hs-var hs-var">countMatch</span></a></span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><span class="annottext">(SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((SimplEnv -&gt; SimplEnv) -&gt; SimplFn ())
-&gt; (SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679503538"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503538"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503538"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">countMatch :: Int
</span><a href="IR.Simplify.html#countMatch"><span class="hs-identifier hs-var">countMatch</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503539"><span class="hs-identifier hs-var">curCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="hs-comment">-- | Record that the ocurrence analyzer is no longer looking inside a match</span><span>
</span><span id="line-190"></span><span class="annot"><a href="IR.Simplify.html#recordExitingMatch"><span class="hs-identifier hs-type">recordExitingMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span id="recordExitingMatch"><span class="annot"><span class="annottext">recordExitingMatch :: SimplFn ()
</span><a href="IR.Simplify.html#recordExitingMatch"><span class="hs-identifier hs-var hs-var">recordExitingMatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>  </span><span id="local-6989586621679503536"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503536"><span class="hs-identifier hs-var">curCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Int) -&gt; SimplFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Int
</span><a href="IR.Simplify.html#countMatch"><span class="hs-identifier hs-var hs-var">countMatch</span></a></span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="annottext">(SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((SimplEnv -&gt; SimplEnv) -&gt; SimplFn ())
-&gt; (SimplEnv -&gt; SimplEnv) -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679503535"><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503535"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimplEnv
</span><a href="#local-6989586621679503535"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">countMatch :: Int
</span><a href="IR.Simplify.html#countMatch"><span class="hs-identifier hs-var">countMatch</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503536"><span class="hs-identifier hs-var">curCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-comment">-- | Returns whether ocurrence analyzer is currently looking inside a match</span><span>
</span><span id="line-197"></span><span class="annot"><a href="IR.Simplify.html#insideMatch"><span class="hs-identifier hs-type">insideMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-198"></span><span id="insideMatch"><span class="annot"><span class="annottext">insideMatch :: SimplFn Bool
</span><a href="IR.Simplify.html#insideMatch"><span class="hs-identifier hs-var hs-var">insideMatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>  </span><span id="local-6989586621679503534"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503534"><span class="hs-identifier hs-var">curCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Int) -&gt; SimplFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Int
</span><a href="IR.Simplify.html#countMatch"><span class="hs-identifier hs-var hs-var">countMatch</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; SimplFn Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679503534"><span class="hs-identifier hs-var">curCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">{- | Entry-point to Simplifer.

Maps over top level definitions to create a new simplified Program
-}</span><span>
</span><span id="line-207"></span><span class="annot"><a href="IR.Simplify.html#simplifyProgram"><span class="hs-identifier hs-type">simplifyProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span id="simplifyProgram"><span class="annot"><span class="annottext">simplifyProgram :: Program Type -&gt; Pass (Program Type)
</span><a href="IR.Simplify.html#simplifyProgram"><span class="hs-identifier hs-var hs-var">simplifyProgram</span></a></span></span><span> </span><span id="local-6989586621679503533"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679503533"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SimplFn (Program Type) -&gt; Pass (Program Type)
forall a. SimplFn a -&gt; Pass a
</span><a href="IR.Simplify.html#runSimplFn"><span class="hs-identifier hs-var">runSimplFn</span></a></span><span> </span><span class="annot"><span class="annottext">(SimplFn (Program Type) -&gt; Pass (Program Type))
-&gt; SimplFn (Program Type) -&gt; Pass (Program Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; SimplFn String
</span><a href="IR.Simplify.html#runOccAnal"><span class="hs-identifier hs-var">runOccAnal</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679503533"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-comment">-- run the occurrence analyzer</span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-comment">-- fail and print out the results of the occurence analyzer</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-comment">-- info &lt;- runOccAnal p</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-comment">-- _ &lt;- Compiler.unexpected $ show info</span><span>
</span><span id="line-213"></span><span>  </span><span id="local-6989586621679503531"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503531"><span class="hs-identifier hs-var">simplifiedProgramDefs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Binder Type, Expr Type) -&gt; SimplFn (Binder Type, Expr Type))
-&gt; [(Binder Type, Expr Type)] -&gt; SimplFn [(Binder Type, Expr Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Binder Type, Expr Type) -&gt; SimplFn (Binder Type, Expr Type)
</span><a href="IR.Simplify.html#simplTop"><span class="hs-identifier hs-var">simplTop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Program Type -&gt; [(Binder Type, Expr Type)]
forall t. Program t -&gt; [(Binder t, Expr t)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var hs-var">I.programDefs</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679503533"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><span class="annottext">Program Type -&gt; SimplFn (Program Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Program Type -&gt; SimplFn (Program Type))
-&gt; Program Type -&gt; SimplFn (Program Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679503533"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">programDefs :: [(Binder Type, Expr Type)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var">I.programDefs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503531"><span class="hs-identifier hs-var">simplifiedProgramDefs</span></a></span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- this whole do expression returns a Compiler.Pass</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">-- | Simplify a top-level definition</span><span>
</span><span id="line-218"></span><span class="annot"><a href="IR.Simplify.html#simplTop"><span class="hs-identifier hs-type">simplTop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span id="simplTop"><span class="annot"><span class="annottext">simplTop :: (Binder Type, Expr Type) -&gt; SimplFn (Binder Type, Expr Type)
</span><a href="IR.Simplify.html#simplTop"><span class="hs-identifier hs-var hs-var">simplTop</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503527"><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679503527"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503526"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503526"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679503527"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; (Binder Type, Expr Type))
-&gt; SimplFn (Expr Type) -&gt; SimplFn (Binder Type, Expr Type)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inscopeset&quot;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503526"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;context&quot;</span></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">{- | Simplify an IR expression.

Probably want more documentation here eventually.
For now we ignore the in scope set and context args.

How do we handle each node?
- Var VarId t                           DONE (except callsite inline)
- Data DConId t                         Default case
- Lit Literal t                         Default case
- App (Expr t) (Expr t) t               DONE
- Let [(Binder, Expr t)] (Expr t) t     DONE (except callsite inline)
- Lambda Binder (Expr t) t              DONE
- Match (Expr t) [(Alt, Expr t)] t      DONE (TODO: match arm elimination)
- Prim Primitive [Expr t] t             DONE
-}</span><span>
</span><span id="line-238"></span><span class="annot"><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-type">simplExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Simplify.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="annot"><a href="IR.Simplify.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">{- | Simplify Primitive Expression

  Simplify each of the arguments to prim
  For ex. 5 + g + h + (6 + v)
  Is the primitive &quot;plus&quot; followed by args 5, g, h, and (6 + v)
  SimpleExpr calls itself on each of &quot;plus&quot;'s arguments, then
  returns the result wrapped back up in an I.Prim IR node.
-}</span><span>
</span><span id="line-249"></span><span id="simplExpr"><span class="annot"><span class="annottext">simplExpr :: Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var hs-var">simplExpr</span></a></span></span><span> </span><span id="local-6989586621679503523"><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503523"><span class="hs-identifier hs-var">sub</span></a></span></span><span> </span><span id="local-6989586621679503522"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503522"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span id="local-6989586621679503520"><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679503520"><span class="hs-keyword hs-var">prim</span></a></span></span><span> </span><span id="local-6989586621679503519"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503519"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621679503518"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503518"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679503517"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503517"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>  </span><span id="local-6989586621679503516"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503516"><span class="hs-identifier hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; SimplFn (Expr Type))
-&gt; [Expr Type] -&gt; SimplFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; SimplFn (Expr Type)) -&gt; String -&gt; SimplFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503517"><span class="hs-identifier hs-var">cont</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((String -&gt; SimplFn (Expr Type)) -&gt; SimplFn (Expr Type))
-&gt; (Expr Type -&gt; String -&gt; SimplFn (Expr Type))
-&gt; Expr Type
-&gt; SimplFn (Expr Type)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503523"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503522"><span class="hs-identifier hs-var">ins</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503519"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679503520"><span class="hs-keyword hs-var">prim</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503516"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503518"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">-- \| Simplify Match Expression</span><span>
</span><span id="line-254"></span><span class="annot"><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span id="local-6989586621679503514"><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503514"><span class="hs-identifier hs-var">sub</span></a></span></span><span> </span><span id="local-6989586621679503513"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503513"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Match"><span class="hs-identifier hs-type">I.Match</span></a></span><span> </span><span id="local-6989586621679503511"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503511"><span class="hs-identifier hs-var">scrutinee</span></a></span></span><span> </span><span id="local-6989586621679503510"><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679503510"><span class="hs-identifier hs-var">arms</span></a></span></span><span> </span><span id="local-6989586621679503509"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503509"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679503508"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503508"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-255"></span><span>  </span><span id="local-6989586621679503507"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503507"><span class="hs-identifier hs-var">scrutinee'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503514"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503513"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503511"><span class="hs-identifier hs-var">scrutinee</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503508"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503506"><span class="annot"><span class="annottext">[Alt Type]
</span><a href="#local-6989586621679503506"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503505"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503505"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Alt Type, Expr Type)] -&gt; ([Alt Type], [Expr Type])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679503510"><span class="hs-identifier hs-var">arms</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span id="local-6989586621679503503"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503503"><span class="hs-identifier hs-var">rhss'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SimplFn (Expr Type)] -&gt; SimplFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="annot"><span class="annottext">([SimplFn (Expr Type)] -&gt; SimplFn [Expr Type])
-&gt; [SimplFn (Expr Type)] -&gt; SimplFn [Expr Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; String -&gt; SimplFn (Expr Type))
-&gt; [Expr Type] -&gt; String -&gt; [SimplFn (Expr Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503514"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503513"><span class="hs-identifier hs-var">ins</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503505"><span class="hs-identifier hs-var">rhss</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503508"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679503501"><span class="annot"><span class="annottext">results :: [(Alt Type, Expr Type)]
</span><a href="#local-6989586621679503501"><span class="hs-identifier hs-var hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt Type] -&gt; [Expr Type] -&gt; [(Alt Type, Expr Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Alt Type]
</span><a href="#local-6989586621679503506"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503503"><span class="hs-identifier hs-var">rhss'</span></a></span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; [(Alt Type, Expr Type)] -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; [(Alt t, Expr t)] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Match"><span class="hs-identifier hs-var">I.Match</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503507"><span class="hs-identifier hs-var">scrutinee'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679503501"><span class="hs-identifier hs-var">results</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503509"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="hs-comment">-- \| Simplify Application Expression</span><span>
</span><span id="line-262"></span><span class="annot"><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span id="local-6989586621679503500"><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503500"><span class="hs-identifier hs-var">sub</span></a></span></span><span> </span><span id="local-6989586621679503499"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503499"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#App"><span class="hs-identifier hs-type">I.App</span></a></span><span> </span><span id="local-6989586621679503497"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503497"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621679503496"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503496"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span id="local-6989586621679503495"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503495"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679503494"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503494"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>  </span><span id="local-6989586621679503493"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503493"><span class="hs-identifier hs-var">lhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503500"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503499"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503497"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503494"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-264"></span><span>  </span><span id="local-6989586621679503492"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503492"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503500"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503499"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503496"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503494"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#App"><span class="hs-identifier hs-var">I.App</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503493"><span class="hs-identifier hs-var">lhs'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503492"><span class="hs-identifier hs-var">rhs'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503495"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="hs-comment">-- \| Simplify Lambda Expression</span><span>
</span><span id="line-268"></span><span class="annot"><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span id="local-6989586621679503491"><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503491"><span class="hs-identifier hs-var">sub</span></a></span></span><span> </span><span id="local-6989586621679503490"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503490"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span> </span><span id="local-6989586621679503488"><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679503488"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span id="local-6989586621679503487"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503487"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621679503486"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503486"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679503485"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503485"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>  </span><span id="local-6989586621679503484"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503484"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503491"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503490"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503487"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503485"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder Type -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Binder t -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-var">I.Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679503488"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503484"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503486"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span class="hs-comment">-- \| Simplify Variable Expression</span><span>
</span><span id="line-273"></span><span class="annot"><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679503483"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503483"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span id="local-6989586621679503482"><span class="annot"><span class="annottext">var :: Expr Type
</span><a href="#local-6989586621679503482"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Var"><span class="hs-identifier hs-type">I.Var</span></a></span><span> </span><span id="local-6989586621679503480"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503480"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679503479"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503479"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>  </span><span id="local-6989586621679503478"><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503478"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId SubstRng) -&gt; SimplFn (Map VarId SubstRng)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId SubstRng
</span><a href="IR.Simplify.html#subst"><span class="hs-identifier hs-var hs-var">subst</span></a></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId SubstRng -&gt; Maybe SubstRng
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503480"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503478"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><span class="annottext">Maybe SubstRng
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503482"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="hs-comment">-- callsite inline, future work</span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Simplify.html#SuspEx"><span class="hs-identifier hs-type">SuspEx</span></a></span><span> </span><span id="local-6989586621679503477"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503477"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679503476"><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503476"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503476"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503483"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503477"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503479"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Simplify.html#DoneEx"><span class="hs-identifier hs-type">DoneEx</span></a></span><span> </span><span id="local-6989586621679503475"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503475"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503483"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503475"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503479"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-comment">-- \| Simplify Let Expressions</span><span>
</span><span id="line-281"></span><span class="annot"><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span id="local-6989586621679503474"><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503474"><span class="hs-identifier hs-var">sub</span></a></span></span><span> </span><span id="local-6989586621679503473"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503473"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Let"><span class="hs-identifier hs-type">I.Let</span></a></span><span> </span><span id="local-6989586621679503471"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503471"><span class="hs-identifier hs-var">binders</span></a></span></span><span> </span><span id="local-6989586621679503470"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503470"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621679503469"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503469"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679503468"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503468"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>  </span><span id="local-6989586621679503467"><span class="annot"><span class="annottext">[(Maybe (Binder Type, Expr Type), Map VarId SubstRng)]
</span><a href="#local-6989586621679503467"><span class="hs-identifier hs-var">simplified</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Binder Type, Expr Type)
 -&gt; SimplFn (Maybe (Binder Type, Expr Type), Map VarId SubstRng))
-&gt; [(Binder Type, Expr Type)]
-&gt; SimplFn [(Maybe (Binder Type, Expr Type), Map VarId SubstRng)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Binder Type, Expr Type)
-&gt; SimplFn (Maybe (Binder Type, Expr Type), Map VarId SubstRng)
forall t.
(Binder t, Expr Type)
-&gt; SimplFn (Maybe (Binder t, Expr Type), Map VarId SubstRng)
</span><a href="#local-6989586621679503466"><span class="hs-identifier hs-var">simplBinder</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503471"><span class="hs-identifier hs-var">binders</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503465"><span class="annot"><span class="annottext">[Maybe (Binder Type, Expr Type)]
</span><a href="#local-6989586621679503465"><span class="hs-identifier hs-var">simplBinders</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503464"><span class="annot"><span class="annottext">[Map VarId SubstRng]
</span><a href="#local-6989586621679503464"><span class="hs-identifier hs-var">subs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Maybe (Binder Type, Expr Type), Map VarId SubstRng)]
-&gt; ([Maybe (Binder Type, Expr Type)], [Map VarId SubstRng])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Maybe (Binder Type, Expr Type), Map VarId SubstRng)]
</span><a href="#local-6989586621679503467"><span class="hs-identifier hs-var">simplified</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679503463"><span class="annot"><span class="annottext">binders' :: [(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503463"><span class="hs-identifier hs-var hs-var">binders'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe (Binder Type, Expr Type)] -&gt; [(Binder Type, Expr Type)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">Ma.catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Binder Type, Expr Type)]
</span><a href="#local-6989586621679503465"><span class="hs-identifier hs-var">simplBinders</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679503461"><span class="annot"><span class="annottext">subs' :: Map VarId SubstRng
</span><a href="#local-6989586621679503461"><span class="hs-identifier hs-var hs-var">subs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map VarId SubstRng -&gt; Map VarId SubstRng -&gt; Map VarId SubstRng)
-&gt; [Map VarId SubstRng] -&gt; Map VarId SubstRng
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldr1</span></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng -&gt; Map VarId SubstRng -&gt; Map VarId SubstRng
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(&lt;&gt;)</span></span><span> </span><span class="annot"><span class="annottext">[Map VarId SubstRng]
</span><a href="#local-6989586621679503464"><span class="hs-identifier hs-var">subs</span></a></span><span>
</span><span id="line-286"></span><span>  </span><span id="local-6989586621679503459"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503459"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503461"><span class="hs-identifier hs-var">subs'</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503473"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503470"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503468"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503463"><span class="hs-identifier hs-var">binders'</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503459"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)] -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. [(Binder t, Expr t)] -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Let"><span class="hs-identifier hs-var">I.Let</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503463"><span class="hs-identifier hs-var">binders'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503459"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679503469"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-289"></span><span>  </span><span id="local-6989586621679503699"><span class="annot"><a href="#local-6989586621679503466"><span class="hs-identifier hs-type">simplBinder</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503699"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503699"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Simplify.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-292"></span><span>  </span><span id="local-6989586621679503466"><span class="annot"><span class="annottext">simplBinder :: (Binder t, Expr Type)
-&gt; SimplFn (Maybe (Binder t, Expr Type), Map VarId SubstRng)
</span><a href="#local-6989586621679503466"><span class="hs-identifier hs-var hs-var">simplBinder</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503457"><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503457"><span class="hs-identifier hs-var">binder</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503456"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503456"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>    </span><span id="local-6989586621679503455"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503455"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503457"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-295"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#BindVar"><span class="hs-identifier hs-type">I.BindVar</span></a></span><span> </span><span id="local-6989586621679503453"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503453"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId OccInfo -&gt; Maybe OccInfo
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503453"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503455"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-296"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="IR.Simplify.html#Dead"><span class="hs-identifier hs-var">Dead</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe (Binder t, Expr Type), Map VarId SubstRng)
-&gt; SimplFn (Maybe (Binder t, Expr Type), Map VarId SubstRng)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Binder t, Expr Type)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503474"><span class="hs-identifier hs-var">sub</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- get rid of this dead binding</span><span>
</span><span id="line-297"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">OccInfo
</span><a href="IR.Simplify.html#OnceSafe"><span class="hs-identifier hs-var">OnceSafe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>          </span><span class="hs-comment">-- preinline test PASSES</span><span>
</span><span id="line-299"></span><span>          </span><span class="hs-comment">-- bind x to E singleton :: k -&gt; a -&gt; Map k a</span><span>
</span><span id="line-300"></span><span>          </span><span class="annot"><span class="annottext">VarId -&gt; SubstRng -&gt; SimplFn ()
</span><a href="IR.Simplify.html#insertSubst"><span class="hs-identifier hs-var">insertSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503453"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(SubstRng -&gt; SimplFn ()) -&gt; SubstRng -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Map VarId SubstRng -&gt; SubstRng
</span><a href="IR.Simplify.html#SuspEx"><span class="hs-identifier hs-var">SuspEx</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503456"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-301"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679503452"><span class="annot"><span class="annottext">sub' :: Map VarId SubstRng
</span><a href="#local-6989586621679503452"><span class="hs-identifier hs-var hs-var">sub'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; SubstRng -&gt; Map VarId SubstRng
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503453"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Map VarId SubstRng -&gt; SubstRng
</span><a href="IR.Simplify.html#SuspEx"><span class="hs-identifier hs-var">SuspEx</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503456"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503474"><span class="hs-identifier hs-var">sub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>          </span><span class="annot"><span class="annottext">(Maybe (Binder t, Expr Type), Map VarId SubstRng)
-&gt; SimplFn (Maybe (Binder t, Expr Type), Map VarId SubstRng)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Binder t, Expr Type)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503452"><span class="hs-identifier hs-var">sub'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>        </span><span class="annot"><span class="annottext">Maybe OccInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-304"></span><span>          </span><span class="hs-comment">-- preinline test FAILS, so do post inline unconditionally</span><span>
</span><span id="line-305"></span><span>          </span><span id="local-6989586621679503450"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503450"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503474"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503473"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503456"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503468"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-comment">-- process the RHS</span><span>
</span><span id="line-306"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503450"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-307"></span><span>            </span><span class="hs-comment">-- x goes here.</span><span>
</span><span id="line-308"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lit"><span class="hs-identifier hs-type">I.Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-309"></span><span>              </span><span class="annot"><span class="annottext">VarId -&gt; SubstRng -&gt; SimplFn ()
</span><a href="IR.Simplify.html#insertSubst"><span class="hs-identifier hs-var">insertSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503453"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(SubstRng -&gt; SimplFn ()) -&gt; SubstRng -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SubstRng
</span><a href="IR.Simplify.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503450"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-310"></span><span>              </span><span class="annot"><span class="annottext">(Maybe (Binder t, Expr Type), Map VarId SubstRng)
-&gt; SimplFn (Maybe (Binder t, Expr Type), Map VarId SubstRng)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Binder t, Expr Type)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- PASSES postinline</span><span>
</span><span id="line-311"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Var"><span class="hs-identifier hs-type">I.Var</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>              </span><span class="annot"><span class="annottext">VarId -&gt; SubstRng -&gt; SimplFn ()
</span><a href="IR.Simplify.html#insertSubst"><span class="hs-identifier hs-var">insertSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503453"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(SubstRng -&gt; SimplFn ()) -&gt; SubstRng -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SubstRng
</span><a href="IR.Simplify.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503450"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-313"></span><span>              </span><span class="annot"><span class="annottext">(Maybe (Binder t, Expr Type), Map VarId SubstRng)
-&gt; SimplFn (Maybe (Binder t, Expr Type), Map VarId SubstRng)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Binder t, Expr Type)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- PASSES postinline</span><span>
</span><span id="line-314"></span><span>            </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-315"></span><span>              </span><span id="local-6989586621679503448"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503448"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503474"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503473"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503456"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503468"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-comment">-- we won't inline x, but still possible to simplify e (RHS)</span><span>
</span><span id="line-316"></span><span>              </span><span class="annot"><span class="annottext">(Maybe (Binder t, Expr Type), Map VarId SubstRng)
-&gt; SimplFn (Maybe (Binder t, Expr Type), Map VarId SubstRng)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Binder t, Expr Type) -&gt; Maybe (Binder t, Expr Type)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503457"><span class="hs-identifier hs-var">binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503448"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503474"><span class="hs-identifier hs-var">sub</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- FAILS postinline; someday callsite inline</span><span>
</span><span id="line-317"></span><span>      </span><span class="annot"><span class="annottext">Binder t
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>        </span><span id="local-6989586621679503447"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503447"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
-&gt; String -&gt; Expr Type -&gt; String -&gt; SimplFn (Expr Type)
</span><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503474"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503473"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503456"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503468"><span class="hs-identifier hs-var">cont</span></a></span><span>
</span><span id="line-319"></span><span>        </span><span class="annot"><span class="annottext">(Maybe (Binder t, Expr Type), Map VarId SubstRng)
-&gt; SimplFn (Maybe (Binder t, Expr Type), Map VarId SubstRng)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Binder t, Expr Type) -&gt; Maybe (Binder t, Expr Type)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503457"><span class="hs-identifier hs-var">binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503447"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><a href="#local-6989586621679503474"><span class="hs-identifier hs-var">sub</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- can't inline wildcards</span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span class="hs-comment">-- \| for all other expressions, don't do anything</span><span>
</span><span id="line-322"></span><span class="annot"><a href="IR.Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId SubstRng
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679503446"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503446"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503446"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span class="hs-comment">{- | Run occurrence analyser over each top level function

Returns logging info as a string.
-}</span><span>
</span><span id="line-329"></span><span class="annot"><a href="IR.Simplify.html#runOccAnal"><span class="hs-identifier hs-type">runOccAnal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-330"></span><span id="runOccAnal"><span class="annot"><span class="annottext">runOccAnal :: Program Type -&gt; SimplFn String
</span><a href="IR.Simplify.html#runOccAnal"><span class="hs-identifier hs-var hs-var">runOccAnal</span></a></span></span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">programDefs :: forall t. Program t -&gt; [(Binder t, Expr t)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var">I.programDefs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679503444"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503444"><span class="hs-identifier hs-var">defs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>  </span><span id="local-6989586621679503443"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503443"><span class="hs-identifier hs-var">defs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Binder Type, Expr Type) -&gt; SimplFn (Binder Type, Expr Type))
-&gt; [(Binder Type, Expr Type)] -&gt; SimplFn [(Binder Type, Expr Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Binder Type, Expr Type) -&gt; SimplFn (Binder Type, Expr Type)
forall t. (Binder t, Expr t) -&gt; SimplFn (Binder t, Expr t)
</span><a href="#local-6989586621679503442"><span class="hs-identifier hs-var">swallowArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503444"><span class="hs-identifier hs-var">defs</span></a></span><span>
</span><span id="line-332"></span><span>  </span><span id="local-6989586621679503441"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679503441"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Binder Type, Expr Type) -&gt; SimplFn String)
-&gt; [(Binder Type, Expr Type)] -&gt; SimplFn [String]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Binder Type, SimplFn (Expr Type, String)) -&gt; SimplFn String
</span><a href="#local-6989586621679503440"><span class="hs-identifier hs-var">getOccInfoForDef</span></a></span><span> </span><span class="annot"><span class="annottext">((Binder Type, SimplFn (Expr Type, String)) -&gt; SimplFn String)
-&gt; ((Binder Type, Expr Type)
    -&gt; (Binder Type, SimplFn (Expr Type, String)))
-&gt; (Binder Type, Expr Type)
-&gt; SimplFn String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; SimplFn (Expr Type, String))
-&gt; (Binder Type, Expr Type)
-&gt; (Binder Type, SimplFn (Expr Type, String))
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503443"><span class="hs-identifier hs-var">defs'</span></a></span><span>
</span><span id="line-333"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; SimplFn String
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679503441"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-comment">{- Take in a top level function, &quot;swallows&quot; its args, and return its body.

  &quot;Swallow&quot; means to add the argument to our occurrence info state.
  It returns a top level function without curried arguments; just the body.
  -}</span><span>
</span><span id="line-340"></span><span>  </span><span id="local-6989586621679503689"><span class="annot"><a href="#local-6989586621679503442"><span class="hs-identifier hs-type">swallowArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503689"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503689"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503689"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503689"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-341"></span><span>  </span><span id="local-6989586621679503442"><span class="annot"><span class="annottext">swallowArgs :: (Binder t, Expr t) -&gt; SimplFn (Binder t, Expr t)
</span><a href="#local-6989586621679503442"><span class="hs-identifier hs-var hs-var">swallowArgs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503438"><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503438"><span class="hs-identifier hs-var">funcName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503437"><span class="annot"><span class="annottext">l :: Expr t
</span><a href="#local-6989586621679503437"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">Maybe VarId -&gt; SimplFn ()
</span><a href="#local-6989586621679503436"><span class="hs-identifier hs-var">addOccs</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe VarId -&gt; SimplFn ()) -&gt; Maybe VarId -&gt; SimplFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Binder t -&gt; Maybe VarId
forall a. Binder a -&gt; Maybe VarId
</span><a href="IR.IR.html#binderToVar"><span class="hs-identifier hs-var">I.binderToVar</span></a></span><span> </span><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503438"><span class="hs-identifier hs-var">funcName</span></a></span><span>
</span><span id="line-343"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503434"><span class="annot"><span class="annottext">[Binder t]
</span><a href="#local-6989586621679503434"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503433"><span class="annot"><span class="annottext">Expr t
</span><a href="#local-6989586621679503433"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr t -&gt; ([Binder t], Expr t)
forall t. Expr t -&gt; ([Binder t], Expr t)
</span><a href="IR.IR.html#unfoldLambda"><span class="hs-identifier hs-var">unfoldLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Expr t
</span><a href="#local-6989586621679503437"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span class="annot"><span class="annottext">(Binder t -&gt; SimplFn ()) -&gt; [Binder t] -&gt; SimplFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe VarId -&gt; SimplFn ()
</span><a href="#local-6989586621679503436"><span class="hs-identifier hs-var">addOccs</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe VarId -&gt; SimplFn ())
-&gt; (Binder t -&gt; Maybe VarId) -&gt; Binder t -&gt; SimplFn ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Binder t -&gt; Maybe VarId
forall a. Binder a -&gt; Maybe VarId
</span><a href="IR.IR.html#binderToVar"><span class="hs-identifier hs-var">I.binderToVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Binder t]
</span><a href="#local-6989586621679503434"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><span class="annottext">(Binder t, Expr t) -&gt; SimplFn (Binder t, Expr t)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503438"><span class="hs-identifier hs-var">funcName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr t
</span><a href="#local-6989586621679503433"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-347"></span><span>    </span><span id="local-6989586621679503436"><span class="annot"><span class="annottext">addOccs :: Maybe VarId -&gt; SimplFn ()
</span><a href="#local-6989586621679503436"><span class="hs-identifier hs-var hs-var">addOccs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679503431"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503431"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; SimplFn ()
</span><a href="IR.Simplify.html#addOccVar"><span class="hs-identifier hs-var">addOccVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503431"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-348"></span><span>    </span><span class="annot"><a href="#local-6989586621679503436"><span class="hs-identifier hs-var">addOccs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe VarId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; SimplFn ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><a href="#local-6989586621679503442"><span class="hs-identifier hs-var">swallowArgs</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503430"><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503430"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503429"><span class="annot"><span class="annottext">Expr t
</span><a href="#local-6989586621679503429"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Binder t, Expr t) -&gt; SimplFn (Binder t, Expr t)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503430"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr t
</span><a href="#local-6989586621679503429"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-comment">-- a hacky way to see the occurence info for each top def</span><span>
</span><span id="line-352"></span><span>  </span><span class="annot"><a href="#local-6989586621679503440"><span class="hs-identifier hs-type">getOccInfoForDef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-353"></span><span>  </span><span id="local-6989586621679503440"><span class="annot"><span class="annottext">getOccInfoForDef :: (Binder Type, SimplFn (Expr Type, String)) -&gt; SimplFn String
</span><a href="#local-6989586621679503440"><span class="hs-identifier hs-var hs-var">getOccInfoForDef</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679503428"><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679503428"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503427"><span class="annot"><span class="annottext">SimplFn (Expr Type, String)
</span><a href="#local-6989586621679503427"><span class="hs-identifier hs-var">tpl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503426"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503426"><span class="hs-identifier hs-var">occinfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimplFn (Expr Type, String)
</span><a href="#local-6989586621679503427"><span class="hs-identifier hs-var">tpl</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; SimplFn String
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SimplFn String) -&gt; String -&gt; SimplFn String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-356"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;START topdef &quot;</span></span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Binder Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679503428"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-358"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; has OccInfo: &quot;</span></span><span>
</span><span id="line-359"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">ShowS
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679503426"><span class="hs-identifier hs-var">occinfo</span></a></span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; END&quot;</span></span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span class="hs-comment">{- | Run the Ocurrence Analyzer over an IR expression node

How do we handle each node?
- Var VarId t                           DONE
- Data DConId t                         Default case (TODO: trivial constructor argument invariant)
- Lit Literal t                         Default case
- App (Expr t) (Expr t) t               DONE
- Let [(Binder, Expr t)] (Expr t) t     DONE
- Lambda Binder (Expr t) t              DONE
- Match (Expr t) [(Alt, Expr t)] t      DONE (TODO: analyze patterns / LHS of arms?)
- Prim Primitive [Expr t] t             DONE
-}</span><span>
</span><span id="line-375"></span><span class="annot"><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-type">occAnalExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="hs-comment">-- | Occurrence Analysis over Let Expression</span><span>
</span><span id="line-379"></span><span id="occAnalExpr"><span class="annot"><span class="annottext">occAnalExpr :: Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var hs-var">occAnalExpr</span></a></span></span><span> </span><span id="local-6989586621679503425"><span class="annot"><span class="annottext">l :: Expr Type
</span><a href="#local-6989586621679503425"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Let"><span class="hs-identifier hs-type">I.Let</span></a></span><span> </span><span id="local-6989586621679503424"><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503424"><span class="hs-identifier hs-var">nameValPairs</span></a></span></span><span> </span><span id="local-6989586621679503423"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503423"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-380"></span><span>  </span><span class="annot"><span class="annottext">((Binder Type, Expr Type) -&gt; SimplFn ())
-&gt; [(Binder Type, Expr Type)] -&gt; SimplFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span>
</span><span id="line-381"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679503422"><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679503422"><span class="hs-identifier hs-var">binder</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679503421"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503421"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-382"></span><span>        </span><span class="annot"><span class="annottext">(Expr Type, String)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503421"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-383"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Binder Type -&gt; Maybe VarId
forall a. Binder a -&gt; Maybe VarId
</span><a href="IR.IR.html#binderToVar"><span class="hs-identifier hs-var">I.binderToVar</span></a></span><span> </span><span class="annot"><span class="annottext">Binder Type
</span><a href="#local-6989586621679503422"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-384"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679503420"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503420"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; SimplFn ()
</span><a href="IR.Simplify.html#addOccVar"><span class="hs-identifier hs-var">addOccVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503420"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-385"></span><span>          </span><span class="annot"><span class="annottext">Maybe VarId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; SimplFn ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">[(Binder Type, Expr Type)]
</span><a href="#local-6989586621679503424"><span class="hs-identifier hs-var">nameValPairs</span></a></span><span>
</span><span id="line-388"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503423"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-389"></span><span>  </span><span id="local-6989586621679503419"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503419"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-390"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String) -&gt; SimplFn (Expr Type, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503425"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503419"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span class="hs-comment">-- \| Occurrence Analysis over Variable Expression</span><span>
</span><span id="line-393"></span><span class="annot"><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span id="local-6989586621679503418"><span class="annot"><span class="annottext">var :: Expr Type
</span><a href="#local-6989586621679503418"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Var"><span class="hs-identifier hs-type">I.Var</span></a></span><span> </span><span id="local-6989586621679503417"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503417"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-394"></span><span>  </span><span class="annot"><span class="annottext">VarId -&gt; SimplFn ()
</span><a href="IR.Simplify.html#updateOccVar"><span class="hs-identifier hs-var">updateOccVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503417"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-395"></span><span>  </span><span id="local-6989586621679503416"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503416"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-396"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String) -&gt; SimplFn (Expr Type, String)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503418"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503416"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span class="hs-comment">-- \| Occurrence Analysis over Lambda Expression</span><span>
</span><span id="line-399"></span><span class="annot"><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span id="local-6989586621679503415"><span class="annot"><span class="annottext">l :: Expr Type
</span><a href="#local-6989586621679503415"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#BindVar"><span class="hs-identifier hs-type">I.BindVar</span></a></span><span> </span><span id="local-6989586621679503414"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503414"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679503413"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503413"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>  </span><span class="annot"><span class="annottext">SimplFn ()
</span><a href="IR.Simplify.html#recordEnteringLambda"><span class="hs-identifier hs-var">recordEnteringLambda</span></a></span><span>
</span><span id="line-401"></span><span>  </span><span class="annot"><span class="annottext">VarId -&gt; SimplFn ()
</span><a href="IR.Simplify.html#addOccVar"><span class="hs-identifier hs-var">addOccVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503414"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-402"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503413"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-403"></span><span>  </span><span class="annot"><span class="annottext">SimplFn ()
</span><a href="IR.Simplify.html#recordExitingLambda"><span class="hs-identifier hs-var">recordExitingLambda</span></a></span><span>
</span><span id="line-404"></span><span>  </span><span id="local-6989586621679503412"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503412"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-405"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String) -&gt; SimplFn (Expr Type, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503415"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503412"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span class="annot"><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span id="local-6989586621679503411"><span class="annot"><span class="annottext">l :: Expr Type
</span><a href="#local-6989586621679503411"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">Binder Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679503410"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503410"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-407"></span><span>  </span><span class="annot"><span class="annottext">SimplFn ()
</span><a href="IR.Simplify.html#recordEnteringLambda"><span class="hs-identifier hs-var">recordEnteringLambda</span></a></span><span>
</span><span id="line-408"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503410"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-409"></span><span>  </span><span class="annot"><span class="annottext">SimplFn ()
</span><a href="IR.Simplify.html#recordExitingLambda"><span class="hs-identifier hs-var">recordExitingLambda</span></a></span><span>
</span><span id="line-410"></span><span>  </span><span id="local-6989586621679503409"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503409"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-411"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String) -&gt; SimplFn (Expr Type, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503411"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503409"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span class="hs-comment">-- \| Occurrence Analysis over Application Expression</span><span>
</span><span id="line-414"></span><span class="annot"><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span id="local-6989586621679503408"><span class="annot"><span class="annottext">a :: Expr Type
</span><a href="#local-6989586621679503408"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#App"><span class="hs-identifier hs-type">I.App</span></a></span><span> </span><span id="local-6989586621679503407"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503407"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621679503406"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503406"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-415"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503407"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-416"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503406"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-417"></span><span>  </span><span id="local-6989586621679503405"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503405"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-418"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String) -&gt; SimplFn (Expr Type, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503408"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503405"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span class="hs-comment">-- \| Occurrence Analysis over Primitve Expression</span><span>
</span><span id="line-421"></span><span class="annot"><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span id="local-6989586621679503404"><span class="annot"><span class="annottext">p :: Expr Type
</span><a href="#local-6989586621679503404"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679503403"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503403"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-422"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type -&gt; SimplFn (Expr Type, String))
-&gt; [Expr Type] -&gt; SimplFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679503403"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-423"></span><span>  </span><span id="local-6989586621679503402"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503402"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-424"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String) -&gt; SimplFn (Expr Type, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503404"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503402"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span class="hs-comment">-- \| Occurrence Analysis over Match Expression</span><span>
</span><span id="line-427"></span><span class="annot"><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span id="local-6989586621679503401"><span class="annot"><span class="annottext">p :: Expr Type
</span><a href="#local-6989586621679503401"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Match"><span class="hs-identifier hs-type">I.Match</span></a></span><span> </span><span id="local-6989586621679503400"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503400"><span class="hs-identifier hs-var">scrutinee</span></a></span></span><span> </span><span id="local-6989586621679503399"><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679503399"><span class="hs-identifier hs-var">arms</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-428"></span><span>  </span><span class="annot"><span class="annottext">SimplFn ()
</span><a href="IR.Simplify.html#recordEnteringMatch"><span class="hs-identifier hs-var">recordEnteringMatch</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503400"><span class="hs-identifier hs-var">scrutinee</span></a></span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-comment">-- let (alts, rhss) = unzip arms</span><span>
</span><span id="line-431"></span><span>  </span><span class="annot"><span class="annottext">((Alt Type, Expr Type) -&gt; SimplFn (Alt Type, String))
-&gt; [(Alt Type, Expr Type)] -&gt; SimplFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt Type -&gt; SimplFn (Alt Type, String)
forall t. Alt t -&gt; SimplFn (Alt t, String)
</span><a href="IR.Simplify.html#occAnalAlt"><span class="hs-identifier hs-var">occAnalAlt</span></a></span><span> </span><span class="annot"><span class="annottext">(Alt Type -&gt; SimplFn (Alt Type, String))
-&gt; ((Alt Type, Expr Type) -&gt; Alt Type)
-&gt; (Alt Type, Expr Type)
-&gt; SimplFn (Alt Type, String)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Alt Type, Expr Type) -&gt; Alt Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679503399"><span class="hs-identifier hs-var">arms</span></a></span><span>
</span><span id="line-432"></span><span>  </span><span class="annot"><span class="annottext">((Alt Type, Expr Type) -&gt; SimplFn (Expr Type, String))
-&gt; [(Alt Type, Expr Type)] -&gt; SimplFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; SimplFn (Expr Type, String)
</span><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; SimplFn (Expr Type, String))
-&gt; ((Alt Type, Expr Type) -&gt; Expr Type)
-&gt; (Alt Type, Expr Type)
-&gt; SimplFn (Expr Type, String)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Alt Type, Expr Type) -&gt; Expr Type
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Alt Type, Expr Type)]
</span><a href="#local-6989586621679503399"><span class="hs-identifier hs-var">arms</span></a></span><span>
</span><span id="line-433"></span><span>  </span><span class="annot"><span class="annottext">SimplFn ()
</span><a href="IR.Simplify.html#recordExitingMatch"><span class="hs-identifier hs-var">recordExitingMatch</span></a></span><span>
</span><span id="line-434"></span><span>  </span><span id="local-6989586621679503397"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503397"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-435"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String) -&gt; SimplFn (Expr Type, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503401"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503397"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span class="hs-comment">-- \| for all other expressions, don't do anything</span><span>
</span><span id="line-438"></span><span class="annot"><a href="IR.Simplify.html#occAnalExpr"><span class="hs-identifier hs-var">occAnalExpr</span></a></span><span> </span><span id="local-6989586621679503396"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503396"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>  </span><span id="local-6989586621679503395"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503395"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-440"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type, String) -&gt; SimplFn (Expr Type, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679503396"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503395"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span class="hs-comment">-- | Run Ocurrence Analyser Over a Match Arm</span><span>
</span><span id="line-444"></span><span id="local-6989586621679503676"><span class="annot"><a href="IR.Simplify.html#occAnalAlt"><span class="hs-identifier hs-type">occAnalAlt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Alt"><span class="hs-identifier hs-type">I.Alt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503676"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Simplify.html#SimplFn"><span class="hs-identifier hs-type">SimplFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Alt"><span class="hs-identifier hs-type">I.Alt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679503676"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-445"></span><span id="occAnalAlt"><span class="annot"><span class="annottext">occAnalAlt :: Alt t -&gt; SimplFn (Alt t, String)
</span><a href="IR.Simplify.html#occAnalAlt"><span class="hs-identifier hs-var hs-var">occAnalAlt</span></a></span></span><span> </span><span id="local-6989586621679503394"><span class="annot"><span class="annottext">alt :: Alt t
</span><a href="#local-6989586621679503394"><span class="hs-identifier hs-var">alt</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#AltBinder"><span class="hs-identifier hs-type">I.AltBinder</span></a></span><span> </span><span id="local-6989586621679503392"><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503392"><span class="hs-identifier hs-var">binder</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Binder t -&gt; Maybe VarId
forall a. Binder a -&gt; Maybe VarId
</span><a href="IR.IR.html#binderToVar"><span class="hs-identifier hs-var">I.binderToVar</span></a></span><span> </span><span class="annot"><span class="annottext">Binder t
</span><a href="#local-6989586621679503392"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679503391"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503391"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; SimplFn ()
</span><a href="IR.Simplify.html#addOccVar"><span class="hs-identifier hs-var">addOccVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679503391"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-448"></span><span>    </span><span class="annot"><span class="annottext">Maybe VarId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; SimplFn ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>  </span><span id="local-6989586621679503390"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503390"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-450"></span><span>  </span><span class="annot"><span class="annottext">(Alt t, String) -&gt; SimplFn (Alt t, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt t
</span><a href="#local-6989586621679503394"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503390"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span class="annot"><a href="IR.Simplify.html#occAnalAlt"><span class="hs-identifier hs-var">occAnalAlt</span></a></span><span> </span><span id="local-6989586621679503389"><span class="annot"><span class="annottext">alt :: Alt t
</span><a href="#local-6989586621679503389"><span class="hs-identifier hs-var">alt</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#AltData"><span class="hs-identifier hs-type">I.AltData</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679503387"><span class="annot"><span class="annottext">[Alt t]
</span><a href="#local-6989586621679503387"><span class="hs-identifier hs-var">alts</span></a></span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-452"></span><span>  </span><span class="annot"><span class="annottext">(Alt t -&gt; SimplFn (Alt t, String)) -&gt; [Alt t] -&gt; SimplFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Alt t -&gt; SimplFn (Alt t, String)
forall t. Alt t -&gt; SimplFn (Alt t, String)
</span><a href="IR.Simplify.html#occAnalAlt"><span class="hs-identifier hs-var">occAnalAlt</span></a></span><span> </span><span class="annot"><span class="annottext">[Alt t]
</span><a href="#local-6989586621679503387"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-453"></span><span>  </span><span id="local-6989586621679503386"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503386"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-454"></span><span>  </span><span class="annot"><span class="annottext">(Alt t, String) -&gt; SimplFn (Alt t, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt t
</span><a href="#local-6989586621679503389"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503386"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span class="annot"><a href="IR.Simplify.html#occAnalAlt"><span class="hs-identifier hs-var">occAnalAlt</span></a></span><span> </span><span id="local-6989586621679503385"><span class="annot"><span class="annottext">Alt t
</span><a href="#local-6989586621679503385"><span class="hs-identifier hs-var">lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-456"></span><span>  </span><span id="local-6989586621679503384"><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503384"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SimplEnv -&gt; Map VarId OccInfo) -&gt; SimplFn (Map VarId OccInfo)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">SimplEnv -&gt; Map VarId OccInfo
</span><a href="IR.Simplify.html#occInfo"><span class="hs-identifier hs-var hs-var">occInfo</span></a></span><span>
</span><span id="line-457"></span><span>  </span><span class="annot"><span class="annottext">(Alt t, String) -&gt; SimplFn (Alt t, String)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt t
</span><a href="#local-6989586621679503385"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map VarId OccInfo
</span><a href="#local-6989586621679503384"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-458"></span></pre></body></html>