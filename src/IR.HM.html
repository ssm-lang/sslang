<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- | Infer types for IR of optionally annotated program using Hindley Milner
type inference algorithm with union find tree data structure.

There are three main stages of the algorithm
1. Assign symbolic typenames
   During this stage, we walk through each expression recursively, initialize
   its type by either assigning a fresh type variable or looking it up in the
   type context at that point, and generate a list of type equations to record
   the relationships between types. We also collapse the list of type
   annotations into the most specific one and put that information into a type
   equation as well to bring it into the later inference. Note that we will be
   modifying the expression monad simultaneously to record its new type info.
2. Solve type equations using unification.
   During this stage, we solve the type equations generated in the last stage
   and build a union find tree. This stage should be merged with stage 1 in the
   future.
3. Find the type of the expression.
   During this stage, we walk through each expression recursively and assign it
   with its inferred type by loop up the root of its temporary type in the union
  find tree.

The three stages are encaptured by the functions 'initTypeVars', 'unifyAll',
and 'getType'.

TODO:
- Define a partial order for the generality of types. The order will be used to
  (1) collapse type annotations into the most specific one; (2) check that
  type annotation is equal to or more specific than the expression's inferred
  type.
- Handle recursive function correctly.
-}</span><span>
</span><span id="line-32"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia #-}</span><span>
</span><span id="line-33"></span><span class="hs-pragma">{-# LANGUAGE BlockArguments #-}</span><span>
</span><span id="line-34"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IR.HM</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">forM_</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span>                 </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">second</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Common.Compiler.html"><span class="hs-identifier">Common.Compiler</span></a></span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Compiler</span></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.IR.html"><span class="hs-identifier">IR.IR</span></a></span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html"><span class="hs-identifier">IR.Types.Annotated</span></a></span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ann</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.Classes.html"><span class="hs-identifier">IR.Types.Classes</span></a></span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Classes</span></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Common.Identifiers.html"><span class="hs-identifier">Common.Identifiers</span></a></span><span>             </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier">Binder</span></a></span><span>
</span><span id="line-48"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier">Identifier</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier">TVarId</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromString</span></span><span>
</span><span id="line-51"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Comonad</span></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Comonad</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>           </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">MonadError</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zipWithM</span></span><span>
</span><span id="line-55"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zipWithM_</span></span><span>
</span><span id="line-56"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Lazy</span></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">MonadState</span></span><span>
</span><span id="line-58"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">StateT</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalStateT</span></span><span>
</span><span id="line-60"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">gets</span></span><span>
</span><span id="line-61"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">modify</span></span><span>
</span><span id="line-62"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">replicateM</span></span><span>
</span><span id="line-63"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="IR.Types.Classes.html"><span class="hs-identifier">IR.Types.Classes</span></a></span><span>               </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier">Scheme</span></a></span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#Forall"><span class="hs-identifier">Forall</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="IR.Types.TypeSystem.html"><span class="hs-identifier">IR.Types.TypeSystem</span></a></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#Builtin"><span class="hs-identifier">Builtin</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#TypeDef"><span class="hs-identifier">TypeDef</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#TypeVariant"><span class="hs-identifier">TypeVariant</span></a></span><span>
</span><span id="line-68"></span><span>                                                  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#VariantNamed"><span class="hs-identifier">VariantNamed</span></a></span><span>
</span><span id="line-69"></span><span>                                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#VariantUnnamed"><span class="hs-identifier">VariantUnnamed</span></a></span><span>
</span><span id="line-70"></span><span>                                                  </span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier">int</span></a></span><span>
</span><span id="line-72"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword">unit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#arrow"><span class="hs-identifier">arrow</span></a></span><span>
</span><span id="line-73"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">-- | Inference State.</span><span>
</span><span id="line-76"></span><span class="hs-keyword">data</span><span> </span><span id="InferState"><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-var">InferState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InferState"><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-var">InferState</span></a></span></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="varMap"><span class="annot"><span class="annottext">InferState -&gt; Map VarId Scheme
</span><a href="IR.HM.html#varMap"><span class="hs-identifier hs-var hs-var">varMap</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier hs-type">Classes.Scheme</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="equations"><span class="annot"><span class="annottext">InferState -&gt; [(Type, Type)]
</span><a href="IR.HM.html#equations"><span class="hs-identifier hs-var hs-var">equations</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="unionFindTree"><span class="annot"><span class="annottext">InferState -&gt; Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var hs-var">unionFindTree</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="count"><span class="annot"><span class="annottext">InferState -&gt; Int
</span><a href="IR.HM.html#count"><span class="hs-identifier hs-var hs-var">count</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="dConType"><span class="annot"><span class="annottext">InferState -&gt; Map DConId (TConId, [TVarId], [Type])
</span><a href="IR.HM.html#dConType"><span class="hs-identifier hs-var hs-var">dConType</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#DConId"><span class="hs-identifier hs-type">I.DConId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#TConId"><span class="hs-identifier hs-type">I.TConId</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier hs-type">TVarId</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">-- | Inference Monad.</span><span>
</span><span id="line-85"></span><span class="hs-keyword">newtype</span><span> </span><span id="InferFn"><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-var">InferFn</span></a></span></span><span> </span><span id="local-6989586621679474023"><span class="annot"><a href="#local-6989586621679474023"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InferFn"><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-var">InferFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-type">InferState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474023"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679474018"><span id="local-6989586621679474020"><span class="annot"><span class="annottext">a -&gt; InferFn b -&gt; InferFn a
(a -&gt; b) -&gt; InferFn a -&gt; InferFn b
(forall a b. (a -&gt; b) -&gt; InferFn a -&gt; InferFn b)
-&gt; (forall a b. a -&gt; InferFn b -&gt; InferFn a) -&gt; Functor InferFn
forall a b. a -&gt; InferFn b -&gt; InferFn a
forall a b. (a -&gt; b) -&gt; InferFn a -&gt; InferFn b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; InferFn b -&gt; InferFn a
$c&lt;$ :: forall a b. a -&gt; InferFn b -&gt; InferFn a
fmap :: (a -&gt; b) -&gt; InferFn a -&gt; InferFn b
$cfmap :: forall a b. (a -&gt; b) -&gt; InferFn a -&gt; InferFn b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span>                      </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-type">InferState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679474006"><span id="local-6989586621679474008"><span id="local-6989586621679474010"><span id="local-6989586621679474012"><span id="local-6989586621679474014"><span class="annot"><span class="annottext">Functor InferFn
a -&gt; InferFn a
Functor InferFn
-&gt; (forall a. a -&gt; InferFn a)
-&gt; (forall a b. InferFn (a -&gt; b) -&gt; InferFn a -&gt; InferFn b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; InferFn a -&gt; InferFn b -&gt; InferFn c)
-&gt; (forall a b. InferFn a -&gt; InferFn b -&gt; InferFn b)
-&gt; (forall a b. InferFn a -&gt; InferFn b -&gt; InferFn a)
-&gt; Applicative InferFn
InferFn a -&gt; InferFn b -&gt; InferFn b
InferFn a -&gt; InferFn b -&gt; InferFn a
InferFn (a -&gt; b) -&gt; InferFn a -&gt; InferFn b
(a -&gt; b -&gt; c) -&gt; InferFn a -&gt; InferFn b -&gt; InferFn c
forall a. a -&gt; InferFn a
forall a b. InferFn a -&gt; InferFn b -&gt; InferFn a
forall a b. InferFn a -&gt; InferFn b -&gt; InferFn b
forall a b. InferFn (a -&gt; b) -&gt; InferFn a -&gt; InferFn b
forall a b c. (a -&gt; b -&gt; c) -&gt; InferFn a -&gt; InferFn b -&gt; InferFn c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: InferFn a -&gt; InferFn b -&gt; InferFn a
$c&lt;* :: forall a b. InferFn a -&gt; InferFn b -&gt; InferFn a
*&gt; :: InferFn a -&gt; InferFn b -&gt; InferFn b
$c*&gt; :: forall a b. InferFn a -&gt; InferFn b -&gt; InferFn b
liftA2 :: (a -&gt; b -&gt; c) -&gt; InferFn a -&gt; InferFn b -&gt; InferFn c
$cliftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; InferFn a -&gt; InferFn b -&gt; InferFn c
&lt;*&gt; :: InferFn (a -&gt; b) -&gt; InferFn a -&gt; InferFn b
$c&lt;*&gt; :: forall a b. InferFn (a -&gt; b) -&gt; InferFn a -&gt; InferFn b
pure :: a -&gt; InferFn a
$cpure :: forall a. a -&gt; InferFn a
$cp1Applicative :: Functor InferFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span>                  </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-type">InferState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473998"><span id="local-6989586621679474000"><span id="local-6989586621679474002"><span class="annot"><span class="annottext">Applicative InferFn
a -&gt; InferFn a
Applicative InferFn
-&gt; (forall a b. InferFn a -&gt; (a -&gt; InferFn b) -&gt; InferFn b)
-&gt; (forall a b. InferFn a -&gt; InferFn b -&gt; InferFn b)
-&gt; (forall a. a -&gt; InferFn a)
-&gt; Monad InferFn
InferFn a -&gt; (a -&gt; InferFn b) -&gt; InferFn b
InferFn a -&gt; InferFn b -&gt; InferFn b
forall a. a -&gt; InferFn a
forall a b. InferFn a -&gt; InferFn b -&gt; InferFn b
forall a b. InferFn a -&gt; (a -&gt; InferFn b) -&gt; InferFn b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: a -&gt; InferFn a
$creturn :: forall a. a -&gt; InferFn a
&gt;&gt; :: InferFn a -&gt; InferFn b -&gt; InferFn b
$c&gt;&gt; :: forall a b. InferFn a -&gt; InferFn b -&gt; InferFn b
&gt;&gt;= :: InferFn a -&gt; (a -&gt; InferFn b) -&gt; InferFn b
$c&gt;&gt;= :: forall a b. InferFn a -&gt; (a -&gt; InferFn b) -&gt; InferFn b
$cp1Monad :: Applicative InferFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span>                        </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-type">InferState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679473994"><span class="annot"><span class="annottext">Monad InferFn
Monad InferFn
-&gt; (forall a. String -&gt; InferFn a) -&gt; MonadFail InferFn
String -&gt; InferFn a
forall a. String -&gt; InferFn a
forall (m :: * -&gt; *).
Monad m -&gt; (forall a. String -&gt; m a) -&gt; MonadFail m
fail :: String -&gt; InferFn a
$cfail :: forall a. String -&gt; InferFn a
$cp1MonadFail :: Monad InferFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadFail</span></span></span><span>                    </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-type">InferState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473988"><span id="local-6989586621679473990"><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Common.Compiler.html#Error"><span class="hs-identifier hs-type">Compiler.Error</span></a></span></span></span><span class="hs-special">)</span><span>  </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-type">InferState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473980"><span id="local-6989586621679473982"><span id="local-6989586621679473984"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-type">InferState</span></a></span></span></span></span><span class="hs-special">)</span><span>      </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="IR.HM.html#InferState"><span class="hs-identifier hs-type">InferState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">-- | Run a InferFn computation.</span><span>
</span><span id="line-94"></span><span id="local-6989586621679474160"><span class="annot"><a href="IR.HM.html#runInferFn"><span class="hs-identifier hs-type">runInferFn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474160"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474160"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-95"></span><span id="runInferFn"><span class="annot"><span class="annottext">runInferFn :: InferFn a -&gt; Pass a
</span><a href="IR.HM.html#runInferFn"><span class="hs-identifier hs-var hs-var">runInferFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span id="local-6989586621679473977"><span class="annot"><span class="annottext">StateT InferState Pass a
</span><a href="#local-6989586621679473977"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateT InferState Pass a -&gt; InferState -&gt; Pass a
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><span class="annottext">StateT InferState Pass a
</span><a href="#local-6989586621679473977"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><span class="annottext">InferState :: Map VarId Scheme
-&gt; [(Type, Type)]
-&gt; Map Type Type
-&gt; Int
-&gt; Map DConId (TConId, [TVarId], [Type])
-&gt; InferState
</span><a href="IR.HM.html#InferState"><span class="hs-identifier hs-type">InferState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">unionFindTree :: Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var">unionFindTree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Type Type
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-98"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">varMap :: Map VarId Scheme
</span><a href="IR.HM.html#varMap"><span class="hs-identifier hs-var">varMap</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Scheme
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-99"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">count :: Int
</span><a href="IR.HM.html#count"><span class="hs-identifier hs-var">count</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-100"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">equations :: [(Type, Type)]
</span><a href="IR.HM.html#equations"><span class="hs-identifier hs-var">equations</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-101"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dConType :: Map DConId (TConId, [TVarId], [Type])
</span><a href="IR.HM.html#dConType"><span class="hs-identifier hs-var">dConType</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map DConId (TConId, [TVarId], [Type])
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-102"></span><span>             </span><span class="hs-special">}</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">-- | 'inferProgram' @p@ infers the type of all the programDefs of the given program @p@.</span><span>
</span><span id="line-105"></span><span class="annot"><a href="IR.HM.html#inferProgram"><span class="hs-identifier hs-type">inferProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span id="inferProgram"><span class="annot"><span class="annottext">inferProgram :: Program Type -&gt; Pass (Program Type)
</span><a href="IR.HM.html#inferProgram"><span class="hs-identifier hs-var hs-var">inferProgram</span></a></span></span><span> </span><span id="local-6989586621679473974"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679473974"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InferFn (Program Type) -&gt; Pass (Program Type)
forall a. InferFn a -&gt; Pass a
</span><a href="IR.HM.html#runInferFn"><span class="hs-identifier hs-var">runInferFn</span></a></span><span> </span><span class="annot"><span class="annottext">(InferFn (Program Type) -&gt; Pass (Program Type))
-&gt; InferFn (Program Type) -&gt; Pass (Program Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621679473973"><span class="annot"><span class="annottext">[(TConId, TypeDef Type)]
</span><a href="#local-6989586621679473973"><span class="hs-identifier hs-var">typeDefs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(TConId, TypeDef Type)] -&gt; InferFn [(TConId, TypeDef Type)]
</span><a href="IR.HM.html#recordADTs"><span class="hs-identifier hs-var">recordADTs</span></a></span><span> </span><span class="annot"><span class="annottext">([(TConId, TypeDef Type)] -&gt; InferFn [(TConId, TypeDef Type)])
-&gt; [(TConId, TypeDef Type)] -&gt; InferFn [(TConId, TypeDef Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; [(TConId, TypeDef Type)]
forall t. Program t -&gt; [(TConId, TypeDef t)]
</span><a href="IR.IR.html#typeDefs"><span class="hs-identifier hs-var hs-var">I.typeDefs</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679473974"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span id="local-6989586621679473970"><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679473970"><span class="hs-identifier hs-var">externDecls'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)] -&gt; InferFn [(VarId, Type)]
</span><a href="IR.HM.html#recordExterns"><span class="hs-identifier hs-var">recordExterns</span></a></span><span> </span><span class="annot"><span class="annottext">([(VarId, Type)] -&gt; InferFn [(VarId, Type)])
-&gt; [(VarId, Type)] -&gt; InferFn [(VarId, Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; [(VarId, Type)]
forall t. Program t -&gt; [(VarId, t)]
</span><a href="IR.IR.html#externDecls"><span class="hs-identifier hs-var hs-var">I.externDecls</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679473974"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn ()
</span><a href="IR.HM.html#recordFDefs"><span class="hs-identifier hs-var">recordFDefs</span></a></span><span> </span><span class="annot"><span class="annottext">([(VarId, Expr Type)] -&gt; InferFn ())
-&gt; [(VarId, Expr Type)] -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; [(VarId, Expr Type)]
forall t. Program t -&gt; [(VarId, Expr t)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var hs-var">I.programDefs</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679473974"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span id="local-6989586621679473965"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473965"><span class="hs-identifier hs-var">defs'</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
</span><a href="IR.HM.html#inferProgramDefs"><span class="hs-identifier hs-var">inferProgramDefs</span></a></span><span> </span><span class="annot"><span class="annottext">([(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)])
-&gt; [(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; [(VarId, Expr Type)]
forall t. Program t -&gt; [(VarId, Expr t)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var hs-var">I.programDefs</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679473974"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><span class="annottext">Program Type -&gt; InferFn (Program Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Program Type -&gt; InferFn (Program Type))
-&gt; Program Type -&gt; InferFn (Program Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program :: forall t.
VarId
-&gt; String
-&gt; [(VarId, t)]
-&gt; [(VarId, Expr t)]
-&gt; [(TConId, TypeDef t)]
-&gt; Program t
</span><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">programDefs :: [(VarId, Expr Type)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var">I.programDefs</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473965"><span class="hs-identifier hs-var">defs'</span></a></span><span>
</span><span id="line-112"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">typeDefs :: [(TConId, TypeDef Type)]
</span><a href="IR.IR.html#typeDefs"><span class="hs-identifier hs-var">I.typeDefs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(TConId, TypeDef Type)]
</span><a href="#local-6989586621679473973"><span class="hs-identifier hs-var">typeDefs'</span></a></span><span>
</span><span id="line-113"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">programEntry :: VarId
</span><a href="IR.IR.html#programEntry"><span class="hs-identifier hs-var">I.programEntry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; VarId
forall t. Program t -&gt; VarId
</span><a href="IR.IR.html#programEntry"><span class="hs-identifier hs-var hs-var">I.programEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679473974"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-114"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cDefs :: String
</span><a href="IR.IR.html#cDefs"><span class="hs-identifier hs-var">I.cDefs</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; String
forall t. Program t -&gt; String
</span><a href="IR.IR.html#cDefs"><span class="hs-identifier hs-var hs-var">I.cDefs</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679473974"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-115"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">externDecls :: [(VarId, Type)]
</span><a href="IR.IR.html#externDecls"><span class="hs-identifier hs-var">I.externDecls</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679473970"><span class="hs-identifier hs-var">externDecls'</span></a></span><span>
</span><span id="line-116"></span><span>                     </span><span class="hs-special">}</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="hs-comment">-- | 'recordFDefs' saves information about all the declared functions for future use</span><span>
</span><span id="line-119"></span><span class="annot"><a href="IR.HM.html#recordFDefs"><span class="hs-identifier hs-type">recordFDefs</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span id="recordFDefs"><span class="annot"><span class="annottext">recordFDefs :: [(VarId, Expr Type)] -&gt; InferFn ()
</span><a href="IR.HM.html#recordFDefs"><span class="hs-identifier hs-var hs-var">recordFDefs</span></a></span></span><span> </span><span id="local-6989586621679473960"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473960"><span class="hs-identifier hs-var">fdefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-123"></span><span>  </span><span class="annot"><span class="annottext">((VarId, Expr Type) -&gt; InferFn ())
-&gt; [(VarId, Expr Type)] -&gt; InferFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">(VarId, Expr Type) -&gt; InferFn ()
</span><a href="#local-6989586621679473958"><span class="hs-identifier hs-var">recordFDef</span></a></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473960"><span class="hs-identifier hs-var">fdefs</span></a></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><a href="#local-6989586621679473958"><span class="hs-identifier hs-type">recordFDef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621679473958"><span class="annot"><span class="annottext">recordFDef :: (VarId, Expr Type) -&gt; InferFn ()
</span><a href="#local-6989586621679473958"><span class="hs-identifier hs-var hs-var">recordFDef</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473957"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473957"><span class="hs-identifier hs-var">fname</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>      </span><span id="local-6989586621679473956"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473956"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferFn Type
</span><a href="IR.HM.html#fresh"><span class="hs-identifier hs-var">fresh</span></a></span><span>
</span><span id="line-128"></span><span>      </span><span class="annot"><span class="annottext">VarId -&gt; Scheme -&gt; InferFn ()
</span><a href="IR.HM.html#insertVar"><span class="hs-identifier hs-var">insertVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473957"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">(Scheme -&gt; InferFn ()) -&gt; Scheme -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TVarId] -&gt; Type -&gt; Scheme
</span><a href="IR.Types.Classes.html#Forall"><span class="hs-identifier hs-var">Classes.Forall</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473956"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-comment">{- | 'recordADTs' saves information about ADTs in the Inference State for future use

saves type of DCon as a (DCon,TCon) key-value pair
transforms Ann.Type to Classes.Type
saves types of DCon args (the ADT fields) as (DCon, [type]) key-value pairs
-}</span><span>
</span><span id="line-136"></span><span class="annot"><a href="IR.HM.html#recordADTs"><span class="hs-identifier hs-type">recordADTs</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#TConId"><span class="hs-identifier hs-type">I.TConId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#TypeDef"><span class="hs-identifier hs-type">TypeDef</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#TConId"><span class="hs-identifier hs-type">I.TConId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#TypeDef"><span class="hs-identifier hs-type">TypeDef</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-139"></span><span id="recordADTs"><span class="annot"><span class="annottext">recordADTs :: [(TConId, TypeDef Type)] -&gt; InferFn [(TConId, TypeDef Type)]
</span><a href="IR.HM.html#recordADTs"><span class="hs-identifier hs-var hs-var">recordADTs</span></a></span></span><span> </span><span id="local-6989586621679473953"><span class="annot"><span class="annottext">[(TConId, TypeDef Type)]
</span><a href="#local-6989586621679473953"><span class="hs-identifier hs-var">defs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="annottext">[(TConId, TypeDef Type)]
-&gt; ((TConId, TypeDef Type) -&gt; InferFn ()) -&gt; InferFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(TConId, TypeDef Type)]
</span><a href="#local-6989586621679473953"><span class="hs-identifier hs-var">defs</span></a></span><span> </span><span class="annot"><span class="annottext">(((TConId, TypeDef Type) -&gt; InferFn ()) -&gt; InferFn ())
-&gt; ((TConId, TypeDef Type) -&gt; InferFn ()) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679473952"><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473952"><span class="hs-identifier hs-var">tcon</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#TypeDef"><span class="hs-identifier hs-type">TypeDef</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">variants :: forall t. TypeDef t -&gt; [(DConId, TypeVariant t)]
</span><a href="IR.Types.TypeSystem.html#variants"><span class="hs-identifier hs-var">variants</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679473949"><span class="annot"><span class="annottext">[(DConId, TypeVariant Type)]
</span><a href="#local-6989586621679473949"><span class="hs-identifier hs-var">vars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">targs :: forall t. TypeDef t -&gt; [TVarId]
</span><a href="IR.Types.TypeSystem.html#targs"><span class="hs-identifier hs-var">targs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679473947"><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473947"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><span class="annottext">((DConId, TypeVariant Type) -&gt; InferFn ())
-&gt; [(DConId, TypeVariant Type)] -&gt; InferFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TConId -&gt; [TVarId] -&gt; (DConId, TypeVariant Type) -&gt; InferFn ()
</span><a href="IR.HM.html#recordDCon"><span class="hs-identifier hs-var">recordDCon</span></a></span><span> </span><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473952"><span class="hs-identifier hs-var">tcon</span></a></span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473947"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(DConId, TypeVariant Type)]
</span><a href="#local-6989586621679473949"><span class="hs-identifier hs-var">vars</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><span class="annottext">[(TConId, TypeDef Type)] -&gt; InferFn [(TConId, TypeDef Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(TConId, TypeDef Type)] -&gt; InferFn [(TConId, TypeDef Type)])
-&gt; [(TConId, TypeDef Type)] -&gt; InferFn [(TConId, TypeDef Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeDef Type -&gt; TypeDef Type)
-&gt; (TConId, TypeDef Type) -&gt; (TConId, TypeDef Type)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; TypeDef Type -&gt; TypeDef Type
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TConId, TypeDef Type) -&gt; (TConId, TypeDef Type))
-&gt; [(TConId, TypeDef Type)] -&gt; [(TConId, TypeDef Type)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(TConId, TypeDef Type)]
</span><a href="#local-6989586621679473953"><span class="hs-identifier hs-var">defs</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="hs-comment">-- | 'insertType' inserts the overall type of an ADT's 'DConid' into the Inference State</span><span>
</span><span id="line-145"></span><span class="annot"><a href="IR.HM.html#recordDCon"><span class="hs-identifier hs-type">recordDCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#TConId"><span class="hs-identifier hs-type">I.TConId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier hs-type">TVarId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#DConId"><span class="hs-identifier hs-type">I.DConId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.TypeSystem.html#TypeVariant"><span class="hs-identifier hs-type">TypeVariant</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span id="recordDCon"><span class="annot"><span class="annottext">recordDCon :: TConId -&gt; [TVarId] -&gt; (DConId, TypeVariant Type) -&gt; InferFn ()
</span><a href="IR.HM.html#recordDCon"><span class="hs-identifier hs-var hs-var">recordDCon</span></a></span></span><span> </span><span id="local-6989586621679473943"><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473943"><span class="hs-identifier hs-var">tcon</span></a></span></span><span> </span><span id="local-6989586621679473942"><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473942"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473941"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473941"><span class="hs-identifier hs-var">dcon</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473940"><span class="annot"><span class="annottext">TypeVariant Type
</span><a href="#local-6989586621679473940"><span class="hs-identifier hs-var">variant</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473939"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473939"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473939"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">dConType :: Map DConId (TConId, [TVarId], [Type])
</span><a href="IR.HM.html#dConType"><span class="hs-identifier hs-var">dConType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DConId
-&gt; (TConId, [TVarId], [Type])
-&gt; Map DConId (TConId, [TVarId], [Type])
-&gt; Map DConId (TConId, [TVarId], [Type])
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473941"><span class="hs-identifier hs-var">dcon</span></a></span><span> </span><span class="annot"><span class="annottext">(TConId, [TVarId], [Type])
</span><a href="#local-6989586621679473937"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(Map DConId (TConId, [TVarId], [Type])
 -&gt; Map DConId (TConId, [TVarId], [Type]))
-&gt; Map DConId (TConId, [TVarId], [Type])
-&gt; Map DConId (TConId, [TVarId], [Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map DConId (TConId, [TVarId], [Type])
</span><a href="IR.HM.html#dConType"><span class="hs-identifier hs-var hs-var">dConType</span></a></span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473939"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679473937"><span class="annot"><span class="annottext">t :: (TConId, [TVarId], [Type])
</span><a href="#local-6989586621679473937"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473943"><span class="hs-identifier hs-var">tcon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473942"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473936"><span class="hs-identifier hs-var">argTypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>          </span><span id="local-6989586621679473936"><span class="annot"><span class="annottext">argTypes :: [Type]
</span><a href="#local-6989586621679473936"><span class="hs-identifier hs-var hs-var">argTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeVariant Type
</span><a href="#local-6989586621679473940"><span class="hs-identifier hs-var">variant</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-150"></span><span>              </span><span class="annot"><a href="IR.Types.TypeSystem.html#VariantNamed"><span class="hs-identifier hs-type">VariantNamed</span></a></span><span> </span><span id="local-6989586621679473935"><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679473935"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">((VarId, Type) -&gt; Type) -&gt; [(VarId, Type)] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VarId, Type) -&gt; Type
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679473935"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-151"></span><span>              </span><span class="annot"><a href="IR.Types.TypeSystem.html#VariantUnnamed"><span class="hs-identifier hs-type">VariantUnnamed</span></a></span><span> </span><span id="local-6989586621679473934"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473934"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473934"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">-- | Record the types of extern symbols.</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- NOTE: this does not actually check for arity and probably doesn't do</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- polymorphism correctly either.</span><span>
</span><span id="line-156"></span><span class="annot"><a href="IR.HM.html#recordExterns"><span class="hs-identifier hs-type">recordExterns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-157"></span><span id="recordExterns"><span class="annot"><span class="annottext">recordExterns :: [(VarId, Type)] -&gt; InferFn [(VarId, Type)]
</span><a href="IR.HM.html#recordExterns"><span class="hs-identifier hs-var hs-var">recordExterns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VarId, Type) -&gt; InferFn (VarId, Type))
-&gt; [(VarId, Type)] -&gt; InferFn [(VarId, Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(VarId, Type) -&gt; InferFn (VarId, Type)
</span><a href="#local-6989586621679473932"><span class="hs-identifier hs-var">recordExtern</span></a></span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679473932"><span class="annot"><span class="annottext">recordExtern :: (VarId, Type) -&gt; InferFn (VarId, Type)
</span><a href="#local-6989586621679473932"><span class="hs-identifier hs-var hs-var">recordExtern</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473931"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473931"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473930"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473930"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473929"><span class="annot"><span class="annottext">t' :: Type
</span><a href="#local-6989586621679473929"><span class="hs-identifier hs-var hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473930"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-160"></span><span>          </span><span class="annot"><span class="annottext">VarId -&gt; Scheme -&gt; InferFn ()
</span><a href="IR.HM.html#insertVar"><span class="hs-identifier hs-var">insertVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473931"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(Scheme -&gt; InferFn ()) -&gt; Scheme -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TVarId] -&gt; Type -&gt; Scheme
</span><a href="IR.Types.Classes.html#Forall"><span class="hs-identifier hs-var">Classes.Forall</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473929"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-161"></span><span>          </span><span class="annot"><span class="annottext">(VarId, Type) -&gt; InferFn (VarId, Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473931"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473929"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">-- recordExterns</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="hs-comment">-- | 'inferProgramDefs' @ds@ infers the type of programDefs @ds@ recursively and binds each varibale to its type.</span><span>
</span><span id="line-166"></span><span class="annot"><a href="IR.HM.html#inferProgramDefs"><span class="hs-identifier hs-type">inferProgramDefs</span></a></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-168"></span><span id="inferProgramDefs"><span class="annot"><span class="annottext">inferProgramDefs :: [(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
</span><a href="IR.HM.html#inferProgramDefs"><span class="hs-identifier hs-var hs-var">inferProgramDefs</span></a></span></span><span> </span><span id="local-6989586621679473928"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473928"><span class="hs-identifier hs-var">fdefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
</span><a href="IR.HM.html#initAllTypeVars"><span class="hs-identifier hs-var">initAllTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473928"><span class="hs-identifier hs-var">fdefs</span></a></span><span> </span><span class="annot"><span class="annottext">InferFn [(VarId, Expr Type)]
-&gt; ([(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)])
-&gt; InferFn [(VarId, Expr Type)]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
</span><a href="IR.HM.html#getAllTypes"><span class="hs-identifier hs-var">getAllTypes</span></a></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="hs-comment">-- | 'initAllTypeVars' initialize all the funcitons' type at once</span><span>
</span><span id="line-171"></span><span class="annot"><a href="IR.HM.html#initAllTypeVars"><span class="hs-identifier hs-type">initAllTypeVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-172"></span><span id="initAllTypeVars"><span class="annot"><span class="annottext">initAllTypeVars :: [(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
</span><a href="IR.HM.html#initAllTypeVars"><span class="hs-identifier hs-var hs-var">initAllTypeVars</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-173"></span><span class="annot"><a href="IR.HM.html#initAllTypeVars"><span class="hs-identifier hs-var">initAllTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679473925"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473925"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473924"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473924"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679473923"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473923"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-174"></span><span>  </span><span id="local-6989586621679473922"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473922"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473924"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-175"></span><span>  </span><span id="local-6989586621679473920"><span class="annot"><span class="annottext">Maybe Scheme
</span><a href="#local-6989586621679473920"><span class="hs-identifier hs-var">record</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; InferFn (Maybe Scheme)
</span><a href="IR.HM.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473925"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Scheme
</span><a href="#local-6989586621679473920"><span class="hs-identifier hs-var">record</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="annottext">Maybe Scheme
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>      </span><span class="annot"><span class="annottext">Error -&gt; InferFn ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><span class="annottext">(Error -&gt; InferFn ()) -&gt; Error -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><span class="annottext">(String -&gt; ErrorMsg) -&gt; String -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unbound variable: &quot;</span></span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473924"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679473915"><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473915"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-184"></span><span>      </span><span id="local-6989586621679473914"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473914"><span class="hs-identifier hs-var">t'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scheme -&gt; InferFn Type
</span><a href="IR.HM.html#instantiate"><span class="hs-identifier hs-var">instantiate</span></a></span><span> </span><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473915"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-185"></span><span>      </span><span class="annot"><span class="annottext">(Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var">insertEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473914"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473922"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><span class="annottext">InferFn ()
</span><a href="IR.HM.html#unifyAll"><span class="hs-identifier hs-var">unifyAll</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span id="local-6989586621679473909"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473909"><span class="hs-identifier hs-var">xs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
</span><a href="IR.HM.html#initAllTypeVars"><span class="hs-identifier hs-var">initAllTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473923"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)])
-&gt; [(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473925"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473922"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VarId, Expr Type) -&gt; [(VarId, Expr Type)] -&gt; [(VarId, Expr Type)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473909"><span class="hs-identifier hs-var">xs'</span></a></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- | 'getAllTypes' replace all the type variables in the initial funciton types</span><span>
</span><span id="line-191"></span><span class="annot"><a href="IR.HM.html#getAllTypes"><span class="hs-identifier hs-type">getAllTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-192"></span><span id="getAllTypes"><span class="annot"><span class="annottext">getAllTypes :: [(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
</span><a href="IR.HM.html#getAllTypes"><span class="hs-identifier hs-var hs-var">getAllTypes</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-193"></span><span class="annot"><a href="IR.HM.html#getAllTypes"><span class="hs-identifier hs-var">getAllTypes</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679473908"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473908"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473907"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473907"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679473906"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473906"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>  </span><span id="local-6989586621679473905"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473905"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473907"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span id="local-6989586621679473903"><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473903"><span class="hs-identifier hs-var">xs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
</span><a href="IR.HM.html#getAllTypes"><span class="hs-identifier hs-var">getAllTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473906"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><span class="annottext">[(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)])
-&gt; [(VarId, Expr Type)] -&gt; InferFn [(VarId, Expr Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473908"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473905"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(VarId, Expr Type) -&gt; [(VarId, Expr Type)] -&gt; [(VarId, Expr Type)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[(VarId, Expr Type)]
</span><a href="#local-6989586621679473903"><span class="hs-identifier hs-var">xs'</span></a></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | Class of things that may contain free type variables.</span><span>
</span><span id="line-199"></span><span class="hs-keyword">class</span><span> </span><span id="HasFreeTVars"><span class="annot"><a href="IR.HM.html#HasFreeTVars"><span class="hs-identifier hs-var">HasFreeTVars</span></a></span></span><span> </span><span id="local-6989586621679474114"><span class="annot"><a href="#local-6989586621679474114"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-200"></span><span>  </span><span id="freeTVars"><span class="annot"><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-type">freeTVars</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679474114"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier hs-type">TVarId</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="IR.HM.html#HasFreeTVars"><span class="hs-identifier hs-type">HasFreeTVars</span></a></span><span> </span><span class="annot"><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier hs-type">TVarId</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-203"></span><span>  </span><span id="local-6989586621679473899"><span class="annot"><span class="annottext">freeTVars :: TVarId -&gt; Set TVarId
</span><a href="#local-6989586621679473899"><span class="hs-identifier hs-var hs-var hs-var hs-var">freeTVars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVarId -&gt; Set TVarId
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="IR.HM.html#HasFreeTVars"><span class="hs-identifier hs-type">HasFreeTVars</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier hs-type">Classes.Scheme</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-comment">{- | Determines the set of free type variables inside a scheme @Forall ns t@.

  The free variables are those in the underlying type @t@ minus the
  variables quantified over by the scheme in @ns@.
  -}</span><span>
</span><span id="line-211"></span><span>  </span><span id="local-6989586621679473896"><span class="annot"><span class="annottext">freeTVars :: Scheme -&gt; Set TVarId
</span><a href="#local-6989586621679473896"><span class="hs-identifier hs-var hs-var hs-var hs-var">freeTVars</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#Forall"><span class="hs-identifier hs-type">Classes.Forall</span></a></span><span> </span><span id="local-6989586621679473895"><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473895"><span class="hs-identifier hs-var">ns</span></a></span></span><span> </span><span id="local-6989586621679473894"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473894"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set TVarId -&gt; Set TVarId -&gt; Set TVarId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.difference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473894"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TVarId] -&gt; Set TVarId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473895"><span class="hs-identifier hs-var">ns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="IR.HM.html#HasFreeTVars"><span class="hs-identifier hs-type">HasFreeTVars</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-214"></span><span>  </span><span id="local-6989586621679473890"><span class="annot"><span class="annottext">freeTVars :: Type -&gt; Set TVarId
</span><a href="#local-6989586621679473890"><span class="hs-identifier hs-var hs-var hs-var hs-var">freeTVars</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span id="local-6989586621679473888"><span class="annot"><span class="annottext">Builtin Type
</span><a href="#local-6989586621679473888"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="annot"><span class="annottext">Builtin Type
</span><a href="#local-6989586621679473888"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TCon"><span class="hs-identifier hs-type">Classes.TCon</span></a></span><span> </span><span class="annot"><span class="annottext">TConId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679473886"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473886"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473886"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-type">Classes.TVar</span></a></span><span> </span><span id="local-6989586621679473884"><span class="annot"><span class="annottext">TVarId
</span><a href="#local-6989586621679473884"><span class="hs-identifier hs-var">n</span></a></span></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVarId -&gt; Set TVarId
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="annot"><span class="annottext">TVarId
</span><a href="#local-6989586621679473884"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span id="local-6989586621679473883"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="IR.HM.html#HasFreeTVars"><span class="hs-identifier hs-type">HasFreeTVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473883"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#HasFreeTVars"><span class="hs-identifier hs-type">HasFreeTVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473883"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-219"></span><span>  </span><span id="local-6989586621679473881"><span class="annot"><span class="annottext">freeTVars :: Builtin t -&gt; Set TVarId
</span><a href="#local-6989586621679473881"><span class="hs-identifier hs-var hs-var hs-var hs-var">freeTVars</span></a></span></span><span> </span><span class="annot"><span class="annottext">Builtin t
</span><a href="IR.Types.TypeSystem.html#Unit"><span class="hs-identifier hs-var">Unit</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set TVarId
forall a. Set a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="annot"><span class="annottext">Builtin t
</span><a href="IR.Types.TypeSystem.html#Void"><span class="hs-identifier hs-var">Void</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set TVarId
forall a. Set a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-type">Ref</span></a></span><span> </span><span id="local-6989586621679473876"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473876"><span class="hs-identifier hs-var">t</span></a></span></span><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473876"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span id="local-6989586621679473874"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473874"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679473873"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473873"><span class="hs-identifier hs-var">r</span></a></span></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set TVarId -&gt; Set TVarId -&gt; Set TVarId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.union</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473874"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473873"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-type">Tuple</span></a></span><span>    </span><span id="local-6989586621679473870"><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621679473870"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[t] -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621679473870"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Integral"><span class="hs-identifier hs-type">Integral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set TVarId
forall a. Set a
</span><span class="hs-identifier hs-var">S.empty</span></span></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span id="local-6989586621679473868"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="IR.HM.html#HasFreeTVars"><span class="hs-identifier hs-type">HasFreeTVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473868"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#HasFreeTVars"><span class="hs-identifier hs-type">HasFreeTVars</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679473868"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-comment">-- | Lifts 'freeTVars' to lists.</span><span>
</span><span id="line-228"></span><span>  </span><span id="local-6989586621679473866"><span class="annot"><span class="annottext">freeTVars :: [a] -&gt; Set TVarId
</span><a href="#local-6989586621679473866"><span class="hs-identifier hs-var hs-var hs-var hs-var">freeTVars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Set TVarId -&gt; Set TVarId) -&gt; Set TVarId -&gt; [a] -&gt; Set TVarId
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set TVarId -&gt; Set TVarId -&gt; Set TVarId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.union</span></span><span> </span><span class="annot"><span class="annottext">(Set TVarId -&gt; Set TVarId -&gt; Set TVarId)
-&gt; (a -&gt; Set TVarId) -&gt; a -&gt; Set TVarId -&gt; Set TVarId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set TVarId
forall a. Set a
</span><span class="hs-identifier hs-var">S.empty</span></span></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-comment">{- | Instantiates the type from the scheme @Forall vs t@.

Create fresh type variable for each quantified type variable in @vs@ and
substitute them in @t@ by applying @subst@ to @t@.
-}</span><span>
</span><span id="line-235"></span><span class="annot"><a href="IR.HM.html#instantiate"><span class="hs-identifier hs-type">instantiate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier hs-type">Classes.Scheme</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span>
</span><span id="line-236"></span><span id="instantiate"><span class="annot"><span class="annottext">instantiate :: Scheme -&gt; InferFn Type
</span><a href="IR.HM.html#instantiate"><span class="hs-identifier hs-var hs-var">instantiate</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#Forall"><span class="hs-identifier hs-type">Classes.Forall</span></a></span><span> </span><span id="local-6989586621679473863"><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473863"><span class="hs-identifier hs-var">ns</span></a></span></span><span> </span><span id="local-6989586621679473862"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473862"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>  </span><span id="local-6989586621679473861"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473861"><span class="hs-identifier hs-var">ns'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TVarId -&gt; InferFn Type) -&gt; [TVarId] -&gt; InferFn [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InferFn Type -&gt; TVarId -&gt; InferFn Type
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">InferFn Type
</span><a href="IR.HM.html#fresh"><span class="hs-identifier hs-var">fresh</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473863"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="annottext">InferFn Type -&gt; InferFn Type
forall a. InferFn a -&gt; InferFn a
</span><a href="IR.HM.html#withNewTypeScope"><span class="hs-identifier hs-var">withNewTypeScope</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473858"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473858"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>      </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473858"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">unionFindTree :: Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var">unionFindTree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Type, Type)] -&gt; Map Type Type
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [(Type, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TVarId -&gt; Type) -&gt; [TVarId] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TVarId -&gt; Type
</span><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-var">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473863"><span class="hs-identifier hs-var">ns</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473861"><span class="hs-identifier hs-var">ns'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-241"></span><span>    </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473862"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="hs-comment">{- | Generalizes the type @t@ into a type scheme given the typing context @ctx@.

Collect all the free type variables in the type @t@ and all the free type
variables in the typing context @ctx@,
away any type variables that appear free in the type environment, and whatever
is leftover can be generalized into a type scheme.
-}</span><span>
</span><span id="line-250"></span><span class="annot"><a href="IR.HM.html#generalize"><span class="hs-identifier hs-type">generalize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier hs-type">Classes.Scheme</span></a></span><span>
</span><span id="line-251"></span><span id="generalize"><span class="annot"><span class="annottext">generalize :: Type -&gt; InferFn Scheme
</span><a href="IR.HM.html#generalize"><span class="hs-identifier hs-var hs-var">generalize</span></a></span></span><span> </span><span id="local-6989586621679473854"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473854"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-252"></span><span>  </span><span id="local-6989586621679473853"><span class="annot"><span class="annottext">Map VarId Scheme
</span><a href="#local-6989586621679473853"><span class="hs-identifier hs-var">vm</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; Map VarId Scheme) -&gt; InferFn (Map VarId Scheme)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map VarId Scheme
</span><a href="IR.HM.html#varMap"><span class="hs-identifier hs-var hs-var">varMap</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span id="local-6989586621679473852"><span class="annot"><span class="annottext">Map Type Type
</span><a href="#local-6989586621679473852"><span class="hs-identifier hs-var">uft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; Map Type Type) -&gt; InferFn (Map Type Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var hs-var">unionFindTree</span></a></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473851"><span class="annot"><span class="annottext">vs :: [TVarId]
</span><a href="#local-6989586621679473851"><span class="hs-identifier hs-var hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set TVarId -&gt; [TVarId]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set TVarId -&gt; [TVarId]) -&gt; Set TVarId -&gt; [TVarId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set TVarId -&gt; Set TVarId -&gt; Set TVarId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.difference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473854"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Set TVarId -&gt; Set TVarId) -&gt; Set TVarId -&gt; Set TVarId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set TVarId -&gt; Set TVarId -&gt; Set TVarId
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.union</span></span><span>
</span><span id="line-255"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Type Type -&gt; [Type]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">Map Type Type
</span><a href="#local-6989586621679473852"><span class="hs-identifier hs-var">uft</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Scheme] -&gt; Set TVarId
forall a. HasFreeTVars a =&gt; a -&gt; Set TVarId
</span><a href="IR.HM.html#freeTVars"><span class="hs-identifier hs-var">freeTVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VarId Scheme -&gt; [Scheme]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">Map VarId Scheme
</span><a href="#local-6989586621679473853"><span class="hs-identifier hs-var">vm</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">Scheme -&gt; InferFn Scheme
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Scheme -&gt; InferFn Scheme) -&gt; Scheme -&gt; InferFn Scheme
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TVarId] -&gt; Type -&gt; Scheme
</span><a href="IR.Types.Classes.html#Forall"><span class="hs-identifier hs-var">Classes.Forall</span></a></span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473851"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473854"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="hs-comment">-- | 'letters' represents list of identifiers to be used to construct free type</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- variables assigned during type inference. The leading '_' distinguish them</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- from user-annotated type variables.</span><span>
</span><span id="line-262"></span><span class="annot"><a href="IR.HM.html#letters"><span class="hs-identifier hs-type">letters</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span>
</span><span id="line-263"></span><span id="letters"><span class="annot"><span class="annottext">letters :: [String]
</span><a href="IR.HM.html#letters"><span class="hs-identifier hs-var hs-var">letters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'_'</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; String -&gt; String
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([String] -&gt; [String]) -&gt; [String] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; [String]) -&gt; [String]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; String -&gt; [String]) -&gt; String -&gt; Int -&gt; [String]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String -&gt; [String]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'a'</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'z'</span></span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">-- | @dummyAnnT@ represents empty type annotation list.</span><span>
</span><span id="line-266"></span><span class="annot"><a href="IR.HM.html#dummyAnnT"><span class="hs-identifier hs-type">dummyAnnT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span>
</span><span id="line-267"></span><span id="dummyAnnT"><span class="annot"><span class="annottext">dummyAnnT :: Type
</span><a href="IR.HM.html#dummyAnnT"><span class="hs-identifier hs-var hs-var">dummyAnnT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVarId -&gt; Type
</span><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-var">Classes.TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Identifier -&gt; TVarId
</span><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier hs-var">TVarId</span></a></span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; TVarId) -&gt; Identifier -&gt; TVarId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Identifier
</span><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-var">Identifier</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-comment">-- | Generates a new 'TVar' using the next tick number and increment the counter.</span><span>
</span><span id="line-270"></span><span class="annot"><a href="IR.HM.html#fresh"><span class="hs-identifier hs-type">fresh</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span>
</span><span id="line-271"></span><span id="fresh"><span class="annot"><span class="annottext">fresh :: InferFn Type
</span><a href="IR.HM.html#fresh"><span class="hs-identifier hs-var hs-var">fresh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-272"></span><span>  </span><span id="local-6989586621679473843"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679473843"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; Int) -&gt; InferFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Int
</span><a href="IR.HM.html#count"><span class="hs-identifier hs-var hs-var">count</span></a></span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473842"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621679473842"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVarId -&gt; Type
</span><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-var">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TVarId -&gt; Type) -&gt; TVarId -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identifier -&gt; TVarId
</span><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier hs-var">TVarId</span></a></span><span> </span><span class="annot"><span class="annottext">(Identifier -&gt; TVarId) -&gt; Identifier -&gt; TVarId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Identifier
</span><a href="Common.Identifiers.html#Identifier"><span class="hs-identifier hs-var">Identifier</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String]
</span><a href="IR.HM.html#letters"><span class="hs-identifier hs-var">letters</span></a></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; Int -&gt; String
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679473843"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473840"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473840"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473840"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">count :: Int
</span><a href="IR.HM.html#count"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679473843"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-275"></span><span>  </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473842"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span class="hs-comment">-- | 'lookupVar' @v@ looks up the type scheme of a variable in the current 'varMap' given its variable ID @v@.</span><span>
</span><span id="line-278"></span><span class="annot"><a href="IR.HM.html#lookupVar"><span class="hs-identifier hs-type">lookupVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier hs-type">Classes.Scheme</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span id="lookupVar"><span class="annot"><span class="annottext">lookupVar :: VarId -&gt; InferFn (Maybe Scheme)
</span><a href="IR.HM.html#lookupVar"><span class="hs-identifier hs-var hs-var">lookupVar</span></a></span></span><span> </span><span id="local-6989586621679473838"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473838"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId Scheme -&gt; Maybe Scheme
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473838"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VarId Scheme -&gt; Maybe Scheme)
-&gt; InferFn (Map VarId Scheme) -&gt; InferFn (Maybe Scheme)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; Map VarId Scheme) -&gt; InferFn (Map VarId Scheme)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map VarId Scheme
</span><a href="IR.HM.html#varMap"><span class="hs-identifier hs-var hs-var">varMap</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span class="hs-comment">-- | Look up the type of a data constructor in the inference state.</span><span>
</span><span id="line-282"></span><span class="annot"><a href="IR.HM.html#lookupDCon"><span class="hs-identifier hs-type">lookupDCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#DConId"><span class="hs-identifier hs-type">I.DConId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier hs-type">Classes.Scheme</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span id="lookupDCon"><span class="annot"><span class="annottext">lookupDCon :: DConId -&gt; InferFn (Maybe Scheme)
</span><a href="IR.HM.html#lookupDCon"><span class="hs-identifier hs-var hs-var">lookupDCon</span></a></span></span><span> </span><span id="local-6989586621679473835"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473835"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TConId, [TVarId], [Type]) -&gt; Scheme)
-&gt; Maybe (TConId, [TVarId], [Type]) -&gt; Maybe Scheme
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(TConId, [TVarId], [Type]) -&gt; Scheme
</span><a href="#local-6989586621679473834"><span class="hs-identifier hs-var">buildScheme</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (TConId, [TVarId], [Type]) -&gt; Maybe Scheme)
-&gt; (Map DConId (TConId, [TVarId], [Type])
    -&gt; Maybe (TConId, [TVarId], [Type]))
-&gt; Map DConId (TConId, [TVarId], [Type])
-&gt; Maybe Scheme
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DConId
-&gt; Map DConId (TConId, [TVarId], [Type])
-&gt; Maybe (TConId, [TVarId], [Type])
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473835"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">(Map DConId (TConId, [TVarId], [Type]) -&gt; Maybe Scheme)
-&gt; InferFn (Map DConId (TConId, [TVarId], [Type]))
-&gt; InferFn (Maybe Scheme)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; Map DConId (TConId, [TVarId], [Type]))
-&gt; InferFn (Map DConId (TConId, [TVarId], [Type]))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map DConId (TConId, [TVarId], [Type])
</span><a href="IR.HM.html#dConType"><span class="hs-identifier hs-var hs-var">dConType</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-285"></span><span>      </span><span class="annot"><a href="#local-6989586621679473834"><span class="hs-identifier hs-type">buildScheme</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#TConId"><span class="hs-identifier hs-type">I.TConId</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Common.Identifiers.html#TVarId"><span class="hs-identifier hs-type">TVarId</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier hs-type">Classes.Scheme</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span id="local-6989586621679473834"><span class="annot"><span class="annottext">buildScheme :: (TConId, [TVarId], [Type]) -&gt; Scheme
</span><a href="#local-6989586621679473834"><span class="hs-identifier hs-var hs-var">buildScheme</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473833"><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473833"><span class="hs-identifier hs-var">tcon</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473832"><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473832"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473831"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473831"><span class="hs-identifier hs-var">ats</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-287"></span><span>        </span><span class="annot"><span class="annottext">[TVarId] -&gt; Type -&gt; Scheme
</span><a href="IR.Types.Classes.html#Forall"><span class="hs-identifier hs-var">Classes.Forall</span></a></span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473832"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Scheme) -&gt; Type -&gt; Scheme
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type -&gt; Type) -&gt; Type -&gt; [Type] -&gt; Type
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
forall t. TypeSystem t =&gt; t -&gt; t -&gt; t
</span><a href="IR.Types.TypeSystem.html#arrow"><span class="hs-identifier hs-var">arrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TConId -&gt; [Type] -&gt; Type
</span><a href="IR.Types.Classes.html#TCon"><span class="hs-identifier hs-var">Classes.TCon</span></a></span><span> </span><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473833"><span class="hs-identifier hs-var">tcon</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TVarId -&gt; Type) -&gt; [TVarId] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TVarId -&gt; Type
</span><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-var">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473832"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473831"><span class="hs-identifier hs-var">ats</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="hs-comment">-- | 'insertVar' @v t@ Insert a variable ID and its type scheme into current 'varMap'.</span><span>
</span><span id="line-290"></span><span class="annot"><a href="IR.HM.html#insertVar"><span class="hs-identifier hs-type">insertVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier hs-type">Classes.Scheme</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span id="insertVar"><span class="annot"><span class="annottext">insertVar :: VarId -&gt; Scheme -&gt; InferFn ()
</span><a href="IR.HM.html#insertVar"><span class="hs-identifier hs-var hs-var">insertVar</span></a></span></span><span> </span><span id="local-6989586621679473830"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473830"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679473829"><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473829"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473828"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473828"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473828"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">varMap :: Map VarId Scheme
</span><a href="IR.HM.html#varMap"><span class="hs-identifier hs-var">varMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Scheme -&gt; Map VarId Scheme -&gt; Map VarId Scheme
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473830"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473829"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VarId Scheme -&gt; Map VarId Scheme)
-&gt; Map VarId Scheme -&gt; Map VarId Scheme
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map VarId Scheme
</span><a href="IR.HM.html#varMap"><span class="hs-identifier hs-var hs-var">varMap</span></a></span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473828"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-comment">-- | 'insertBinder' is a wrapper of 'insertVar' for 'Binder' type.</span><span>
</span><span id="line-294"></span><span class="annot"><a href="IR.HM.html#insertBinder"><span class="hs-identifier hs-type">insertBinder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">Binder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Scheme"><span class="hs-identifier hs-type">Classes.Scheme</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span id="insertBinder"><span class="annot"><span class="annottext">insertBinder :: Binder -&gt; Scheme -&gt; InferFn ()
</span><a href="IR.HM.html#insertBinder"><span class="hs-identifier hs-var hs-var">insertBinder</span></a></span></span><span> </span><span class="annot"><span class="annottext">Binder
</span><span class="hs-identifier hs-var">Nothing</span></span><span>    </span><span class="annot"><span class="annottext">Scheme
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; InferFn ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span class="annot"><a href="IR.HM.html#insertBinder"><span class="hs-identifier hs-var">insertBinder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679473826"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473826"><span class="hs-identifier hs-var">vid</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473825"><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473825"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Scheme -&gt; InferFn ()
</span><a href="IR.HM.html#insertVar"><span class="hs-identifier hs-var">insertVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473826"><span class="hs-identifier hs-var">vid</span></a></span><span> </span><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473825"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="hs-comment">-- | 'insertEquation' @e@ inserts @e@ into the current 'equations' list.</span><span>
</span><span id="line-299"></span><span class="annot"><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-type">insertEquation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span id="insertEquation"><span class="annot"><span class="annottext">insertEquation :: (Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var hs-var">insertEquation</span></a></span></span><span> </span><span id="local-6989586621679473824"><span class="annot"><span class="annottext">(Type, Type)
</span><a href="#local-6989586621679473824"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473823"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473823"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473823"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">equations :: [(Type, Type)]
</span><a href="IR.HM.html#equations"><span class="hs-identifier hs-var">equations</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type, Type)
</span><a href="#local-6989586621679473824"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">(Type, Type) -&gt; [(Type, Type)] -&gt; [(Type, Type)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; [(Type, Type)]
</span><a href="IR.HM.html#equations"><span class="hs-identifier hs-var hs-var">equations</span></a></span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473823"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-comment">-- | 'insertUnion' @t1 t2@ inserts @t1 : t2@ into the current 'unionFindTree'.</span><span>
</span><span id="line-303"></span><span class="annot"><a href="IR.HM.html#insertUnion"><span class="hs-identifier hs-type">insertUnion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span id="insertUnion"><span class="annot"><span class="annottext">insertUnion :: Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#insertUnion"><span class="hs-identifier hs-var hs-var">insertUnion</span></a></span></span><span> </span><span id="local-6989586621679473821"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473821"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621679473820"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473820"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473819"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473819"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473819"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">unionFindTree :: Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var">unionFindTree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Map Type Type -&gt; Map Type Type
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473821"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473820"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Type Type -&gt; Map Type Type) -&gt; Map Type Type -&gt; Map Type Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var hs-var">unionFindTree</span></a></span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473819"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="hs-comment">-- | Helper function to support local modificaton of 'varMap'.</span><span>
</span><span id="line-308"></span><span id="local-6989586621679473818"><span class="annot"><a href="IR.HM.html#withNewScope"><span class="hs-identifier hs-type">withNewScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473818"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679473818"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-309"></span><span id="withNewScope"><span class="annot"><span class="annottext">withNewScope :: InferFn a -&gt; InferFn a
</span><a href="IR.HM.html#withNewScope"><span class="hs-identifier hs-var hs-var">withNewScope</span></a></span></span><span> </span><span id="local-6989586621679473816"><span class="annot"><span class="annottext">InferFn a
</span><a href="#local-6989586621679473816"><span class="hs-identifier hs-var">inf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>  </span><span id="local-6989586621679473815"><span class="annot"><span class="annottext">Map VarId Scheme
</span><a href="#local-6989586621679473815"><span class="hs-identifier hs-var">vm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; Map VarId Scheme) -&gt; InferFn (Map VarId Scheme)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map VarId Scheme
</span><a href="IR.HM.html#varMap"><span class="hs-identifier hs-var hs-var">varMap</span></a></span><span>
</span><span id="line-311"></span><span>  </span><span id="local-6989586621679473814"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679473814"><span class="hs-identifier hs-var">x</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferFn a
</span><a href="#local-6989586621679473816"><span class="hs-identifier hs-var">inf</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473813"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473813"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473813"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">varMap :: Map VarId Scheme
</span><a href="IR.HM.html#varMap"><span class="hs-identifier hs-var">varMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Scheme
</span><a href="#local-6989586621679473815"><span class="hs-identifier hs-var">vm</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-313"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; InferFn a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679473814"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="hs-comment">-- | Helper function to support local modificaton of 'unionFindTree'.</span><span>
</span><span id="line-316"></span><span id="local-6989586621679474098"><span class="annot"><a href="IR.HM.html#withNewTypeScope"><span class="hs-identifier hs-type">withNewTypeScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474098"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679474098"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-317"></span><span id="withNewTypeScope"><span class="annot"><span class="annottext">withNewTypeScope :: InferFn a -&gt; InferFn a
</span><a href="IR.HM.html#withNewTypeScope"><span class="hs-identifier hs-var hs-var">withNewTypeScope</span></a></span></span><span> </span><span id="local-6989586621679473812"><span class="annot"><span class="annottext">InferFn a
</span><a href="#local-6989586621679473812"><span class="hs-identifier hs-var">inf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>  </span><span id="local-6989586621679473811"><span class="annot"><span class="annottext">Map Type Type
</span><a href="#local-6989586621679473811"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; Map Type Type) -&gt; InferFn (Map Type Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var hs-var">unionFindTree</span></a></span><span>
</span><span id="line-319"></span><span>  </span><span id="local-6989586621679473810"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679473810"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferFn a
</span><a href="#local-6989586621679473812"><span class="hs-identifier hs-var">inf</span></a></span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473809"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473809"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473809"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">unionFindTree :: Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var">unionFindTree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Type Type
</span><a href="#local-6989586621679473811"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-321"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; InferFn a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679473810"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span class="hs-comment">-- | Helper function to collapse a list of type annotation to a single one with</span><span>
</span><span id="line-324"></span><span class="hs-comment">-- 'Classes.type' type. If the list is empty, use</span><span>
</span><span id="line-325"></span><span class="hs-comment">-- @Classes.TVar (TVarId $ Identifier &quot;_&quot;))@ to denote a dummy annotation.</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- TODO: Currently just take the first type annotation of the list as the</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- result. Need to implement the 'collapse' step to find and return the most</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- specific type annotation from the list. Need yo add support for annotating</span><span>
</span><span id="line-329"></span><span class="hs-comment">-- type variables as well.</span><span>
</span><span id="line-330"></span><span class="annot"><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-type">collapseAnnT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span>
</span><span id="line-331"></span><span id="collapseAnnT"><span class="annot"><span class="annottext">collapseAnnT :: Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var hs-var">collapseAnnT</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.HM.html#dummyAnnT"><span class="hs-identifier hs-var">dummyAnnT</span></a></span><span>
</span><span id="line-332"></span><span class="annot"><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span> </span><span id="local-6989586621679473807"><span class="annot"><span class="annottext">[TypeAnnote]
</span><a href="#local-6989586621679473807"><span class="hs-identifier hs-var">anns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[TypeAnnote] -&gt; TypeAnnote
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">[TypeAnnote]
</span><a href="#local-6989586621679473807"><span class="hs-identifier hs-var">anns</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-333"></span><span>  </span><span class="annot"><a href="IR.Types.Annotated.html#TBuiltin"><span class="hs-identifier hs-type">Ann.TBuiltin</span></a></span><span> </span><span id="local-6989586621679473804"><span class="annot"><span class="annottext">Builtin Type
</span><a href="#local-6989586621679473804"><span class="hs-identifier hs-var">tb</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">(Builtin Type -&gt; Type) -&gt; Builtin Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Builtin Type -&gt; Builtin Type
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Builtin Type
</span><a href="#local-6989586621679473804"><span class="hs-identifier hs-var">tb</span></a></span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><a href="IR.Types.Annotated.html#TVar"><span class="hs-identifier hs-type">Ann.TVar</span></a></span><span>     </span><span id="local-6989586621679473802"><span class="annot"><span class="annottext">TVarId
</span><a href="#local-6989586621679473802"><span class="hs-identifier hs-var">tvar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVarId -&gt; Type
</span><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-var">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVarId
</span><a href="#local-6989586621679473802"><span class="hs-identifier hs-var">tvar</span></a></span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><a href="IR.Types.Annotated.html#TCon"><span class="hs-identifier hs-type">Ann.TCon</span></a></span><span> </span><span id="local-6989586621679473800"><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473800"><span class="hs-identifier hs-var">tcon</span></a></span></span><span> </span><span id="local-6989586621679473799"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473799"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TConId -&gt; [Type] -&gt; Type
</span><a href="IR.Types.Classes.html#TCon"><span class="hs-identifier hs-var">Classes.TCon</span></a></span><span> </span><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473800"><span class="hs-identifier hs-var">tcon</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; Type) -&gt; [Type] -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473799"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="hs-comment">{- | Stage 1: Assign symbolic typenames

'initTypeVars' @e@ walks into the expression @e@ recursively, assign a fresh
'TVar' to each unknown type, and build type equations that will be solved later.
-}</span><span>
</span><span id="line-342"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-type">initTypeVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span id="initTypeVars"><span class="annot"><span class="annottext">initTypeVars :: Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var hs-var">initTypeVars</span></a></span></span><span> </span><span id="local-6989586621679473798"><span class="annot"><span class="annottext">e :: Expr Type
</span><a href="#local-6989586621679473798"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Var"><span class="hs-identifier hs-type">I.Var</span></a></span><span> </span><span id="local-6989586621679473796"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473796"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679473795"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473795"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473794"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473794"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473795"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span id="local-6989586621679473793"><span class="annot"><span class="annottext">Maybe Scheme
</span><a href="#local-6989586621679473793"><span class="hs-identifier hs-var">record</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; InferFn (Maybe Scheme)
</span><a href="IR.HM.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473796"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-346"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Scheme
</span><a href="#local-6989586621679473793"><span class="hs-identifier hs-var">record</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><span class="annottext">Maybe Scheme
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-348"></span><span>      </span><span class="annot"><span class="annottext">Error -&gt; InferFn (Expr Type)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-349"></span><span>        </span><span class="annot"><span class="annottext">(Error -&gt; InferFn (Expr Type)) -&gt; Error -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="annottext">(String -&gt; ErrorMsg) -&gt; String -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unbound variable: &quot;</span></span><span>
</span><span id="line-352"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473798"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679473792"><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473792"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>      </span><span id="local-6989586621679473791"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473791"><span class="hs-identifier hs-var">t'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scheme -&gt; InferFn Type
</span><a href="IR.HM.html#instantiate"><span class="hs-identifier hs-var">instantiate</span></a></span><span> </span><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473792"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-355"></span><span>      </span><span id="local-6989586621679473790"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473790"><span class="hs-identifier hs-var">t''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473794"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473791"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-356"></span><span>      </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Expr Type
forall t. VarId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Var"><span class="hs-identifier hs-var">I.Var</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473796"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473790"><span class="hs-identifier hs-var">t''</span></a></span><span>
</span><span id="line-357"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span> </span><span id="local-6989586621679473787"><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473787"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679473786"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473786"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679473785"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473785"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473784"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473784"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473785"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-359"></span><span>  </span><span id="local-6989586621679473783"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473783"><span class="hs-identifier hs-var">tin</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferFn Type
</span><a href="IR.HM.html#fresh"><span class="hs-identifier hs-var">fresh</span></a></span><span>
</span><span id="line-360"></span><span>  </span><span id="local-6989586621679473782"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473782"><span class="hs-identifier hs-var">b'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferFn (Expr Type) -&gt; InferFn (Expr Type)
forall a. InferFn a -&gt; InferFn a
</span><a href="IR.HM.html#withNewScope"><span class="hs-identifier hs-var">withNewScope</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-361"></span><span>    </span><span class="annot"><span class="annottext">Binder -&gt; Scheme -&gt; InferFn ()
</span><a href="IR.HM.html#insertBinder"><span class="hs-identifier hs-var">insertBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473787"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TVarId] -&gt; Type -&gt; Scheme
</span><a href="IR.Types.Classes.html#Forall"><span class="hs-identifier hs-var">Classes.Forall</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473783"><span class="hs-identifier hs-var">tin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473786"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-363"></span><span>  </span><span id="local-6989586621679473781"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473781"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473784"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">(Builtin Type -&gt; Type) -&gt; Builtin Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Builtin Type
forall t. t -&gt; t -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473783"><span class="hs-identifier hs-var">tin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473782"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Binder -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Binder -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-var">I.Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473787"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473782"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473781"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-365"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Let"><span class="hs-identifier hs-type">I.Let</span></a></span><span> </span><span id="local-6989586621679473779"><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679473779"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span id="local-6989586621679473778"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473778"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679473777"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473777"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473776"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473776"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473777"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679473775"><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679473775"><span class="hs-identifier hs-var">vs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473774"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473774"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferFn ([(Binder, Expr Type)], Expr Type)
-&gt; InferFn ([(Binder, Expr Type)], Expr Type)
forall a. InferFn a -&gt; InferFn a
</span><a href="IR.HM.html#withNewScope"><span class="hs-identifier hs-var">withNewScope</span></a></span><span> </span><span class="annot"><span class="annottext">(InferFn ([(Binder, Expr Type)], Expr Type)
 -&gt; InferFn ([(Binder, Expr Type)], Expr Type))
-&gt; InferFn ([(Binder, Expr Type)], Expr Type)
-&gt; InferFn ([(Binder, Expr Type)], Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)]
-&gt; Expr Type -&gt; InferFn ([(Binder, Expr Type)], Expr Type)
forall (t :: * -&gt; *).
Traversable t =&gt;
t (Binder, Expr Type)
-&gt; Expr Type -&gt; InferFn (t (Binder, Expr Type), Expr Type)
</span><a href="#local-6989586621679473773"><span class="hs-identifier hs-var">localinitTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679473779"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473778"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-368"></span><span>  </span><span id="local-6989586621679473772"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473772"><span class="hs-identifier hs-var">t</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473776"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473774"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)] -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. [(Binder, Expr t)] -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Let"><span class="hs-identifier hs-var">I.Let</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679473775"><span class="hs-identifier hs-var">vs'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473774"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473772"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-370"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-371"></span><span>  </span><span id="local-6989586621679473773"><span class="annot"><span class="annottext">localinitTypeVars :: t (Binder, Expr Type)
-&gt; Expr Type -&gt; InferFn (t (Binder, Expr Type), Expr Type)
</span><a href="#local-6989586621679473773"><span class="hs-identifier hs-var hs-var">localinitTypeVars</span></a></span></span><span> </span><span id="local-6989586621679473771"><span class="annot"><span class="annottext">t (Binder, Expr Type)
</span><a href="#local-6989586621679473771"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679473770"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473770"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>    </span><span id="local-6989586621679473769"><span class="annot"><span class="annottext">t (Binder, Expr Type)
</span><a href="#local-6989586621679473769"><span class="hs-identifier hs-var">bs'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Binder, Expr Type) -&gt; InferFn (Binder, Expr Type))
-&gt; t (Binder, Expr Type) -&gt; InferFn (t (Binder, Expr Type))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Binder, Expr Type) -&gt; InferFn (Binder, Expr Type)
</span><a href="#local-6989586621679473768"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">t (Binder, Expr Type)
</span><a href="#local-6989586621679473771"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span id="local-6989586621679473767"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473767"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473770"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span class="annot"><span class="annottext">(t (Binder, Expr Type), Expr Type)
-&gt; InferFn (t (Binder, Expr Type), Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t (Binder, Expr Type)
</span><a href="#local-6989586621679473769"><span class="hs-identifier hs-var">bs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473767"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-376"></span><span>    </span><span id="local-6989586621679473768"><span class="annot"><span class="annottext">fn :: (Binder, Expr Type) -&gt; InferFn (Binder, Expr Type)
</span><a href="#local-6989586621679473768"><span class="hs-identifier hs-var hs-var">fn</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473766"><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473766"><span class="hs-identifier hs-var">binder</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473765"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473765"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-377"></span><span>      </span><span id="local-6989586621679473764"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473764"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473765"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-378"></span><span>      </span><span class="annot"><span class="annottext">InferFn ()
</span><a href="IR.HM.html#unifyAll"><span class="hs-identifier hs-var">unifyAll</span></a></span><span>
</span><span id="line-379"></span><span>      </span><span id="local-6989586621679473763"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473763"><span class="hs-identifier hs-var">e''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473764"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-380"></span><span>      </span><span id="local-6989586621679473762"><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473762"><span class="hs-identifier hs-var">s</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Scheme
</span><a href="IR.HM.html#generalize"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Scheme) -&gt; Type -&gt; InferFn Scheme
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473763"><span class="hs-identifier hs-var">e''</span></a></span><span>
</span><span id="line-381"></span><span>      </span><span class="annot"><span class="annottext">Binder -&gt; Scheme -&gt; InferFn ()
</span><a href="IR.HM.html#insertBinder"><span class="hs-identifier hs-var">insertBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473766"><span class="hs-identifier hs-var">binder</span></a></span><span> </span><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473762"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-382"></span><span>      </span><span class="annot"><span class="annottext">(Binder, Expr Type) -&gt; InferFn (Binder, Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473766"><span class="hs-identifier hs-var">binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473763"><span class="hs-identifier hs-var">e''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span id="local-6989586621679473761"><span class="annot"><span class="annottext">e :: Expr Type
</span><a href="#local-6989586621679473761"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Data"><span class="hs-identifier hs-type">I.Data</span></a></span><span> </span><span id="local-6989586621679473759"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473759"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679473758"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473758"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-384"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473757"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473757"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473758"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-385"></span><span>  </span><span id="local-6989586621679473756"><span class="annot"><span class="annottext">Maybe Scheme
</span><a href="#local-6989586621679473756"><span class="hs-identifier hs-var">record</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DConId -&gt; InferFn (Maybe Scheme)
</span><a href="IR.HM.html#lookupDCon"><span class="hs-identifier hs-var">lookupDCon</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473759"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-386"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Scheme
</span><a href="#local-6989586621679473756"><span class="hs-identifier hs-var">record</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">Maybe Scheme
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-388"></span><span>      </span><span class="annot"><span class="annottext">Error -&gt; InferFn (Expr Type)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="annottext">(Error -&gt; InferFn (Expr Type)) -&gt; Error -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span>
</span><span id="line-390"></span><span>        </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><span class="annottext">(String -&gt; ErrorMsg) -&gt; String -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unable to type data constructor: &quot;</span></span><span>
</span><span id="line-392"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473761"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679473755"><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473755"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-394"></span><span>      </span><span id="local-6989586621679473754"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473754"><span class="hs-identifier hs-var">t'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scheme -&gt; InferFn Type
</span><a href="IR.HM.html#instantiate"><span class="hs-identifier hs-var">instantiate</span></a></span><span> </span><span class="annot"><span class="annottext">Scheme
</span><a href="#local-6989586621679473755"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-395"></span><span>      </span><span id="local-6989586621679473753"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473753"><span class="hs-identifier hs-var">t''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473757"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473754"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-396"></span><span>      </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DConId -&gt; Type -&gt; Expr Type
forall t. DConId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Data"><span class="hs-identifier hs-var">I.Data</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473759"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473753"><span class="hs-identifier hs-var">t''</span></a></span><span>
</span><span id="line-397"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#App"><span class="hs-identifier hs-type">I.App</span></a></span><span> </span><span id="local-6989586621679473751"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473751"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679473750"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473750"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679473749"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473749"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473748"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473748"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473749"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-399"></span><span>  </span><span id="local-6989586621679473747"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473747"><span class="hs-identifier hs-var">a'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473751"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-400"></span><span>  </span><span id="local-6989586621679473746"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473746"><span class="hs-identifier hs-var">b'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473750"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-401"></span><span>  </span><span id="local-6989586621679473745"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473745"><span class="hs-identifier hs-var">tout</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferFn Type
</span><a href="IR.HM.html#fresh"><span class="hs-identifier hs-var">fresh</span></a></span><span>
</span><span id="line-402"></span><span>  </span><span class="annot"><span class="annottext">(Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var">insertEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Builtin Type
forall t. t -&gt; t -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473746"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473745"><span class="hs-identifier hs-var">tout</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473747"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>  </span><span id="local-6989586621679473744"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473744"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473748"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473745"><span class="hs-identifier hs-var">tout</span></a></span><span>
</span><span id="line-404"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#App"><span class="hs-identifier hs-var">I.App</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473747"><span class="hs-identifier hs-var">a'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473746"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473744"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-405"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lit"><span class="hs-identifier hs-type">I.Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="IR.IR.html#LitEvent"><span class="hs-identifier hs-var">I.LitEvent</span></a></span><span> </span><span id="local-6989586621679473741"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473741"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473740"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473740"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473741"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-407"></span><span>  </span><span id="local-6989586621679473739"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473739"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473740"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-408"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Type -&gt; Expr Type
forall t. Literal -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lit"><span class="hs-identifier hs-var">I.Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="IR.IR.html#LitEvent"><span class="hs-identifier hs-var">I.LitEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473739"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-409"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lit"><span class="hs-identifier hs-type">I.Lit</span></a></span><span> </span><span id="local-6989586621679473738"><span class="annot"><span class="annottext">i :: Literal
</span><a href="#local-6989586621679473738"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#LitIntegral"><span class="hs-identifier hs-type">I.LitIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473736"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473736"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473735"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473735"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473736"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-411"></span><span>  </span><span id="local-6989586621679473734"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473734"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473735"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Type -&gt; Expr Type
forall t. Literal -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lit"><span class="hs-identifier hs-var">I.Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679473738"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473734"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-413"></span><span class="hs-comment">-- | Infer the type of a Primitive expression.</span><span>
</span><span id="line-414"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#New"><span class="hs-identifier hs-var">I.New</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473731"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473731"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473730"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473730"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-415"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473729"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473729"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473730"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-416"></span><span>  </span><span id="local-6989586621679473728"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473728"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473731"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-417"></span><span>  </span><span id="local-6989586621679473727"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473727"><span class="hs-identifier hs-var">t</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473729"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Builtin Type
forall t. t -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-var">Ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473728"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#New"><span class="hs-identifier hs-var">I.New</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473728"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473727"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-419"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Deref"><span class="hs-identifier hs-var">I.Deref</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473725"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473725"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473724"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473724"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473723"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473723"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473724"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-421"></span><span>  </span><span id="local-6989586621679473722"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473722"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473725"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-422"></span><span>  </span><span id="local-6989586621679473721"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473721"><span class="hs-identifier hs-var">t</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferFn Type
</span><a href="IR.HM.html#fresh"><span class="hs-identifier hs-var">fresh</span></a></span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><span class="annottext">(Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var">insertEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Builtin Type
forall t. t -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-var">Ref</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473721"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473722"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>  </span><span id="local-6989586621679473720"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473720"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473723"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473721"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-425"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Deref"><span class="hs-identifier hs-var">I.Deref</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473722"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473720"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-426"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Dup"><span class="hs-identifier hs-var">I.Dup</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473718"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473718"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473717"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473717"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473716"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473716"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473717"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-428"></span><span>  </span><span id="local-6989586621679473715"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473715"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473718"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span id="local-6989586621679473714"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473714"><span class="hs-identifier hs-var">t</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473716"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473715"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Dup"><span class="hs-identifier hs-var">I.Dup</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473715"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473714"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-431"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Drop"><span class="hs-identifier hs-var">I.Drop</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473712"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473712"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473711"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473711"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473710"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473710"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473709"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473709"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473710"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-433"></span><span>  </span><span id="local-6989586621679473708"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473708"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473712"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-434"></span><span>  </span><span id="local-6989586621679473707"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473707"><span class="hs-identifier hs-var">r'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473711"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-435"></span><span>  </span><span id="local-6989586621679473706"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473706"><span class="hs-identifier hs-var">t</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473709"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473708"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Drop"><span class="hs-identifier hs-var">I.Drop</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473708"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473707"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473706"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-437"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Assign"><span class="hs-identifier hs-var">I.Assign</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473704"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473704"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473703"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473703"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473702"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473702"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-438"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473701"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473701"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473702"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-439"></span><span>  </span><span id="local-6989586621679473700"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473700"><span class="hs-identifier hs-var">t</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473701"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-440"></span><span>  </span><span id="local-6989586621679473699"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473699"><span class="hs-identifier hs-var">lhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473704"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-441"></span><span>  </span><span id="local-6989586621679473698"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473698"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473703"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-442"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Assign"><span class="hs-identifier hs-var">I.Assign</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473699"><span class="hs-identifier hs-var">lhs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473698"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473700"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-443"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473696"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473696"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimAdd"><span class="hs-identifier hs-var">I.PrimAdd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473694"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473694"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473693"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473693"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473692"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473692"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473696"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473694"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473693"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473692"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-444"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473690"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473690"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimSub"><span class="hs-identifier hs-var">I.PrimSub</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473688"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473688"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473687"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473687"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473686"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473686"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473690"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473688"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473687"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473686"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-445"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473685"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473685"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimMul"><span class="hs-identifier hs-var">I.PrimMul</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473683"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473683"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473682"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473682"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473681"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473681"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473685"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473683"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473682"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473681"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-446"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473680"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473680"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimDiv"><span class="hs-identifier hs-var">I.PrimDiv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473678"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473678"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473677"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473677"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473676"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473676"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473680"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473678"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473677"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473676"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-447"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473675"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473675"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimMod"><span class="hs-identifier hs-var">I.PrimMod</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473673"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473673"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473672"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473672"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473671"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473671"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473675"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473673"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473672"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473671"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-448"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473670"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473670"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimEq"><span class="hs-identifier hs-var">I.PrimEq</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-special">[</span><span id="local-6989586621679473668"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473668"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473667"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473667"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473666"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473666"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473670"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473668"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473667"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473666"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-449"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473665"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473665"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimNeq"><span class="hs-identifier hs-var">I.PrimNeq</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473663"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473663"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473662"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473662"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473661"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473661"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473665"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473663"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473662"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473661"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-450"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473660"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473660"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimGt"><span class="hs-identifier hs-var">I.PrimGt</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-special">[</span><span id="local-6989586621679473658"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473658"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473657"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473657"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473656"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473656"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473660"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473658"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473657"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473656"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-451"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473655"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473655"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimLt"><span class="hs-identifier hs-var">I.PrimLt</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-special">[</span><span id="local-6989586621679473653"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473653"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473652"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473652"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473651"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473651"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473655"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473653"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473652"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473651"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-452"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473650"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473650"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimGe"><span class="hs-identifier hs-var">I.PrimGe</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-special">[</span><span id="local-6989586621679473648"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473648"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473647"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473647"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473646"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473646"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473650"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473648"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473647"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473646"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-453"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473645"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473645"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimLe"><span class="hs-identifier hs-var">I.PrimLe</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-special">[</span><span id="local-6989586621679473643"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473643"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473642"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473642"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473641"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473641"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var">inferPrimBinop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473645"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473643"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473642"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473641"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-454"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#After"><span class="hs-identifier hs-var">I.After</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473639"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473639"><span class="hs-identifier hs-var">del</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473638"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473638"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473637"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473637"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473636"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473636"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473635"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473635"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473636"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-456"></span><span>  </span><span id="local-6989586621679473634"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473634"><span class="hs-identifier hs-var">t</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473635"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-457"></span><span>  </span><span id="local-6989586621679473633"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473633"><span class="hs-identifier hs-var">del'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473639"><span class="hs-identifier hs-var">del</span></a></span><span>
</span><span id="line-458"></span><span>  </span><span id="local-6989586621679473632"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473632"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473637"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-459"></span><span>  </span><span id="local-6989586621679473631"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473631"><span class="hs-identifier hs-var">lhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473638"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-460"></span><span>  </span><span class="annot"><span class="annottext">(Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var">insertEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473633"><span class="hs-identifier hs-var">del'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>  </span><span class="annot"><span class="annottext">(Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var">insertEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473631"><span class="hs-identifier hs-var">lhs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Builtin Type
forall t. t -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-var">Ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473632"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#After"><span class="hs-identifier hs-var">I.After</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473633"><span class="hs-identifier hs-var">del'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473631"><span class="hs-identifier hs-var">lhs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473632"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473634"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-463"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Break"><span class="hs-identifier hs-var">I.Break</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473629"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473629"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-464"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473628"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473628"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473629"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-465"></span><span>  </span><span id="local-6989586621679473627"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473627"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473628"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-466"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Break"><span class="hs-identifier hs-var">I.Break</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473627"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-467"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Now"><span class="hs-identifier hs-var">I.Now</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473625"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473625"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-468"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473624"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473624"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473625"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-469"></span><span>  </span><span id="local-6989586621679473623"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473623"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473624"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Type) -&gt; Type -&gt; InferFn Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span> </span><span class="hs-comment">-- TODO: this should be 64-bit timestamp type</span><span>
</span><span id="line-470"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Now"><span class="hs-identifier hs-var">I.Now</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473623"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-471"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Loop"><span class="hs-identifier hs-var">I.Loop</span></a></span><span> </span><span id="local-6989586621679473621"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473621"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679473620"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473620"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473619"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473619"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473620"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-473"></span><span>  </span><span id="local-6989586621679473618"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473618"><span class="hs-identifier hs-var">t</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473619"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-474"></span><span>  </span><span id="local-6989586621679473617"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473617"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; [Expr Type] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473621"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-475"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Loop"><span class="hs-identifier hs-var">I.Loop</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473617"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473618"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-476"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Wait"><span class="hs-identifier hs-var">I.Wait</span></a></span><span> </span><span id="local-6989586621679473615"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473615"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679473614"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473614"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-477"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473613"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473613"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473614"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-478"></span><span>  </span><span id="local-6989586621679473612"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473612"><span class="hs-identifier hs-var">t</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473613"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-479"></span><span>  </span><span id="local-6989586621679473611"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473611"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; [Expr Type] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473615"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-480"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Wait"><span class="hs-identifier hs-var">I.Wait</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473611"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473612"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-481"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Par"><span class="hs-identifier hs-var">I.Par</span></a></span><span> </span><span id="local-6989586621679473609"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473609"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679473608"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473608"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-482"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473607"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473607"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473608"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-483"></span><span>  </span><span id="local-6989586621679473606"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473606"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; [Expr Type] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473609"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-484"></span><span>  </span><span id="local-6989586621679473605"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473605"><span class="hs-identifier hs-var">t</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473607"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Builtin Type
forall t. [t] -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-var">Tuple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr Type -&gt; Type) -&gt; [Expr Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473606"><span class="hs-identifier hs-var">es'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Par"><span class="hs-identifier hs-var">I.Par</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473606"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473605"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-486"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Match"><span class="hs-identifier hs-type">I.Match</span></a></span><span> </span><span id="local-6989586621679473603"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473603"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621679473602"><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679473602"><span class="hs-identifier hs-var">arms</span></a></span></span><span> </span><span id="local-6989586621679473601"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473601"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-487"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473600"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473600"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473601"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-488"></span><span>  </span><span id="local-6989586621679473599"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473599"><span class="hs-identifier hs-var">cond'</span></a></span></span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473603"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-489"></span><span>  </span><span id="local-6989586621679473598"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473598"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679473597"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473597"><span class="hs-identifier hs-var">he</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679473596"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473596"><span class="hs-identifier hs-var">tes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Alt, Expr Type) -&gt; InferFn (Expr Type))
-&gt; [(Alt, Expr Type)] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Alt, Expr Type) -&gt; InferFn (Expr Type)
</span><a href="#local-6989586621679473595"><span class="hs-identifier hs-var">checkArm</span></a></span><span> </span><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679473602"><span class="hs-identifier hs-var">arms</span></a></span><span>
</span><span id="line-490"></span><span>  </span><span id="local-6989586621679473594"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473594"><span class="hs-identifier hs-var">t</span></a></span></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473600"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473597"><span class="hs-identifier hs-var">he</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>  </span><span class="hs-comment">-- make sure all the expressions on the rhs have the same type</span><span>
</span><span id="line-492"></span><span>  </span><span class="annot"><span class="annottext">(Expr Type -&gt; Expr Type -&gt; InferFn ())
-&gt; [Expr Type] -&gt; [Expr Type] -&gt; InferFn ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679473593"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473593"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621679473592"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473592"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var">insertEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473593"><span class="hs-identifier hs-var">e1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473592"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473598"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473596"><span class="hs-identifier hs-var">tes</span></a></span><span>
</span><span id="line-493"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473591"><span class="annot"><span class="annottext">arms' :: [(Alt, Expr Type)]
</span><a href="#local-6989586621679473591"><span class="hs-identifier hs-var hs-var">arms'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt] -&gt; [Expr Type] -&gt; [(Alt, Expr Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Alt, Expr Type) -&gt; Alt
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Alt, Expr Type) -&gt; Alt) -&gt; [(Alt, Expr Type)] -&gt; [Alt]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679473602"><span class="hs-identifier hs-var">arms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473598"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-494"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; [(Alt, Expr Type)] -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; [(Alt, Expr t)] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Match"><span class="hs-identifier hs-var">I.Match</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473599"><span class="hs-identifier hs-var">cond'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679473591"><span class="hs-identifier hs-var">arms'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473594"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-496"></span><span>  </span><span class="annot"><a href="#local-6989586621679473595"><span class="hs-identifier hs-type">checkArm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Alt"><span class="hs-identifier hs-type">I.Alt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>  </span><span id="local-6989586621679473595"><span class="annot"><span class="annottext">checkArm :: (Alt, Expr Type) -&gt; InferFn (Expr Type)
</span><a href="#local-6989586621679473595"><span class="hs-identifier hs-var hs-var">checkArm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#AltData"><span class="hs-identifier hs-type">I.AltData</span></a></span><span> </span><span id="local-6989586621679473589"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473589"><span class="hs-identifier hs-var">dcon</span></a></span></span><span> </span><span id="local-6989586621679473588"><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679473588"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473587"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473587"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InferFn (Expr Type) -&gt; InferFn (Expr Type)
forall a. InferFn a -&gt; InferFn a
</span><a href="IR.HM.html#withNewScope"><span class="hs-identifier hs-var">withNewScope</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TConId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473586"><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473586"><span class="hs-identifier hs-var">tvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473585"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473585"><span class="hs-identifier hs-var">ats</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DConId
-&gt; Map DConId (TConId, [TVarId], [Type])
-&gt; Maybe (TConId, [TVarId], [Type])
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473589"><span class="hs-identifier hs-var">dcon</span></a></span><span> </span><span class="annot"><span class="annottext">(Map DConId (TConId, [TVarId], [Type])
 -&gt; Maybe (TConId, [TVarId], [Type]))
-&gt; InferFn (Map DConId (TConId, [TVarId], [Type]))
-&gt; InferFn (Maybe (TConId, [TVarId], [Type]))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; Map DConId (TConId, [TVarId], [Type]))
-&gt; InferFn (Map DConId (TConId, [TVarId], [Type]))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map DConId (TConId, [TVarId], [Type])
</span><a href="IR.HM.html#dConType"><span class="hs-identifier hs-var hs-var">dConType</span></a></span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-comment">-- NOTE: this is kind of a hack, i.e., could be done more elegantly.</span><span>
</span><span id="line-500"></span><span>    </span><span class="hs-comment">-- What I did here is inline 'instantiate', except instead of instantiating</span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-comment">-- a single scheme, I instantiate each of the DCon's arguments in</span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-comment">-- a dependent manner. That is, I create fresh type variables for each</span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-comment">-- quantified type variable in @tvs@, and then 'solveType' for each DCon arg</span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-comment">-- separately.</span><span>
</span><span id="line-505"></span><span>    </span><span id="local-6989586621679473584"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473584"><span class="hs-identifier hs-var">tvs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TVarId -&gt; InferFn Type) -&gt; [TVarId] -&gt; InferFn [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InferFn Type -&gt; TVarId -&gt; InferFn Type
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">InferFn Type
</span><a href="IR.HM.html#fresh"><span class="hs-identifier hs-var">fresh</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473586"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-506"></span><span>    </span><span id="local-6989586621679473583"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473583"><span class="hs-identifier hs-var">ats'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InferFn [Type] -&gt; InferFn [Type]
forall a. InferFn a -&gt; InferFn a
</span><a href="IR.HM.html#withNewTypeScope"><span class="hs-identifier hs-var">withNewTypeScope</span></a></span><span> </span><span class="annot"><span class="annottext">(InferFn [Type] -&gt; InferFn [Type])
-&gt; InferFn [Type] -&gt; InferFn [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-507"></span><span>      </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473582"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473582"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-508"></span><span>        </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473582"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">unionFindTree :: Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var">unionFindTree</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Type, Type)] -&gt; Map Type Type
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [(Type, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TVarId -&gt; Type) -&gt; [TVarId] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TVarId -&gt; Type
</span><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-var">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">[TVarId]
</span><a href="#local-6989586621679473586"><span class="hs-identifier hs-var">tvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473584"><span class="hs-identifier hs-var">tvs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-509"></span><span>      </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Type) -&gt; [Type] -&gt; InferFn [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473585"><span class="hs-identifier hs-var">ats</span></a></span><span>
</span><span id="line-510"></span><span>    </span><span class="annot"><span class="annottext">[(Binder, Type)] -&gt; ((Binder, Type) -&gt; InferFn ()) -&gt; InferFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binder] -&gt; [Type] -&gt; [(Binder, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679473588"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473583"><span class="hs-identifier hs-var">ats'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Binder, Type) -&gt; InferFn ()) -&gt; InferFn ())
-&gt; ((Binder, Type) -&gt; InferFn ()) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679473581"><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473581"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473580"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473580"><span class="hs-identifier hs-var">at'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-511"></span><span>      </span><span class="annot"><span class="annottext">Binder -&gt; Scheme -&gt; InferFn ()
</span><a href="IR.HM.html#insertBinder"><span class="hs-identifier hs-var">insertBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473581"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TVarId] -&gt; Type -&gt; Scheme
</span><a href="IR.Types.Classes.html#Forall"><span class="hs-identifier hs-var">Forall</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473580"><span class="hs-identifier hs-var">at'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>    </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473587"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-513"></span><span>  </span><span class="annot"><a href="#local-6989586621679473595"><span class="hs-identifier hs-var">checkArm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alt
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473579"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473579"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InferFn (Expr Type) -&gt; InferFn (Expr Type)
forall a. InferFn a -&gt; InferFn a
</span><a href="IR.HM.html#withNewScope"><span class="hs-identifier hs-var">withNewScope</span></a></span><span> </span><span class="annot"><span class="annottext">(InferFn (Expr Type) -&gt; InferFn (Expr Type))
-&gt; InferFn (Expr Type) -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473579"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-514"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span id="local-6989586621679473578"><span class="annot"><span class="annottext">c :: Primitive
</span><a href="#local-6989586621679473578"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#CQuote"><span class="hs-identifier hs-type">I.CQuote</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473576"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473576"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-515"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679473578"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Expr Type) -&gt; Type -&gt; Expr Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473576"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-516"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span id="local-6989586621679473575"><span class="annot"><span class="annottext">c :: Primitive
</span><a href="#local-6989586621679473575"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#CCall"><span class="hs-identifier hs-type">I.CCall</span></a></span><span> </span><span class="annot"><span class="annottext">CSym
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473573"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473573"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679473572"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473572"><span class="hs-identifier hs-var">annT</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-517"></span><span>  </span><span id="local-6989586621679473571"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473571"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; [Expr Type] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473573"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-518"></span><span>  </span><span id="local-6989586621679473570"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473570"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473572"><span class="hs-identifier hs-var">annT</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-519"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679473575"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473571"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473570"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-520"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span id="local-6989586621679473569"><span class="annot"><span class="annottext">e :: Expr Type
</span><a href="#local-6989586621679473569"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-521"></span><span>  </span><span class="annot"><span class="annottext">Error -&gt; InferFn (Expr Type)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-522"></span><span>    </span><span class="annot"><span class="annottext">(Error -&gt; InferFn (Expr Type)) -&gt; Error -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span>
</span><span id="line-523"></span><span>    </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-524"></span><span>    </span><span class="annot"><span class="annottext">(String -&gt; ErrorMsg) -&gt; String -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unsupported Prim expression: &quot;</span></span><span>
</span><span id="line-525"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473569"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-526"></span><span class="annot"><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span id="local-6989586621679473568"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473568"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-527"></span><span>  </span><span class="annot"><span class="annottext">Error -&gt; InferFn (Expr Type)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-528"></span><span>    </span><span class="annot"><span class="annottext">(Error -&gt; InferFn (Expr Type)) -&gt; Error -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span>
</span><span id="line-529"></span><span>    </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-530"></span><span>    </span><span class="annot"><span class="annottext">(String -&gt; ErrorMsg) -&gt; String -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unable to type unknown expression: &quot;</span></span><span>
</span><span id="line-531"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473568"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span class="hs-comment">-- | Infer the type of a binary integer operation.</span><span>
</span><span id="line-534"></span><span class="annot"><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-type">inferPrimBinop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Annotated.html#Type"><span class="hs-identifier hs-type">Ann.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span id="inferPrimBinop"><span class="annot"><span class="annottext">inferPrimBinop :: PrimOp -&gt; Expr Type -&gt; Expr Type -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#inferPrimBinop"><span class="hs-identifier hs-var hs-var">inferPrimBinop</span></a></span></span><span> </span><span id="local-6989586621679473567"><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473567"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621679473566"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473566"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621679473565"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473565"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621679473564"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473564"><span class="hs-identifier hs-var">annT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473563"><span class="annot"><span class="annottext">annT' :: Type
</span><a href="#local-6989586621679473563"><span class="hs-identifier hs-var hs-var">annT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="IR.HM.html#collapseAnnT"><span class="hs-identifier hs-var">collapseAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473564"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-537"></span><span>  </span><span id="local-6989586621679473562"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473562"><span class="hs-identifier hs-var">t</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473563"><span class="hs-identifier hs-var">annT'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>  </span><span id="local-6989586621679473561"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473561"><span class="hs-identifier hs-var">e1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473566"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-539"></span><span>  </span><span id="local-6989586621679473560"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473560"><span class="hs-identifier hs-var">e2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#initTypeVars"><span class="hs-identifier hs-var">initTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473565"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-540"></span><span>  </span><span class="annot"><span class="annottext">(Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var">insertEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473561"><span class="hs-identifier hs-var">e1'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>  </span><span class="annot"><span class="annottext">(Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var">insertEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473560"><span class="hs-identifier hs-var">e2'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473567"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473561"><span class="hs-identifier hs-var">e1'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473560"><span class="hs-identifier hs-var">e2'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473562"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-543"></span><span>
</span><span id="line-544"></span><span class="hs-comment">-- | @typeCheck annT expectedT@ checks whether the type annotation @annT@ is</span><span>
</span><span id="line-545"></span><span class="hs-comment">-- compatible with the expected type @expectedT@. Insert new type equations when</span><span>
</span><span id="line-546"></span><span class="hs-comment">-- the expected type is a type variable.</span><span>
</span><span id="line-547"></span><span class="hs-comment">-- TODO: currently only consider equality as compatibility. Need to support the</span><span>
</span><span id="line-548"></span><span class="hs-comment">-- case when type annotation is more specific than the expected type.</span><span>
</span><span id="line-549"></span><span class="annot"><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-type">typeCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span>
</span><span id="line-550"></span><span id="typeCheck"><span class="annot"><span class="annottext">typeCheck :: Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var hs-var">typeCheck</span></a></span></span><span> </span><span id="local-6989586621679473559"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473559"><span class="hs-identifier hs-var">annT</span></a></span></span><span> </span><span id="local-6989586621679473558"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473558"><span class="hs-identifier hs-var">expectedT</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473559"><span class="hs-identifier hs-var">annT</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="IR.HM.html#dummyAnnT"><span class="hs-identifier hs-var">dummyAnnT</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473559"><span class="hs-identifier hs-var">annT</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473558"><span class="hs-identifier hs-var">expectedT</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-551"></span><span>  </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473558"><span class="hs-identifier hs-var">expectedT</span></a></span><span>
</span><span id="line-552"></span><span class="annot"><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-type">Ref</span></a></span><span> </span><span id="local-6989586621679473556"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473556"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-type">Ref</span></a></span><span> </span><span id="local-6989586621679473555"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473555"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-553"></span><span>  </span><span id="local-6989586621679473554"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473554"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473556"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473555"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-554"></span><span>  </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Type) -&gt; Type -&gt; InferFn Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Builtin Type
forall t. t -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-var">Ref</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473554"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span class="annot"><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span id="local-6989586621679473553"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473553"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621679473552"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473552"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span id="local-6989586621679473551"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473551"><span class="hs-identifier hs-var">t3</span></a></span></span><span> </span><span id="local-6989586621679473550"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473550"><span class="hs-identifier hs-var">t4</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-557"></span><span>    </span><span id="local-6989586621679473549"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473549"><span class="hs-identifier hs-var">t1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473553"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473551"><span class="hs-identifier hs-var">t3</span></a></span><span>
</span><span id="line-558"></span><span>    </span><span id="local-6989586621679473548"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473548"><span class="hs-identifier hs-var">t2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473552"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473550"><span class="hs-identifier hs-var">t4</span></a></span><span>
</span><span id="line-559"></span><span>    </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Type) -&gt; Type -&gt; InferFn Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Builtin Type
forall t. t -&gt; t -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473549"><span class="hs-identifier hs-var">t1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473548"><span class="hs-identifier hs-var">t2'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span class="annot"><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-type">Tuple</span></a></span><span> </span><span id="local-6989586621679473547"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473547"><span class="hs-identifier hs-var">ts1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-type">Tuple</span></a></span><span> </span><span id="local-6989586621679473546"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473546"><span class="hs-identifier hs-var">ts2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-561"></span><span>  </span><span id="local-6989586621679473545"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473545"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type -&gt; InferFn Type)
-&gt; [Type] -&gt; [Type] -&gt; InferFn [Type]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn Type
</span><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473547"><span class="hs-identifier hs-var">ts1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473546"><span class="hs-identifier hs-var">ts2</span></a></span><span>
</span><span id="line-562"></span><span>  </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Type) -&gt; Type -&gt; InferFn Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Builtin Type
forall t. [t] -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-var">Tuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473545"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span class="annot"><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span id="local-6989586621679473544"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473544"><span class="hs-identifier hs-var">annT</span></a></span></span><span> </span><span id="local-6989586621679473543"><span class="annot"><span class="annottext">expectedT :: Type
</span><a href="#local-6989586621679473543"><span class="hs-identifier hs-var">expectedT</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-type">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVarId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-564"></span><span>  </span><span class="annot"><span class="annottext">(Type, Type) -&gt; InferFn ()
</span><a href="IR.HM.html#insertEquation"><span class="hs-identifier hs-var">insertEquation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473543"><span class="hs-identifier hs-var">expectedT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473544"><span class="hs-identifier hs-var">annT</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InferFn () -&gt; InferFn Type -&gt; InferFn Type
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473543"><span class="hs-identifier hs-var">expectedT</span></a></span><span>
</span><span id="line-565"></span><span class="annot"><a href="IR.HM.html#typeCheck"><span class="hs-identifier hs-var">typeCheck</span></a></span><span> </span><span id="local-6989586621679473542"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473542"><span class="hs-identifier hs-var">annT</span></a></span></span><span> </span><span id="local-6989586621679473541"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473541"><span class="hs-identifier hs-var">expectedT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-566"></span><span>  </span><span class="annot"><span class="annottext">Error -&gt; InferFn Type
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-567"></span><span>    </span><span class="annot"><span class="annottext">(Error -&gt; InferFn Type) -&gt; Error -&gt; InferFn Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span>
</span><span id="line-568"></span><span>    </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-569"></span><span>    </span><span class="annot"><span class="annottext">(String -&gt; ErrorMsg) -&gt; String -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Incompatible type annotation: expected &quot;</span></span><span>
</span><span id="line-570"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473541"><span class="hs-identifier hs-var">expectedT</span></a></span><span>
</span><span id="line-571"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, but got &quot;</span></span><span>
</span><span id="line-572"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473542"><span class="hs-identifier hs-var">annT</span></a></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span class="hs-comment">{- | Stage 2: Solve type equations using unification.

Solve the list of 'equations' one by one and puts solutions as new enties in
the 'unionFindTree'.
-}</span><span>
</span><span id="line-579"></span><span class="annot"><a href="IR.HM.html#unifyAll"><span class="hs-identifier hs-type">unifyAll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span id="unifyAll"><span class="annot"><span class="annottext">unifyAll :: InferFn ()
</span><a href="IR.HM.html#unifyAll"><span class="hs-identifier hs-var hs-var">unifyAll</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-581"></span><span>  </span><span id="local-6989586621679473540"><span class="annot"><span class="annottext">[(Type, Type)]
</span><a href="#local-6989586621679473540"><span class="hs-identifier hs-var">eq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; [(Type, Type)]) -&gt; InferFn [(Type, Type)]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; [(Type, Type)]
</span><a href="IR.HM.html#equations"><span class="hs-identifier hs-var hs-var">equations</span></a></span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(Type, Type)]
</span><a href="#local-6989586621679473540"><span class="hs-identifier hs-var">eq</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-583"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; InferFn ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679473539"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473539"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473538"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473538"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679473537"><span class="annot"><span class="annottext">[(Type, Type)]
</span><a href="#local-6989586621679473537"><span class="hs-identifier hs-var">eqs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-585"></span><span>      </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473539"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473538"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-586"></span><span>      </span><span class="annot"><span class="annottext">(InferState -&gt; InferState) -&gt; InferFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((InferState -&gt; InferState) -&gt; InferFn ())
-&gt; (InferState -&gt; InferState) -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679473535"><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473535"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InferState
</span><a href="#local-6989586621679473535"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">equations :: [(Type, Type)]
</span><a href="IR.HM.html#equations"><span class="hs-identifier hs-var">equations</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Type, Type)]
</span><a href="#local-6989586621679473537"><span class="hs-identifier hs-var">eqs</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-587"></span><span>      </span><span class="annot"><span class="annottext">InferFn ()
</span><a href="IR.HM.html#unifyAll"><span class="hs-identifier hs-var">unifyAll</span></a></span><span>
</span><span id="line-588"></span><span>
</span><span id="line-589"></span><span class="hs-comment">-- |'unify' @t1 t2@ solves the type equation t1 ~ t2 and put the solution into 'unionFindTree'.</span><span>
</span><span id="line-590"></span><span class="annot"><a href="IR.HM.html#unify"><span class="hs-identifier hs-type">unify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-591"></span><span id="unify"><span class="annot"><span class="annottext">unify :: Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var hs-var">unify</span></a></span></span><span> </span><span id="local-6989586621679473534"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473534"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621679473533"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473533"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473534"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473533"><span class="hs-identifier hs-var">t2</span></a></span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; InferFn ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-592"></span><span class="annot"><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span id="local-6989586621679473532"><span class="annot"><span class="annottext">tv1 :: Type
</span><a href="#local-6989586621679473532"><span class="hs-identifier hs-var">tv1</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-type">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVarId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473531"><span class="annot"><span class="annottext">tv2 :: Type
</span><a href="#local-6989586621679473531"><span class="hs-identifier hs-var">tv2</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-type">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVarId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-593"></span><span>  </span><span id="local-6989586621679473530"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473530"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#findRoot"><span class="hs-identifier hs-var">findRoot</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473532"><span class="hs-identifier hs-var">tv1</span></a></span><span>
</span><span id="line-594"></span><span>  </span><span id="local-6989586621679473528"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473528"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#findRoot"><span class="hs-identifier hs-var">findRoot</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473531"><span class="hs-identifier hs-var">tv2</span></a></span><span>
</span><span id="line-595"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473530"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473532"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473528"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473531"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#insertUnion"><span class="hs-identifier hs-var">insertUnion</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473530"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473528"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473530"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473528"><span class="hs-identifier hs-var">r2</span></a></span><span>
</span><span id="line-596"></span><span class="annot"><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span id="local-6989586621679473526"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473526"><span class="hs-identifier hs-var">t</span></a></span></span><span>                   </span><span id="local-6989586621679473525"><span class="annot"><span class="annottext">tv :: Type
</span><a href="#local-6989586621679473525"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-type">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVarId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473525"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473526"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-597"></span><span class="annot"><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span id="local-6989586621679473524"><span class="annot"><span class="annottext">tv :: Type
</span><a href="#local-6989586621679473524"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-type">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVarId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473523"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473523"><span class="hs-identifier hs-var">t</span></a></span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-598"></span><span>  </span><span id="local-6989586621679473522"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473522"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#findRoot"><span class="hs-identifier hs-var">findRoot</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473524"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-599"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473522"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473524"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#insertUnion"><span class="hs-identifier hs-var">insertUnion</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473522"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473523"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473522"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473523"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-600"></span><span class="annot"><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-type">Ref</span></a></span><span> </span><span id="local-6989586621679473521"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473521"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-type">Ref</span></a></span><span> </span><span id="local-6989586621679473520"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473520"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473521"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473520"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-601"></span><span class="annot"><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span id="local-6989586621679473519"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473519"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621679473518"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473518"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span id="local-6989586621679473517"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473517"><span class="hs-identifier hs-var">t3</span></a></span></span><span> </span><span id="local-6989586621679473516"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473516"><span class="hs-identifier hs-var">t4</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-602"></span><span>  </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473519"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473517"><span class="hs-identifier hs-var">t3</span></a></span><span> </span><span class="annot"><span class="annottext">InferFn () -&gt; InferFn () -&gt; InferFn ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473518"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473516"><span class="hs-identifier hs-var">t4</span></a></span><span>
</span><span id="line-603"></span><span class="annot"><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-type">Tuple</span></a></span><span> </span><span id="local-6989586621679473515"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473515"><span class="hs-identifier hs-var">ts1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-type">Tuple</span></a></span><span> </span><span id="local-6989586621679473514"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473514"><span class="hs-identifier hs-var">ts2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-604"></span><span>  </span><span class="annot"><span class="annottext">(Type -&gt; Type -&gt; InferFn ()) -&gt; [Type] -&gt; [Type] -&gt; InferFn ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473515"><span class="hs-identifier hs-var">ts1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473514"><span class="hs-identifier hs-var">ts2</span></a></span><span>
</span><span id="line-605"></span><span class="annot"><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TCon"><span class="hs-identifier hs-type">Classes.TCon</span></a></span><span> </span><span id="local-6989586621679473513"><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473513"><span class="hs-identifier hs-var">d1</span></a></span></span><span> </span><span id="local-6989586621679473512"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473512"><span class="hs-identifier hs-var">tvs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TCon"><span class="hs-identifier hs-type">Classes.TCon</span></a></span><span> </span><span id="local-6989586621679473511"><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473511"><span class="hs-identifier hs-var">d2</span></a></span></span><span> </span><span id="local-6989586621679473510"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473510"><span class="hs-identifier hs-var">tvs2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473513"><span class="hs-identifier hs-var">d1</span></a></span><span> </span><span class="annot"><span class="annottext">TConId -&gt; TConId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679473511"><span class="hs-identifier hs-var">d2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-606"></span><span>  </span><span class="annot"><span class="annottext">(Type -&gt; Type -&gt; InferFn ()) -&gt; [Type] -&gt; [Type] -&gt; InferFn ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; InferFn ()
</span><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473512"><span class="hs-identifier hs-var">tvs1</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473510"><span class="hs-identifier hs-var">tvs2</span></a></span><span>
</span><span id="line-607"></span><span class="annot"><a href="IR.HM.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span id="local-6989586621679473509"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473509"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621679473508"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473508"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-608"></span><span>  </span><span class="annot"><span class="annottext">Error -&gt; InferFn ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-609"></span><span>    </span><span class="annot"><span class="annottext">(Error -&gt; InferFn ()) -&gt; Error -&gt; InferFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span>
</span><span id="line-610"></span><span>    </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-611"></span><span>    </span><span class="annot"><span class="annottext">(String -&gt; ErrorMsg) -&gt; String -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Single unification error: &quot;</span></span><span>
</span><span id="line-612"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473509"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-613"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, &quot;</span></span><span>
</span><span id="line-614"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473508"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-615"></span><span>
</span><span id="line-616"></span><span class="hs-comment">{- | Stage 3: Find the type of the expression based on 'unionFindTree'.

'getType' @e@ walks into the expression @e@ and solves its type @t@ recursively.
-}</span><span>
</span><span id="line-620"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-type">getType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span id="getType"><span class="annot"><span class="annottext">getType :: Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var hs-var">getType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Var"><span class="hs-identifier hs-type">I.Var</span></a></span><span> </span><span id="local-6989586621679473507"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473507"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679473506"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473506"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-622"></span><span>  </span><span id="local-6989586621679473505"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473505"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473506"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-623"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Expr Type
forall t. VarId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Var"><span class="hs-identifier hs-var">I.Var</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679473507"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473505"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-624"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span> </span><span id="local-6989586621679473504"><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473504"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679473503"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473503"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679473502"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473502"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-625"></span><span>  </span><span id="local-6989586621679473501"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473501"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473503"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-626"></span><span>  </span><span id="local-6989586621679473500"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473500"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473502"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-627"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Binder -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Binder -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-var">I.Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679473504"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473501"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473500"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-628"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Let"><span class="hs-identifier hs-type">I.Let</span></a></span><span> </span><span id="local-6989586621679473499"><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679473499"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span id="local-6989586621679473498"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473498"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-629"></span><span>  </span><span id="local-6989586621679473497"><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679473497"><span class="hs-identifier hs-var">vs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Binder, Expr Type) -&gt; InferFn (Binder, Expr Type))
-&gt; [(Binder, Expr Type)] -&gt; InferFn [(Binder, Expr Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; (Binder, Expr Type) -&gt; InferFn (Binder, Expr Type)
forall (m :: * -&gt; *) t b a.
Monad m =&gt;
(t -&gt; m b) -&gt; (a, t) -&gt; m (a, b)
</span><a href="#local-6989586621679473496"><span class="hs-identifier hs-var">fmapSnd</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679473499"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-630"></span><span>  </span><span id="local-6989586621679473495"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473495"><span class="hs-identifier hs-var">b'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473498"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-631"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)] -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. [(Binder, Expr t)] -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Let"><span class="hs-identifier hs-var">I.Let</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder, Expr Type)]
</span><a href="#local-6989586621679473497"><span class="hs-identifier hs-var">vs'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473495"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473495"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-633"></span><span>  </span><span id="local-6989586621679473496"><span class="annot"><span class="annottext">fmapSnd :: (t -&gt; m b) -&gt; (a, t) -&gt; m (a, b)
</span><a href="#local-6989586621679473496"><span class="hs-identifier hs-var hs-var">fmapSnd</span></a></span></span><span> </span><span id="local-6989586621679473494"><span class="annot"><span class="annottext">t -&gt; m b
</span><a href="#local-6989586621679473494"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679473493"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679473493"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473492"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473492"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-634"></span><span>    </span><span id="local-6989586621679473491"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679473491"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">t -&gt; m b
</span><a href="#local-6989586621679473494"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679473492"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-635"></span><span>    </span><span class="annot"><span class="annottext">(a, b) -&gt; m (a, b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679473493"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679473491"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span>  </span><span class="annot"><a href="IR.IR.html#Lit"><span class="hs-identifier hs-type">I.Lit</span></a></span><span>  </span><span class="annot"><span class="annottext">Literal
</span><a href="IR.IR.html#LitEvent"><span class="hs-identifier hs-var">I.LitEvent</span></a></span><span>          </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Type -&gt; Expr Type
forall t. Literal -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lit"><span class="hs-identifier hs-var">I.Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="IR.IR.html#LitEvent"><span class="hs-identifier hs-var">I.LitEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-637"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span>  </span><span class="annot"><a href="IR.IR.html#Lit"><span class="hs-identifier hs-type">I.Lit</span></a></span><span>  </span><span id="local-6989586621679473490"><span class="annot"><span class="annottext">i :: Literal
</span><a href="#local-6989586621679473490"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#LitIntegral"><span class="hs-identifier hs-type">I.LitIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Type -&gt; Expr Type
forall t. Literal -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Lit"><span class="hs-identifier hs-var">I.Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679473490"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">)</span><span>
</span><span id="line-638"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Data"><span class="hs-identifier hs-type">I.Data</span></a></span><span> </span><span id="local-6989586621679473489"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473489"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679473488"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473488"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-639"></span><span>  </span><span id="local-6989586621679473487"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473487"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473488"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-640"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DConId -&gt; Type -&gt; Expr Type
forall t. DConId -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Data"><span class="hs-identifier hs-var">I.Data</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679473489"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473487"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-641"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#App"><span class="hs-identifier hs-type">I.App</span></a></span><span> </span><span id="local-6989586621679473486"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473486"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679473485"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473485"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679473484"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473484"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-642"></span><span>  </span><span id="local-6989586621679473483"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473483"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473486"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-643"></span><span>  </span><span id="local-6989586621679473482"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473482"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473485"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-644"></span><span>  </span><span id="local-6989586621679473481"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473481"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473484"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-645"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; Expr t -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#App"><span class="hs-identifier hs-var">I.App</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473483"><span class="hs-identifier hs-var">a'</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473482"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473481"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-646"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#New"><span class="hs-identifier hs-var">I.New</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473480"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473480"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473479"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473479"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-647"></span><span>  </span><span id="local-6989586621679473478"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473478"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473480"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-648"></span><span>  </span><span id="local-6989586621679473477"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473477"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473479"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-649"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#New"><span class="hs-identifier hs-var">I.New</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473478"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473477"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-650"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Deref"><span class="hs-identifier hs-var">I.Deref</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473476"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473476"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473475"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473475"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-651"></span><span>  </span><span id="local-6989586621679473474"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473474"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473476"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-652"></span><span>  </span><span id="local-6989586621679473473"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473473"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473475"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-653"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Deref"><span class="hs-identifier hs-var">I.Deref</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473474"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473473"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-654"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Dup"><span class="hs-identifier hs-var">I.Dup</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473472"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473472"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473471"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473471"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-655"></span><span>  </span><span id="local-6989586621679473470"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473470"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473472"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-656"></span><span>  </span><span id="local-6989586621679473469"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473469"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473471"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-657"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Dup"><span class="hs-identifier hs-var">I.Dup</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473470"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473469"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-658"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Drop"><span class="hs-identifier hs-var">I.Drop</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473468"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473468"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473467"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473467"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679473466"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473466"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-659"></span><span>  </span><span id="local-6989586621679473465"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473465"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473468"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-660"></span><span>  </span><span id="local-6989586621679473464"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473464"><span class="hs-identifier hs-var">r'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473467"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-661"></span><span>  </span><span id="local-6989586621679473463"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473463"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473466"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-662"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Drop"><span class="hs-identifier hs-var">I.Drop</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473465"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473464"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473463"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-663"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Assign"><span class="hs-identifier hs-var">I.Assign</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473462"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473462"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473461"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473461"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-664"></span><span>  </span><span id="local-6989586621679473460"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473460"><span class="hs-identifier hs-var">lhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473462"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-665"></span><span>  </span><span id="local-6989586621679473459"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473459"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473461"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-666"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Assign"><span class="hs-identifier hs-var">I.Assign</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473460"><span class="hs-identifier hs-var">lhs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473459"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-667"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473458"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473458"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimAdd"><span class="hs-identifier hs-var">I.PrimAdd</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473457"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473457"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473458"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473457"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-668"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473455"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473455"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimSub"><span class="hs-identifier hs-var">I.PrimSub</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473454"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473454"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473455"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473454"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-669"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473453"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473453"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimMul"><span class="hs-identifier hs-var">I.PrimMul</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473452"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473452"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473453"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473452"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-670"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473451"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473451"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimDiv"><span class="hs-identifier hs-var">I.PrimDiv</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473450"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473450"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473451"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473450"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-671"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473449"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473449"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimMod"><span class="hs-identifier hs-var">I.PrimMod</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473448"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473448"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473449"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473448"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-672"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473447"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473447"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimEq"><span class="hs-identifier hs-var">I.PrimEq</span></a></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621679473446"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473446"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473447"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473446"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-673"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473445"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473445"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimNeq"><span class="hs-identifier hs-var">I.PrimNeq</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473444"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473444"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473445"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473444"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-674"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473443"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473443"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimGt"><span class="hs-identifier hs-var">I.PrimGt</span></a></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621679473442"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473442"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473443"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473442"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-675"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473441"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473441"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimLt"><span class="hs-identifier hs-var">I.PrimLt</span></a></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621679473440"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473440"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473441"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473440"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-676"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473439"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473439"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimGe"><span class="hs-identifier hs-var">I.PrimGe</span></a></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621679473438"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473438"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473439"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473438"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-677"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679473437"><span class="annot"><span class="annottext">o :: PrimOp
</span><a href="#local-6989586621679473437"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimLe"><span class="hs-identifier hs-var">I.PrimLe</span></a></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621679473436"><span class="annot"><span class="annottext">es :: [Expr Type]
</span><a href="#local-6989586621679473436"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var">getTypePrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473437"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473436"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn (Expr Type)) -&gt; Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span>
</span><span id="line-678"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#After"><span class="hs-identifier hs-var">I.After</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679473435"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473435"><span class="hs-identifier hs-var">del</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473434"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473434"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679473433"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473433"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-679"></span><span>  </span><span id="local-6989586621679473432"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473432"><span class="hs-identifier hs-var">del'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473435"><span class="hs-identifier hs-var">del</span></a></span><span>
</span><span id="line-680"></span><span>  </span><span id="local-6989586621679473431"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473431"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473433"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-681"></span><span>  </span><span id="local-6989586621679473430"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473430"><span class="hs-identifier hs-var">lhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473434"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-682"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#After"><span class="hs-identifier hs-var">I.After</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473432"><span class="hs-identifier hs-var">del'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473430"><span class="hs-identifier hs-var">lhs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473431"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-683"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Break"><span class="hs-identifier hs-var">I.Break</span></a></span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Break"><span class="hs-identifier hs-var">I.Break</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-684"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Now"><span class="hs-identifier hs-var">I.Now</span></a></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Now"><span class="hs-identifier hs-var">I.Now</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Expr Type) -&gt; Type -&gt; Expr Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type
forall t. TypeSystem t =&gt; Int -&gt; t
</span><a href="IR.Types.TypeSystem.html#int"><span class="hs-identifier hs-var">int</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span> </span><span class="hs-comment">-- TODO: this should return 64-bit timestamp type</span><span>
</span><span id="line-685"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Loop"><span class="hs-identifier hs-var">I.Loop</span></a></span><span>   </span><span id="local-6989586621679473429"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473429"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-686"></span><span>  </span><span id="local-6989586621679473428"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473428"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; [Expr Type] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473429"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-687"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Loop"><span class="hs-identifier hs-var">I.Loop</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473428"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-688"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Wait"><span class="hs-identifier hs-var">I.Wait</span></a></span><span> </span><span id="local-6989586621679473427"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473427"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-689"></span><span>  </span><span id="local-6989586621679473426"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473426"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; [Expr Type] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473427"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-690"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Wait"><span class="hs-identifier hs-var">I.Wait</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473426"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span>
</span><span id="line-691"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Par"><span class="hs-identifier hs-var">I.Par</span></a></span><span> </span><span id="local-6989586621679473425"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473425"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-692"></span><span>  </span><span id="local-6989586621679473424"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473424"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; [Expr Type] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473425"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-693"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Par"><span class="hs-identifier hs-var">I.Par</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473424"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Expr Type) -&gt; Type -&gt; Expr Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Builtin Type
forall t. [t] -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-var">Tuple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr Type -&gt; Type) -&gt; [Expr Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473424"><span class="hs-identifier hs-var">es'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-694"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Match"><span class="hs-identifier hs-type">I.Match</span></a></span><span> </span><span id="local-6989586621679473423"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473423"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621679473422"><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679473422"><span class="hs-identifier hs-var">arms</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-695"></span><span>  </span><span id="local-6989586621679473421"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473421"><span class="hs-identifier hs-var">cond'</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473423"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span id="local-6989586621679473420"><span class="annot"><span class="annottext">arms' :: [Expr Type]
</span><a href="#local-6989586621679473420"><span class="hs-identifier hs-var">arms'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679473419"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473419"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Alt, Expr Type) -&gt; InferFn (Expr Type))
-&gt; [(Alt, Expr Type)] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; ((Alt, Expr Type) -&gt; Expr Type)
-&gt; (Alt, Expr Type)
-&gt; InferFn (Expr Type)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Alt, Expr Type) -&gt; Expr Type
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679473422"><span class="hs-identifier hs-var">arms</span></a></span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-comment">-- make sure all arms are of the same type</span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; [Type] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473419"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; Type) -&gt; [Expr Type] -&gt; [Type]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473420"><span class="hs-identifier hs-var">arms'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-699"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Error -&gt; InferFn (Expr Type)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Error -&gt; InferFn (Expr Type)) -&gt; Error -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-700"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RHS of match arms are different types &quot;</span></span><span>
</span><span id="line-701"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-702"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473416"><span class="annot"><span class="annottext">arms'' :: [(Alt, Expr Type)]
</span><a href="#local-6989586621679473416"><span class="hs-identifier hs-var hs-var">arms''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Alt] -&gt; [Expr Type] -&gt; [(Alt, Expr Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Alt, Expr Type) -&gt; Alt
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Alt, Expr Type) -&gt; Alt) -&gt; [(Alt, Expr Type)] -&gt; [Alt]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679473422"><span class="hs-identifier hs-var">arms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473420"><span class="hs-identifier hs-var">arms'</span></a></span><span>
</span><span id="line-703"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679473415"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621679473415"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall (w :: * -&gt; *) a. Comonad w =&gt; w a -&gt; a
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473419"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-704"></span><span>      </span><span class="hs-comment">-- type of match is type of one of its arms</span><span>
</span><span id="line-705"></span><span>      </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expr Type -&gt; [(Alt, Expr Type)] -&gt; Type -&gt; Expr Type
forall t. Expr t -&gt; [(Alt, Expr t)] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Match"><span class="hs-identifier hs-var">I.Match</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473421"><span class="hs-identifier hs-var">cond'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679473416"><span class="hs-identifier hs-var">arms''</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473415"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span id="local-6989586621679473414"><span class="annot"><span class="annottext">e :: Expr Type
</span><a href="#local-6989586621679473414"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#CQuote"><span class="hs-identifier hs-type">I.CQuote</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473414"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-707"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span id="local-6989586621679473413"><span class="annot"><span class="annottext">c :: Primitive
</span><a href="#local-6989586621679473413"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#CCall"><span class="hs-identifier hs-type">I.CCall</span></a></span><span> </span><span class="annot"><span class="annottext">CSym
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679473412"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473412"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-708"></span><span>  </span><span id="local-6989586621679473411"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473411"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; [Expr Type] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473412"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-709"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679473413"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473411"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall t. TypeSystem t =&gt; t
</span><a href="IR.Types.TypeSystem.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span> </span><span class="hs-comment">-- TODO: handle non-unit return value typet</span><span>
</span><span id="line-710"></span><span class="annot"><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span id="local-6989586621679473410"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473410"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-711"></span><span>  </span><span class="annot"><span class="annottext">Error -&gt; InferFn (Expr Type)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span>
</span><span id="line-712"></span><span>    </span><span class="annot"><span class="annottext">(Error -&gt; InferFn (Expr Type)) -&gt; Error -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span>
</span><span id="line-713"></span><span>    </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span>
</span><span id="line-714"></span><span>    </span><span class="annot"><span class="annottext">(String -&gt; ErrorMsg) -&gt; String -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unable to get the type of unknown expression: &quot;</span></span><span>
</span><span id="line-715"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679473410"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span class="hs-comment">-- | Recursively get type of operands to PrimOp, then apply given type.</span><span>
</span><span id="line-718"></span><span class="annot"><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-type">getTypePrimOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span id="getTypePrimOp"><span class="annot"><span class="annottext">getTypePrimOp :: PrimOp -&gt; [Expr Type] -&gt; Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getTypePrimOp"><span class="hs-identifier hs-var hs-var">getTypePrimOp</span></a></span></span><span> </span><span id="local-6989586621679473409"><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473409"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621679473408"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473408"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679473407"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473407"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-720"></span><span>  </span><span id="local-6989586621679473406"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473406"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; [Expr Type] -&gt; InferFn [Expr Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
</span><a href="IR.HM.html#getType"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473408"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-721"></span><span>  </span><span class="annot"><span class="annottext">Expr Type -&gt; InferFn (Expr Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; InferFn (Expr Type))
-&gt; Expr Type -&gt; InferFn (Expr Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; Expr Type
forall t. Primitive -&gt; [Expr t] -&gt; t -&gt; Expr t
</span><a href="IR.IR.html#Prim"><span class="hs-identifier hs-var">I.Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimOp -&gt; Primitive
</span><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-var">I.PrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679473409"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679473406"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473407"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span class="hs-comment">-- | 'solveType' @t@ solves the type @t@ by replacing any embeded 'TVar' @tvar@</span><span>
</span><span id="line-724"></span><span class="hs-comment">--   with its real type, which is the root of @tvar@ in the 'unionFindTree'.</span><span>
</span><span id="line-725"></span><span class="annot"><a href="IR.HM.html#solveType"><span class="hs-identifier hs-type">solveType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span>
</span><span id="line-726"></span><span id="solveType"><span class="annot"><span class="annottext">solveType :: Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var hs-var">solveType</span></a></span></span><span> </span><span id="local-6989586621679473405"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621679473405"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Integral"><span class="hs-identifier hs-type">Integral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473405"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-727"></span><span class="annot"><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span id="local-6989586621679473404"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621679473404"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">Builtin Type
</span><a href="IR.Types.TypeSystem.html#Unit"><span class="hs-identifier hs-var">Unit</span></a></span><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473404"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-728"></span><span class="annot"><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span id="local-6989586621679473403"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621679473403"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">Builtin Type
</span><a href="IR.Types.TypeSystem.html#Void"><span class="hs-identifier hs-var">Void</span></a></span><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473403"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-729"></span><span class="annot"><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span id="local-6989586621679473402"><span class="annot"><span class="annottext">tv :: Type
</span><a href="#local-6989586621679473402"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-type">Classes.TVar</span></a></span><span>     </span><span class="annot"><span class="annottext">TVarId
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#findRoot"><span class="hs-identifier hs-var">findRoot</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473402"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-730"></span><span class="annot"><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="hs-special">(</span><span>   </span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-type">Ref</span></a></span><span> </span><span id="local-6989586621679473401"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473401"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-731"></span><span>  </span><span id="local-6989586621679473400"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473400"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473401"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-732"></span><span>  </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Type) -&gt; Type -&gt; InferFn Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">(Builtin Type -&gt; Type) -&gt; Builtin Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Builtin Type
forall t. t -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Ref"><span class="hs-identifier hs-var">Ref</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473400"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-733"></span><span class="annot"><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-type">Tuple</span></a></span><span> </span><span id="local-6989586621679473399"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473399"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-734"></span><span>  </span><span id="local-6989586621679473398"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473398"><span class="hs-identifier hs-var">ts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Type) -&gt; [Type] -&gt; InferFn [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473399"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-735"></span><span>  </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Type) -&gt; Type -&gt; InferFn Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">(Builtin Type -&gt; Type) -&gt; Builtin Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Builtin Type
forall t. [t] -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Tuple"><span class="hs-identifier hs-var">Tuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679473398"><span class="hs-identifier hs-var">ts'</span></a></span><span>
</span><span id="line-736"></span><span class="annot"><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-type">Classes.TBuiltin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span id="local-6989586621679473397"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473397"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621679473396"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473396"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-737"></span><span>  </span><span id="local-6989586621679473395"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473395"><span class="hs-identifier hs-var">t1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473397"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-738"></span><span>  </span><span id="local-6989586621679473394"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473394"><span class="hs-identifier hs-var">t2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473396"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-739"></span><span>  </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; InferFn Type) -&gt; Type -&gt; InferFn Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Builtin Type -&gt; Type
</span><a href="IR.Types.Classes.html#TBuiltin"><span class="hs-identifier hs-var">Classes.TBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">(Builtin Type -&gt; Type) -&gt; Builtin Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Builtin Type
forall t. t -&gt; t -&gt; Builtin t
</span><a href="IR.Types.TypeSystem.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473395"><span class="hs-identifier hs-var">t1'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473394"><span class="hs-identifier hs-var">t2'</span></a></span><span>
</span><span id="line-740"></span><span class="annot"><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span id="local-6989586621679473393"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621679473393"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TCon"><span class="hs-identifier hs-type">Classes.TCon</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#TConId"><span class="hs-identifier hs-type">I.TConId</span></a></span><span> </span><span class="annot"><span class="annottext">Identifier
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473393"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-741"></span><span class="annot"><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span id="local-6989586621679473391"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473391"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-742"></span><span>  </span><span class="annot"><span class="annottext">Error -&gt; InferFn Type
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Error -&gt; InferFn Type) -&gt; Error -&gt; InferFn Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorMsg -&gt; Error
</span><a href="Common.Compiler.html#TypeError"><span class="hs-identifier hs-var">Compiler.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorMsg -&gt; Error) -&gt; ErrorMsg -&gt; Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ErrorMsg
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ErrorMsg) -&gt; String -&gt; ErrorMsg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Solve Type error &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473391"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-743"></span><span>
</span><span id="line-744"></span><span class="hs-comment">-- | 'findRoot' @t@ finds the root of @t@ inside 'unionFindTree'.</span><span>
</span><span id="line-745"></span><span class="annot"><a href="IR.HM.html#findRoot"><span class="hs-identifier hs-type">findRoot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.HM.html#InferFn"><span class="hs-identifier hs-type">InferFn</span></a></span><span> </span><span class="annot"><a href="IR.Types.Classes.html#Type"><span class="hs-identifier hs-type">Classes.Type</span></a></span><span>
</span><span id="line-746"></span><span id="findRoot"><span class="annot"><span class="annottext">findRoot :: Type -&gt; InferFn Type
</span><a href="IR.HM.html#findRoot"><span class="hs-identifier hs-var hs-var">findRoot</span></a></span></span><span> </span><span id="local-6989586621679473390"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621679473390"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.Types.Classes.html#TVar"><span class="hs-identifier hs-type">Classes.TVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVarId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-747"></span><span>  </span><span id="local-6989586621679473389"><span class="annot"><span class="annottext">Map Type Type
</span><a href="#local-6989586621679473389"><span class="hs-identifier hs-var">sb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(InferState -&gt; Map Type Type) -&gt; InferFn (Map Type Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">InferState -&gt; Map Type Type
</span><a href="IR.HM.html#unionFindTree"><span class="hs-identifier hs-var hs-var">unionFindTree</span></a></span><span>
</span><span id="line-748"></span><span>  </span><span class="hs-comment">-- We find the root of @t@ if @t@ exists in the tree as a key and its value is different from itself</span><span>
</span><span id="line-749"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Map Type Type -&gt; Maybe Type
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473390"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Map Type Type
</span><a href="#local-6989586621679473389"><span class="hs-identifier hs-var">sb</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-750"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679473388"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473388"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473388"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473390"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#findRoot"><span class="hs-identifier hs-var">findRoot</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473388"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-751"></span><span>    </span><span class="annot"><span class="annottext">Maybe Type
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473390"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-752"></span><span class="annot"><a href="IR.HM.html#findRoot"><span class="hs-identifier hs-var">findRoot</span></a></span><span> </span><span id="local-6989586621679473387"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473387"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; InferFn Type
</span><a href="IR.HM.html#solveType"><span class="hs-identifier hs-var">solveType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679473387"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-753"></span></pre></body></html>