<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DerivingVia #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-unrecognised-pragmas #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">{- | Translate SSM program to C compilation unit.

What is expected of the IR:

Well-formed: All primitive functions are applied to the right number of
arguments.

Pure par expression: All par-expressions' operands are applications that have no
side effects.

Defunctionalized: No lambdas; the only terms with an arrow type are variables
or applications.

Name mangled: All variable identifiers are unique.
-}</span><span>
</span><span id="line-21"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Codegen.Codegen</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Codegen.LibSSM.html"><span class="hs-identifier">Codegen.LibSSM</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Codegen.Typegen.html"><span class="hs-identifier">Codegen.Typegen</span></a></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Codegen.Typegen.html#DConInfo"><span class="hs-identifier">DConInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codegen.Typegen.html#TConInfo"><span class="hs-identifier">TConInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codegen.Typegen.html#TypegenInfo"><span class="hs-identifier">TypegenInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Codegen.Typegen.html#genTypes"><span class="hs-identifier">genTypes</span></a></span><span>
</span><span id="line-28"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.IR.html"><span class="hs-identifier">IR.IR</span></a></span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="IR.Types.html"><span class="hs-identifier">IR.Types</span></a></span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">I</span></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Language.C.Quote.GCC</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.C.Syntax</span></span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Common.Compiler.html"><span class="hs-identifier">Common.Compiler</span></a></span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Compiler</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Common.Identifiers.html"><span class="hs-identifier">Common.Identifiers</span></a></span><span>             </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Common.Identifiers.html#fromId"><span class="hs-identifier">fromId</span></a></span><span>
</span><span id="line-38"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromString</span></span><span>
</span><span id="line-39"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">foldM</span></span><span>
</span><span id="line-41"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span>
</span><span id="line-42"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>           </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">MonadError</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Lazy</span></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">MonadState</span></span><span>
</span><span id="line-45"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">StateT</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalStateT</span></span><span>
</span><span id="line-47"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">gets</span></span><span>
</span><span id="line-48"></span><span>                                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">modify</span></span><span>
</span><span id="line-49"></span><span>                                                </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span>                 </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Bifunctor</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>                     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span>                 </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">drop</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.Stack</span></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">HasCallStack</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-comment">-- | Possible, but temporarily punted for the sake of expediency.</span><span>
</span><span id="line-58"></span><span id="local-6989586621679525608"><span class="annot"><a href="Codegen.Codegen.html#todo"><span class="hs-identifier hs-type">todo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679525608"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-59"></span><span id="todo"><span class="annot"><span class="annottext">todo :: a
</span><a href="Codegen.Codegen.html#todo"><span class="hs-identifier hs-var hs-var">todo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; a
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Not yet implemented&quot;</span></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="hs-comment">-- | Impossible without a discussion about implementation strategy.</span><span>
</span><span id="line-62"></span><span id="local-6989586621679525446"><span class="annot"><a href="Codegen.Codegen.html#nope"><span class="hs-identifier hs-type">nope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679525446"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-63"></span><span id="nope"><span class="annot"><span class="annottext">nope :: a
</span><a href="Codegen.Codegen.html#nope"><span class="hs-identifier hs-var hs-var">nope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; a
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Not yet supported&quot;</span></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">-- | Hack to allow us to splice string literals into C AST</span><span>
</span><span id="line-66"></span><span class="hs-keyword">newtype</span><span> </span><span id="EscExp"><span class="annot"><a href="Codegen.Codegen.html#EscExp"><span class="hs-identifier hs-var">EscExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EscExp"><span class="annot"><a href="Codegen.Codegen.html#EscExp"><span class="hs-identifier hs-var">EscExp</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ToExp</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#EscExp"><span class="hs-identifier hs-type">EscExp</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-68"></span><span>  </span><span id="local-6989586621679525440"><span class="annot"><span class="annottext">toExp :: EscExp -&gt; SrcLoc -&gt; Exp
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">toExp</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codegen.Codegen.html#EscExp"><span class="hs-identifier hs-type">EscExp</span></a></span><span> </span><span id="local-6989586621679525438"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679525438"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679525437"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621679525437"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SrcLoc -&gt; Exp
</span><span class="hs-identifier hs-var">C.EscExp</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679525438"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621679525437"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-comment">{- | State maintained while compiling a top-level SSM function.

The information here is populated while generating the step function, so that
should be computed first, before this information is used to generate the act
struct and enter definitions.
-}</span><span>
</span><span id="line-76"></span><span class="hs-keyword">data</span><span> </span><span id="GenFnState"><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-var">GenFnState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="GenFnState"><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-var">GenFnState</span></a></span></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="fnName"><span class="annot"><span class="annottext">GenFnState -&gt; VarId
</span><a href="Codegen.Codegen.html#fnName"><span class="hs-identifier hs-var hs-var">fnName</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span>               </span><span class="hs-comment">-- ^ Function name</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fnParams"><span class="annot"><span class="annottext">GenFnState -&gt; [(Binder, Type)]
</span><a href="Codegen.Codegen.html#fnParams"><span class="hs-identifier hs-var hs-var">fnParams</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Function parameters</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fnRetTy"><span class="annot"><span class="annottext">GenFnState -&gt; Type
</span><a href="Codegen.Codegen.html#fnRetTy"><span class="hs-identifier hs-var hs-var">fnRetTy</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>                </span><span class="hs-comment">-- ^ Function return type</span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fnBody"><span class="annot"><span class="annottext">GenFnState -&gt; Expr Type
</span><a href="Codegen.Codegen.html#fnBody"><span class="hs-identifier hs-var hs-var">fnBody</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>         </span><span class="hs-comment">-- ^ Function body</span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fnLocals"><span class="annot"><span class="annottext">GenFnState -&gt; Map VarId Type
</span><a href="Codegen.Codegen.html#fnLocals"><span class="hs-identifier hs-var hs-var">fnLocals</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>  </span><span class="hs-comment">-- ^ Function local variables</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fnVars"><span class="annot"><span class="annottext">GenFnState -&gt; Map VarId Exp
</span><a href="Codegen.Codegen.html#fnVars"><span class="hs-identifier hs-var hs-var">fnVars</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span>   </span><span class="hs-comment">-- ^ How to resolve variables</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fnMaxWaits"><span class="annot"><span class="annottext">GenFnState -&gt; Int
</span><a href="Codegen.Codegen.html#fnMaxWaits"><span class="hs-identifier hs-var hs-var">fnMaxWaits</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>                   </span><span class="hs-comment">-- ^ Number of triggers needed</span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fnCases"><span class="annot"><span class="annottext">GenFnState -&gt; Int
</span><a href="Codegen.Codegen.html#fnCases"><span class="hs-identifier hs-var hs-var">fnCases</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>                   </span><span class="hs-comment">-- ^ Yield point counter</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fnFresh"><span class="annot"><span class="annottext">GenFnState -&gt; Int
</span><a href="Codegen.Codegen.html#fnFresh"><span class="hs-identifier hs-var hs-var">fnFresh</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>                   </span><span class="hs-comment">-- ^ Temporary variable name counter</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="fnTypeInfo"><span class="annot"><span class="annottext">GenFnState -&gt; TypegenInfo
</span><a href="Codegen.Codegen.html#fnTypeInfo"><span class="hs-identifier hs-var hs-var">fnTypeInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Typegen.html#TypegenInfo"><span class="hs-identifier hs-type">TypegenInfo</span></a></span><span>           </span><span class="hs-comment">-- ^ (User-defined) type information</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">{- | Translation monad for procedures, with derived typeclass instances.

We declare 'GenFn' as a newtype so that we can implement 'MonadFail' for it,
allowing us to use monadic pattern matching.
-}</span><span>
</span><span id="line-94"></span><span class="hs-keyword">newtype</span><span> </span><span id="GenFn"><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-var">GenFn</span></a></span></span><span> </span><span id="local-6989586621679525424"><span class="annot"><a href="#local-6989586621679525424"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="GenFn"><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-var">GenFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525424"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679525419"><span id="local-6989586621679525421"><span class="annot"><span class="annottext">a -&gt; GenFn b -&gt; GenFn a
(a -&gt; b) -&gt; GenFn a -&gt; GenFn b
(forall a b. (a -&gt; b) -&gt; GenFn a -&gt; GenFn b)
-&gt; (forall a b. a -&gt; GenFn b -&gt; GenFn a) -&gt; Functor GenFn
forall a b. a -&gt; GenFn b -&gt; GenFn a
forall a b. (a -&gt; b) -&gt; GenFn a -&gt; GenFn b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; GenFn b -&gt; GenFn a
$c&lt;$ :: forall a b. a -&gt; GenFn b -&gt; GenFn a
fmap :: (a -&gt; b) -&gt; GenFn a -&gt; GenFn b
$cfmap :: forall a b. (a -&gt; b) -&gt; GenFn a -&gt; GenFn b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679525407"><span id="local-6989586621679525409"><span id="local-6989586621679525411"><span id="local-6989586621679525413"><span id="local-6989586621679525415"><span class="annot"><span class="annottext">Functor GenFn
a -&gt; GenFn a
Functor GenFn
-&gt; (forall a. a -&gt; GenFn a)
-&gt; (forall a b. GenFn (a -&gt; b) -&gt; GenFn a -&gt; GenFn b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; GenFn a -&gt; GenFn b -&gt; GenFn c)
-&gt; (forall a b. GenFn a -&gt; GenFn b -&gt; GenFn b)
-&gt; (forall a b. GenFn a -&gt; GenFn b -&gt; GenFn a)
-&gt; Applicative GenFn
GenFn a -&gt; GenFn b -&gt; GenFn b
GenFn a -&gt; GenFn b -&gt; GenFn a
GenFn (a -&gt; b) -&gt; GenFn a -&gt; GenFn b
(a -&gt; b -&gt; c) -&gt; GenFn a -&gt; GenFn b -&gt; GenFn c
forall a. a -&gt; GenFn a
forall a b. GenFn a -&gt; GenFn b -&gt; GenFn a
forall a b. GenFn a -&gt; GenFn b -&gt; GenFn b
forall a b. GenFn (a -&gt; b) -&gt; GenFn a -&gt; GenFn b
forall a b c. (a -&gt; b -&gt; c) -&gt; GenFn a -&gt; GenFn b -&gt; GenFn c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: GenFn a -&gt; GenFn b -&gt; GenFn a
$c&lt;* :: forall a b. GenFn a -&gt; GenFn b -&gt; GenFn a
*&gt; :: GenFn a -&gt; GenFn b -&gt; GenFn b
$c*&gt; :: forall a b. GenFn a -&gt; GenFn b -&gt; GenFn b
liftA2 :: (a -&gt; b -&gt; c) -&gt; GenFn a -&gt; GenFn b -&gt; GenFn c
$cliftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; GenFn a -&gt; GenFn b -&gt; GenFn c
&lt;*&gt; :: GenFn (a -&gt; b) -&gt; GenFn a -&gt; GenFn b
$c&lt;*&gt; :: forall a b. GenFn (a -&gt; b) -&gt; GenFn a -&gt; GenFn b
pure :: a -&gt; GenFn a
$cpure :: forall a. a -&gt; GenFn a
$cp1Applicative :: Functor GenFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679525399"><span id="local-6989586621679525401"><span id="local-6989586621679525403"><span class="annot"><span class="annottext">Applicative GenFn
a -&gt; GenFn a
Applicative GenFn
-&gt; (forall a b. GenFn a -&gt; (a -&gt; GenFn b) -&gt; GenFn b)
-&gt; (forall a b. GenFn a -&gt; GenFn b -&gt; GenFn b)
-&gt; (forall a. a -&gt; GenFn a)
-&gt; Monad GenFn
GenFn a -&gt; (a -&gt; GenFn b) -&gt; GenFn b
GenFn a -&gt; GenFn b -&gt; GenFn b
forall a. a -&gt; GenFn a
forall a b. GenFn a -&gt; GenFn b -&gt; GenFn b
forall a b. GenFn a -&gt; (a -&gt; GenFn b) -&gt; GenFn b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: a -&gt; GenFn a
$creturn :: forall a. a -&gt; GenFn a
&gt;&gt; :: GenFn a -&gt; GenFn b -&gt; GenFn b
$c&gt;&gt; :: forall a b. GenFn a -&gt; GenFn b -&gt; GenFn b
&gt;&gt;= :: GenFn a -&gt; (a -&gt; GenFn b) -&gt; GenFn b
$c&gt;&gt;= :: forall a b. GenFn a -&gt; (a -&gt; GenFn b) -&gt; GenFn b
$cp1Monad :: Applicative GenFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679525395"><span class="annot"><span class="annottext">Monad GenFn
Monad GenFn -&gt; (forall a. [Char] -&gt; GenFn a) -&gt; MonadFail GenFn
[Char] -&gt; GenFn a
forall a. [Char] -&gt; GenFn a
forall (m :: * -&gt; *).
Monad m -&gt; (forall a. [Char] -&gt; m a) -&gt; MonadFail m
fail :: [Char] -&gt; GenFn a
$cfail :: forall a. [Char] -&gt; GenFn a
$cp1MonadFail :: Monad GenFn
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadFail</span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525389"><span id="local-6989586621679525391"><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Common.Compiler.html#Error"><span class="hs-identifier hs-type">Compiler.Error</span></a></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525381"><span id="local-6989586621679525383"><span id="local-6989586621679525385"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525370"><span id="local-6989586621679525372"><span id="local-6989586621679525374"><span id="local-6989586621679525376"><span class="annot"><span class="hs-identifier hs-type">Compiler.MonadWriter</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Common.Compiler.html#Warning"><span class="hs-identifier hs-type">Compiler.Warning</span></a></span><span class="hs-special">]</span></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-comment">-- | Run a 'GenFn' computation on a procedure.</span><span>
</span><span id="line-104"></span><span id="local-6989586621679525539"><span class="annot"><a href="Codegen.Codegen.html#runGenFn"><span class="hs-identifier hs-type">runGenFn</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span>              </span><span class="hs-comment">-- ^ Name of procedure</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ Names and types of parameters to procedure</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>               </span><span class="hs-comment">-- ^ Name and type of return parameter of procedure</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span>        </span><span class="hs-comment">-- ^ Body of procedure</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Typegen.html#TypegenInfo"><span class="hs-identifier hs-type">TypegenInfo</span></a></span><span>          </span><span class="hs-comment">-- ^ Type information</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Other global identifiers</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525539"><span class="hs-identifier hs-type">a</span></a></span><span>              </span><span class="hs-comment">-- ^ Translation monad to run</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525539"><span class="hs-identifier hs-type">a</span></a></span><span>      </span><span class="hs-comment">-- ^ Pass on errors to caller</span></span><span>
</span><span id="line-113"></span><span id="runGenFn"><span class="annot"><span class="annottext">runGenFn :: VarId
-&gt; [(Binder, Type)]
-&gt; Type
-&gt; Expr Type
-&gt; TypegenInfo
-&gt; [(VarId, Type)]
-&gt; GenFn a
-&gt; Pass a
</span><a href="Codegen.Codegen.html#runGenFn"><span class="hs-identifier hs-var hs-var">runGenFn</span></a></span></span><span> </span><span id="local-6989586621679525367"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525367"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679525366"><span class="annot"><span class="annottext">[(Binder, Type)]
</span><a href="#local-6989586621679525366"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621679525365"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525365"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span id="local-6989586621679525364"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525364"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621679525363"><span class="annot"><span class="annottext">TypegenInfo
</span><a href="#local-6989586621679525363"><span class="hs-identifier hs-var">typeInfo</span></a></span></span><span> </span><span id="local-6989586621679525362"><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679525362"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span id="local-6989586621679525361"><span class="annot"><span class="annottext">StateT GenFnState Pass a
</span><a href="#local-6989586621679525361"><span class="hs-identifier hs-var">tra</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="annottext">StateT GenFnState Pass a -&gt; GenFnState -&gt; Pass a
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span> </span><span class="annot"><span class="annottext">StateT GenFnState Pass a
</span><a href="#local-6989586621679525361"><span class="hs-identifier hs-var">tra</span></a></span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Pass a) -&gt; GenFnState -&gt; Pass a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GenFnState :: VarId
-&gt; [(Binder, Type)]
-&gt; Type
-&gt; Expr Type
-&gt; Map VarId Type
-&gt; Map VarId Exp
-&gt; Int
-&gt; Int
-&gt; Int
-&gt; TypegenInfo
-&gt; GenFnState
</span><a href="Codegen.Codegen.html#GenFnState"><span class="hs-identifier hs-type">GenFnState</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fnName :: VarId
</span><a href="Codegen.Codegen.html#fnName"><span class="hs-identifier hs-var">fnName</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525367"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fnParams :: [(Binder, Type)]
</span><a href="Codegen.Codegen.html#fnParams"><span class="hs-identifier hs-var">fnParams</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Binder, Type)]
</span><a href="#local-6989586621679525366"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fnRetTy :: Type
</span><a href="Codegen.Codegen.html#fnRetTy"><span class="hs-identifier hs-var">fnRetTy</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525365"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fnBody :: Expr Type
</span><a href="Codegen.Codegen.html#fnBody"><span class="hs-identifier hs-var">fnBody</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525364"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fnLocals :: Map VarId Type
</span><a href="Codegen.Codegen.html#fnLocals"><span class="hs-identifier hs-var">fnLocals</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Type
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fnVars :: Map VarId Exp
</span><a href="Codegen.Codegen.html#fnVars"><span class="hs-identifier hs-var">fnVars</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VarId, Exp)] -&gt; Map VarId Exp
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span>
</span><span id="line-121"></span><span>                   </span><span class="annot"><span class="annottext">([(VarId, Exp)] -&gt; Map VarId Exp)
-&gt; [(VarId, Exp)] -&gt; Map VarId Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">((Binder, Type) -&gt; Maybe (VarId, Exp))
-&gt; [(Binder, Type)] -&gt; [(VarId, Exp)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarId -&gt; (VarId, Exp)) -&gt; Binder -&gt; Maybe (VarId, Exp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; (VarId, Exp)
</span><a href="#local-6989586621679525358"><span class="hs-identifier hs-var">resolveParam</span></a></span><span> </span><span class="annot"><span class="annottext">(Binder -&gt; Maybe (VarId, Exp))
-&gt; ((Binder, Type) -&gt; Binder)
-&gt; (Binder, Type)
-&gt; Maybe (VarId, Exp)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Binder, Type) -&gt; Binder
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Binder, Type)]
</span><a href="#local-6989586621679525366"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-122"></span><span>                   </span><span class="annot"><span class="annottext">[(VarId, Exp)] -&gt; [(VarId, Exp)] -&gt; [(VarId, Exp)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">((VarId, Type) -&gt; (VarId, Exp))
-&gt; [(VarId, Type)] -&gt; [(VarId, Exp)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VarId, Type) -&gt; (VarId, Exp)
</span><a href="#local-6989586621679525356"><span class="hs-identifier hs-var">genGlobal</span></a></span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679525362"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fnTypeInfo :: TypegenInfo
</span><a href="Codegen.Codegen.html#fnTypeInfo"><span class="hs-identifier hs-var">fnTypeInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypegenInfo
</span><a href="#local-6989586621679525363"><span class="hs-identifier hs-var">typeInfo</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fnMaxWaits :: Int
</span><a href="Codegen.Codegen.html#fnMaxWaits"><span class="hs-identifier hs-var">fnMaxWaits</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fnCases :: Int
</span><a href="Codegen.Codegen.html#fnCases"><span class="hs-identifier hs-var">fnCases</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">fnFresh :: Int
</span><a href="Codegen.Codegen.html#fnFresh"><span class="hs-identifier hs-var">fnFresh</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-128"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><a href="#local-6989586621679525358"><span class="hs-identifier hs-type">resolveParam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>  </span><span id="local-6989586621679525358"><span class="annot"><span class="annottext">resolveParam :: VarId -&gt; (VarId, Exp)
</span><a href="#local-6989586621679525358"><span class="hs-identifier hs-var hs-var">resolveParam</span></a></span></span><span> </span><span id="local-6989586621679525355"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525355"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525355"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CIdent -&gt; Exp
</span><a href="Codegen.LibSSM.html#acts_"><span class="hs-identifier hs-var">acts_</span></a></span><span> </span><span class="annot"><span class="annottext">(CIdent -&gt; Exp) -&gt; CIdent -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; CIdent
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525355"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><a href="#local-6989586621679525356"><span class="hs-identifier hs-type">genGlobal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>  </span><span id="local-6989586621679525356"><span class="annot"><span class="annottext">genGlobal :: (VarId, Type) -&gt; (VarId, Exp)
</span><a href="#local-6989586621679525356"><span class="hs-identifier hs-var hs-var">genGlobal</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525353"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525353"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Arrow"><span class="hs-identifier hs-type">I.Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525353"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CIdent -&gt; Exp
</span><a href="Codegen.LibSSM.html#static_value"><span class="hs-identifier hs-var">static_value</span></a></span><span> </span><span class="annot"><span class="annottext">(CIdent -&gt; Exp) -&gt; CIdent -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; CIdent
</span><a href="Codegen.LibSSM.html#closure_"><span class="hs-identifier hs-var">closure_</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525353"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><a href="#local-6989586621679525356"><span class="hs-identifier hs-var">genGlobal</span></a></span><span> </span><span class="annot"><span class="annottext">(VarId, Type)
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarId, Exp)
forall a. HasCallStack =&gt; a
</span><a href="Codegen.Codegen.html#todo"><span class="hs-identifier hs-var">todo</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-comment">-- | Lookup some information associated with a type constructor.</span><span>
</span><span id="line-137"></span><span id="local-6989586621679525349"><span class="annot"><a href="Codegen.Codegen.html#getsTCon"><span class="hs-identifier hs-type">getsTCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codegen.Typegen.html#TConInfo"><span class="hs-identifier hs-type">TConInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679525349"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Identifiers.html#TConId"><span class="hs-identifier hs-type">I.TConId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525349"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-138"></span><span id="getsTCon"><span class="annot"><span class="annottext">getsTCon :: (TConInfo -&gt; a) -&gt; TConId -&gt; GenFn a
</span><a href="Codegen.Codegen.html#getsTCon"><span class="hs-identifier hs-var hs-var">getsTCon</span></a></span></span><span> </span><span id="local-6989586621679525347"><span class="annot"><span class="annottext">TConInfo -&gt; a
</span><a href="#local-6989586621679525347"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679525346"><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679525346"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679525345"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679525345"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TConInfo -&gt; a) -&gt; Maybe TConInfo -&gt; Maybe a
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TConInfo -&gt; a
</span><a href="#local-6989586621679525347"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe TConInfo -&gt; Maybe a)
-&gt; (TypegenInfo -&gt; Maybe TConInfo) -&gt; TypegenInfo -&gt; Maybe a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypegenInfo -&gt; TConId -&gt; Maybe TConInfo
</span><a href="Codegen.Typegen.html#tconInfo"><span class="hs-operator hs-var hs-var">`tconInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">TConId
</span><a href="#local-6989586621679525346"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypegenInfo -&gt; Maybe a) -&gt; GenFn TypegenInfo -&gt; GenFn (Maybe a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; TypegenInfo) -&gt; GenFn TypegenInfo
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; TypegenInfo
</span><a href="Codegen.Codegen.html#fnTypeInfo"><span class="hs-identifier hs-var hs-var">fnTypeInfo</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; GenFn a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679525345"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- | Lookup some information associated with a data constructor.</span><span>
</span><span id="line-143"></span><span id="local-6989586621679525488"><span class="annot"><a href="Codegen.Codegen.html#getsDCon"><span class="hs-identifier hs-type">getsDCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codegen.Typegen.html#DConInfo"><span class="hs-identifier hs-type">DConInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679525488"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Identifiers.html#DConId"><span class="hs-identifier hs-type">I.DConId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525488"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-144"></span><span id="getsDCon"><span class="annot"><span class="annottext">getsDCon :: (DConInfo -&gt; a) -&gt; DConId -&gt; GenFn a
</span><a href="Codegen.Codegen.html#getsDCon"><span class="hs-identifier hs-var hs-var">getsDCon</span></a></span></span><span> </span><span id="local-6989586621679525341"><span class="annot"><span class="annottext">DConInfo -&gt; a
</span><a href="#local-6989586621679525341"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679525340"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679525340"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679525339"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679525339"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DConInfo -&gt; a) -&gt; Maybe DConInfo -&gt; Maybe a
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">DConInfo -&gt; a
</span><a href="#local-6989586621679525341"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe DConInfo -&gt; Maybe a)
-&gt; (TypegenInfo -&gt; Maybe DConInfo) -&gt; TypegenInfo -&gt; Maybe a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypegenInfo -&gt; DConId -&gt; Maybe DConInfo
</span><a href="Codegen.Typegen.html#dconInfo"><span class="hs-operator hs-var hs-var">`dconInfo`</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679525340"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypegenInfo -&gt; Maybe a) -&gt; GenFn TypegenInfo -&gt; GenFn (Maybe a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; TypegenInfo) -&gt; GenFn TypegenInfo
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; TypegenInfo
</span><a href="Codegen.Codegen.html#fnTypeInfo"><span class="hs-identifier hs-var hs-var">fnTypeInfo</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; GenFn a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679525339"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="hs-comment">-- | Read and increment the number of cases in a procedure, i.e., @fnCases++@.</span><span>
</span><span id="line-149"></span><span class="annot"><a href="Codegen.Codegen.html#nextCase"><span class="hs-identifier hs-type">nextCase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-150"></span><span id="nextCase"><span class="annot"><span class="annottext">nextCase :: GenFn Int
</span><a href="Codegen.Codegen.html#nextCase"><span class="hs-identifier hs-var hs-var">nextCase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-151"></span><span>  </span><span id="local-6989586621679525336"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525336"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Int) -&gt; GenFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Int
</span><a href="Codegen.Codegen.html#fnCases"><span class="hs-identifier hs-var hs-var">fnCases</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><span class="annottext">(GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((GenFnState -&gt; GenFnState) -&gt; GenFn ())
-&gt; (GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525335"><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525335"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525335"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fnCases :: Int
</span><a href="Codegen.Codegen.html#fnCases"><span class="hs-identifier hs-var">fnCases</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525336"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; GenFn Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525336"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- | Obtain fresh integer in the 'GenFn' monad</span><span>
</span><span id="line-156"></span><span class="annot"><a href="Codegen.Codegen.html#getFresh"><span class="hs-identifier hs-type">getFresh</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-157"></span><span id="getFresh"><span class="annot"><span class="annottext">getFresh :: GenFn Int
</span><a href="Codegen.Codegen.html#getFresh"><span class="hs-identifier hs-var hs-var">getFresh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>  </span><span id="local-6989586621679525332"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525332"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Int) -&gt; GenFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Int
</span><a href="Codegen.Codegen.html#fnFresh"><span class="hs-identifier hs-var hs-var">fnFresh</span></a></span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><span class="annottext">(GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((GenFnState -&gt; GenFnState) -&gt; GenFn ())
-&gt; (GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525331"><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525331"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525331"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fnFresh :: Int
</span><a href="Codegen.Codegen.html#fnFresh"><span class="hs-identifier hs-var">fnFresh</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525332"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; GenFn Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525332"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | Bind a variable to a C expression.</span><span>
</span><span id="line-163"></span><span class="annot"><a href="Codegen.Codegen.html#addBinding"><span class="hs-identifier hs-type">addBinding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span id="addBinding"><span class="annot"><span class="annottext">addBinding :: Binder -&gt; Exp -&gt; GenFn ()
</span><a href="Codegen.Codegen.html#addBinding"><span class="hs-identifier hs-var hs-var">addBinding</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679525329"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525329"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679525328"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679525328"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><span class="annottext">(GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((GenFnState -&gt; GenFnState) -&gt; GenFn ())
-&gt; (GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525327"><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525327"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525327"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fnVars :: Map VarId Exp
</span><a href="Codegen.Codegen.html#fnVars"><span class="hs-identifier hs-var">fnVars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Exp -&gt; Map VarId Exp -&gt; Map VarId Exp
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525329"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679525328"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VarId Exp -&gt; Map VarId Exp) -&gt; Map VarId Exp -&gt; Map VarId Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Map VarId Exp
</span><a href="Codegen.Codegen.html#fnVars"><span class="hs-identifier hs-var hs-var">fnVars</span></a></span><span> </span><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525327"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-166"></span><span class="annot"><a href="Codegen.Codegen.html#addBinding"><span class="hs-identifier hs-var">addBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; GenFn ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="hs-comment">-- | Register a new local variable, to be declared in activation record.</span><span>
</span><span id="line-169"></span><span class="annot"><a href="Codegen.Codegen.html#addLocal"><span class="hs-identifier hs-type">addLocal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span>
</span><span id="line-170"></span><span id="addLocal"><span class="annot"><span class="annottext">addLocal :: VarId -&gt; Type -&gt; GenFn VarId
</span><a href="Codegen.Codegen.html#addLocal"><span class="hs-identifier hs-var hs-var">addLocal</span></a></span></span><span> </span><span id="local-6989586621679525324"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525324"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679525323"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525323"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>  </span><span id="local-6989586621679525322"><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679525322"><span class="hs-identifier hs-var">fnl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Map VarId Type) -&gt; GenFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Map VarId Type
</span><a href="Codegen.Codegen.html#fnLocals"><span class="hs-identifier hs-var hs-var">fnLocals</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span id="local-6989586621679525321"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525321"><span class="hs-identifier hs-var">v'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525324"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId Type -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`M.member`</span></span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679525322"><span class="hs-identifier hs-var">fnl</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-174"></span><span>      </span><span id="local-6989586621679525319"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525319"><span class="hs-identifier hs-var">ctr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn Int
</span><a href="Codegen.Codegen.html#getFresh"><span class="hs-identifier hs-var">getFresh</span></a></span><span>
</span><span id="line-175"></span><span>      </span><span class="annot"><span class="annottext">VarId -&gt; GenFn VarId
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(VarId -&gt; GenFn VarId) -&gt; VarId -&gt; GenFn VarId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525324"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; VarId -&gt; VarId
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; VarId
forall a. IsString a =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525319"><span class="hs-identifier hs-var">ctr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; GenFn VarId
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525324"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="annottext">(GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((GenFnState -&gt; GenFnState) -&gt; GenFn ())
-&gt; (GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525317"><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525317"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525317"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fnLocals :: Map VarId Type
</span><a href="Codegen.Codegen.html#fnLocals"><span class="hs-identifier hs-var">fnLocals</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; Map VarId Type -&gt; Map VarId Type
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525321"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525323"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Map VarId Type
</span><a href="#local-6989586621679525322"><span class="hs-identifier hs-var">fnl</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><span class="annottext">VarId -&gt; GenFn VarId
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525321"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-comment">-- | Bind a variable to a C expression only while computing the given monad.</span><span>
</span><span id="line-181"></span><span id="local-6989586621679525576"><span class="annot"><a href="Codegen.Codegen.html#withBindings"><span class="hs-identifier hs-type">withBindings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525576"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525576"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-182"></span><span id="withBindings"><span class="annot"><span class="annottext">withBindings :: [(Binder, Exp)] -&gt; GenFn a -&gt; GenFn a
</span><a href="Codegen.Codegen.html#withBindings"><span class="hs-identifier hs-var hs-var">withBindings</span></a></span></span><span> </span><span id="local-6989586621679525315"><span class="annot"><span class="annottext">[(Binder, Exp)]
</span><a href="#local-6989586621679525315"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679525314"><span class="annot"><span class="annottext">GenFn a
</span><a href="#local-6989586621679525314"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-183"></span><span>  </span><span id="local-6989586621679525313"><span class="annot"><span class="annottext">Map VarId Exp
</span><a href="#local-6989586621679525313"><span class="hs-identifier hs-var">fnv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Map VarId Exp) -&gt; GenFn (Map VarId Exp)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Map VarId Exp
</span><a href="Codegen.Codegen.html#fnVars"><span class="hs-identifier hs-var hs-var">fnVars</span></a></span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><span class="annottext">((Binder, Exp) -&gt; GenFn ()) -&gt; [(Binder, Exp)] -&gt; GenFn ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Binder -&gt; Exp -&gt; GenFn ()) -&gt; (Binder, Exp) -&gt; GenFn ()
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Binder -&gt; Exp -&gt; GenFn ()
</span><a href="Codegen.Codegen.html#addBinding"><span class="hs-identifier hs-var">addBinding</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Binder, Exp)]
</span><a href="#local-6989586621679525315"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-185"></span><span>  </span><span id="local-6989586621679525310"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679525310"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn a
</span><a href="#local-6989586621679525314"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><span class="annottext">(GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((GenFnState -&gt; GenFnState) -&gt; GenFn ())
-&gt; (GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525309"><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525309"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525309"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fnVars :: Map VarId Exp
</span><a href="Codegen.Codegen.html#fnVars"><span class="hs-identifier hs-var">fnVars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VarId Exp
</span><a href="#local-6989586621679525313"><span class="hs-identifier hs-var">fnv</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; GenFn a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679525310"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="hs-comment">-- | Register a local variable and bind its C expression during a monad.</span><span>
</span><span id="line-190"></span><span id="local-6989586621679525487"><span class="annot"><a href="Codegen.Codegen.html#withNewLocal"><span class="hs-identifier hs-type">withNewLocal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525487"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679525487"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-191"></span><span id="withNewLocal"><span class="annot"><span class="annottext">withNewLocal :: (VarId, Type) -&gt; GenFn a -&gt; GenFn a
</span><a href="Codegen.Codegen.html#withNewLocal"><span class="hs-identifier hs-var hs-var">withNewLocal</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525307"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525307"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525306"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525306"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679525305"><span class="annot"><span class="annottext">GenFn a
</span><a href="#local-6989586621679525305"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>  </span><span id="local-6989586621679525304"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525304"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; GenFn VarId
</span><a href="Codegen.Codegen.html#addLocal"><span class="hs-identifier hs-var">addLocal</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525307"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525306"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="annottext">[(Binder, Exp)] -&gt; GenFn a -&gt; GenFn a
forall a. [(Binder, Exp)] -&gt; GenFn a -&gt; GenFn a
</span><a href="Codegen.Codegen.html#withBindings"><span class="hs-identifier hs-var">withBindings</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; Binder
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525307"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CIdent -&gt; Exp
</span><a href="Codegen.LibSSM.html#acts_"><span class="hs-identifier hs-var">acts_</span></a></span><span> </span><span class="annot"><span class="annottext">(CIdent -&gt; Exp) -&gt; CIdent -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; CIdent
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525304"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">GenFn a
</span><a href="#local-6989586621679525305"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- | Register number of wait statements track of number of triggers needed.</span><span>
</span><span id="line-196"></span><span class="annot"><a href="Codegen.Codegen.html#maxWait"><span class="hs-identifier hs-type">maxWait</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span id="maxWait"><span class="annot"><span class="annottext">maxWait :: Int -&gt; GenFn ()
</span><a href="Codegen.Codegen.html#maxWait"><span class="hs-identifier hs-var hs-var">maxWait</span></a></span></span><span> </span><span id="local-6989586621679525302"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525302"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((GenFnState -&gt; GenFnState) -&gt; GenFn ())
-&gt; (GenFnState -&gt; GenFnState) -&gt; GenFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679525301"><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525301"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525301"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fnMaxWaits :: Int
</span><a href="Codegen.Codegen.html#fnMaxWaits"><span class="hs-identifier hs-var">fnMaxWaits</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525302"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`max`</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Int
</span><a href="Codegen.Codegen.html#fnMaxWaits"><span class="hs-identifier hs-var hs-var">fnMaxWaits</span></a></span><span> </span><span class="annot"><span class="annottext">GenFnState
</span><a href="#local-6989586621679525301"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="hs-comment">-- | Generate a fresh label.</span><span>
</span><span id="line-200"></span><span class="annot"><a href="Codegen.Codegen.html#freshLabel"><span class="hs-identifier hs-type">freshLabel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><a href="Codegen.LibSSM.html#CIdent"><span class="hs-identifier hs-type">CIdent</span></a></span><span>
</span><span id="line-201"></span><span id="freshLabel"><span class="annot"><span class="annottext">freshLabel :: GenFn CIdent
</span><a href="Codegen.Codegen.html#freshLabel"><span class="hs-identifier hs-var hs-var">freshLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CIdent -&gt; CIdent
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">(CIdent -&gt; CIdent) -&gt; (Int -&gt; CIdent) -&gt; Int -&gt; CIdent
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; CIdent
</span><a href="Codegen.LibSSM.html#label_"><span class="hs-identifier hs-var">label_</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; CIdent) -&gt; GenFn Int -&gt; GenFn CIdent
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">GenFn Int
</span><a href="Codegen.Codegen.html#getFresh"><span class="hs-identifier hs-var">getFresh</span></a></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">-- | Generate anonymous local variable in activation record for storage.</span><span>
</span><span id="line-204"></span><span class="annot"><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-type">genTmp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span>
</span><span id="line-205"></span><span id="genTmp"><span class="annot"><span class="annottext">genTmp :: Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var hs-var">genTmp</span></a></span></span><span> </span><span id="local-6989586621679525296"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525296"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>  </span><span id="local-6989586621679525295"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525295"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CIdent -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">(CIdent -&gt; VarId) -&gt; (Int -&gt; CIdent) -&gt; Int -&gt; VarId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; CIdent
</span><a href="Codegen.LibSSM.html#tmp_"><span class="hs-identifier hs-var">tmp_</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; VarId) -&gt; GenFn Int -&gt; GenFn VarId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">GenFn Int
</span><a href="Codegen.Codegen.html#getFresh"><span class="hs-identifier hs-var">getFresh</span></a></span><span>
</span><span id="line-207"></span><span>  </span><span id="local-6989586621679525293"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525293"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type -&gt; GenFn VarId
</span><a href="Codegen.Codegen.html#addLocal"><span class="hs-identifier hs-var">addLocal</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525295"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525296"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><span class="annottext">Exp -&gt; GenFn Exp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; GenFn Exp) -&gt; Exp -&gt; GenFn Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CIdent -&gt; Exp
</span><a href="Codegen.LibSSM.html#acts_"><span class="hs-identifier hs-var">acts_</span></a></span><span> </span><span class="annot"><span class="annottext">(CIdent -&gt; Exp) -&gt; CIdent -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; CIdent
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525293"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="hs-comment">-- | Translate a list of SSM parameters to C parameters.</span><span>
</span><span id="line-211"></span><span class="annot"><a href="Codegen.Codegen.html#genParams"><span class="hs-identifier hs-type">genParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#Binder"><span class="hs-identifier hs-type">I.Binder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Codegen.LibSSM.html#CIdent"><span class="hs-identifier hs-type">CIdent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-212"></span><span id="genParams"><span class="annot"><span class="annottext">genParams :: [(Binder, Type)] -&gt; [(CIdent, Type)]
</span><a href="Codegen.Codegen.html#genParams"><span class="hs-identifier hs-var hs-var">genParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; (Binder, Type) -&gt; (CIdent, Type))
-&gt; [Int] -&gt; [(Binder, Type)] -&gt; [(CIdent, Type)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; (Binder, Type) -&gt; (CIdent, Type)
forall (p :: * -&gt; * -&gt; *) a b.
(Bifunctor p, Identifiable a) =&gt;
Int -&gt; p (Maybe a) b -&gt; p CIdent Type
</span><a href="#local-6989586621679525290"><span class="hs-identifier hs-var">genArg</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679525290"><span class="annot"><span class="annottext">genArg :: Int -&gt; p (Maybe a) b -&gt; p CIdent Type
</span><a href="#local-6989586621679525290"><span class="hs-identifier hs-var hs-var">genArg</span></a></span></span><span> </span><span id="local-6989586621679525289"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525289"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; CIdent)
-&gt; (b -&gt; Type) -&gt; p (Maybe a) b -&gt; p CIdent Type
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CIdent -&gt; (a -&gt; CIdent) -&gt; Maybe a -&gt; CIdent
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; CIdent
</span><a href="Codegen.LibSSM.html#arg_"><span class="hs-identifier hs-var">arg_</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525289"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; CIdent
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; b -&gt; Type
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Codegen.LibSSM.html#value_t"><span class="hs-identifier hs-var">value_t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-comment">-- | Translate a list of SSM local declarations to C declarations.</span><span>
</span><span id="line-216"></span><span class="annot"><a href="Codegen.Codegen.html#genLocals"><span class="hs-identifier hs-type">genLocals</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Codegen.LibSSM.html#CIdent"><span class="hs-identifier hs-type">CIdent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-217"></span><span id="genLocals"><span class="annot"><span class="annottext">genLocals :: [(VarId, Type)] -&gt; [(CIdent, Type)]
</span><a href="Codegen.Codegen.html#genLocals"><span class="hs-identifier hs-var hs-var">genLocals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VarId, Type) -&gt; (CIdent, Type))
-&gt; [(VarId, Type)] -&gt; [(CIdent, Type)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(((VarId, Type) -&gt; (CIdent, Type))
 -&gt; [(VarId, Type)] -&gt; [(CIdent, Type)])
-&gt; ((VarId, Type) -&gt; (CIdent, Type))
-&gt; [(VarId, Type)]
-&gt; [(CIdent, Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VarId -&gt; CIdent)
-&gt; (Type -&gt; Type) -&gt; (VarId, Type) -&gt; (CIdent, Type)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; CIdent
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Type
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Codegen.LibSSM.html#value_t"><span class="hs-identifier hs-var">value_t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-comment">-- | Generate declarations for @numTrigs@ triggers.</span><span>
</span><span id="line-220"></span><span class="annot"><a href="Codegen.Codegen.html#genTrigs"><span class="hs-identifier hs-type">genTrigs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Codegen.LibSSM.html#CIdent"><span class="hs-identifier hs-type">CIdent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-221"></span><span id="genTrigs"><span class="annot"><span class="annottext">genTrigs :: Int -&gt; [(CIdent, Type)]
</span><a href="Codegen.Codegen.html#genTrigs"><span class="hs-identifier hs-var hs-var">genTrigs</span></a></span></span><span> </span><span id="local-6989586621679525281"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525281"><span class="hs-identifier hs-var">numTrigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[CIdent] -&gt; [Type] -&gt; [(CIdent, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; CIdent) -&gt; [Int] -&gt; [CIdent]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; CIdent
</span><a href="Codegen.LibSSM.html#trig_"><span class="hs-identifier hs-var">trig_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525281"><span class="hs-identifier hs-var">numTrigs</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [Type]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="Codegen.LibSSM.html#trigger_t"><span class="hs-identifier hs-var">trigger_t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">-- | The constant unit value, the singleton inhabitant of the type Unit.</span><span>
</span><span id="line-224"></span><span class="annot"><a href="Codegen.Codegen.html#unit"><span class="hs-keyword hs-type">unit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span>
</span><span id="line-225"></span><span id="unit"><span class="annot"><span class="annottext">unit :: Exp
</span><a href="Codegen.Codegen.html#unit"><span class="hs-keyword hs-var hs-var">unit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|0|]</span></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-comment">-- | Fake undefined value used for expressions of type Void.</span><span>
</span><span id="line-228"></span><span class="annot"><a href="Codegen.Codegen.html#undef"><span class="hs-identifier hs-type">undef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span>
</span><span id="line-229"></span><span id="undef"><span class="annot"><span class="annottext">undef :: Exp
</span><a href="Codegen.Codegen.html#undef"><span class="hs-identifier hs-var hs-var">undef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|0xdeadbeef|]</span></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="hs-comment">{-------- Compilation --------}</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="hs-comment">-- | Generate a C compilation from an SSM program.</span><span>
</span><span id="line-234"></span><span class="hs-comment">--</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- Each top-level function in a program is turned into three components:</span><span>
</span><span id="line-236"></span><span class="hs-comment">--</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- 1. a struct (the activation record);</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- 2. an initialization function (the enter function); and</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- 3. a step function, which corresponds to the actual procedure body.</span><span>
</span><span id="line-240"></span><span class="hs-comment">--</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- Items 2 and 3 include both declarations and definitions.</span><span>
</span><span id="line-242"></span><span class="annot"><a href="Codegen.Codegen.html#genProgram"><span class="hs-identifier hs-type">genProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Program"><span class="hs-identifier hs-type">I.Program</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">]</span><span>
</span><span id="line-243"></span><span id="genProgram"><span class="annot"><span class="annottext">genProgram :: Program Type -&gt; Pass [Definition]
</span><a href="Codegen.Codegen.html#genProgram"><span class="hs-identifier hs-var hs-var">genProgram</span></a></span></span><span> </span><span id="local-6989586621679525267"><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679525267"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679525266"><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679525266"><span class="hs-identifier hs-var">tdefs</span></a></span></span><span> </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525265"><span class="annot"><span class="annottext">TypegenInfo
</span><a href="#local-6989586621679525265"><span class="hs-identifier hs-var">tinfo</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(TConId, TypeDef)] -&gt; Pass ([Definition], TypegenInfo)
</span><a href="Codegen.Typegen.html#genTypes"><span class="hs-identifier hs-var">genTypes</span></a></span><span> </span><span class="annot"><span class="annottext">([(TConId, TypeDef)] -&gt; Pass ([Definition], TypegenInfo))
-&gt; [(TConId, TypeDef)] -&gt; Pass ([Definition], TypegenInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; [(TConId, TypeDef)]
forall t. Program t -&gt; [(TConId, TypeDef)]
</span><a href="IR.IR.html#typeDefs"><span class="hs-identifier hs-var hs-var">I.typeDefs</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679525267"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679525263"><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679525263"><span class="hs-identifier hs-var">cdecls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525262"><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679525262"><span class="hs-identifier hs-var">cdefns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[([Definition], [Definition])] -&gt; ([Definition], [Definition])
forall a a. [([a], [a])] -&gt; ([a], [a])
</span><a href="#local-6989586621679525261"><span class="hs-identifier hs-var">cUnpack</span></a></span><span> </span><span class="annot"><span class="annottext">([([Definition], [Definition])] -&gt; ([Definition], [Definition]))
-&gt; Pass [([Definition], [Definition])]
-&gt; Pass ([Definition], [Definition])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((VarId, Expr Type) -&gt; Pass ([Definition], [Definition]))
-&gt; [(VarId, Expr Type)] -&gt; Pass [([Definition], [Definition])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypegenInfo
-&gt; (VarId, Expr Type) -&gt; Pass ([Definition], [Definition])
</span><a href="#local-6989586621679525259"><span class="hs-identifier hs-var">genTop</span></a></span><span> </span><span class="annot"><span class="annottext">TypegenInfo
</span><a href="#local-6989586621679525265"><span class="hs-identifier hs-var">tinfo</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Program Type -&gt; [(VarId, Expr Type)]
forall t. Program t -&gt; [(VarId, Expr t)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var hs-var">I.programDefs</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679525267"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span id="local-6989586621679525257"><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679525257"><span class="hs-identifier hs-var">externs</span></a></span></span><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((VarId, Type) -&gt; Pass Definition)
-&gt; [(VarId, Type)] -&gt; Pass [Definition]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(VarId, Type) -&gt; Pass Definition
</span><a href="Codegen.Codegen.html#genExtern"><span class="hs-identifier hs-var">genExtern</span></a></span><span> </span><span class="annot"><span class="annottext">([(VarId, Type)] -&gt; Pass [Definition])
-&gt; [(VarId, Type)] -&gt; Pass [Definition]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; [(VarId, Type)]
forall t. Program t -&gt; [(VarId, Type)]
</span><a href="IR.IR.html#externDecls"><span class="hs-identifier hs-var hs-var">I.externDecls</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679525267"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-247"></span><span>  </span><span class="annot"><span class="annottext">[Definition] -&gt; Pass [Definition]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">([Definition] -&gt; Pass [Definition])
-&gt; [Definition] -&gt; Pass [Definition]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>  </span><span class="annot"><span class="annottext">[Definition]
</span><a href="Codegen.Codegen.html#includes"><span class="hs-identifier hs-var">includes</span></a></span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><span class="annottext">[Definition] -&gt; [Definition] -&gt; [Definition]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679525266"><span class="hs-identifier hs-var">tdefs</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><span class="annottext">[Definition] -&gt; [Definition] -&gt; [Definition]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679525257"><span class="hs-identifier hs-var">externs</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span class="annot"><span class="annottext">[Definition] -&gt; [Definition] -&gt; [Definition]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679525253"><span class="hs-identifier hs-var">cescs</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span class="annot"><span class="annottext">[Definition] -&gt; [Definition] -&gt; [Definition]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679525263"><span class="hs-identifier hs-var">cdecls</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><span class="annottext">[Definition] -&gt; [Definition] -&gt; [Definition]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Definition]
</span><a href="#local-6989586621679525262"><span class="hs-identifier hs-var">cdefns</span></a></span><span>
</span><span id="line-254"></span><span>    </span><span class="annot"><span class="annottext">[Definition] -&gt; [Definition] -&gt; [Definition]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; [Definition]
</span><a href="Codegen.Codegen.html#genInitProgram"><span class="hs-identifier hs-var">genInitProgram</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Program Type -&gt; VarId
forall t. Program t -&gt; VarId
</span><a href="IR.IR.html#programEntry"><span class="hs-identifier hs-var hs-var">I.programEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679525267"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><a href="#local-6989586621679525259"><span class="hs-identifier hs-type">genTop</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Typegen.html#TypegenInfo"><span class="hs-identifier hs-type">TypegenInfo</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>  </span><span id="local-6989586621679525259"><span class="annot"><span class="annottext">genTop :: TypegenInfo
-&gt; (VarId, Expr Type) -&gt; Pass ([Definition], [Definition])
</span><a href="#local-6989586621679525259"><span class="hs-identifier hs-var hs-var">genTop</span></a></span></span><span> </span><span id="local-6989586621679525250"><span class="annot"><span class="annottext">TypegenInfo
</span><a href="#local-6989586621679525250"><span class="hs-identifier hs-var">tinfo</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525249"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525249"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525248"><span class="annot"><span class="annottext">l :: Expr Type
</span><a href="#local-6989586621679525248"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679525246"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525246"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><span class="annottext">VarId
-&gt; [(Binder, Type)]
-&gt; Type
-&gt; Expr Type
-&gt; TypegenInfo
-&gt; [(VarId, Type)]
-&gt; GenFn ([Definition], [Definition])
-&gt; Pass ([Definition], [Definition])
forall a.
VarId
-&gt; [(Binder, Type)]
-&gt; Type
-&gt; Expr Type
-&gt; TypegenInfo
-&gt; [(VarId, Type)]
-&gt; GenFn a
-&gt; Pass a
</span><a href="Codegen.Codegen.html#runGenFn"><span class="hs-identifier hs-var">runGenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId -&gt; VarId
forall a b. (Identifiable a, Identifiable b) =&gt; a -&gt; b
</span><a href="Common.Identifiers.html#fromId"><span class="hs-identifier hs-var">fromId</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525249"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binder] -&gt; [Type] -&gt; [(Binder, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679525245"><span class="hs-identifier hs-var">argIds</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679525244"><span class="hs-identifier hs-var">argTys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525243"><span class="hs-identifier hs-var">retTy</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525242"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">TypegenInfo
</span><a href="#local-6989586621679525250"><span class="hs-identifier hs-var">tinfo</span></a></span><span> </span><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679525241"><span class="hs-identifier hs-var">tops</span></a></span><span> </span><span class="annot"><span class="annottext">(GenFn ([Definition], [Definition])
 -&gt; Pass ([Definition], [Definition]))
-&gt; GenFn ([Definition], [Definition])
-&gt; Pass ([Definition], [Definition])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679525240"><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525240"><span class="hs-identifier hs-var">stepDecl</span></a></span></span><span>   </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525239"><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525239"><span class="hs-identifier hs-var">stepDefn</span></a></span></span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn (Definition, Definition)
</span><a href="Codegen.Codegen.html#genStep"><span class="hs-identifier hs-var">genStep</span></a></span><span>
</span><span id="line-263"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679525237"><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525237"><span class="hs-identifier hs-var">enterDecl</span></a></span></span><span>  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525236"><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525236"><span class="hs-identifier hs-var">enterDefn</span></a></span></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn (Definition, Definition)
</span><a href="Codegen.Codegen.html#genEnter"><span class="hs-identifier hs-var">genEnter</span></a></span><span>
</span><span id="line-264"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679525234"><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525234"><span class="hs-identifier hs-var">closureDecl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525233"><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525233"><span class="hs-identifier hs-var">closureDefn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn (Definition, Definition)
</span><a href="Codegen.Codegen.html#genStaticClosure"><span class="hs-identifier hs-var">genStaticClosure</span></a></span><span>
</span><span id="line-265"></span><span>      </span><span id="local-6989586621679525231"><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525231"><span class="hs-identifier hs-var">structDefn</span></a></span></span><span>                 </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn Definition
</span><a href="Codegen.Codegen.html#genStruct"><span class="hs-identifier hs-var">genStruct</span></a></span><span>
</span><span id="line-266"></span><span>      </span><span class="annot"><span class="annottext">([Definition], [Definition]) -&gt; GenFn ([Definition], [Definition])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-267"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525231"><span class="hs-identifier hs-var">structDefn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525237"><span class="hs-identifier hs-var">enterDecl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525234"><span class="hs-identifier hs-var">closureDecl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525240"><span class="hs-identifier hs-var">stepDecl</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-268"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525236"><span class="hs-identifier hs-var">enterDefn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525233"><span class="hs-identifier hs-var">closureDefn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Definition
</span><a href="#local-6989586621679525239"><span class="hs-identifier hs-var">stepDefn</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-269"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>    </span><span id="local-6989586621679525241"><span class="annot"><span class="annottext">tops :: [(VarId, Type)]
</span><a href="#local-6989586621679525241"><span class="hs-identifier hs-var hs-var">tops</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VarId, Expr Type) -&gt; (VarId, Type))
-&gt; [(VarId, Expr Type)] -&gt; [(VarId, Type)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Expr Type -&gt; Type) -&gt; (VarId, Expr Type) -&gt; (VarId, Type)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall t. Expr t -&gt; t
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VarId, Expr Type)] -&gt; [(VarId, Type)])
-&gt; [(VarId, Expr Type)] -&gt; [(VarId, Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Program Type -&gt; [(VarId, Expr Type)]
forall t. Program t -&gt; [(VarId, Expr t)]
</span><a href="IR.IR.html#programDefs"><span class="hs-identifier hs-var hs-var">I.programDefs</span></a></span><span> </span><span class="annot"><span class="annottext">Program Type
</span><a href="#local-6989586621679525267"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679525245"><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679525245"><span class="hs-identifier hs-var">argIds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525242"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525242"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; ([Binder], Expr Type)
forall t. Expr t -&gt; ([Binder], Expr t)
</span><a href="IR.IR.html#unfoldLambda"><span class="hs-identifier hs-var">I.unfoldLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525248"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679525244"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679525244"><span class="hs-identifier hs-var">argTys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525243"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525243"><span class="hs-identifier hs-var">retTy</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([Type], Type)
</span><a href="IR.Types.Type.html#unfoldArrow"><span class="hs-identifier hs-var">I.unfoldArrow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525246"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><a href="#local-6989586621679525259"><span class="hs-identifier hs-var">genTop</span></a></span><span> </span><span class="annot"><span class="annottext">TypegenInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Lit"><span class="hs-identifier hs-type">I.Lit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pass ([Definition], [Definition])
forall a. HasCallStack =&gt; a
</span><a href="Codegen.Codegen.html#todo"><span class="hs-identifier hs-var">todo</span></a></span><span>
</span><span id="line-275"></span><span>  </span><span class="annot"><a href="#local-6989586621679525259"><span class="hs-identifier hs-var">genTop</span></a></span><span> </span><span class="annot"><span class="annottext">TypegenInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pass ([Definition], [Definition])
forall a. HasCallStack =&gt; a
</span><a href="Codegen.Codegen.html#nope"><span class="hs-identifier hs-var">nope</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>  </span><span id="local-6989586621679525261"><span class="annot"><span class="annottext">cUnpack :: [([a], [a])] -&gt; ([a], [a])
</span><a href="#local-6989586621679525261"><span class="hs-identifier hs-var hs-var">cUnpack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([[a]] -&gt; [a]) -&gt; ([[a]] -&gt; [a]) -&gt; ([[a]], [[a]]) -&gt; ([a], [a])
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">[[a]] -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[a]] -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">(([[a]], [[a]]) -&gt; ([a], [a]))
-&gt; ([([a], [a])] -&gt; ([[a]], [[a]])) -&gt; [([a], [a])] -&gt; ([a], [a])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[([a], [a])] -&gt; ([[a]], [[a]])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span>
</span><span id="line-278"></span><span>  </span><span id="local-6989586621679525253"><span class="annot"><span class="annottext">cescs :: [Definition]
</span><a href="#local-6989586621679525253"><span class="hs-identifier hs-var hs-var">cescs</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cunit|$esc:(I.cDefs p)|]</span></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-comment">-- | Include statements in the generated C file.</span><span>
</span><span id="line-281"></span><span class="annot"><a href="Codegen.Codegen.html#includes"><span class="hs-identifier hs-type">includes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">]</span><span>
</span><span id="line-282"></span><span id="includes"><span class="annot"><span class="annottext">includes :: [Definition]
</span><a href="Codegen.Codegen.html#includes"><span class="hs-identifier hs-var hs-var">includes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cunit|
$esc:(&quot;#include \&quot;ssm.h\&quot;&quot;)
typedef char unit;
|]</span></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span class="hs-comment">-- | Setup the entry point of the program.</span><span>
</span><span id="line-288"></span><span class="annot"><a href="Codegen.Codegen.html#genInitProgram"><span class="hs-identifier hs-type">genInitProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">]</span><span>
</span><span id="line-289"></span><span id="genInitProgram"><span class="annot"><span class="annottext">genInitProgram :: VarId -&gt; [Definition]
</span><a href="Codegen.Codegen.html#genInitProgram"><span class="hs-identifier hs-var hs-var">genInitProgram</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Definition] -&gt; VarId -&gt; [Definition]
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- genInitProgram entry = [cunit|</span><span>
</span><span id="line-291"></span><span class="hs-comment">--     $ty:act_t *$id:stdout_handler_enter($ty:act_t *parent,</span><span>
</span><span id="line-292"></span><span class="hs-comment">--                                         $ty:priority_t priority,</span><span>
</span><span id="line-293"></span><span class="hs-comment">--                                         $ty:depth_t depth,</span><span>
</span><span id="line-294"></span><span class="hs-comment">--                                         $ty:value_t *argv,</span><span>
</span><span id="line-295"></span><span class="hs-comment">--                                         $ty:value_t *ret);</span><span>
</span><span id="line-296"></span><span class="hs-comment">--</span><span>
</span><span id="line-297"></span><span class="hs-comment">--     void $id:stdin_handler_spawn($ty:sv_t *ssm_stdin);</span><span>
</span><span id="line-298"></span><span class="hs-comment">--     void $id:stdin_handler_kill(void);</span><span>
</span><span id="line-299"></span><span class="hs-comment">--</span><span>
</span><span id="line-300"></span><span class="hs-comment">--     void $id:program_init(void) {</span><span>
</span><span id="line-301"></span><span class="hs-comment">--       $ty:value_t ssm_stdin = $exp:std_sv;</span><span>
</span><span id="line-302"></span><span class="hs-comment">--       $ty:value_t ssm_stdout = $exp:std_sv;</span><span>
</span><span id="line-303"></span><span class="hs-comment">--</span><span>
</span><span id="line-304"></span><span class="hs-comment">--       $ty:value_t std_argv[2] = { ssm_stdin, ssm_stdout };</span><span>
</span><span id="line-305"></span><span class="hs-comment">--</span><span>
</span><span id="line-306"></span><span class="hs-comment">--       $exp:(activate enter_stdout);</span><span>
</span><span id="line-307"></span><span class="hs-comment">--       $exp:(activate enter_entry);</span><span>
</span><span id="line-308"></span><span class="hs-comment">--</span><span>
</span><span id="line-309"></span><span class="hs-comment">--       $id:stdin_handler_spawn($exp:(to_sv $ cexpr &quot;ssm_stdin&quot;));</span><span>
</span><span id="line-310"></span><span class="hs-comment">--     }</span><span>
</span><span id="line-311"></span><span class="hs-comment">--</span><span>
</span><span id="line-312"></span><span class="hs-comment">--     void $id:program_exit(void) {</span><span>
</span><span id="line-313"></span><span class="hs-comment">--       $id:stdin_handler_kill();</span><span>
</span><span id="line-314"></span><span class="hs-comment">--     }</span><span>
</span><span id="line-315"></span><span class="hs-comment">--   |]</span><span>
</span><span id="line-316"></span><span class="hs-comment">--  where</span><span>
</span><span id="line-317"></span><span class="hs-comment">--   std_sv                    = new_sv $ marshal [cexp|0|]</span><span>
</span><span id="line-318"></span><span class="hs-comment">--</span><span>
</span><span id="line-319"></span><span class="hs-comment">--   parArgs                   = genParArgs 2 (root_priority, root_depth)</span><span>
</span><span id="line-320"></span><span class="hs-comment">--   (stdoutPrio, stdoutDepth) = head parArgs</span><span>
</span><span id="line-321"></span><span class="hs-comment">--   (entryPrio , entryDepth ) = parArgs !! 1</span><span>
</span><span id="line-322"></span><span class="hs-comment">--   enter_stdout = [cexp|$id:stdout_handler_enter(&amp;$exp:top_parent,</span><span>
</span><span id="line-323"></span><span class="hs-comment">--                                                 $exp:stdoutPrio,</span><span>
</span><span id="line-324"></span><span class="hs-comment">--                                                 $exp:stdoutDepth,</span><span>
</span><span id="line-325"></span><span class="hs-comment">--                                                 &amp;ssm_stdout,</span><span>
</span><span id="line-326"></span><span class="hs-comment">--                                                 NULL)|]</span><span>
</span><span id="line-327"></span><span class="hs-comment">--</span><span>
</span><span id="line-328"></span><span class="hs-comment">--   enter_entry = [cexp|$id:(enter_ entry)(&amp;$exp:top_parent,</span><span>
</span><span id="line-329"></span><span class="hs-comment">--                                          $exp:entryPrio,</span><span>
</span><span id="line-330"></span><span class="hs-comment">--                                          $exp:entryDepth,</span><span>
</span><span id="line-331"></span><span class="hs-comment">--                                          std_argv,</span><span>
</span><span id="line-332"></span><span class="hs-comment">--                                          NULL)|]</span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span class="annot"><a href="Codegen.Codegen.html#genExtern"><span class="hs-identifier hs-type">genExtern</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.Identifiers.html#VarId"><span class="hs-identifier hs-type">I.VarId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.Compiler.html#Pass"><span class="hs-identifier hs-type">Compiler.Pass</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span>
</span><span id="line-335"></span><span id="genExtern"><span class="annot"><span class="annottext">genExtern :: (VarId, Type) -&gt; Pass Definition
</span><a href="Codegen.Codegen.html#genExtern"><span class="hs-identifier hs-var hs-var">genExtern</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525213"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525213"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525212"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525212"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Definition -&gt; Pass Definition
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="">[cedecl|
    extern $ty:value_t $id:v($params:xparams);
  |]</span></span><span>
</span><span id="line-338"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-339"></span><span>  </span><span id="local-6989586621679525198"><span class="annot"><span class="annottext">argNum :: Int
</span><a href="#local-6989586621679525198"><span class="hs-identifier hs-var hs-var">argNum</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; Int) -&gt; [Type] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Type], Type) -&gt; [Type]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(([Type], Type) -&gt; [Type]) -&gt; ([Type], Type) -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; ([Type], Type)
</span><a href="IR.Types.Type.html#unfoldArrow"><span class="hs-identifier hs-var">I.unfoldArrow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525212"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-340"></span><span>  </span><span id="local-6989586621679525211"><span class="annot"><span class="annottext">xparams :: [Param]
</span><a href="#local-6989586621679525211"><span class="hs-identifier hs-var hs-var">xparams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Param -&gt; [Param]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525198"><span class="hs-identifier hs-var">argNum</span></a></span><span> </span><span class="annot"><span class="">[cparam|$ty:value_t|]</span></span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span class="hs-comment">-- | Generate struct definition for an SSM procedure.</span><span>
</span><span id="line-343"></span><span class="hs-comment">--</span><span>
</span><span id="line-344"></span><span class="hs-comment">-- This is where local variables, triggers, and parameter values are stored.</span><span>
</span><span id="line-345"></span><span class="annot"><a href="Codegen.Codegen.html#genStruct"><span class="hs-identifier hs-type">genStruct</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span>
</span><span id="line-346"></span><span id="genStruct"><span class="annot"><span class="annottext">genStruct :: GenFn Definition
</span><a href="Codegen.Codegen.html#genStruct"><span class="hs-identifier hs-var hs-var">genStruct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-347"></span><span>  </span><span id="local-6989586621679525189"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525189"><span class="hs-identifier hs-var">name</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; VarId) -&gt; GenFn VarId
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; VarId
</span><a href="Codegen.Codegen.html#fnName"><span class="hs-identifier hs-var hs-var">fnName</span></a></span><span>
</span><span id="line-348"></span><span>  </span><span id="local-6989586621679525188"><span class="annot"><span class="annottext">[(Binder, Type)]
</span><a href="#local-6989586621679525188"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; [(Binder, Type)]) -&gt; GenFn [(Binder, Type)]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; [(Binder, Type)]
</span><a href="Codegen.Codegen.html#fnParams"><span class="hs-identifier hs-var hs-var">fnParams</span></a></span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-comment">-- retTy  &lt;- gets fnRetTy</span><span>
</span><span id="line-350"></span><span>  </span><span id="local-6989586621679525187"><span class="annot"><span class="annottext">[(VarId, Type)]
</span><a href="#local-6989586621679525187"><span class="hs-identifier hs-var">locs</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VarId Type -&gt; [(VarId, Type)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map VarId Type -&gt; [(VarId, Type)])
-&gt; GenFn (Map VarId Type) -&gt; GenFn [(VarId, Type)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Map VarId Type) -&gt; GenFn (Map VarId Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Map VarId Type
</span><a href="Codegen.Codegen.html#fnLocals"><span class="hs-identifier hs-var hs-var">fnLocals</span></a></span><span>
</span><span id="line-351"></span><span>  </span><span id="local-6989586621679525185"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525185"><span class="hs-identifier hs-var">trigs</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Int) -&gt; GenFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Int
</span><a href="Codegen.Codegen.html#fnMaxWaits"><span class="hs-identifier hs-var hs-var">fnMaxWaits</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>  </span><span class="annot"><span class="annottext">Definition -&gt; GenFn Definition
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="">[cedecl|
    typedef struct {
      $ty:act_t $id:act_member;

      $sdecls:(map structField $ genParams params)
      $ty:value_t *$id:ret_val;
      $sdecls:(map structField $ genLocals locs)
      $sdecls:(map structField $ genTrigs trigs)

    } $id:(act_typename name);
  |]</span></span><span>
</span><span id="line-364"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-365"></span><span>  </span><span class="annot"><a href="#local-6989586621679525184"><span class="hs-identifier hs-type">structField</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codegen.LibSSM.html#CIdent"><span class="hs-identifier hs-type">CIdent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.FieldGroup</span></span><span>
</span><span id="line-366"></span><span>  </span><span id="local-6989586621679525184"><span class="annot"><span class="annottext">structField :: (CIdent, Type) -&gt; FieldGroup
</span><a href="#local-6989586621679525184"><span class="hs-identifier hs-var hs-var">structField</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525165"><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679525165"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525164"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525164"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[csdecl|$ty:t $id:n;|]</span></span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="hs-comment">-- | Generate the enter function for an SSM procedure and its signature.</span><span>
</span><span id="line-369"></span><span class="hs-comment">--</span><span>
</span><span id="line-370"></span><span class="hs-comment">-- Its struct is allocated and initialized (partially; local variables' values are</span><span>
</span><span id="line-371"></span><span class="hs-comment">-- left uninitialized).</span><span>
</span><span id="line-372"></span><span class="annot"><a href="Codegen.Codegen.html#genEnter"><span class="hs-identifier hs-type">genEnter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span id="genEnter"><span class="annot"><span class="annottext">genEnter :: GenFn (Definition, Definition)
</span><a href="Codegen.Codegen.html#genEnter"><span class="hs-identifier hs-var hs-var">genEnter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-374"></span><span>  </span><span id="local-6989586621679525158"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525158"><span class="hs-identifier hs-var">actName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; VarId) -&gt; GenFn VarId
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; VarId
</span><a href="Codegen.Codegen.html#fnName"><span class="hs-identifier hs-var hs-var">fnName</span></a></span><span>
</span><span id="line-375"></span><span>  </span><span id="local-6989586621679525157"><span class="annot"><span class="annottext">[(Binder, Type)]
</span><a href="#local-6989586621679525157"><span class="hs-identifier hs-var">params</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; [(Binder, Type)]) -&gt; GenFn [(Binder, Type)]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; [(Binder, Type)]
</span><a href="Codegen.Codegen.html#fnParams"><span class="hs-identifier hs-var hs-var">fnParams</span></a></span><span>
</span><span id="line-376"></span><span>  </span><span id="local-6989586621679525156"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525156"><span class="hs-identifier hs-var">trigs</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Int) -&gt; GenFn Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Int
</span><a href="Codegen.Codegen.html#fnMaxWaits"><span class="hs-identifier hs-var hs-var">fnMaxWaits</span></a></span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525155"><span class="annot"><span class="annottext">act :: Type
</span><a href="#local-6989586621679525155"><span class="hs-identifier hs-var hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type
</span><a href="Codegen.LibSSM.html#act_"><span class="hs-identifier hs-var">act_</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525158"><span class="hs-identifier hs-var">actName</span></a></span><span>
</span><span id="line-378"></span><span>      </span><span id="local-6989586621679525153"><span class="annot"><span class="annottext">enterParams :: [Param]
</span><a href="#local-6989586621679525153"><span class="hs-identifier hs-var hs-var">enterParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="">[cparam|$ty:act_t *$id:enter_caller|]</span></span><span>
</span><span id="line-380"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[cparam|$ty:priority_t $id:enter_priority|]</span></span><span>
</span><span id="line-381"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[cparam|$ty:depth_t $id:enter_depth|]</span></span><span>
</span><span id="line-382"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[cparam|$ty:value_t *$id:argv|]</span></span><span>
</span><span id="line-383"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[cparam|$ty:value_t *$id:ret_val|]</span></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-385"></span><span>      </span><span id="local-6989586621679525121"><span class="annot"><span class="annottext">alloc_act :: Exp
</span><a href="#local-6989586621679525121"><span class="hs-identifier hs-var hs-var">alloc_act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Exp -&gt; Exp -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#enter"><span class="hs-identifier hs-var">enter</span></a></span><span> </span><span class="annot"><span class="">[cexp|sizeof($ty:act)|]</span></span><span>
</span><span id="line-386"></span><span>                        </span><span class="annot"><span class="">[cexp|$id:(step_ actName)|]</span></span><span>
</span><span id="line-387"></span><span>                        </span><span class="annot"><span class="">[cexp|$id:enter_caller|]</span></span><span>
</span><span id="line-388"></span><span>                        </span><span class="annot"><span class="">[cexp|$id:enter_priority|]</span></span><span>
</span><span id="line-389"></span><span>                        </span><span class="annot"><span class="">[cexp|$id:enter_depth|]</span></span><span>
</span><span id="line-390"></span><span>      </span><span id="local-6989586621679525116"><span class="annot"><span class="annottext">get_acts :: Exp
</span><a href="#local-6989586621679525116"><span class="hs-identifier hs-var hs-var">get_acts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; VarId -&gt; Exp
</span><a href="Codegen.LibSSM.html#to_act"><span class="hs-identifier hs-var">to_act</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CIdent -&gt; Exp
</span><a href="Codegen.LibSSM.html#cexpr"><span class="hs-identifier hs-var">cexpr</span></a></span><span> </span><span class="annot"><span class="annottext">CIdent
</span><a href="Codegen.LibSSM.html#actg"><span class="hs-identifier hs-var">actg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525158"><span class="hs-identifier hs-var">actName</span></a></span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span>      </span><span id="local-6989586621679525495"><span class="annot"><a href="#local-6989586621679525112"><span class="hs-identifier hs-type">initParam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codegen.LibSSM.html#CIdent"><span class="hs-identifier hs-type">CIdent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679525495"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Stm</span></span></span><span>
</span><span id="line-393"></span><span>      </span><span id="local-6989586621679525112"><span class="annot"><span class="annottext">initParam :: (CIdent, b) -&gt; Int -&gt; Stm
</span><a href="#local-6989586621679525112"><span class="hs-identifier hs-var hs-var">initParam</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525111"><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679525111"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679525110"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525110"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cstm|$id:acts-&gt;$id:n = $id:argv[$int:i];|]</span></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>      </span><span id="local-6989586621679525496"><span class="annot"><a href="#local-6989586621679525103"><span class="hs-identifier hs-type">initTrig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Codegen.LibSSM.html#CIdent"><span class="hs-identifier hs-type">CIdent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679525496"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Stm</span></span></span><span>
</span><span id="line-396"></span><span>      </span><span id="local-6989586621679525103"><span class="annot"><span class="annottext">initTrig :: (CIdent, b) -&gt; Stm
</span><a href="#local-6989586621679525103"><span class="hs-identifier hs-var hs-var">initTrig</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679525102"><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679525102"><span class="hs-identifier hs-var">trigId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cstm|$id:acts-&gt;$id:trigId.act = $id:actg;|]</span></span><span>
</span><span id="line-397"></span><span>  </span><span class="annot"><span class="annottext">(Definition, Definition) -&gt; GenFn (Definition, Definition)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[cedecl|$ty:act_t *$id:(enter_ actName)($params:enterParams);|]</span></span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[cedecl|
        $ty:act_t *$id:(enter_ actName)($params:enterParams) {
          $ty:act_t *$id:actg = $exp:alloc_act;
          $ty:act *$id:acts = $exp:get_acts;

          /* Assign parameters */
          $stms:(zipWith initParam (genParams params) [0..])

          /* Set return value */
          $id:acts-&gt;$id:ret_val = $id:ret_val;

          /* Initialize triggers */
          $stms:(map initTrig $ genTrigs trigs)

          return $id:actg;
        }
      |]</span></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span class="hs-comment">-- | Generate static closure for top-level function</span><span>
</span><span id="line-419"></span><span class="annot"><a href="Codegen.Codegen.html#genStaticClosure"><span class="hs-identifier hs-type">genStaticClosure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span id="genStaticClosure"><span class="annot"><span class="annottext">genStaticClosure :: GenFn (Definition, Definition)
</span><a href="Codegen.Codegen.html#genStaticClosure"><span class="hs-identifier hs-var hs-var">genStaticClosure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-421"></span><span>  </span><span id="local-6989586621679525073"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525073"><span class="hs-identifier hs-var">actName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; VarId) -&gt; GenFn VarId
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; VarId
</span><a href="Codegen.Codegen.html#fnName"><span class="hs-identifier hs-var hs-var">fnName</span></a></span><span>
</span><span id="line-422"></span><span>  </span><span id="local-6989586621679525072"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525072"><span class="hs-identifier hs-var">argc</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Binder, Type)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([(Binder, Type)] -&gt; Int) -&gt; GenFn [(Binder, Type)] -&gt; GenFn Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; [(Binder, Type)]) -&gt; GenFn [(Binder, Type)]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; [(Binder, Type)]
</span><a href="Codegen.Codegen.html#fnParams"><span class="hs-identifier hs-var hs-var">fnParams</span></a></span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525071"><span class="annot"><span class="annottext">closure_name :: CIdent
</span><a href="#local-6989586621679525071"><span class="hs-identifier hs-var hs-var">closure_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; CIdent
</span><a href="Codegen.LibSSM.html#closure_"><span class="hs-identifier hs-var">closure_</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525073"><span class="hs-identifier hs-var">actName</span></a></span><span>
</span><span id="line-424"></span><span>      </span><span id="local-6989586621679525070"><span class="annot"><span class="annottext">enter_f :: Exp
</span><a href="#local-6989586621679525070"><span class="hs-identifier hs-var hs-var">enter_f</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$id:(enter_ actName)|]</span></span><span>
</span><span id="line-425"></span><span>  </span><span class="annot"><span class="annottext">(Definition, Definition) -&gt; GenFn (Definition, Definition)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-426"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[cedecl|extern $ty:closure1_t $id:closure_name;|]</span></span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[cedecl|$ty:closure1_t $id:closure_name = $init:(static_closure enter_f argc);|]</span></span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span class="hs-comment">-- | Generate the step function for an SSM procedure.</span><span>
</span><span id="line-431"></span><span class="hs-comment">--</span><span>
</span><span id="line-432"></span><span class="hs-comment">-- This function just defines the function definition and switch statement that</span><span>
</span><span id="line-433"></span><span class="hs-comment">-- wraps the statements of the procedure. The heavy lifting is performed by</span><span>
</span><span id="line-434"></span><span class="hs-comment">-- 'genExpr'.</span><span>
</span><span id="line-435"></span><span class="annot"><a href="Codegen.Codegen.html#genStep"><span class="hs-identifier hs-type">genStep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span id="genStep"><span class="annot"><span class="annottext">genStep :: GenFn (Definition, Definition)
</span><a href="Codegen.Codegen.html#genStep"><span class="hs-identifier hs-var hs-var">genStep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-437"></span><span>  </span><span id="local-6989586621679525057"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525057"><span class="hs-identifier hs-var">actName</span></a></span></span><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; VarId) -&gt; GenFn VarId
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; VarId
</span><a href="Codegen.Codegen.html#fnName"><span class="hs-identifier hs-var hs-var">fnName</span></a></span><span>
</span><span id="line-438"></span><span>  </span><span id="local-6989586621679525056"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525056"><span class="hs-identifier hs-var">actBody</span></a></span></span><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Expr Type) -&gt; GenFn (Expr Type)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Expr Type
</span><a href="Codegen.Codegen.html#fnBody"><span class="hs-identifier hs-var hs-var">fnBody</span></a></span><span>
</span><span id="line-439"></span><span>  </span><span id="local-6989586621679525055"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525055"><span class="hs-identifier hs-var">firstCase</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn Int
</span><a href="Codegen.Codegen.html#nextCase"><span class="hs-identifier hs-var">nextCase</span></a></span><span>
</span><span id="line-440"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679525054"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679525054"><span class="hs-identifier hs-var">ret_expr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525053"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679525053"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525056"><span class="hs-identifier hs-var">actBody</span></a></span><span> </span><span class="hs-comment">-- Toss away return value</span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679525051"><span class="annot"><span class="annottext">act :: Type
</span><a href="#local-6989586621679525051"><span class="hs-identifier hs-var hs-var">act</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Type
</span><a href="Codegen.LibSSM.html#act_"><span class="hs-identifier hs-var">act_</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525057"><span class="hs-identifier hs-var">actName</span></a></span><span>
</span><span id="line-442"></span><span>      </span><span id="local-6989586621679525050"><span class="annot"><span class="annottext">get_acts :: Exp
</span><a href="#local-6989586621679525050"><span class="hs-identifier hs-var hs-var">get_acts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; VarId -&gt; Exp
</span><a href="Codegen.LibSSM.html#to_act"><span class="hs-identifier hs-var">to_act</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CIdent -&gt; Exp
</span><a href="Codegen.LibSSM.html#cexpr"><span class="hs-identifier hs-var">cexpr</span></a></span><span> </span><span class="annot"><span class="annottext">CIdent
</span><a href="Codegen.LibSSM.html#actg"><span class="hs-identifier hs-var">actg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525057"><span class="hs-identifier hs-var">actName</span></a></span><span>
</span><span id="line-443"></span><span>      </span><span id="local-6989586621679525049"><span class="annot"><span class="annottext">do_leave :: Exp
</span><a href="#local-6989586621679525049"><span class="hs-identifier hs-var hs-var">do_leave</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#leave"><span class="hs-identifier hs-var">leave</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CIdent -&gt; Exp
</span><a href="Codegen.LibSSM.html#cexpr"><span class="hs-identifier hs-var">cexpr</span></a></span><span> </span><span class="annot"><span class="annottext">CIdent
</span><a href="Codegen.LibSSM.html#actg"><span class="hs-identifier hs-var">actg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Exp
</span><a href="Codegen.LibSSM.html#csizeof"><span class="hs-identifier hs-var">csizeof</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525051"><span class="hs-identifier hs-var">act</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>  </span><span class="annot"><span class="annottext">(Definition, Definition) -&gt; GenFn (Definition, Definition)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-445"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[cedecl|void $id:(step_ actName)($ty:act_t *$id:actg);|]</span></span><span>
</span><span id="line-446"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[cedecl|
        void $id:(step_ actName)($ty:act_t *$id:actg) {
          $ty:act *$id:acts = $exp:get_acts;

          switch ($id:actg-&gt;$id:act_pc) {
          case $int:firstCase:;
            $items:stms

          default:
            break;
          }
        if ($id:acts-&gt;$id:ret_val)
          *$id:acts-&gt;$id:ret_val = $exp:ret_expr;
        $id:leave_label:
          $exp:do_leave;
        }
      |]</span></span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>
</span><span id="line-465"></span><span class="hs-comment">-- | Helper to generate yield point in step function.</span><span>
</span><span id="line-466"></span><span class="annot"><a href="Codegen.Codegen.html#genYield"><span class="hs-identifier hs-type">genYield</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span>
</span><span id="line-467"></span><span id="genYield"><span class="annot"><span class="annottext">genYield :: GenFn [BlockItem]
</span><a href="Codegen.Codegen.html#genYield"><span class="hs-identifier hs-var hs-var">genYield</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-468"></span><span>  </span><span id="local-6989586621679525018"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679525018"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn Int
</span><a href="Codegen.Codegen.html#nextCase"><span class="hs-identifier hs-var">nextCase</span></a></span><span>
</span><span id="line-469"></span><span>  </span><span class="annot"><span class="annottext">[BlockItem] -&gt; GenFn [BlockItem]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="">[citems|
    $id:actg-&gt;$id:act_pc = $int:next;
    return;
    case $int:next:;
    |]</span></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span class="hs-comment">-- | Translate an SSM expression into a C expression and statements.</span><span>
</span><span id="line-476"></span><span class="hs-comment">--</span><span>
</span><span id="line-477"></span><span class="hs-comment">-- SSM IR is a side-effectful expression language, with two implications when</span><span>
</span><span id="line-478"></span><span class="hs-comment">-- translating to C:</span><span>
</span><span id="line-479"></span><span class="hs-comment">--</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- 1.  every expression has a value (even if it is an uninhabited type), so this</span><span>
</span><span id="line-481"></span><span class="hs-comment">--    must be reflected in C; and</span><span>
</span><span id="line-482"></span><span class="hs-comment">-- 2.  some of the side effects in SSM cannot be implemented in C using expressions</span><span>
</span><span id="line-483"></span><span class="hs-comment">--    alone.</span><span>
</span><span id="line-484"></span><span class="hs-comment">--</span><span>
</span><span id="line-485"></span><span class="hs-comment">-- These two implications roughly translate to the @C.Exp@ and @[C.BlockItem]@ in</span><span>
</span><span id="line-486"></span><span class="hs-comment">-- @genExpr@'s return type. When we translate an SSM expression @e@:</span><span>
</span><span id="line-487"></span><span class="hs-comment">--</span><span>
</span><span id="line-488"></span><span class="hs-comment">-- &gt; (val, stms) &lt;- genExpr e</span><span>
</span><span id="line-489"></span><span class="hs-comment">--</span><span>
</span><span id="line-490"></span><span class="hs-comment">-- @val@ represents the C expression that corresponds to the value of @e@ upon</span><span>
</span><span id="line-491"></span><span class="hs-comment">-- evaluation, while @stms@ represents the list of preceding statements that</span><span>
</span><span id="line-492"></span><span class="hs-comment">-- compute @val@.</span><span>
</span><span id="line-493"></span><span class="hs-comment">--</span><span>
</span><span id="line-494"></span><span class="hs-comment">-- A further consideration upon point 2 is that SSM expressions may yield control</span><span>
</span><span id="line-495"></span><span class="hs-comment">-- at any point. Thus, the C expression returned by @genExpr@ must accommodate the</span><span>
</span><span id="line-496"></span><span class="hs-comment">-- step function suspending and resuming. For instance, consider the following SSM</span><span>
</span><span id="line-497"></span><span class="hs-comment">-- IR expression:</span><span>
</span><span id="line-498"></span><span class="hs-comment">--</span><span>
</span><span id="line-499"></span><span class="hs-comment">-- &gt; (let x = 3 in x) + (wait r; 6)</span><span>
</span><span id="line-500"></span><span class="hs-comment">--</span><span>
</span><span id="line-501"></span><span class="hs-comment">-- The @x@ in the let-binding in the left operand cannot just be a local variable</span><span>
</span><span id="line-502"></span><span class="hs-comment">-- in the step function, because it would be &quot;uninitialized&quot; by the yield in the</span><span>
</span><span id="line-503"></span><span class="hs-comment">-- right operand:</span><span>
</span><span id="line-504"></span><span class="hs-comment">--</span><span>
</span><span id="line-505"></span><span class="hs-comment">-- &gt;   // let x = 3 in x</span><span>
</span><span id="line-506"></span><span class="hs-comment">-- &gt;   // stms:</span><span>
</span><span id="line-507"></span><span class="hs-comment">-- &gt;   int x = 3;</span><span>
</span><span id="line-508"></span><span class="hs-comment">-- &gt;   // exp: x</span><span>
</span><span id="line-509"></span><span class="hs-comment">-- &gt;</span><span>
</span><span id="line-510"></span><span class="hs-comment">-- &gt;   // (wait r; 6)</span><span>
</span><span id="line-511"></span><span class="hs-comment">-- &gt;   // stms:</span><span>
</span><span id="line-512"></span><span class="hs-comment">-- &gt;   ssm_sensitize(r);</span><span>
</span><span id="line-513"></span><span class="hs-comment">-- &gt;   actg-&gt;pc = N;</span><span>
</span><span id="line-514"></span><span class="hs-comment">-- &gt;   return;</span><span>
</span><span id="line-515"></span><span class="hs-comment">-- &gt; case N:</span><span>
</span><span id="line-516"></span><span class="hs-comment">-- &gt;   ssm_desensitize(r);</span><span>
</span><span id="line-517"></span><span class="hs-comment">-- &gt;   // exp: 6</span><span>
</span><span id="line-518"></span><span class="hs-comment">-- &gt;</span><span>
</span><span id="line-519"></span><span class="hs-comment">-- &gt;   // After the return, x is no longer initialized, so the following is</span><span>
</span><span id="line-520"></span><span class="hs-comment">-- &gt;   // undefined behavior:</span><span>
</span><span id="line-521"></span><span class="hs-comment">-- &gt;   x + 6</span><span>
</span><span id="line-522"></span><span class="hs-comment">--</span><span>
</span><span id="line-523"></span><span class="hs-comment">-- To ensure this is cannot happen, we conservatively declare @x@ as a local</span><span>
</span><span id="line-524"></span><span class="hs-comment">-- variable in the activation record, so that its value is preserved between</span><span>
</span><span id="line-525"></span><span class="hs-comment">-- yields, even if this is not usually necessary. We leave it to later compiler</span><span>
</span><span id="line-526"></span><span class="hs-comment">-- passes to optimize this.</span><span>
</span><span id="line-527"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-type">genExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span id="genExpr"><span class="annot"><span class="annottext">genExpr :: Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var hs-var">genExpr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Var"><span class="hs-identifier hs-type">I.Var</span></a></span><span> </span><span id="local-6989586621679525016"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525016"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-529"></span><span>  </span><span id="local-6989586621679525015"><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621679525015"><span class="hs-identifier hs-var">mv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId Exp -&gt; Maybe Exp
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525016"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VarId Exp -&gt; Maybe Exp)
-&gt; GenFn (Map VarId Exp) -&gt; GenFn (Maybe Exp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Map VarId Exp) -&gt; GenFn (Map VarId Exp)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Map VarId Exp
</span><a href="Codegen.Codegen.html#fnVars"><span class="hs-identifier hs-var hs-var">fnVars</span></a></span><span>
</span><span id="line-530"></span><span>  </span><span id="local-6989586621679525013"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679525013"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn Exp -&gt; (Exp -&gt; GenFn Exp) -&gt; Maybe Exp -&gt; GenFn Exp
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">GenFn Exp
forall a. GenFn a
</span><a href="#local-6989586621679525012"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; GenFn Exp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621679525015"><span class="hs-identifier hs-var">mv</span></a></span><span>
</span><span id="line-531"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679525013"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679525012"><span class="annot"><span class="annottext">err :: GenFn a
</span><a href="#local-6989586621679525012"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; GenFn a
forall (m :: * -&gt; *) a. MonadError Error m =&gt; [Char] -&gt; m a
</span><a href="Common.Compiler.html#unexpected"><span class="hs-identifier hs-var">Compiler.unexpected</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; GenFn a) -&gt; [Char] -&gt; GenFn a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Codegen: Could not find I.Var named &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">VarId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525016"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-533"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Data"><span class="hs-identifier hs-type">I.Data</span></a></span><span> </span><span id="local-6989586621679525009"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679525009"><span class="hs-identifier hs-var">dcon</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-534"></span><span>  </span><span id="local-6989586621679525008"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679525008"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DConInfo -&gt; Exp) -&gt; DConId -&gt; GenFn Exp
forall a. (DConInfo -&gt; a) -&gt; DConId -&gt; GenFn a
</span><a href="Codegen.Codegen.html#getsDCon"><span class="hs-identifier hs-var">getsDCon</span></a></span><span> </span><span class="annot"><span class="annottext">DConInfo -&gt; Exp
</span><a href="Codegen.Typegen.html#dconConstruct"><span class="hs-identifier hs-var hs-var">dconConstruct</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679525009"><span class="hs-identifier hs-var">dcon</span></a></span><span>
</span><span id="line-535"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679525008"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Lit"><span class="hs-identifier hs-type">I.Lit</span></a></span><span> </span><span id="local-6989586621679525006"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679525006"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679525005"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525005"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-537"></span><span>  </span><span id="local-6989586621679525004"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679525004"><span class="hs-identifier hs-var">tmp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679525005"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-538"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679525004"><span class="hs-identifier hs-var">tmp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[citems|$exp:tmp = $exp:(genLiteral l);|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Let"><span class="hs-identifier hs-type">I.Let</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679525001"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525001"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679525000"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525000"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679524999"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524999"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524998"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524998"><span class="hs-identifier hs-var">defVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524997"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524997"><span class="hs-identifier hs-var">defStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525000"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-541"></span><span>  </span><span class="annot"><span class="annottext">(VarId, Type)
-&gt; GenFn (Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall a. (VarId, Type) -&gt; GenFn a -&gt; GenFn a
</span><a href="Codegen.Codegen.html#withNewLocal"><span class="hs-identifier hs-var">withNewLocal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525001"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall t. Expr t -&gt; t
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679525000"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(GenFn (Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem]))
-&gt; GenFn (Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-542"></span><span>    </span><span class="hs-comment">-- Look up n because withNewLocal may have mangled its name.</span><span>
</span><span id="line-543"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679524996"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524996"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarId -&gt; Map VarId Exp -&gt; Maybe Exp
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679525001"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VarId Exp -&gt; Maybe Exp)
-&gt; GenFn (Map VarId Exp) -&gt; GenFn (Maybe Exp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(GenFnState -&gt; Map VarId Exp) -&gt; GenFn (Map VarId Exp)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">GenFnState -&gt; Map VarId Exp
</span><a href="Codegen.Codegen.html#fnVars"><span class="hs-identifier hs-var hs-var">fnVars</span></a></span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524995"><span class="annot"><span class="annottext">defInit :: [BlockItem]
</span><a href="#local-6989586621679524995"><span class="hs-identifier hs-var hs-var">defInit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|$exp:n' = $exp:defVal;|]</span></span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679524994"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524994"><span class="hs-identifier hs-var">bodyVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524993"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524993"><span class="hs-identifier hs-var">bodyStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524999"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-546"></span><span>    </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524994"><span class="hs-identifier hs-var">bodyVal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524997"><span class="hs-identifier hs-var">defStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524995"><span class="hs-identifier hs-var">defInit</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524993"><span class="hs-identifier hs-var">bodyStms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Let"><span class="hs-identifier hs-type">I.Let</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524992"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524992"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span id="local-6989586621679524991"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524991"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524990"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524990"><span class="hs-identifier hs-var">defStms</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524992"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-comment">-- Throw away value</span><span>
</span><span id="line-549"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524989"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524989"><span class="hs-identifier hs-var">bodyVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524988"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">bodyStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524991"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-550"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524989"><span class="hs-identifier hs-var">bodyVal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524990"><span class="hs-identifier hs-var">defStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524988"><span class="hs-identifier hs-var">bodyStms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><a href="IR.IR.html#Let"><span class="hs-identifier hs-type">I.Let</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot handle mutually recursive bindings&quot;</span></span><span>
</span><span id="line-552"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span id="local-6989586621679524987"><span class="annot"><span class="annottext">e :: Expr Type
</span><a href="#local-6989586621679524987"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#App"><span class="hs-identifier hs-type">I.App</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679524985"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524985"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-553"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679524984"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524984"><span class="hs-identifier hs-var">fn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524983"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524983"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([(Expr Type, Type)] -&gt; [Expr Type])
-&gt; (Expr Type, [(Expr Type, Type)]) -&gt; (Expr Type, [Expr Type])
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Expr Type, Type) -&gt; Expr Type)
-&gt; [(Expr Type, Type)] -&gt; [Expr Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type, Type) -&gt; Expr Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Expr Type, [(Expr Type, Type)]) -&gt; (Expr Type, [Expr Type]))
-&gt; (Expr Type, [(Expr Type, Type)]) -&gt; (Expr Type, [Expr Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; (Expr Type, [(Expr Type, Type)])
forall t. Expr t -&gt; (Expr t, [(Expr t, t)])
</span><a href="IR.IR.html#unfoldApp"><span class="hs-identifier hs-var">I.unfoldApp</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524987"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-554"></span><span>  </span><span class="hs-comment">-- args must be non-empty because a is an App</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524984"><span class="hs-identifier hs-var">fn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-556"></span><span>    </span><span class="hs-comment">-- I.Var _ _ -&gt; do</span><span>
</span><span id="line-557"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Dup"><span class="hs-identifier hs-var">I.Dup</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.IR.html#Var"><span class="hs-identifier hs-type">I.Var</span></a></span><span> </span><span class="annot"><span class="annottext">VarId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-558"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679524979"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524979"><span class="hs-identifier hs-var">fnExp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524978"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524978"><span class="hs-identifier hs-var">fnStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524984"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-559"></span><span>      </span><span class="annot"><span class="annottext">((Exp, [BlockItem]) -&gt; Expr Type -&gt; GenFn (Exp, [BlockItem]))
-&gt; (Exp, [BlockItem]) -&gt; [Expr Type] -&gt; GenFn (Exp, [BlockItem])
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="#local-6989586621679524977"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524979"><span class="hs-identifier hs-var">fnExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524978"><span class="hs-identifier hs-var">fnStms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524983"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-560"></span><span>     </span><span class="hs-keyword">where</span><span>
</span><span id="line-561"></span><span>      </span><span id="local-6989586621679524977"><span class="annot"><span class="annottext">apply :: (Exp, [BlockItem]) -&gt; Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="#local-6989586621679524977"><span class="hs-identifier hs-var hs-var">apply</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679524976"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524976"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524975"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524975"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679524974"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524974"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-562"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679524973"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524973"><span class="hs-identifier hs-var">aVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524972"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524972"><span class="hs-identifier hs-var">aStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524974"><span class="hs-identifier hs-var">a</span></a></span><span>  </span><span class="hs-comment">-- first evaluate argument</span><span>
</span><span id="line-563"></span><span>        </span><span id="local-6989586621679524971"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524971"><span class="hs-identifier hs-var">ret</span></a></span></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524985"><span class="hs-identifier hs-var">ty</span></a></span><span>  </span><span class="hs-comment">-- allocate return value address</span><span>
</span><span id="line-564"></span><span>        </span><span id="local-6989586621679524970"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524970"><span class="hs-identifier hs-var">yield</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn [BlockItem]
</span><a href="Codegen.Codegen.html#genYield"><span class="hs-identifier hs-var">genYield</span></a></span><span>   </span><span class="hs-comment">-- application might necessitate yield</span><span>
</span><span id="line-565"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524969"><span class="annot"><span class="annottext">current :: Exp
</span><a href="#local-6989586621679524969"><span class="hs-identifier hs-var hs-var">current</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$id:actg|]</span></span><span>
</span><span id="line-566"></span><span>            </span><span id="local-6989586621679524968"><span class="annot"><span class="annottext">prio :: Exp
</span><a href="#local-6989586621679524968"><span class="hs-identifier hs-var hs-var">prio</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$exp:current-&gt;$id:act_priority|]</span></span><span>
</span><span id="line-567"></span><span>            </span><span id="local-6989586621679524966"><span class="annot"><span class="annottext">depth :: Exp
</span><a href="#local-6989586621679524966"><span class="hs-identifier hs-var hs-var">depth</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$exp:current-&gt;$id:act_depth|]</span></span><span>
</span><span id="line-568"></span><span>            </span><span id="local-6989586621679524964"><span class="annot"><span class="annottext">retp :: Exp
</span><a href="#local-6989586621679524964"><span class="hs-identifier hs-var hs-var">retp</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|&amp;$exp:ret|]</span></span><span>
</span><span id="line-569"></span><span>            </span><span id="local-6989586621679524962"><span class="annot"><span class="annottext">appStms :: [BlockItem]
</span><a href="#local-6989586621679524962"><span class="hs-identifier hs-var hs-var">appStms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|
              $exp:(closure_apply f aVal current prio depth retp);
              if ($exp:(has_children current)) {
                $items:yield;
              }
              $exp:(drop f);
            |]</span></span><span>
</span><span id="line-576"></span><span>        </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524971"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524975"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524972"><span class="hs-identifier hs-var">aStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524962"><span class="hs-identifier hs-var">appStms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Data"><span class="hs-identifier hs-type">I.Data</span></a></span><span> </span><span id="local-6989586621679524958"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679524958"><span class="hs-identifier hs-var">dcon</span></a></span></span><span> </span><span id="local-6989586621679524957"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524957"><span class="hs-identifier hs-var">dty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-578"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679524956"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679524956"><span class="hs-identifier hs-var">argVals</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524955"><span class="annot"><span class="annottext">[[BlockItem]]
</span><a href="#local-6989586621679524955"><span class="hs-identifier hs-var">evalStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Exp, [BlockItem])] -&gt; ([Exp], [[BlockItem]])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Exp, [BlockItem])] -&gt; ([Exp], [[BlockItem]]))
-&gt; GenFn [(Exp, [BlockItem])] -&gt; GenFn ([Exp], [[BlockItem]])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; GenFn (Exp, [BlockItem]))
-&gt; [Expr Type] -&gt; GenFn [(Exp, [BlockItem])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524983"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-579"></span><span>      </span><span id="local-6989586621679524954"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679524954"><span class="hs-identifier hs-var">onHeap</span></a></span></span><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DConInfo -&gt; Bool) -&gt; DConId -&gt; GenFn Bool
forall a. (DConInfo -&gt; a) -&gt; DConId -&gt; GenFn a
</span><a href="Codegen.Codegen.html#getsDCon"><span class="hs-identifier hs-var">getsDCon</span></a></span><span> </span><span class="annot"><span class="annottext">DConInfo -&gt; Bool
</span><a href="Codegen.Typegen.html#dconOnHeap"><span class="hs-identifier hs-var hs-var">dconOnHeap</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679524958"><span class="hs-identifier hs-var">dcon</span></a></span><span>
</span><span id="line-580"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; GenFn () -&gt; GenFn ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679524954"><span class="hs-identifier hs-var">onHeap</span></a></span><span> </span><span class="annot"><span class="annottext">(GenFn () -&gt; GenFn ()) -&gt; GenFn () -&gt; GenFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-581"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; GenFn ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; GenFn ()) -&gt; [Char] -&gt; GenFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot handle packed fields yet, for: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">DConId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679524958"><span class="hs-identifier hs-var">dcon</span></a></span><span>
</span><span id="line-582"></span><span>      </span><span id="local-6989586621679524952"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524952"><span class="hs-identifier hs-var">construct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DConInfo -&gt; Exp) -&gt; DConId -&gt; GenFn Exp
forall a. (DConInfo -&gt; a) -&gt; DConId -&gt; GenFn a
</span><a href="Codegen.Codegen.html#getsDCon"><span class="hs-identifier hs-var">getsDCon</span></a></span><span> </span><span class="annot"><span class="annottext">DConInfo -&gt; Exp
</span><a href="Codegen.Typegen.html#dconConstruct"><span class="hs-identifier hs-var hs-var">dconConstruct</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679524958"><span class="hs-identifier hs-var">dcon</span></a></span><span>
</span><span id="line-583"></span><span>      </span><span id="local-6989586621679524951"><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; Exp
</span><a href="#local-6989586621679524951"><span class="hs-identifier hs-var">destruct</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DConInfo -&gt; Int -&gt; Exp -&gt; Exp)
-&gt; DConId -&gt; GenFn (Int -&gt; Exp -&gt; Exp)
forall a. (DConInfo -&gt; a) -&gt; DConId -&gt; GenFn a
</span><a href="Codegen.Codegen.html#getsDCon"><span class="hs-identifier hs-var">getsDCon</span></a></span><span> </span><span class="annot"><span class="annottext">DConInfo -&gt; Int -&gt; Exp -&gt; Exp
</span><a href="Codegen.Typegen.html#dconDestruct"><span class="hs-identifier hs-var hs-var">dconDestruct</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679524958"><span class="hs-identifier hs-var">dcon</span></a></span><span>
</span><span id="line-584"></span><span>      </span><span id="local-6989586621679524949"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524949"><span class="hs-identifier hs-var">tmp</span></a></span></span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524957"><span class="hs-identifier hs-var">dty</span></a></span><span>
</span><span id="line-585"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524948"><span class="annot"><span class="annottext">alloc :: [BlockItem]
</span><a href="#local-6989586621679524948"><span class="hs-identifier hs-var hs-var">alloc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="">[citem|$exp:tmp = $exp:construct;|]</span></span><span class="hs-special">]</span><span>
</span><span id="line-586"></span><span>          </span><span id="local-6989586621679524947"><span class="annot"><span class="annottext">initField :: a -&gt; Int -&gt; BlockItem
</span><a href="#local-6989586621679524947"><span class="hs-identifier hs-var hs-var">initField</span></a></span></span><span> </span><span id="local-6989586621679524946"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679524946"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621679524945"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524945"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citem|$exp:(destruct i tmp) = $exp:y;|]</span></span><span>
</span><span id="line-587"></span><span>          </span><span id="local-6989586621679524944"><span class="annot"><span class="annottext">initFields :: [BlockItem]
</span><a href="#local-6989586621679524944"><span class="hs-identifier hs-var hs-var">initFields</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Int -&gt; BlockItem) -&gt; [Exp] -&gt; [Int] -&gt; [BlockItem]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Int -&gt; BlockItem
forall a. ToExp a =&gt; a -&gt; Int -&gt; BlockItem
</span><a href="#local-6989586621679524947"><span class="hs-identifier hs-var">initField</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679524956"><span class="hs-identifier hs-var">argVals</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-588"></span><span>      </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524949"><span class="hs-identifier hs-var">tmp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[[BlockItem]] -&gt; [BlockItem]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]]
</span><a href="#local-6989586621679524955"><span class="hs-identifier hs-var">evalStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524948"><span class="hs-identifier hs-var">alloc</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524944"><span class="hs-identifier hs-var">initFields</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-589"></span><span>    </span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; GenFn (Exp, [BlockItem]))
-&gt; [Char] -&gt; GenFn (Exp, [BlockItem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot apply this expression: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524984"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-590"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Match"><span class="hs-identifier hs-type">I.Match</span></a></span><span> </span><span id="local-6989586621679524942"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524942"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679524941"><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679524941"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621679524940"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524940"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-591"></span><span>  </span><span class="hs-comment">-- To implement a match expression, we need to generate a C switch statement</span><span>
</span><span id="line-592"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-593"></span><span>  </span><span class="hs-comment">-- which switches on the tag of the scrutinee @s@.</span><span>
</span><span id="line-594"></span><span>  </span><span class="hs-comment">-- However, since we're already using a switch statement for jumping to</span><span>
</span><span id="line-595"></span><span>  </span><span class="hs-comment">-- program counters, we cannot simply nest the switch statement, since we will</span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-comment">-- risk the inner switch statement (for the match expression) shadowing the</span><span>
</span><span id="line-597"></span><span>  </span><span class="hs-comment">-- cases of the outer switch statement (for the program counters). In</span><span>
</span><span id="line-598"></span><span>  </span><span class="hs-comment">-- particular, we will be unable to yield inside of match expression arm with</span><span>
</span><span id="line-599"></span><span>  </span><span class="hs-comment">-- this naive compilation scheme.</span><span>
</span><span id="line-600"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-601"></span><span>  </span><span class="hs-comment">-- So, in order to keep the C statements &quot;flat&quot;, we use a basic block-style</span><span>
</span><span id="line-602"></span><span>  </span><span class="hs-comment">-- scheme, where the inner switch statement only jumps (using @goto@) to</span><span>
</span><span id="line-603"></span><span>  </span><span class="hs-comment">-- blocks corresponding to each arm of the match expression; this ensures that</span><span>
</span><span id="line-604"></span><span>  </span><span class="hs-comment">-- we never need to yield in the inner switch statement, thus side-stepping</span><span>
</span><span id="line-605"></span><span>  </span><span class="hs-comment">-- C's limitation. At the end of each block, we jump to a join statement that</span><span>
</span><span id="line-606"></span><span>  </span><span class="hs-comment">-- follows the blocks generated for each arm.</span><span>
</span><span id="line-607"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524939"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524939"><span class="hs-identifier hs-var">sExp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524938"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524938"><span class="hs-identifier hs-var">sStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524942"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-608"></span><span>  </span><span id="local-6989586621679524937"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524937"><span class="hs-identifier hs-var">scrut</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; GenFn Exp) -&gt; Type -&gt; GenFn Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Type
forall t. Expr t -&gt; t
</span><a href="IR.IR.html#extract"><span class="hs-identifier hs-var">I.extract</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524942"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-609"></span><span>  </span><span id="local-6989586621679524936"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524936"><span class="hs-identifier hs-var">val</span></a></span></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524940"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-610"></span><span>  </span><span id="local-6989586621679524935"><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524935"><span class="hs-identifier hs-var">joinLabel</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn CIdent
</span><a href="Codegen.Codegen.html#freshLabel"><span class="hs-identifier hs-var">freshLabel</span></a></span><span>
</span><span id="line-611"></span><span>
</span><span id="line-612"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-613"></span><span>    </span><span id="local-6989586621679524934"><span class="annot"><span class="annottext">assignScrut :: [BlockItem]
</span><a href="#local-6989586621679524934"><span class="hs-identifier hs-var hs-var">assignScrut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|$exp:scrut = $exp:sExp;|]</span></span><span>
</span><span id="line-614"></span><span>    </span><span id="local-6989586621679524933"><span class="annot"><span class="annottext">tag :: Exp
</span><a href="#local-6989586621679524933"><span class="hs-identifier hs-var hs-var">tag</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#adt_tag"><span class="hs-identifier hs-var">adt_tag</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524937"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="hs-comment">-- TODO: look this up using typeScrut</span><span>
</span><span id="line-615"></span><span>    </span><span id="local-6989586621679524931"><span class="annot"><span class="annottext">switch :: [BlockItem] -&gt; [BlockItem]
</span><a href="#local-6989586621679524931"><span class="hs-identifier hs-var hs-var">switch</span></a></span></span><span> </span><span id="local-6989586621679524930"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524930"><span class="hs-identifier hs-var">cases</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|switch ($exp:tag) { $items:cases }|]</span></span><span>
</span><span id="line-616"></span><span>    </span><span id="local-6989586621679524929"><span class="annot"><span class="annottext">assignVal :: a -&gt; [BlockItem]
</span><a href="#local-6989586621679524929"><span class="hs-identifier hs-var hs-var">assignVal</span></a></span></span><span> </span><span id="local-6989586621679524928"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679524928"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|$exp:val = $exp:e;|]</span></span><span>
</span><span id="line-617"></span><span>    </span><span id="local-6989586621679524927"><span class="annot"><span class="annottext">joinStm :: [BlockItem]
</span><a href="#local-6989586621679524927"><span class="hs-identifier hs-var hs-var">joinStm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|$id:joinLabel:;|]</span></span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span>    </span><span class="hs-comment">{- | Generate statements for a sslang match arm.

    Produces two C blocks; the first is just the case statements inside of the
    inner switch matching on the tag, while the second is the basic block
    corresponding to the consequence of a match arm.
    -}</span><span>
</span><span id="line-625"></span><span>    </span><span class="annot"><a href="#local-6989586621679524926"><span class="hs-identifier hs-type">genArm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Alt"><span class="hs-identifier hs-type">I.Alt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>    </span><span id="local-6989586621679524926"><span class="annot"><span class="annottext">genArm :: (Alt, Expr Type) -&gt; GenFn ([BlockItem], [BlockItem])
</span><a href="#local-6989586621679524926"><span class="hs-identifier hs-var hs-var">genArm</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679524925"><span class="annot"><span class="annottext">Alt
</span><a href="#local-6989586621679524925"><span class="hs-identifier hs-var">alt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524924"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524924"><span class="hs-identifier hs-var">arm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-627"></span><span>      </span><span id="local-6989586621679524923"><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524923"><span class="hs-identifier hs-var">armLabel</span></a></span></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn CIdent
</span><a href="Codegen.Codegen.html#freshLabel"><span class="hs-identifier hs-var">freshLabel</span></a></span><span>
</span><span id="line-628"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679524922"><span class="annot"><span class="annottext">BlockItem
</span><a href="#local-6989586621679524922"><span class="hs-identifier hs-var">altLabel</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524921"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524921"><span class="hs-identifier hs-var">armBlk</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CIdent
-&gt; Alt -&gt; GenFn [BlockItem] -&gt; GenFn (BlockItem, [BlockItem])
</span><a href="#local-6989586621679524920"><span class="hs-identifier hs-var">withAltScope</span></a></span><span> </span><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524923"><span class="hs-identifier hs-var">armLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Alt
</span><a href="#local-6989586621679524925"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">(GenFn [BlockItem] -&gt; GenFn (BlockItem, [BlockItem]))
-&gt; GenFn [BlockItem] -&gt; GenFn (BlockItem, [BlockItem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-629"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679524919"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524919"><span class="hs-identifier hs-var">armExp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524918"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524918"><span class="hs-identifier hs-var">armStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524924"><span class="hs-identifier hs-var">arm</span></a></span><span>
</span><span id="line-630"></span><span>        </span><span class="annot"><span class="annottext">[BlockItem] -&gt; GenFn [BlockItem]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([BlockItem] -&gt; GenFn [BlockItem])
-&gt; [BlockItem] -&gt; GenFn [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524918"><span class="hs-identifier hs-var">armStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; [BlockItem]
forall a. ToExp a =&gt; a -&gt; [BlockItem]
</span><a href="#local-6989586621679524929"><span class="hs-identifier hs-var">assignVal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524919"><span class="hs-identifier hs-var">armExp</span></a></span><span>
</span><span id="line-631"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524917"><span class="annot"><span class="annottext">armCase :: [BlockItem]
</span><a href="#local-6989586621679524917"><span class="hs-identifier hs-var hs-var">armCase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|$item:altLabel goto $id:armLabel;|]</span></span><span>
</span><span id="line-632"></span><span>      </span><span class="annot"><span class="annottext">([BlockItem], [BlockItem]) -&gt; GenFn ([BlockItem], [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524917"><span class="hs-identifier hs-var">armCase</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524921"><span class="hs-identifier hs-var">armBlk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>
</span><span id="line-634"></span><span>    </span><span class="hs-comment">-- | Generate the case statements for the inner switch.</span><span>
</span><span id="line-635"></span><span>    </span><span class="annot"><a href="#local-6989586621679524915"><span class="hs-identifier hs-type">mkBlk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.LibSSM.html#CIdent"><span class="hs-identifier hs-type">CIdent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span>
</span><span id="line-636"></span><span>    </span><span id="local-6989586621679524915"><span class="annot"><span class="annottext">mkBlk :: CIdent -&gt; [BlockItem] -&gt; [BlockItem]
</span><a href="#local-6989586621679524915"><span class="hs-identifier hs-var hs-var">mkBlk</span></a></span></span><span> </span><span id="local-6989586621679524914"><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524914"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621679524913"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524913"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-637"></span><span>      </span><span class="annot"><span class="">[citems|$id:label:;|]</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524913"><span class="hs-identifier hs-var">blk</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="">[citems|goto $id:joinLabel;|]</span></span><span>
</span><span id="line-638"></span><span>
</span><span id="line-639"></span><span>    </span><span class="hs-comment">{- | Generate the basic block for each match arm's consequence.

    This helper follows a reader monad pattern, taking a monad as an argument,
    since scope of the consequence expression is extended by the variables bound
    by the match expression's pattern.
    -}</span><span>
</span><span id="line-645"></span><span>    </span><span class="annot"><a href="#local-6989586621679524920"><span class="hs-identifier hs-type">withAltScope</span></a></span><span>
</span><span id="line-646"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Codegen.LibSSM.html#CIdent"><span class="hs-identifier hs-type">CIdent</span></a></span><span>
</span><span id="line-647"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Alt"><span class="hs-identifier hs-type">I.Alt</span></a></span><span>
</span><span id="line-648"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span>
</span><span id="line-649"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span>    </span><span id="local-6989586621679524920"><span class="annot"><span class="annottext">withAltScope :: CIdent
-&gt; Alt -&gt; GenFn [BlockItem] -&gt; GenFn (BlockItem, [BlockItem])
</span><a href="#local-6989586621679524920"><span class="hs-identifier hs-var hs-var">withAltScope</span></a></span></span><span> </span><span id="local-6989586621679524912"><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524912"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#AltData"><span class="hs-identifier hs-type">I.AltData</span></a></span><span> </span><span id="local-6989586621679524910"><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679524910"><span class="hs-identifier hs-var">dcon</span></a></span></span><span> </span><span id="local-6989586621679524909"><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679524909"><span class="hs-identifier hs-var">fields</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679524908"><span class="annot"><span class="annottext">GenFn [BlockItem]
</span><a href="#local-6989586621679524908"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-651"></span><span>      </span><span id="local-6989586621679524907"><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; Exp
</span><a href="#local-6989586621679524907"><span class="hs-identifier hs-var">destruct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DConInfo -&gt; Int -&gt; Exp -&gt; Exp)
-&gt; DConId -&gt; GenFn (Int -&gt; Exp -&gt; Exp)
forall a. (DConInfo -&gt; a) -&gt; DConId -&gt; GenFn a
</span><a href="Codegen.Codegen.html#getsDCon"><span class="hs-identifier hs-var">getsDCon</span></a></span><span> </span><span class="annot"><span class="annottext">DConInfo -&gt; Int -&gt; Exp -&gt; Exp
</span><a href="Codegen.Typegen.html#dconDestruct"><span class="hs-identifier hs-var hs-var">dconDestruct</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679524910"><span class="hs-identifier hs-var">dcon</span></a></span><span>
</span><span id="line-652"></span><span>      </span><span id="local-6989586621679524906"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524906"><span class="hs-identifier hs-var">cas</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DConInfo -&gt; Exp) -&gt; DConId -&gt; GenFn Exp
forall a. (DConInfo -&gt; a) -&gt; DConId -&gt; GenFn a
</span><a href="Codegen.Codegen.html#getsDCon"><span class="hs-identifier hs-var">getsDCon</span></a></span><span> </span><span class="annot"><span class="annottext">DConInfo -&gt; Exp
</span><a href="Codegen.Typegen.html#dconCase"><span class="hs-identifier hs-var hs-var">dconCase</span></a></span><span> </span><span class="annot"><span class="annottext">DConId
</span><a href="#local-6989586621679524910"><span class="hs-identifier hs-var">dcon</span></a></span><span>
</span><span id="line-653"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524904"><span class="annot"><span class="annottext">fieldBinds :: [(Binder, Exp)]
</span><a href="#local-6989586621679524904"><span class="hs-identifier hs-var hs-var">fieldBinds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-654"></span><span>            </span><span class="annot"><span class="annottext">(Binder -&gt; Int -&gt; (Binder, Exp))
-&gt; [Binder] -&gt; [Int] -&gt; [(Binder, Exp)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679524903"><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679524903"><span class="hs-identifier hs-var">field</span></a></span></span><span> </span><span id="local-6989586621679524902"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524902"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679524903"><span class="hs-identifier hs-var">field</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; Exp
</span><a href="#local-6989586621679524907"><span class="hs-identifier hs-var">destruct</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524902"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524937"><span class="hs-identifier hs-var">scrut</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Binder]
</span><a href="#local-6989586621679524909"><span class="hs-identifier hs-var">fields</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-655"></span><span>      </span><span id="local-6989586621679524901"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524901"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Binder, Exp)] -&gt; GenFn [BlockItem] -&gt; GenFn [BlockItem]
forall a. [(Binder, Exp)] -&gt; GenFn a -&gt; GenFn a
</span><a href="Codegen.Codegen.html#withBindings"><span class="hs-identifier hs-var">withBindings</span></a></span><span> </span><span class="annot"><span class="annottext">[(Binder, Exp)]
</span><a href="#local-6989586621679524904"><span class="hs-identifier hs-var">fieldBinds</span></a></span><span> </span><span class="annot"><span class="annottext">GenFn [BlockItem]
</span><a href="#local-6989586621679524908"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-656"></span><span>      </span><span class="annot"><span class="annottext">(BlockItem, [BlockItem]) -&gt; GenFn (BlockItem, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">[citem|case $exp:cas:;|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CIdent -&gt; [BlockItem] -&gt; [BlockItem]
</span><a href="#local-6989586621679524915"><span class="hs-identifier hs-var">mkBlk</span></a></span><span> </span><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524912"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524901"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-657"></span><span>    </span><span class="annot"><a href="#local-6989586621679524920"><span class="hs-identifier hs-var">withAltScope</span></a></span><span> </span><span id="local-6989586621679524900"><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524900"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#AltLit"><span class="hs-identifier hs-type">I.AltLit</span></a></span><span> </span><span id="local-6989586621679524898"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621679524898"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679524897"><span class="annot"><span class="annottext">GenFn [BlockItem]
</span><a href="#local-6989586621679524897"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-658"></span><span>      </span><span id="local-6989586621679524896"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524896"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn [BlockItem]
</span><a href="#local-6989586621679524897"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-659"></span><span>      </span><span class="annot"><span class="annottext">(BlockItem, [BlockItem]) -&gt; GenFn (BlockItem, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">[citem|case $exp:(genLiteralRaw l):;|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CIdent -&gt; [BlockItem] -&gt; [BlockItem]
</span><a href="#local-6989586621679524915"><span class="hs-identifier hs-var">mkBlk</span></a></span><span> </span><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524900"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524896"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-660"></span><span>    </span><span class="annot"><a href="#local-6989586621679524920"><span class="hs-identifier hs-var">withAltScope</span></a></span><span> </span><span id="local-6989586621679524894"><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524894"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#AltDefault"><span class="hs-identifier hs-type">I.AltDefault</span></a></span><span> </span><span id="local-6989586621679524892"><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679524892"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679524891"><span class="annot"><span class="annottext">GenFn [BlockItem]
</span><a href="#local-6989586621679524891"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-661"></span><span>      </span><span id="local-6989586621679524890"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524890"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Binder, Exp)] -&gt; GenFn [BlockItem] -&gt; GenFn [BlockItem]
forall a. [(Binder, Exp)] -&gt; GenFn a -&gt; GenFn a
</span><a href="Codegen.Codegen.html#withBindings"><span class="hs-identifier hs-var">withBindings</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679524892"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524937"><span class="hs-identifier hs-var">scrut</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">GenFn [BlockItem]
</span><a href="#local-6989586621679524891"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-662"></span><span>      </span><span class="annot"><span class="annottext">Binder -&gt; Exp -&gt; GenFn ()
</span><a href="Codegen.Codegen.html#addBinding"><span class="hs-identifier hs-var">addBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Binder
</span><a href="#local-6989586621679524892"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524937"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-663"></span><span>      </span><span class="annot"><span class="annottext">(BlockItem, [BlockItem]) -&gt; GenFn (BlockItem, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">[citem|default:;|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CIdent -&gt; [BlockItem] -&gt; [BlockItem]
</span><a href="#local-6989586621679524915"><span class="hs-identifier hs-var">mkBlk</span></a></span><span> </span><span class="annot"><span class="annottext">CIdent
</span><a href="#local-6989586621679524894"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524890"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-664"></span><span>
</span><span id="line-665"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524889"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524889"><span class="hs-identifier hs-var">cases</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524888"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524888"><span class="hs-identifier hs-var">blks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([[BlockItem]] -&gt; [BlockItem])
-&gt; ([[BlockItem]] -&gt; [BlockItem])
-&gt; ([[BlockItem]], [[BlockItem]])
-&gt; ([BlockItem], [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]] -&gt; [BlockItem]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]] -&gt; [BlockItem]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">(([[BlockItem]], [[BlockItem]]) -&gt; ([BlockItem], [BlockItem]))
-&gt; ([([BlockItem], [BlockItem])] -&gt; ([[BlockItem]], [[BlockItem]]))
-&gt; [([BlockItem], [BlockItem])]
-&gt; ([BlockItem], [BlockItem])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[([BlockItem], [BlockItem])] -&gt; ([[BlockItem]], [[BlockItem]])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([([BlockItem], [BlockItem])] -&gt; ([BlockItem], [BlockItem]))
-&gt; GenFn [([BlockItem], [BlockItem])]
-&gt; GenFn ([BlockItem], [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Alt, Expr Type) -&gt; GenFn ([BlockItem], [BlockItem]))
-&gt; [(Alt, Expr Type)] -&gt; GenFn [([BlockItem], [BlockItem])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Alt, Expr Type) -&gt; GenFn ([BlockItem], [BlockItem])
</span><a href="#local-6989586621679524926"><span class="hs-identifier hs-var">genArm</span></a></span><span> </span><span class="annot"><span class="annottext">[(Alt, Expr Type)]
</span><a href="#local-6989586621679524941"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-666"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524936"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524938"><span class="hs-identifier hs-var">sStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524934"><span class="hs-identifier hs-var">assignScrut</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem]
</span><a href="#local-6989586621679524931"><span class="hs-identifier hs-var">switch</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524889"><span class="hs-identifier hs-var">cases</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524888"><span class="hs-identifier hs-var">blks</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524927"><span class="hs-identifier hs-var">joinStm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><a href="IR.IR.html#Lambda"><span class="hs-identifier hs-type">I.Lambda</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot handle lambdas&quot;</span></span><span>
</span><span id="line-668"></span><span class="annot"><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Prim"><span class="hs-identifier hs-type">I.Prim</span></a></span><span> </span><span id="local-6989586621679524887"><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679524887"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679524886"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524886"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679524885"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524885"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Primitive -&gt; [Expr Type] -&gt; Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="#local-6989586621679524887"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524886"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524885"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span class="hs-comment">-- | Generate code for SSM primitive; see 'genExpr' for extended discussion.</span><span>
</span><span id="line-671"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-type">genPrim</span></a></span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Primitive"><span class="hs-identifier hs-type">I.Primitive</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span id="genPrim"><span class="annot"><span class="annottext">genPrim :: Primitive -&gt; [Expr Type] -&gt; Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var hs-var">genPrim</span></a></span></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#New"><span class="hs-identifier hs-var">I.New</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524882"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524882"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679524881"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524881"><span class="hs-identifier hs-var">refType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-674"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524880"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524880"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524879"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524879"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524882"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-675"></span><span>  </span><span id="local-6989586621679524878"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524878"><span class="hs-identifier hs-var">tmp</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524881"><span class="hs-identifier hs-var">refType</span></a></span><span>
</span><span id="line-676"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524878"><span class="hs-identifier hs-var">tmp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524879"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="">[citems|$exp:tmp = $exp:(new_sv val); $exp:(drop val);|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Dup"><span class="hs-identifier hs-var">I.Dup</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524876"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524876"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-678"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524875"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524875"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524874"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524874"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524876"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-679"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524875"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524874"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="">[citems|$exp:(dup val);|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Drop"><span class="hs-identifier hs-var">I.Drop</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524871"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524871"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524870"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524870"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-681"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524869"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524869"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524868"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524868"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524871"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-682"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524867"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524867"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524866"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524866"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524870"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-comment">-- NOTE: this should never really be side-effectful!</span><span>
</span><span id="line-683"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524869"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524868"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524866"><span class="hs-identifier hs-var">stms'</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="">[citems|$exp:(drop ref);|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Deref"><span class="hs-identifier hs-var">I.Deref</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524864"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524864"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679524863"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524863"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524862"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524862"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524861"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524861"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524864"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-686"></span><span>  </span><span id="local-6989586621679524860"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524860"><span class="hs-identifier hs-var">tmp</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524863"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-687"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524860"><span class="hs-identifier hs-var">tmp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524861"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="">[citems|$exp:tmp = $exp:(deref val); $exp:(drop val);|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-688"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Assign"><span class="hs-identifier hs-var">I.Assign</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524857"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524857"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524856"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524856"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-689"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524855"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524855"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524854"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524854"><span class="hs-identifier hs-var">lhsStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524857"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-690"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524853"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524853"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524852"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524852"><span class="hs-identifier hs-var">rhsStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524856"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-691"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524851"><span class="annot"><span class="annottext">prio :: Exp
</span><a href="#local-6989586621679524851"><span class="hs-identifier hs-var hs-var">prio</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$id:actg-&gt;$id:act_priority|]</span></span><span>
</span><span id="line-692"></span><span>      </span><span id="local-6989586621679524850"><span class="annot"><span class="annottext">assignBlock :: [BlockItem]
</span><a href="#local-6989586621679524850"><span class="hs-identifier hs-var hs-var">assignBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|
          $items:lhsStms
          $items:rhsStms
          $exp:(assign lhsVal prio rhsVal);
          $exp:(drop rhsVal);
          $exp:(drop lhsVal);
        |]</span></span><span>
</span><span id="line-699"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="Codegen.Codegen.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524850"><span class="hs-identifier hs-var">assignBlock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#After"><span class="hs-identifier hs-var">I.After</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524847"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524847"><span class="hs-identifier hs-var">time</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524846"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524846"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524845"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524845"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-701"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524844"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524844"><span class="hs-identifier hs-var">timeVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524843"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524843"><span class="hs-identifier hs-var">timeStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524847"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524842"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524842"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span> </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524841"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524841"><span class="hs-identifier hs-var">lhsStms</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524846"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-703"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524840"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524840"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span> </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524839"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524839"><span class="hs-identifier hs-var">rhsStms</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524845"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-704"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524838"><span class="annot"><span class="annottext">when :: Exp
</span><a href="#local-6989586621679524838"><span class="hs-identifier hs-var hs-var">when</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$exp:now() + $exp:(unmarshal timeVal)|]</span></span><span>
</span><span id="line-705"></span><span>      </span><span id="local-6989586621679524832"><span class="annot"><span class="annottext">laterBlock :: [BlockItem]
</span><a href="#local-6989586621679524832"><span class="hs-identifier hs-var hs-var">laterBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|
          $items:timeStms
          $items:lhsStms
          $items:rhsStms
          $exp:(later lhsVal when rhsVal);
          $exp:(drop timeVal);
          $exp:(drop rhsVal);
          $exp:(drop lhsVal);
        |]</span></span><span>
</span><span id="line-714"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="Codegen.Codegen.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524832"><span class="hs-identifier hs-var">laterBlock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Par"><span class="hs-identifier hs-var">I.Par</span></a></span><span> </span><span id="local-6989586621679524829"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524829"><span class="hs-identifier hs-var">procs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-716"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524828"><span class="annot"><span class="annottext">numChildren :: Int
</span><a href="#local-6989586621679524828"><span class="hs-identifier hs-var hs-var">numChildren</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Expr Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524829"><span class="hs-identifier hs-var">procs</span></a></span><span>
</span><span id="line-717"></span><span>      </span><span id="local-6989586621679524827"><span class="annot"><span class="annottext">parArgs :: [(Exp, Exp)]
</span><a href="#local-6989586621679524827"><span class="hs-identifier hs-var hs-var">parArgs</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; (Exp, Exp) -&gt; [(Exp, Exp)]
</span><a href="Codegen.Codegen.html#genParArgs"><span class="hs-identifier hs-var">genParArgs</span></a></span><span>
</span><span id="line-718"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524828"><span class="hs-identifier hs-var">numChildren</span></a></span><span>
</span><span id="line-719"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="">[cexp|$id:actg-&gt;$id:act_priority|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[cexp|$id:actg-&gt;$id:act_depth|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span>      </span><span id="local-6989586621679524825"><span class="annot"><span class="annottext">checkNewDepth :: [BlockItem]
</span><a href="#local-6989586621679524825"><span class="hs-identifier hs-var hs-var">checkNewDepth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|
          if ($id:actg-&gt;$id:act_depth &lt; $exp:(depthSub numChildren))
            $exp:(throw EXHAUSTED_PRIORITY);
        |]</span></span><span>
</span><span id="line-725"></span><span>
</span><span id="line-726"></span><span>      </span><span class="hs-comment">-- FIXME: ideally, par expressions must all be parallel applications that</span><span>
</span><span id="line-727"></span><span>      </span><span class="hs-comment">-- don't yield/block. However, that relies on a liftPar pass that isn't</span><span>
</span><span id="line-728"></span><span>      </span><span class="hs-comment">-- implemented just yet.</span><span>
</span><span id="line-729"></span><span>      </span><span class="hs-comment">-- So, this is currently broken in that side effects inside the arguments</span><span>
</span><span id="line-730"></span><span>      </span><span class="hs-comment">-- of function calls will be evaluated sequentially, which is wrong.</span><span>
</span><span id="line-731"></span><span>      </span><span class="annot"><a href="#local-6989586621679524820"><span class="hs-identifier hs-type">apply</span></a></span><span>
</span><span id="line-732"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-733"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-734"></span><span>      </span><span id="local-6989586621679524820"><span class="annot"><span class="annottext">apply :: (Expr Type, (Exp, Exp)) -&gt; GenFn (Exp, [BlockItem], [BlockItem])
</span><a href="#local-6989586621679524820"><span class="hs-identifier hs-var hs-var">apply</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#App"><span class="hs-identifier hs-type">I.App</span></a></span><span> </span><span id="local-6989586621679524819"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524819"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span id="local-6989586621679524818"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524818"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621679524817"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524817"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679524816"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524816"><span class="hs-identifier hs-var">prio</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524815"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524815"><span class="hs-identifier hs-var">depth</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-735"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679524814"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524814"><span class="hs-identifier hs-var">fnExp</span></a></span></span><span> </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524813"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524813"><span class="hs-identifier hs-var">fnStms</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524819"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-736"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679524812"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524812"><span class="hs-identifier hs-var">argExp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524811"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524811"><span class="hs-identifier hs-var">argStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524818"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-737"></span><span>        </span><span id="local-6989586621679524810"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524810"><span class="hs-identifier hs-var">ret</span></a></span></span><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524817"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-738"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524809"><span class="annot"><span class="annottext">current :: Exp
</span><a href="#local-6989586621679524809"><span class="hs-identifier hs-var hs-var">current</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$id:actg|]</span></span><span>
</span><span id="line-739"></span><span>            </span><span id="local-6989586621679524808"><span class="annot"><span class="annottext">retp :: Exp
</span><a href="#local-6989586621679524808"><span class="hs-identifier hs-var hs-var">retp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|&amp;$exp:ret|]</span></span><span>
</span><span id="line-740"></span><span>            </span><span id="local-6989586621679524807"><span class="annot"><span class="annottext">appStms :: [BlockItem]
</span><a href="#local-6989586621679524807"><span class="hs-identifier hs-var hs-var">appStms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|
              $exp:(closure_apply fnExp argExp current prio depth retp);
              $exp:(drop fnExp);
            |]</span></span><span>
</span><span id="line-744"></span><span>        </span><span class="annot"><span class="annottext">(Exp, [BlockItem], [BlockItem])
-&gt; GenFn (Exp, [BlockItem], [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524810"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524813"><span class="hs-identifier hs-var">fnStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524811"><span class="hs-identifier hs-var">argStms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524807"><span class="hs-identifier hs-var">appStms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span>      </span><span class="annot"><a href="#local-6989586621679524820"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679524806"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524806"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Exp, Exp)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-746"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; GenFn (Exp, [BlockItem], [BlockItem])
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; GenFn (Exp, [BlockItem], [BlockItem]))
-&gt; [Char] -&gt; GenFn (Exp, [BlockItem], [BlockItem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot compile par with non-application expression: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524806"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524805"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679524805"><span class="hs-identifier hs-var">_rets</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524804"><span class="annot"><span class="annottext">[[BlockItem]]
</span><a href="#local-6989586621679524804"><span class="hs-identifier hs-var">befores</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524803"><span class="annot"><span class="annottext">[[BlockItem]]
</span><a href="#local-6989586621679524803"><span class="hs-identifier hs-var">activates</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Exp, [BlockItem], [BlockItem])]
-&gt; ([Exp], [[BlockItem]], [[BlockItem]])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">([(Exp, [BlockItem], [BlockItem])]
 -&gt; ([Exp], [[BlockItem]], [[BlockItem]]))
-&gt; GenFn [(Exp, [BlockItem], [BlockItem])]
-&gt; GenFn ([Exp], [[BlockItem]], [[BlockItem]])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Expr Type, (Exp, Exp)) -&gt; GenFn (Exp, [BlockItem], [BlockItem]))
-&gt; [(Expr Type, (Exp, Exp))]
-&gt; GenFn [(Exp, [BlockItem], [BlockItem])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type, (Exp, Exp)) -&gt; GenFn (Exp, [BlockItem], [BlockItem])
</span><a href="#local-6989586621679524820"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Expr Type] -&gt; [(Exp, Exp)] -&gt; [(Expr Type, (Exp, Exp))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524829"><span class="hs-identifier hs-var">procs</span></a></span><span> </span><span class="annot"><span class="annottext">[(Exp, Exp)]
</span><a href="#local-6989586621679524827"><span class="hs-identifier hs-var">parArgs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-749"></span><span>  </span><span id="local-6989586621679524801"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524801"><span class="hs-identifier hs-var">yield</span></a></span></span><span>                       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn [BlockItem]
</span><a href="Codegen.Codegen.html#genYield"><span class="hs-identifier hs-var">genYield</span></a></span><span>
</span><span id="line-750"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524800"><span class="annot"><span class="annottext">parRetVal :: Exp
</span><a href="#local-6989586621679524800"><span class="hs-identifier hs-var hs-var">parRetVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="Codegen.Codegen.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span> </span><span class="hs-comment">-- TODO: return tuple of values</span><span>
</span><span id="line-751"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-752"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524800"><span class="hs-identifier hs-var">parRetVal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524825"><span class="hs-identifier hs-var">checkNewDepth</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]] -&gt; [BlockItem]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]]
</span><a href="#local-6989586621679524804"><span class="hs-identifier hs-var">befores</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]] -&gt; [BlockItem]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]]
</span><a href="#local-6989586621679524803"><span class="hs-identifier hs-var">activates</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524801"><span class="hs-identifier hs-var">yield</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-753"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Wait"><span class="hs-identifier hs-var">I.Wait</span></a></span><span> </span><span id="local-6989586621679524798"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524798"><span class="hs-identifier hs-var">vars</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-754"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524797"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679524797"><span class="hs-identifier hs-var">varVals</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524796"><span class="annot"><span class="annottext">[[BlockItem]]
</span><a href="#local-6989586621679524796"><span class="hs-identifier hs-var">varStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Exp, [BlockItem])] -&gt; ([Exp], [[BlockItem]])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Exp, [BlockItem])] -&gt; ([Exp], [[BlockItem]]))
-&gt; GenFn [(Exp, [BlockItem])] -&gt; GenFn ([Exp], [[BlockItem]])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; GenFn (Exp, [BlockItem]))
-&gt; [Expr Type] -&gt; GenFn [(Exp, [BlockItem])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524798"><span class="hs-identifier hs-var">vars</span></a></span><span>
</span><span id="line-755"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; GenFn ()
</span><a href="Codegen.Codegen.html#maxWait"><span class="hs-identifier hs-var">maxWait</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; GenFn ()) -&gt; Int -&gt; GenFn ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Exp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679524797"><span class="hs-identifier hs-var">varVals</span></a></span><span>
</span><span id="line-756"></span><span>  </span><span id="local-6989586621679524795"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524795"><span class="hs-identifier hs-var">yield</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenFn [BlockItem]
</span><a href="Codegen.Codegen.html#genYield"><span class="hs-identifier hs-var">genYield</span></a></span><span>
</span><span id="line-757"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524794"><span class="annot"><span class="annottext">trigs :: [(Exp, Exp)]
</span><a href="#local-6989586621679524794"><span class="hs-identifier hs-var hs-var">trigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Exp] -&gt; [Exp] -&gt; [(Exp, Exp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679524797"><span class="hs-identifier hs-var">varVals</span></a></span><span> </span><span class="annot"><span class="annottext">([Exp] -&gt; [(Exp, Exp)]) -&gt; [Exp] -&gt; [(Exp, Exp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Exp) -&gt; [Int] -&gt; [Exp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp
</span><a href="#local-6989586621679524793"><span class="hs-identifier hs-var">mkTrig</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-758"></span><span>      </span><span id="local-6989586621679524793"><span class="annot"><span class="annottext">mkTrig :: Int -&gt; Exp
</span><a href="#local-6989586621679524793"><span class="hs-identifier hs-var hs-var">mkTrig</span></a></span></span><span> </span><span id="local-6989586621679524792"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524792"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|&amp;$exp:(acts_ $ trig_ i)|]</span></span><span>
</span><span id="line-759"></span><span>      </span><span id="local-6989586621679524791"><span class="annot"><span class="annottext">sens :: (Exp, Exp) -&gt; BlockItem
</span><a href="#local-6989586621679524791"><span class="hs-identifier hs-var hs-var">sens</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679524790"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524790"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524789"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524789"><span class="hs-identifier hs-var">trig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citem|$exp:(sensitize var trig);|]</span></span><span>
</span><span id="line-760"></span><span>      </span><span id="local-6989586621679524787"><span class="annot"><span class="annottext">desens :: (Exp, Exp) -&gt; [BlockItem]
</span><a href="#local-6989586621679524787"><span class="hs-identifier hs-var hs-var">desens</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679524786"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524786"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524785"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524785"><span class="hs-identifier hs-var">trig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citems|$exp:(desensitize trig); $exp:(drop var);|]</span></span><span>
</span><span id="line-761"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-762"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="Codegen.Codegen.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[[BlockItem]] -&gt; [BlockItem]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]]
</span><a href="#local-6989586621679524796"><span class="hs-identifier hs-var">varStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; BlockItem) -&gt; [(Exp, Exp)] -&gt; [BlockItem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Exp, Exp) -&gt; BlockItem
</span><a href="#local-6989586621679524791"><span class="hs-identifier hs-var">sens</span></a></span><span> </span><span class="annot"><span class="annottext">[(Exp, Exp)]
</span><a href="#local-6989586621679524794"><span class="hs-identifier hs-var">trigs</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524795"><span class="hs-identifier hs-var">yield</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; [BlockItem]) -&gt; [(Exp, Exp)] -&gt; [BlockItem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">(Exp, Exp) -&gt; [BlockItem]
</span><a href="#local-6989586621679524787"><span class="hs-identifier hs-var">desens</span></a></span><span> </span><span class="annot"><span class="annottext">[(Exp, Exp)]
</span><a href="#local-6989586621679524794"><span class="hs-identifier hs-var">trigs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-763"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Loop"><span class="hs-identifier hs-var">I.Loop</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524781"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524781"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-764"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524780"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524780"><span class="hs-identifier hs-var">bodyStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524781"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-765"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="Codegen.Codegen.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[citems|for (;;) { $items:bodyStms }|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Break"><span class="hs-identifier hs-var">I.Break</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="Codegen.Codegen.html#undef"><span class="hs-identifier hs-var">undef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[citems|break;|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><a href="IR.IR.html#Now"><span class="hs-identifier hs-var">I.Now</span></a></span><span>   </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Expr Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621679524776"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524776"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-768"></span><span>  </span><span id="local-6989586621679524775"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524775"><span class="hs-identifier hs-var">tmp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524776"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-769"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524775"><span class="hs-identifier hs-var">tmp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[citems|$exp:tmp = $exp:(marshal $ ccall now []);|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#CQuote"><span class="hs-identifier hs-type">I.CQuote</span></a></span><span> </span><span id="local-6989586621679524772"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679524772"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">[cexp|$exp:(EscExp e)|]</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-771"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#CCall"><span class="hs-identifier hs-type">I.CCall</span></a></span><span>  </span><span id="local-6989586621679524770"><span class="annot"><span class="annottext">CSym
</span><a href="#local-6989586621679524770"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679524769"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524769"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-772"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524768"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679524768"><span class="hs-identifier hs-var">argExps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524767"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524767"><span class="hs-identifier hs-var">argStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([[BlockItem]] -&gt; [BlockItem])
-&gt; ([Exp], [[BlockItem]]) -&gt; ([Exp], [BlockItem])
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]] -&gt; [BlockItem]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">(([Exp], [[BlockItem]]) -&gt; ([Exp], [BlockItem]))
-&gt; ([(Exp, [BlockItem])] -&gt; ([Exp], [[BlockItem]]))
-&gt; [(Exp, [BlockItem])]
-&gt; ([Exp], [BlockItem])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(Exp, [BlockItem])] -&gt; ([Exp], [[BlockItem]])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Exp, [BlockItem])] -&gt; ([Exp], [BlockItem]))
-&gt; GenFn [(Exp, [BlockItem])] -&gt; GenFn ([Exp], [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; GenFn (Exp, [BlockItem]))
-&gt; [Expr Type] -&gt; GenFn [(Exp, [BlockItem])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524769"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-773"></span><span>  </span><span class="hs-comment">-- TODO: obtain return value from call</span><span>
</span><span id="line-774"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="Codegen.Codegen.html#unit"><span class="hs-keyword hs-var">unit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524767"><span class="hs-identifier hs-var">argStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="">[citems|$id:s($args:argExps);|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-775"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#FfiCall"><span class="hs-identifier hs-type">I.FfiCall</span></a></span><span> </span><span id="local-6989586621679524764"><span class="annot"><span class="annottext">VarId
</span><a href="#local-6989586621679524764"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679524763"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524763"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679524762"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524762"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-776"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524761"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679524761"><span class="hs-identifier hs-var">argExps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524760"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524760"><span class="hs-identifier hs-var">argStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([[BlockItem]] -&gt; [BlockItem])
-&gt; ([Exp], [[BlockItem]]) -&gt; ([Exp], [BlockItem])
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">[[BlockItem]] -&gt; [BlockItem]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">(([Exp], [[BlockItem]]) -&gt; ([Exp], [BlockItem]))
-&gt; ([(Exp, [BlockItem])] -&gt; ([Exp], [[BlockItem]]))
-&gt; [(Exp, [BlockItem])]
-&gt; ([Exp], [BlockItem])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(Exp, [BlockItem])] -&gt; ([Exp], [[BlockItem]])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Exp, [BlockItem])] -&gt; ([Exp], [BlockItem]))
-&gt; GenFn [(Exp, [BlockItem])] -&gt; GenFn ([Exp], [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Expr Type -&gt; GenFn (Exp, [BlockItem]))
-&gt; [Expr Type] -&gt; GenFn [(Exp, [BlockItem])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524763"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-777"></span><span>  </span><span id="local-6989586621679524759"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524759"><span class="hs-identifier hs-var">ret</span></a></span></span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524762"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-778"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524758"><span class="annot"><span class="annottext">doDrop :: Exp -&gt; BlockItem
</span><a href="#local-6989586621679524758"><span class="hs-identifier hs-var hs-var">doDrop</span></a></span></span><span> </span><span id="local-6989586621679524757"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524757"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[citem|$exp:(drop arg);|]</span></span><span>
</span><span id="line-779"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-780"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524759"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-781"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524760"><span class="hs-identifier hs-var">argStms</span></a></span><span>
</span><span id="line-782"></span><span>    </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="">[citems|$exp:ret = $id:s($args:argExps);|]</span></span><span>
</span><span id="line-783"></span><span>    </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; BlockItem) -&gt; [Exp] -&gt; [BlockItem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; BlockItem
</span><a href="#local-6989586621679524758"><span class="hs-identifier hs-var">doDrop</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621679524761"><span class="hs-identifier hs-var">argExps</span></a></span><span>
</span><span id="line-784"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span id="local-6989586621679524754"><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679524754"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679524753"><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524753"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679524752"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524752"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-786"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524751"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524751"><span class="hs-identifier hs-var">opVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524750"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524750"><span class="hs-identifier hs-var">opStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrimOp -&gt; [Expr Type] -&gt; Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="#local-6989586621679524754"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><a href="#local-6989586621679524753"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524752"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-787"></span><span>  </span><span id="local-6989586621679524748"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524748"><span class="hs-identifier hs-var">tmp</span></a></span></span><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; GenFn Exp
</span><a href="Codegen.Codegen.html#genTmp"><span class="hs-identifier hs-var">genTmp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679524752"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-788"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524748"><span class="hs-identifier hs-var">tmp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524750"><span class="hs-identifier hs-var">opStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="">[citems|$exp:tmp = $exp:opVal;|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-789"></span><span class="annot"><a href="Codegen.Codegen.html#genPrim"><span class="hs-identifier hs-var">genPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Primitive
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Unsupported Primitive or wrong number of arguments&quot;</span></span><span>
</span><span id="line-790"></span><span>
</span><span id="line-791"></span><span class="hs-comment">-- | Generate C value for SSM literal, marshalled.</span><span>
</span><span id="line-792"></span><span class="annot"><a href="Codegen.Codegen.html#genLiteral"><span class="hs-identifier hs-type">genLiteral</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Literal"><span class="hs-identifier hs-type">I.Literal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span>
</span><span id="line-793"></span><span id="genLiteral"><span class="annot"><span class="annottext">genLiteral :: Literal -&gt; Exp
</span><a href="Codegen.Codegen.html#genLiteral"><span class="hs-identifier hs-var hs-var">genLiteral</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Literal -&gt; Exp) -&gt; Literal -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Literal -&gt; Exp
</span><a href="Codegen.Codegen.html#genLiteralRaw"><span class="hs-identifier hs-var">genLiteralRaw</span></a></span><span>
</span><span id="line-794"></span><span>
</span><span id="line-795"></span><span class="hs-comment">-- | Generate C value for SSM literal, unmarshalled.</span><span>
</span><span id="line-796"></span><span class="annot"><a href="Codegen.Codegen.html#genLiteralRaw"><span class="hs-identifier hs-type">genLiteralRaw</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Literal"><span class="hs-identifier hs-type">I.Literal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span>
</span><span id="line-797"></span><span id="genLiteralRaw"><span class="annot"><span class="annottext">genLiteralRaw :: Literal -&gt; Exp
</span><a href="Codegen.Codegen.html#genLiteralRaw"><span class="hs-identifier hs-var hs-var">genLiteralRaw</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IR.IR.html#LitIntegral"><span class="hs-identifier hs-type">I.LitIntegral</span></a></span><span> </span><span id="local-6989586621679524746"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679524746"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$int:i|]</span></span><span>
</span><span id="line-798"></span><span class="annot"><a href="Codegen.Codegen.html#genLiteralRaw"><span class="hs-identifier hs-var">genLiteralRaw</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="IR.IR.html#LitEvent"><span class="hs-identifier hs-var">I.LitEvent</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|1|]</span></span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span>
</span><span id="line-801"></span><span class="hs-comment">-- | Generate C expression for SSM primitive operation.</span><span>
</span><span id="line-802"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-type">genPrimOp</span></a></span><span>
</span><span id="line-803"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#PrimOp"><span class="hs-identifier hs-type">I.PrimOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-804"></span><span id="genPrimOp"><span class="annot"><span class="annottext">genPrimOp :: PrimOp -&gt; [Expr Type] -&gt; Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var hs-var">genPrimOp</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimAdd"><span class="hs-identifier hs-var">I.PrimAdd</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524743"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524743"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524742"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524742"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-805"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524741"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524741"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524740"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524740"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524739"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524739"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-806"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524743"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524742"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-807"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal + $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524739"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-808"></span><span>  </span><span class="hs-comment">-- TODO: optimization:</span><span>
</span><span id="line-809"></span><span>  </span><span class="hs-comment">--  All integers are 31 bits + 1 tag bit, so zero tag bit on one argument,</span><span>
</span><span id="line-810"></span><span>  </span><span class="hs-comment">-- add together, and the result will be sum with a tag bit of 1.</span><span>
</span><span id="line-811"></span><span>  </span><span class="hs-comment">-- let val = word_to_val</span><span>
</span><span id="line-812"></span><span>  </span><span class="hs-comment">--           [cexp|$exp:(val_to_word lhsVal) + ($exp:(val_to_word rhsVal) &amp; ~1)|]</span><span>
</span><span id="line-813"></span><span>  </span><span class="hs-comment">-- return (val, stms)</span><span>
</span><span id="line-814"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimSub"><span class="hs-identifier hs-var">I.PrimSub</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524735"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524735"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524734"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524734"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-815"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524733"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524733"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524732"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524732"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524731"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524731"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-816"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524735"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524734"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-817"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal - $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524731"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-818"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimMul"><span class="hs-identifier hs-var">I.PrimMul</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524728"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524728"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524727"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524727"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-819"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524726"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524726"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524725"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524725"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524724"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524724"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-820"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524728"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524727"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-821"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal * $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524724"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimDiv"><span class="hs-identifier hs-var">I.PrimDiv</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524721"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524721"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524720"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524720"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-823"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524719"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524719"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524718"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524718"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524717"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524717"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-824"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524721"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524720"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-825"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal / $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524717"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimMod"><span class="hs-identifier hs-var">I.PrimMod</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524714"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524714"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524713"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524713"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-827"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524712"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524712"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524711"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524711"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524710"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524710"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-828"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524714"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524713"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-829"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal % $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524710"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-830"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimNeg"><span class="hs-identifier hs-var">I.PrimNeg</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524707"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524707"><span class="hs-identifier hs-var">opr</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-831"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524706"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524706"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524705"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524705"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp, [BlockItem]) -&gt; (Exp, [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">((Exp, [BlockItem]) -&gt; (Exp, [BlockItem]))
-&gt; GenFn (Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524707"><span class="hs-identifier hs-var">opr</span></a></span><span>
</span><span id="line-832"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|- $exp:val|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524705"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimBitAnd"><span class="hs-identifier hs-var">I.PrimBitAnd</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524702"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524702"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524701"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524701"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-834"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524700"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524700"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524699"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524699"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524698"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524698"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-835"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524702"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524701"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-836"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal &amp; $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524698"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-837"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimBitOr"><span class="hs-identifier hs-var">I.PrimBitOr</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524695"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524695"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524694"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524694"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-838"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524693"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524693"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524692"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524692"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524691"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524691"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-839"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524695"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524694"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-840"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal | $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524691"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-841"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimBitNot"><span class="hs-identifier hs-var">I.PrimBitNot</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524688"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524688"><span class="hs-identifier hs-var">opr</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-842"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524687"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524687"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524686"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524686"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp, [BlockItem]) -&gt; (Exp, [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">((Exp, [BlockItem]) -&gt; (Exp, [BlockItem]))
-&gt; GenFn (Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524688"><span class="hs-identifier hs-var">opr</span></a></span><span>
</span><span id="line-843"></span><span>  </span><span class="hs-comment">-- TODO: optimization:</span><span>
</span><span id="line-844"></span><span>  </span><span class="hs-comment">-- all integers are 31 bits + 1 tag bit, so val XOR (~1) flips the 31 bits and</span><span>
</span><span id="line-845"></span><span>  </span><span class="hs-comment">-- keeps the tag bit 1.</span><span>
</span><span id="line-846"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|($exp:val ^ (~1))|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524686"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimEq"><span class="hs-identifier hs-var">I.PrimEq</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524682"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524682"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524681"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524681"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-848"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524680"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524680"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524679"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524679"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524678"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524678"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-849"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524682"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524681"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-850"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal == $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524678"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-851"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimNeq"><span class="hs-identifier hs-var">I.PrimNeq</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524675"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524675"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524674"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524674"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-852"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524673"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524673"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524672"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524672"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524671"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524671"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-853"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524675"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524674"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-854"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal != $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524671"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-855"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimNot"><span class="hs-identifier hs-var">I.PrimNot</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524668"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524668"><span class="hs-identifier hs-var">opr</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-856"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524667"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524667"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524666"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524666"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp, [BlockItem]) -&gt; (Exp, [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span> </span><span class="annot"><span class="annottext">((Exp, [BlockItem]) -&gt; (Exp, [BlockItem]))
-&gt; GenFn (Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524668"><span class="hs-identifier hs-var">opr</span></a></span><span>
</span><span id="line-857"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|! $exp:val|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524666"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-858"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimGt"><span class="hs-identifier hs-var">I.PrimGt</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524663"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524663"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524662"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524662"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-859"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524661"><span class="annot"><span class="annottext">unmarshal' :: Exp -&gt; Exp
</span><a href="#local-6989586621679524661"><span class="hs-identifier hs-var hs-var">unmarshal'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSize -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#cast_to_signed"><span class="hs-identifier hs-var">cast_to_signed</span></a></span><span> </span><span class="annot"><span class="annottext">CSize
</span><a href="Codegen.LibSSM.html#Size32"><span class="hs-identifier hs-var">Size32</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; Exp -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#shl"><span class="hs-operator hs-var">`shl`</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp
</span><a href="Codegen.LibSSM.html#cint"><span class="hs-identifier hs-var">cint</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; Exp -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span>
</span><span id="line-860"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524656"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524656"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524655"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524655"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524654"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524654"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-861"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="#local-6989586621679524661"><span class="hs-identifier hs-var">unmarshal'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="#local-6989586621679524661"><span class="hs-identifier hs-var">unmarshal'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524663"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524662"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-862"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal &gt; $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524654"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-863"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimGe"><span class="hs-identifier hs-var">I.PrimGe</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524651"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524651"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524650"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524650"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-864"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524649"><span class="annot"><span class="annottext">unmarshal' :: Exp -&gt; Exp
</span><a href="#local-6989586621679524649"><span class="hs-identifier hs-var hs-var">unmarshal'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSize -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#cast_to_signed"><span class="hs-identifier hs-var">cast_to_signed</span></a></span><span> </span><span class="annot"><span class="annottext">CSize
</span><a href="Codegen.LibSSM.html#Size32"><span class="hs-identifier hs-var">Size32</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; Exp -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#shl"><span class="hs-operator hs-var">`shl`</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp
</span><a href="Codegen.LibSSM.html#cint"><span class="hs-identifier hs-var">cint</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; Exp -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span>
</span><span id="line-865"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524648"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524648"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524647"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524647"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524646"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524646"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-866"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="#local-6989586621679524649"><span class="hs-identifier hs-var">unmarshal'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="#local-6989586621679524649"><span class="hs-identifier hs-var">unmarshal'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524651"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524650"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-867"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal &gt;= $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524646"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-868"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimLt"><span class="hs-identifier hs-var">I.PrimLt</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524643"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524643"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524642"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524642"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-869"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524641"><span class="annot"><span class="annottext">unmarshal' :: Exp -&gt; Exp
</span><a href="#local-6989586621679524641"><span class="hs-identifier hs-var hs-var">unmarshal'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSize -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#cast_to_signed"><span class="hs-identifier hs-var">cast_to_signed</span></a></span><span> </span><span class="annot"><span class="annottext">CSize
</span><a href="Codegen.LibSSM.html#Size32"><span class="hs-identifier hs-var">Size32</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; Exp -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#shl"><span class="hs-operator hs-var">`shl`</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp
</span><a href="Codegen.LibSSM.html#cint"><span class="hs-identifier hs-var">cint</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; Exp -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span>
</span><span id="line-870"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524640"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524640"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524639"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524639"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524638"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524638"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-871"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="#local-6989586621679524641"><span class="hs-identifier hs-var">unmarshal'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="#local-6989586621679524641"><span class="hs-identifier hs-var">unmarshal'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524643"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524642"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-872"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal &lt; $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524638"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-873"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><a href="IR.IR.html#PrimLe"><span class="hs-identifier hs-var">I.PrimLe</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679524636"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524636"><span class="hs-identifier hs-var">lhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524635"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524635"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-874"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524634"><span class="annot"><span class="annottext">unmarshal' :: Exp -&gt; Exp
</span><a href="#local-6989586621679524634"><span class="hs-identifier hs-var hs-var">unmarshal'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSize -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#cast_to_signed"><span class="hs-identifier hs-var">cast_to_signed</span></a></span><span> </span><span class="annot"><span class="annottext">CSize
</span><a href="Codegen.LibSSM.html#Size32"><span class="hs-identifier hs-var">Size32</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; Exp -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#shl"><span class="hs-operator hs-var">`shl`</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp
</span><a href="Codegen.LibSSM.html#cint"><span class="hs-identifier hs-var">cint</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; Exp -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#unmarshal"><span class="hs-identifier hs-var">unmarshal</span></a></span><span>
</span><span id="line-875"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679524633"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524633"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524632"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524632"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524631"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524631"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-876"></span><span>    </span><span class="annot"><span class="annottext">((Exp, Exp) -&gt; (Exp, Exp))
-&gt; ((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem])
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; (Exp -&gt; Exp) -&gt; (Exp, Exp) -&gt; (Exp, Exp)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="#local-6989586621679524634"><span class="hs-identifier hs-var">unmarshal'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="#local-6989586621679524634"><span class="hs-identifier hs-var">unmarshal'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Exp, Exp), [BlockItem]) -&gt; ((Exp, Exp), [BlockItem]))
-&gt; GenFn ((Exp, Exp), [BlockItem])
-&gt; GenFn ((Exp, Exp), [BlockItem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var">genBinop</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524636"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524635"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-877"></span><span>  </span><span class="annot"><span class="annottext">(Exp, [BlockItem]) -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp
</span><a href="Codegen.LibSSM.html#marshal"><span class="hs-identifier hs-var">marshal</span></a></span><span> </span><span class="annot"><span class="">[cexp|$exp:lhsVal &lt;= $exp:rhsVal|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524631"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-878"></span><span class="annot"><a href="Codegen.Codegen.html#genPrimOp"><span class="hs-identifier hs-var">genPrimOp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Expr Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; GenFn (Exp, [BlockItem])
forall (m :: * -&gt; *) a. MonadFail m =&gt; [Char] -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Unsupported PrimOp or wrong number of arguments&quot;</span></span><span>
</span><span id="line-879"></span><span>
</span><span id="line-880"></span><span class="hs-comment">-- | Helper for sequencing across binary operations.</span><span>
</span><span id="line-881"></span><span class="annot"><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-type">genBinop</span></a></span><span>
</span><span id="line-882"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IR.IR.html#Expr"><span class="hs-identifier hs-type">I.Expr</span></a></span><span> </span><span class="annot"><a href="IR.Types.Type.html#Type"><span class="hs-identifier hs-type">I.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Codegen.Codegen.html#GenFn"><span class="hs-identifier hs-type">GenFn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-883"></span><span id="genBinop"><span class="annot"><span class="annottext">genBinop :: Expr Type -&gt; Expr Type -&gt; GenFn ((Exp, Exp), [BlockItem])
</span><a href="Codegen.Codegen.html#genBinop"><span class="hs-identifier hs-var hs-var">genBinop</span></a></span></span><span> </span><span id="local-6989586621679524629"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524629"><span class="hs-identifier hs-var">lhs</span></a></span></span><span> </span><span id="local-6989586621679524628"><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524628"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-884"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524627"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524627"><span class="hs-identifier hs-var">lhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524626"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524626"><span class="hs-identifier hs-var">lhsStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524629"><span class="hs-identifier hs-var">lhs</span></a></span><span>
</span><span id="line-885"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679524625"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524625"><span class="hs-identifier hs-var">rhsVal</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524624"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524624"><span class="hs-identifier hs-var">rhsStms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Expr Type -&gt; GenFn (Exp, [BlockItem])
</span><a href="Codegen.Codegen.html#genExpr"><span class="hs-identifier hs-var">genExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Expr Type
</span><a href="#local-6989586621679524628"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-886"></span><span>  </span><span class="annot"><span class="annottext">((Exp, Exp), [BlockItem]) -&gt; GenFn ((Exp, Exp), [BlockItem])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524627"><span class="hs-identifier hs-var">lhsVal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524625"><span class="hs-identifier hs-var">rhsVal</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524626"><span class="hs-identifier hs-var">lhsStms</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem] -&gt; [BlockItem] -&gt; [BlockItem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621679524624"><span class="hs-identifier hs-var">rhsStms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-887"></span><span>
</span><span id="line-888"></span><span class="hs-comment">-- | Compute priority and depth arguments for a par fork of given width.</span><span>
</span><span id="line-889"></span><span class="annot"><a href="Codegen.Codegen.html#genParArgs"><span class="hs-identifier hs-type">genParArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-890"></span><span id="genParArgs"><span class="annot"><span class="annottext">genParArgs :: Int -&gt; (Exp, Exp) -&gt; [(Exp, Exp)]
</span><a href="Codegen.Codegen.html#genParArgs"><span class="hs-identifier hs-var hs-var">genParArgs</span></a></span></span><span> </span><span id="local-6989586621679524623"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524623"><span class="hs-identifier hs-var">width</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679524622"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524622"><span class="hs-identifier hs-var">currentPrio</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679524621"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524621"><span class="hs-identifier hs-var">currentDepth</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-891"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679524620"><span class="annot"><span class="annottext">p :: Exp
</span><a href="#local-6989586621679524620"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$exp:currentPrio + ($int:(i-1) * (1 &lt;&lt; $exp:d))|]</span></span><span>
</span><span id="line-892"></span><span>        </span><span id="local-6989586621679524618"><span class="annot"><span class="annottext">d :: Exp
</span><a href="#local-6989586621679524618"><span class="hs-identifier hs-var hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$exp:currentDepth - $exp:(depthSub width)|]</span></span><span>
</span><span id="line-893"></span><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524620"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621679524618"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-894"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679524619"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524619"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524623"><span class="hs-identifier hs-var">width</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-895"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-896"></span><span>
</span><span id="line-897"></span><span class="hs-comment">-- | How much the depth should be decreased when par forking given width.</span><span>
</span><span id="line-898"></span><span class="annot"><a href="Codegen.Codegen.html#depthSub"><span class="hs-identifier hs-type">depthSub</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Exp</span></span><span>
</span><span id="line-899"></span><span id="depthSub"><span class="annot"><span class="annottext">depthSub :: Int -&gt; Exp
</span><a href="Codegen.Codegen.html#depthSub"><span class="hs-identifier hs-var hs-var">depthSub</span></a></span></span><span> </span><span id="local-6989586621679524616"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524616"><span class="hs-identifier hs-var">width</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[cexp|$int:ds|]</span></span><span>
</span><span id="line-900"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679524615"><span class="annot"><span class="annottext">ds :: Int
</span><a href="#local-6989586621679524615"><span class="hs-identifier hs-var hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double -&gt; Int
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">ceiling</span></span><span> </span><span class="annot"><span class="annottext">(Double -&gt; Int) -&gt; Double -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Floating a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">logBase</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Double -&gt; Double) -&gt; Double -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679524616"><span class="hs-identifier hs-var">width</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-901"></span></pre></body></html>